<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>个人资料页</title>
    <url>/post/about-me/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="孙继刚"><a href="#孙继刚" class="headerlink" title="孙继刚"></a>孙继刚</h1><ul>
<li>男 / 1992.09 / 党员 / 汉族</li>
<li>手机: <a href="tel://1717932390">1717932390</a></li>
<li>博客: <a href="https://madordie.github.io/">继刚的博客</a></li>
<li>GitHub: <a href="https://github.com/madordie" target="_blank" rel="noopener">madordie</a></li>
<li>Email: <a href="mailto:io.madordie@gmail.com">io.madordie@gmail.com</a></li>
</ul>
<h2 id="个人技能"><a href="#个人技能" class="headerlink" title="个人技能"></a>个人技能</h2><ul>
<li>熟练掌握Objective-C、Swift等语言, 了解shell、C</li>
<li>能够使用各种工具分析并解决内存泄漏、崩溃等问题</li>
<li>熟练掌握runtime、runloop、block等,并了解相关的底层知识</li>
<li>能够根据业务需求进行较优地技术选型以及实现</li>
<li>拥有较强的发现、分析、解决问题的能力</li>
<li>拥有良好的编程习惯</li>
<li>能够使用Jenkins等自动化工具进行持续集成并分发</li>
</ul>
<h2 id="工作经历"><a href="#工作经历" class="headerlink" title="工作经历"></a>工作经历</h2><ul>
<li>2015.08-至今 上海房多多网络科技有限公司 (iOS高级工程师)</li>
<li>2014.10-2015.05 上海商路网络科技有限公司 (iOS工程师)</li>
</ul>
<h2 id="项目经历"><a href="#项目经历" class="headerlink" title="项目经历"></a>项目经历</h2><h3 id="多多卖房"><a href="#多多卖房" class="headerlink" title="多多卖房"></a>多多卖房</h3><p>一个房多多经纪商户专业获客平台、经纪人移动作业平台</p>
<ul>
<li>主要使用语言: Objective-C + Swift</li>
<li>主要使用布局: Code Frame + AutoLayout</li>
<li>组织项目启动并规范开发流程以适应更多人的协作开发</li>
<li>推进项目模块化</li>
<li>主导一些核心库的底层实现</li>
</ul>
<h3 id="可可赚"><a href="#可可赚" class="headerlink" title="可可赚"></a>可可赚</h3><p>一个发布任务、做任务、领取现金的刷榜积分墙</p>
<ul>
<li>主要使用语言: Objective-C + C + Swift</li>
<li>主要负责安装检测、混淆、反逆向等核心功能的研发与维护</li>
<li>负责分析、标记、锁定可疑用户行为的账号及关联账号</li>
</ul>
<h3 id="房多多"><a href="#房多多" class="headerlink" title="房多多"></a>房多多</h3><p>一个可以进行新房、二手房、租房进行买卖的平台</p>
<ul>
<li>主要使用语言: Objective-C + Swift</li>
<li>主要使用布局: Code Frame + AutoLayout</li>
<li>搭建并维护Jenkins平台</li>
<li>设计实现并维护较为复杂的模块</li>
<li>根据崩溃系统的统计,分析并修复各种崩溃</li>
</ul>
<h3 id="肌肤管家"><a href="#肌肤管家" class="headerlink" title="肌肤管家"></a>肌肤管家</h3><p>一个用硬件测试皮肤数据并提供保养建议的化妆品社区</p>
<ul>
<li>主要使用语言: Objective-C + C</li>
<li>主要使用布局: Interface Builder + AutoLayout</li>
<li>负责项目2x版本核心功能的开发、维护 如: 社区、IM、等</li>
<li>一代硬件肌肤测试仪的硬件对接与功能开发</li>
</ul>
<h2 id="教育背景"><a href="#教育背景" class="headerlink" title="教育背景"></a>教育背景</h2><p>本科: 2011.09-2015.06 南阳理工学院   软件工程(移动设备应用开发方向)</p>
<h2 id="自我评价"><a href="#自我评价" class="headerlink" title="自我评价"></a>自我评价</h2><ul>
<li>热衷于技术</li>
<li>始终信奉: 代码的简单程度与维护成本以及出错率成正比</li>
<li>乐观开朗、思维活跃、做事认真负责、为人积极乐观、有较强的团队意识</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>博客迁移公告</title>
    <url>/post/about-change-blog/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>你敢信！我又搬家了。。</p>
<p>之前在<a href="http://www.cnblogs.com/madordie/" target="_blank" rel="noopener">博客园</a>后来又去了<a href="http://madordie.leanote.com/" target="_blank" rel="noopener">蚂蚁笔记</a>，最后吧，我就到了<a href="https://madordie.github.io/">这里</a>。</p>
<p>说下大体感受：</p>
<p><a href="http://www.cnblogs.com/" target="_blank" rel="noopener">博客园</a>挺好的，不过不喜欢其编码方式，真的不喜欢。博客园的主题什么的都是可以定制，但是总归是写起来比较费劲的。</p>
<p><del><a href="https://leanote.com/" target="_blank" rel="noopener">蚂蚁笔记</a>不错，我开始时候logo还不是这个<img src="http://7xvzwi.com1.z0.glb.clouddn.com/leanote_new_logo.png" width=35 alt="新logo">原来logo是<img src="http://7xvzwi.com1.z0.glb.clouddn.com/leanote_old_logo.png" width=35 alt="旧logo" >😂,不过现在已经很厉害了，开始了各种业务。期待会走得更好更远。</del></p>
<p>蚂蚁笔记已不支持免费用户部署博客，这里是<a href="https://leanote.com/pricing" target="_blank" rel="noopener">价格方案</a>。</p>
<p>我是看了<a href="http://blog.devtang.com/" target="_blank" rel="noopener">巧哥</a>的<a href="http://blog.devtang.com/2012/02/10/setup-blog-based-on-github/" target="_blank" rel="noopener">这个博文</a>才开始准备转到Github的。。赶脚markdown很好玩，虽然出来很早了，但是并没有仔细的去学习这个语法，于是乎这个博客就用<a href="https://hexo.io/" target="_blank" rel="noopener">hexo</a>进行搭建。</p>
<p>虽然我还不知道怎么让百度收录我的Github，但是主要的是能尝试着自己想试试确没有尝试的事情！</p>
]]></content>
      <categories>
        <category>公告</category>
      </categories>
      <tags>
        <tag>blog</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo的博客让百度收录</title>
    <url>/post/use-hexo-setup-blog/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>这个github.io搭建的过程参考，以及向百度推送的python、js脚本。</p>
<a id="more"></a>

<h1 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h1><p>感谢 <a href="http://lovenight.github.io/" target="_blank" rel="noopener">岁月如歌</a> 的这个<a href="http://lovenight.github.io/2015/11/10/Hexo-3-1-1-%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%8C%87%E5%8D%97/" target="_blank" rel="noopener">《Hexo 3.1.1 静态博客搭建指南》</a>同时感谢这个<a href="http://lovenight.github.io/2015/11/18/%E5%90%91%E7%99%BE%E5%BA%A6%E6%8E%A8%E9%80%81hexo%E5%8D%9A%E5%AE%A2%E6%89%80%E6%9C%89%E9%93%BE%E6%8E%A5%E7%9A%84Python%E8%84%9A%E6%9C%AC/" target="_blank" rel="noopener">《向百度推送hexo博客所有链接的Python脚本》</a>(别问我为啥点不开，这个要问博主，不过要看这个文章也不是没办法的😂，因为这个博客也用git管理的。。。你懂)</p>
<p>另外还有一个<a href="http://emufan.com/" target="_blank" rel="noopener">soul</a>的<a href="http://emufan.com/2016/02/18/%E7%99%BE%E5%BA%A6%E4%B8%BB%E5%8A%A8%E6%8E%A8%E9%80%81hexo%E7%94%9F%E6%88%90%E7%9A%84%E6%96%87%E7%AB%A0/" target="_blank" rel="noopener">百度主动推送hexo生成的文章</a></p>
<h1 id="python自动推送脚本修改"><a href="#python自动推送脚本修改" class="headerlink" title="python自动推送脚本修改"></a>python自动推送脚本修改</h1><p>上面说的博主大约用的是windows，所以脚本并不能立马的运行在Mac上，需要做些修改：故修改为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: LoveNight</span></span><br><span class="line"><span class="comment"># @Date:   2015-11-16 20:45:59</span></span><br><span class="line"><span class="comment"># @Last Modified by:   LoveNight</span></span><br><span class="line"><span class="comment"># @Last Modified time: 2015-11-18 18:07:19</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># @Last Modified by:   Keith</span></span><br><span class="line"><span class="comment"># @Last Modified time: 2016-07-06 16:22:45</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup <span class="keyword">as</span> BS</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">#import msvcrt</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">hexo 博客专用，向百度站长平台提交所有网址</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">本脚本必须放在hexo博客的根目录下执行！需要已安装生成百度站点地图的插件。</span></span><br><span class="line"><span class="string">百度站长平台提交链接：http://zhanzhang.baidu.com/linksubmit/index</span></span><br><span class="line"><span class="string">主动推送：最为快速的提交方式，推荐您将站点当天新产出链接立即通过此方式推送给百度，以保证新链接可以及时被百度收录。</span></span><br><span class="line"><span class="string">从中找到自己的接口调用地址</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">python环境：</span></span><br><span class="line"><span class="string">pip install beautifulsoup4</span></span><br><span class="line"><span class="string">pip install requests</span></span><br><span class="line"><span class="string">xcode-select --install	</span></span><br><span class="line"><span class="string">pip install lxml </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ❌❌❌ 抄的需要更改这个URL！！这是我的！！❌❌❌</span></span><br><span class="line">url = <span class="string">'http://data.zz.baidu.com/urls?site=https://madordie.github.io&amp;token=j33t0VEPFl24tJ8N'</span></span><br><span class="line">baidu_sitemap = os.path.join(sys.path[<span class="number">0</span>], <span class="string">'public'</span>, <span class="string">'baidusitemap.xml'</span>)</span><br><span class="line">google_sitemap = os.path.join(sys.path[<span class="number">0</span>], <span class="string">'public'</span>, <span class="string">'sitemap.xml'</span>)</span><br><span class="line">sitemap = [baidu_sitemap, google_sitemap]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> (os.path.exists(baidu_sitemap) <span class="keyword">or</span> os.path.exists(</span><br><span class="line">    google_sitemap)), <span class="string">"没找到任何网站地图，请检查！"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从站点地图中读取网址列表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrls</span><span class="params">()</span>:</span></span><br><span class="line">    urls = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> sitemap:</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(_):</span><br><span class="line">            <span class="keyword">with</span> open(_, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                xml = f.read()</span><br><span class="line">        soup = BS(xml, <span class="string">"xml"</span>)</span><br><span class="line">        tags = soup.find_all(<span class="string">"loc"</span>)</span><br><span class="line">        urls += [x.string <span class="keyword">for</span> x <span class="keyword">in</span> tags]</span><br><span class="line">        <span class="keyword">if</span> _ == baidu_sitemap:</span><br><span class="line">            tags = soup.find_all(<span class="string">"breadCrumb"</span>, url=<span class="literal">True</span>)</span><br><span class="line">            urls += [x[<span class="string">"url"</span>] <span class="keyword">for</span> x <span class="keyword">in</span> tags]</span><br><span class="line">    <span class="keyword">return</span> urls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># POST提交网址列表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postUrls</span><span class="params">(urls)</span>:</span></span><br><span class="line">    urls = set(urls)  <span class="comment"># 先去重</span></span><br><span class="line">    print(<span class="string">"一共提取出 %s 个网址"</span> % len(urls))</span><br><span class="line">    print(urls)</span><br><span class="line">    data = <span class="string">"\n"</span>.join(urls)</span><br><span class="line">    <span class="keyword">return</span> requests.post(url, data=data).text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    urls = getUrls()</span><br><span class="line">    result = postUrls(urls)</span><br><span class="line">    print(<span class="string">"提交结果："</span>)</span><br><span class="line">    print(result)</span><br><span class="line"><span class="comment">#    msvcrt.getch()</span></span><br></pre></td></tr></table></figure>

<h1 id="js脚本"><a href="#js脚本" class="headerlink" title="js脚本"></a>js脚本</h1><p>这个脚本是我在<a href="http://emufan.com/" target="_blank" rel="noopener">soul</a>的<a href="http://emufan.com/2016/02/18/%E7%99%BE%E5%BA%A6%E4%B8%BB%E5%8A%A8%E6%8E%A8%E9%80%81hexo%E7%94%9F%E6%88%90%E7%9A%84%E6%96%87%E7%AB%A0/" target="_blank" rel="noopener">百度主动推送hexo生成的文章</a>发现的，感觉也很赞。</p>
<blockquote>
<h2 id="github"><a href="#github" class="headerlink" title="github"></a>github</h2><p>  <a href="https://github.com/Relsoul/bdwork/tree/master/soul/hexo%E7%99%BE%E5%BA%A6%E4%B8%BB%E5%8A%A8%E4%B8%8A%E4%BC%A0" target="_blank" rel="noopener">脚本地址</a></p>
</blockquote>
<h2 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h2><p>  今天发现百度没收录我的站..主要是我的站点换来换去的..估计被ban了..然后想用sitemap来推送一下..结果发现github禁用了百度爬虫..没办法只能主动推送了.</p>
<h2 id="利用插件"><a href="#利用插件" class="headerlink" title="利用插件"></a>利用插件</h2><p>  这里利用到了一款插件<br>  <a href="https://github.com/coneycode/hexo-generator-baidu-sitemap" target="_blank" rel="noopener">hexo-generator-baidu-sitemap</a><br>  设置很简单 只需要在.config.yml添加一些数据即可, 下面附上我的添加数据 theme这个可以随意更改 下面的copy即可<br>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Extensions</span><br><span class="line">## Plugins: http:&#x2F;&#x2F;hexo.io&#x2F;plugins&#x2F;</span><br><span class="line">## Themes: http:&#x2F;&#x2F;hexo.io&#x2F;themes&#x2F;</span><br><span class="line">theme: yilia</span><br><span class="line">baidusitemap:</span><br><span class="line">path: baidusitemap.xml</span><br></pre></td></tr></table></figure></p>
<blockquote>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>  然后hexo g 生成一下数据 会在public下面发现一个文件名为baidusitemap.xml</p>
</blockquote>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>  这里用nodejs写了一款脚本 大概流程是 获取baidusitemap.xml里面的内容 然后读取本地的一个site_file.json这个文件 这个文件存储的是上一次数据 与上一次数据进行对比 如果对比发现新数据那么就上传新数据 否则全部上传.</p>
<h2 id="运行脚本"><a href="#运行脚本" class="headerlink" title="运行脚本"></a>运行脚本</h2><p>  把ActivePush.js脚本放在hexo文件夹主目录 然后用nodejs ActivePush.js一下即可 这里还支持一个参数nodejs ActivePush.js all 则是不对比直接上传数据</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>blog</tag>
        <tag>SEO</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu使用SakuraFrp实现内网穿透</title>
    <url>/post/ubuntu-sakura-frp/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>记录将一台吃灰的笔记本改装成服务器，并暴露在公网下的过程。</p>
<a id="more"></a>

<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><ul>
<li>一个 ubuntu-18.04.2-desktop-amd64.iso</li>
<li>一台陈旧的Gateway笔记本</li>
<li>一台主战MBP</li>
</ul>
<p>iso: 如果从<a href="https://ubuntu.com/download/desktop" target="_blank" rel="noopener">官网</a>下载速度比较慢，可以考虑上<code>wget</code>、迅雷。我这里使用了<code>wget</code>并且使用了<a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cdimage/ubuntu/releases/" target="_blank" rel="noopener">清华的镜像</a></p>
<p>Gateway: 还是个win10，于是乎顺手就把<code>ubuntu-18.04.2-desktop-amd64.iso</code>制作成了U盘，此处我就不说了，反正能引导进去就行啊哈哈哈</p>
<p>MBP: 主要工作在这里。比如远程win桌面用的是<a href="https://apps.apple.com/us/app/microsoft-remote-desktop/id1295203466?mt=12" target="_blank" rel="noopener">Microsoft Remote Desktop</a></p>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><p>注意，Ubuntu会将硬盘 <strong>所有分区全部格式化</strong> ，请先妥善备份。</p>
<p>经过安装提示以及笔记本的疯狂发热很快就安装完事了。</p>
<h2 id="设置Ubuntu软件源"><a href="#设置Ubuntu软件源" class="headerlink" title="设置Ubuntu软件源"></a>设置Ubuntu软件源</h2><p>这里还是用清华大学的镜像，其<a href="https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/" target="_blank" rel="noopener">Ubuntu 镜像使用帮助</a>也是相当的详细：</p>
<blockquote>
<p>Ubuntu 的软件源配置文件是 /etc/apt/sources.list。将系统自带的该文件做个备份，将该文件替换为下面内容，即可使用 TUNA 的软件源镜像。</p>
<p>选择你的ubuntu版本: 18.04 LTS</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"># 预发布软件源，不建议启用</span><br><span class="line"># deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-proposed main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-proposed main restricted universe multiverse</span><br></pre></td></tr></table></figure>

<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p><code>apt</code>已经相当完善，此处不再赘述。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt dist-upgrade</span><br></pre></td></tr></table></figure>

<p>当然，别忘了安装<code>wget</code>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt install wget</span><br></pre></td></tr></table></figure>

<p>此处如果按照上面的步骤已经设置了清华大学的镜像源，那速度将会很快。要不然就很慢慢慢。。</p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><p>此步骤并非必须，只是记录一下一些很坑的事情，啊哈哈哈哈</p>
<h3 id="没有Wi-Fi选项"><a href="#没有Wi-Fi选项" class="headerlink" title="没有Wi-Fi选项"></a>没有Wi-Fi选项</h3><p>安装Wi-Fi驱动，记得重启哦：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt install bcmwl-kernel-source</span><br></pre></td></tr></table></figure>

<h3 id="未知的显示器（Unknown-Display）"><a href="#未知的显示器（Unknown-Display）" class="headerlink" title="未知的显示器（Unknown Display）"></a>未知的显示器（Unknown Display）</h3><p>如果是很快的意识到是<code>设置</code>里面有一个<code>未知的显示器</code>，并且以<code>拼接</code>的方式使用，那你就直接根据<a href="https://bugs.launchpad.net/ubuntu/+source/ubuntu-drivers-common/+bug/1296020" target="_blank" rel="noopener">Non-existent display detected in both intel driver and nvidia driver (Optimus Laptop)</a>所示，只需安装Bumblebee并重启即可。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt install bumblebee-nvidia</span><br></pre></td></tr></table></figure>

<p>该问题貌似是由于集成显卡和独显共存的问题，所以当你并没有连接外接显示器但是却出现以下双显示器才有的功能时候记得用这个方案。</p>
<ul>
<li>APP打开了却看不到界面，只看到页面嗖的一下飞出了屏幕</li>
<li>左上角有时候会出现一个黑框框，里面有一个数字1</li>
<li>鼠标放至屏幕上下左右，有一个边会进去</li>
<li>右键窗口会有一个类似<code>移至显示器右侧</code>的按钮，点了就看不见了</li>
<li><code>xrandr --listmonitors</code> 有两个</li>
</ul>
<h3 id="切换Intel和Nvidia显卡"><a href="#切换Intel和Nvidia显卡" class="headerlink" title="切换Intel和Nvidia显卡"></a>切换Intel和Nvidia显卡</h3><p><strong>no zuo no die no life, 听我一句劝别玩这个。。。</strong>。如果G了去看下<a href="https://www.qingsword.com/qing/ubuntu-remove-nvidia.html" target="_blank" rel="noopener">解决Ubuntu18.04安装Nvidia驱动开机卡死</a></p>
<p><a href="https://www.linuxbabe.com/desktop-linux/switch-intel-nvidia-graphics-card-ubuntu" target="_blank" rel="noopener">How To Switch Between Intel and Nvidia Graphics Card on Ubuntu</a>遇到卡在<code>Started bpfilter</code>之后需要编辑/etc/gdm3/custom.conf，将下面这一行放开：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">＃WaylandEnable = FALSE</span><br></pre></td></tr></table></figure>

<h1 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h1><p>将<code>内网穿透</code>放在Google里面搜索一下会有很多方案，我的VPS被邻居连累之后就没有再买，所以我没有域名、公网IP。。。其中搜索结果的大部分都不适合我。</p>
<p>其中大部分提到一个<code>DDNS</code>的概念：<a href="https://zh.wikipedia.org/wiki/%E5%8B%95%E6%85%8BDNS" target="_blank" rel="noopener">维基百科:动态DNS</a></p>
<blockquote>
<p>动态DNS（英语：Dynamic DNS，简称DDNS）是域名系统（DNS）中的一种自动更新名称服务器（Name server）内容的技术。根据互联网的域名订立规则，域名必须跟从固定的IP地址。但动态DNS系统为动态网域提供一个固定的名称服务器（Name server），透过即时更新，使外界用户能够连上动态用户的网址。</p>
</blockquote>
<p>了解玩这个之后就可以搜索并选择DDMS方案了。</p>
<p>再明确一下目标：在外网ssh进内网我们刚建好的Ubuntu。</p>
<h2 id="fatedier-frp"><a href="#fatedier-frp" class="headerlink" title="fatedier/frp"></a>fatedier/frp</h2><p>首推这种方案：<a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">fatedier/frp</a>, 文档有中文并且比较详细。</p>
<p>还有少数派的一个文章也不错：<a href="https://sspai.com/post/52523" target="_blank" rel="noopener">使用frp进行内网穿透</a></p>
<h2 id="TPDDNS"><a href="#TPDDNS" class="headerlink" title="TPDDNS"></a>TPDDNS</h2><p>不过我家里的路由是<a href="https://www.tp-link.com.cn/" target="_blank" rel="noopener">TP-LINK</a>的，TP-LINK是可以参考<a href="https://service.tp-link.com.cn/detail_article_2978.html" target="_blank" rel="noopener">TPDDNS的使用方法介绍</a>可以直接使用的。</p>
<p>不过坑比的事情是[TPDDNS]支持的硬件版本是4.0。参考<a href="https://service.tp-link.com.cn/detail_article_1420.html" target="_blank" rel="noopener">如何查看产品型号与硬件版本？</a>，也就是其<code>ver 4.0</code>之上是可以的。</p>
<p>最好是问一下<code>TP-LINK 在线客服</code>，一般 某猫、某狗上面的客服是不懂这个的。</p>
<p>很显然我家里的路由是V3.0 啊哈哈哈 此方案我这里不适用。不过看上面的教程已经很详尽了，应该比较好搞。</p>
<h2 id="Sakura-Frp"><a href="#Sakura-Frp" class="headerlink" title="Sakura Frp"></a>Sakura Frp</h2><p>这个据<a href="https://www.natfrp.org/" target="_blank" rel="noopener">官网</a>介绍是这样的：</p>
<blockquote>
<p>简单方便<br>客户端基于 Fatedier Frp 修改，免去了配置文件，改为从网络读取配置，您只需要在网站上简单操作即可添加映射。</p>
<p>完全免费<br>您不必再为了内网穿透多花一分钱，Sakura Frp 是永远免费的，我们只为了让更多人能体验到免费、好用的内网穿透。</p>
<p>自由使用<br>我们非常欢迎您将 Sakura Frp 集成到自己的软件中，并且我们提供了多种 API 接口以供使用，完全没有使用限制。</p>
</blockquote>
<p>好了，适合我这种不愿意花钱的穷屌丝，来<a href="https://openid.natfrp.org/?action=register&src=www.natfrp.com" target="_blank" rel="noopener">注册</a>吧。。</p>
<p>登录进去才发现，好多文字。没有明显的新手教程，对我这种不是很懂<code>FRP</code>的人来说简直一脸懵逼。</p>
<h2 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h2><p><a href="https://www.natfrp.com/page/panel/" target="_blank" rel="noopener">映射列表</a>中的<code>示例映射 - Linux SSH</code>正合我意，然后只需要再点一下<code>随机端口</code>就可以不用输入直接点添加了。</p>
<p><img src="/images/2019-07-09-13-43-31.png" alt="Linux SSH 并随机端口"></p>
<p><img src="/images/2019-07-09-13-44-25.png" alt="已添加的隧道列表"></p>
<p>至此第一个映射已经创建了，然后需要去Ubuntu上开启代理吧</p>
<h2 id="开启代理"><a href="#开启代理" class="headerlink" title="开启代理"></a>开启代理</h2><p>在<a href="https://www.natfrp.com/page/panel/" target="_blank" rel="noopener">客户软件</a>中找到适合自己的<code>Linux x64 (64位操作系统)</code>包并下载至Ubuntu:</p>
<p>此处将包下载至<code>/opt/natfrp</code>(该路径将在后面的配置中使用)</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo mkdir -p /opt/natfrp &amp;&amp; <span class="built_in">cd</span> /opt/natfrp</span><br><span class="line">sudo wget https://cdn.tcotp.cn:4443/client/Sakura_frpc_linux_amd64.tar.gz</span><br><span class="line">sudo tar zxvf Sakura_frpc_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压完成后，就会得到一个可执行文件<code>Sakura_frpc_linux_amd64</code>(该文件名将在后面的配置中使用)</p>
<p>根据<a href="https://www.zerobbs.net/?s=viewpost&tid=5" target="_blank" rel="noopener">Linux 将 Sakura Frp 设置为服务，开机自动启动</a>的教程操作如下：</p>
<h3 id="创建service"><a href="#创建service" class="headerlink" title="创建service"></a>创建service</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo vi /etc/systemd/system/sakurafrp.service</span><br></pre></td></tr></table></figure>

<h3 id="根据自己的配置写入service"><a href="#根据自己的配置写入service" class="headerlink" title="根据自己的配置写入service"></a>根据自己的配置写入service</h3><p><code>/opt/natfrp/</code>: Sakura_frpc_linux_amd64的全路径<br><code>/opt/natfrp/Sakura_frpc_linux_amd64</code>: 解压之后的Sakura_frpc_linux_amd64全路径<br><code>--sid=</code>: 服务器列表中左侧的数字</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Sakura Frp Client</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">WorkingDirectory=/opt/natfrp/</span><br><span class="line">LimitNOFILE=4096</span><br><span class="line">PIDFile=/var/run/sakurafrp/client.pid</span><br><span class="line">ExecStart=/opt/natfrp/Sakura_frpc_linux_amd64 --su=你的账号 --sp=你的密码 --sid=你要选择的服务器的ID(就是服务器列表左侧的数字)</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitInterval=600</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>sid信息[2019.7.9:14:10]:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">| ID	名称		状态		介绍</span><br><span class="line">|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">| 1	宁波电信	√ 在线		高防线路，适合搭 Minecraft 服务器，使用人数较多 (官方服务器)</span><br><span class="line">| 2	宁波联通	√ 在线		联通线路，防御 20G，适合部分移动联通&#x2F;用户使用 (官方服务器)</span><br><span class="line">| 3	徐州电信	√ 在线		徐州高防电信，适合开服，月流量固定 500G，请合理使用 (官方服务器)</span><br><span class="line">| 4	贵州电信	× 离线		贵州电信节点，无防御，适合小流量传输服务[超流量停机] (官方服务器)</span><br><span class="line">| 6	罗马尼亚	× 离线		罗马尼亚不限内容无视 DMCA 版权服务器，免备案 (官方服务器)</span><br><span class="line">| 7	日本千兆	√ 在线		日本千兆服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">| 8	台湾百兆	√ 在线		台湾谷歌云 100M 服务器，适合建站，延迟较低，免备案 (官方服务器)</span><br><span class="line">| 9	香港线路1 √ 在线		香港 StarryDNS 100M 服务器，适合建站 (官方服务器)</span><br><span class="line">| 10	江苏镇江	√ 在线		江苏镇江 100M 服务器，BGP 全国优化线路，适合开服 (官方服务器)</span><br><span class="line">| 12	河南电信	√ 在线		河南电信线路服务器，适合开服以及小流量服务 (官方服务器)</span><br><span class="line">| 13	香港线路2 √ 在线		香港谷歌云 100M 服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">| 30	洛杉矶01	√ 在线		美国洛杉矶千兆服务器，适合建站，免备案 线路 1 (官方服务器)</span><br><span class="line">| 31	洛杉矶02	√ 在线		美国洛杉矶千兆服务器，适合建站，免备案 线路 2 (官方服务器)</span><br><span class="line">| 32	洛杉矶03	√ 在线		美国洛杉矶千兆服务器，适合建站，免备案 线路 3 (官方服务器)</span><br><span class="line">| 33	洛杉矶04	√ 在线		美国洛杉矶千兆服务器，适合建站，免备案 线路 4 (官方服务器)</span><br><span class="line">| 34	洛杉矶05	√ 在线		美国洛杉矶千兆服务器，适合建站，免备案 线路 5 (官方服务器)</span><br><span class="line">| 38	新加坡01	× 离线		新加坡阿里云 30M 服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">| 39	蒙特利尔	√ 在线		加拿大蒙特利尔谷歌云 100M 服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">| 43	香港移动	× 离线		香港 UOvZ 100M 移动服务器，适合建站，免备案[机房断网维护中] (官方服务器)</span><br><span class="line">| 45	美国纽约1 √ 在线		美国纽约百兆服务器，适合建站，免备案 线路1 (官方服务器)</span><br><span class="line">| 46	美国纽约2 √ 在线		美国纽约百兆服务器，适合建站，免备案 线路2 (官方服务器)</span><br><span class="line">| 47	日本长野	× 离线		日本长野百兆服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<h3 id="启动service"><a href="#启动service" class="headerlink" title="启动service"></a>启动service</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<p>服务就创建成功了，接下来启动服务：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl start sakurafrp</span><br></pre></td></tr></table></figure>

<p>将服务设置为开机启动</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> sakurafrp</span><br></pre></td></tr></table></figure>

<p>如果要停止运行客户端，只需要输入</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl stop sakurafrp</span><br></pre></td></tr></table></figure>

<p>如果要禁止开机启动，输入</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> sakurafrp</span><br></pre></td></tr></table></figure>

<p>至此，来让我们看一下当前的状态：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╰─&gt;$ sudo systemctl status sakurafrp</span><br><span class="line">● sakurafrp.service - Sakura Frp Client</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/sakurafrp.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Tue 2019-07-09 11:07:19 CST; 3h 13min ago</span><br><span class="line"> Main PID: 3301 (Sakura_frpc_lin)</span><br><span class="line">    Tasks: 10 (<span class="built_in">limit</span>: 4915)</span><br><span class="line">   Memory: 5.9M</span><br><span class="line">   CGroup: /system.slice/sakurafrp.service</span><br><span class="line">           └─3301 /opt/natfrp/Sakura_frpc_linux_amd64 --su=xxxxxxxx --sp=xxxxxxxx --sid=xxx</span><br><span class="line"></span><br><span class="line">7月 09 11:07:20 madordie-NV47H Sakura_frpc_linux_amd64[3301]: &gt;配置文件载入成功</span><br><span class="line">7月 09 11:07:20 madordie-NV47H Sakura_frpc_linux_amd64[3301]: 2019/07/09 11:07:20 [I] [proxy_manager.go:322] 增加代理: [xxx.natfrp.org:22941        29795-87248]</span><br><span class="line">7月 09 11:07:20 madordie-NV47H Sakura_frpc_linux_amd64[3301]: 2019/07/09 11:07:20 [I] [control.go:242] [d54792913cdac17d] 登录成功, 获取到运行ID [d54792913cdac17d], server udp port [7001]</span><br><span class="line">7月 09 11:07:20 madordie-NV47H Sakura_frpc_linux_amd64[3301]: 2019/07/09 11:07:20 [I] [control.go:167] [d54792913cdac17d] [xxx.natfrp.org:22941        29795-87248] 启动代理成功</span><br></pre></td></tr></table></figure>

<p>可以看到<code>[xxx.natfrp.org:22941        29795-87248] 启动代理成功</code></p>
<p>需要注意的是选用的sid不一样其代理的域名也不一样。这个是很显然的，但是是容易忽略的。</p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p>在MBP上验证一下<code>xxx.natfrp.org:22941</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╰─&gt;$ ssh -p 22941 madordie@xxx.natfrp.org</span><br><span class="line">Welcome to Ubuntu 19.04 (GNU/Linux 4.18.0-15-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12 updates can be installed immediately.</span><br><span class="line">6 of these updates are security updates.</span><br><span class="line"></span><br><span class="line">Last login: Tue Jul  9 14:19:33 2019 from 127.0.0.1</span><br></pre></td></tr></table></figure>

<p><code>Sakura Frp</code>已通，愉快的玩耍吧！</p>
<p>括弧：一旦其暴露出去别忘了考虑安全，比如你的这个SSH账号、密码是否足够复杂，或者是否关闭了账号密码登陆。</p>
<h1 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h1><p>还有一些其他的方案可以选择，比如：</p>
<ul>
<li><a href="https://hsk.oray.com/" target="_blank" rel="noopener">花生壳</a></li>
<li><a href="https://www.noip.com/" target="_blank" rel="noopener">no-ip</a></li>
<li><a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">开源的frp</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>内网穿透</tag>
      </tags>
  </entry>
  <entry>
    <title>mac10.13 pods 命令错误</title>
    <url>/post/macos-high-sierra-cocoapods/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>每逢升级大版本总要过搞点事情。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ pod env</span><br><span class="line">-bash: /usr/<span class="built_in">local</span>/bin/pod: /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby: bad interpreter: No such file or directory</span><br></pre></td></tr></table></figure>

<p>不论是<code>pod env</code>、<code>pod update</code> 等等均报上面的错误。</p>
<p>如果Google发现：</p>
<ul>
<li><a href="https://stackoverflow.com/questions/44396215/cocoapods-not-working-in-macos-high-sierra" target="_blank" rel="noopener">ruby - CocoaPods not working in macOS High Sierra - Stack Overflow</a></li>
<li><a href="https://github.com/CocoaPods/CocoaPods/issues/6778" target="_blank" rel="noopener">CocoaPods CLI fails in High Sierra due to change of Ruby version #6778</a></li>
<li><a href="https://github.com/CocoaPods/CocoaPods/issues/6898#issuecomment-332060096" target="_blank" rel="noopener">High Sierra: bad interpreter #6898</a></li>
</ul>
<p>事情的缘由就是这样。</p>
<p><a href="https://github.com/CocoaPods/CocoaPods/issues/6898#issuecomment-332060096" target="_blank" rel="noopener">#6898</a>中道出了简单直接的解决方案：</p>
<blockquote>
<p>for all others:</p>
</blockquote>
<blockquote>
<p><code>gem install -n /usr/local/bin cocoapods</code></p>
</blockquote>
<blockquote>
<p>fixes it</p>
</blockquote>
<p><strong>综合起来</strong>解决这个问题是这样的：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ gem update --system</span><br><span class="line">$ gem uninstall cocoapods</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'gem: --bindir /usr/local/bin'</span> &gt;&gt; ~/.gemrc</span><br><span class="line">$ sudo gem install cocoapods</span><br></pre></td></tr></table></figure>

<p>愉快的使用cocoapods吧～</p>
]]></content>
      <categories>
        <category>macOS</category>
      </categories>
      <tags>
        <tag>cocoapods</tag>
      </tags>
  </entry>
  <entry>
    <title>mac10.13依旧让Xcode支持打开终端</title>
    <url>/post/mac-high-sierra-open-with-external/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>在macOS10.13以前是支持Xcode中直接打开终端的，步骤呢就是下面这样子：</p>
<p><img src="/images/mac-high-sierra-open-with-external-1.gif" alt="效果图"></p>
<ol>
<li>右击工程</li>
<li>Open With External Editor</li>
<li>终端弹出来了。。</li>
</ol>
<p>如果没有生效，就是你的电脑上装了什么可以打开<code>xx.xcodeproj</code>的应用程序，也就是在<code>Finder</code>下右击可以看到如下样式：</p>
<p><img src="/images/mac-high-sierra-open-with-external-2.jpg" alt="效果图"></p>
<p>呐～ Xcode为默认，备忘录为默认下面的第一个～～</p>
<p>对，如果这样的话，那么按照上面3步，得到的结果是：这个文件被莫名其妙的保存在了备忘录～～  </p>
<p>这不是我们要的🤷‍♂️，下面我们通过修改<code>备忘录.app</code>的配置文件来达到我们的效果。</p>
<a id="more"></a>

<h3 id="成因"><a href="#成因" class="headerlink" title="成因"></a>成因</h3><p>macSO10.13加强了备忘录，嗯的确变强了，可是并没有Xcode和终端常用。</p>
<p>备忘录增加了导入的功能，支持了一些文件的打开(只是导入而已。。)，但是并不适合我。于是改一下吧～～</p>
<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><ol>
<li>在<code>应用程序</code>中找到<code>备忘录</code></li>
<li>显示包内容</li>
<li>找到 我们要修改的plist文件： <code>Contents/Info.plist</code></li>
<li>做一下备份：复制一下。。</li>
<li>确保 &lt;4&gt; 已完成</li>
<li>直接修改<code>Info.plist</code>会提示没有权限，使用<code>sudo vim Info.plist</code>修改</li>
<li>不管你用什么方法，删除下面的这些代码<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleTypeName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>General files and folders<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleTypeRole<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>Viewer<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>LSItemContentTypes<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>public.data<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>public.directory<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><code>:wq</code></li>
<li>重启一下 （目的：重建索引）</li>
</ol>
<h3 id="至于我做了什么"><a href="#至于我做了什么" class="headerlink" title="至于我做了什么"></a>至于我做了什么</h3><p>讲道理，用Xcode的都知道吧？这个是注册的app支持的文件类型。 删除之后就可以了，就这么多😂</p>
<h3 id="注意一下"><a href="#注意一下" class="headerlink" title="注意一下"></a>注意一下</h3><p><code>操作</code>中的<code>步骤9</code>可以有脚本，但是还是老实重启一下吧，有的脚本会使部分图标失效，巨烦。。还是重启一下比较靠谱。毕竟不着急</p>
]]></content>
      <categories>
        <category>macOS</category>
      </categories>
      <tags>
        <tag>Xcode</tag>
      </tags>
  </entry>
  <entry>
    <title>sketech模块同步插件</title>
    <url>/post/sync-sketchplugin/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="Sketch-模块同步插件"><a href="#Sketch-模块同步插件" class="headerlink" title="Sketch 模块同步插件"></a>Sketch 模块同步插件</h2><p>通过该插件可以将sketch中的画板转换为data然后上传至服务器，并能通过插件将服务器的data下载至本地还原为之前的画板。</p>
<p><img src="https://github.com/madordie/sync-sketch-plugin/blob/master/Untitled.gif?raw=true" alt="预览"></p>
<a id="more"></a>

<h2 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h2><p>功能的实现都是通过<a href="https://www.sketchapp.com/" target="_blank" rel="noopener">Sketch.app</a>的API实现</p>
<p>其核心功能就俩：</p>
<ul>
<li>将画板编码</li>
<li>解码为画板</li>
</ul>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><p>由于功能并不复杂，但是sketch并没有完整的API文档，所以只能摸索着来，最后总结一下用到的API，只有下面的几个重要函数。</p>
<p>但是要找到这些API并不是随手一个Google可以得到，现将其列出，方便你能随手Google一下就得到：）</p>
<p>另外，下面几部分的代码都通过<a href="https://github.com/ccgus/CocoaScript" target="_blank" rel="noopener">CocoaScript</a>的语法，所以可以直接应用到插件中。</p>
<p>为了能更好的理解和使用相关API，我尽量详细。</p>
<h3 id="将画板编码"><a href="#将画板编码" class="headerlink" title="将画板编码"></a>将画板编码</h3><p>本节会将所有已经选中的层所对应的画板转换为json字符串。</p>
<p>ps.</p>
<ul>
<li><code>层</code>包含sketch能够呈现的所有组件，包括但不限于：文本、矩形、图片、画板。</li>
<li>如果选中的层没有画板，将会被忽略。</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> selection = context.selection,</span><br><span class="line">    artboards = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; selection.count(); i++) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 取出选中的所有画板</span></span><br><span class="line">        <span class="keyword">var</span> artboard = selection[i].parentArtboard();</span><br><span class="line">        <span class="keyword">if</span> (artboards.indexOf(artboard) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// 过滤重复的画板</span></span><br><span class="line">            artboards.push(artboard);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (artboards.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 并无选中的任何画板</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此时 artboards 数组， 即为当前选中的所有画板</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> selectionStrings = [];</span><br><span class="line">artboards.forEach(<span class="function"><span class="params">artboard</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 将画板转为JSON字符串，并保存在 selectionStrings 数组中</span></span><br><span class="line">        selectionStrings.push(MSJSONDataArchiver.archiveStringWithRootObject_error_(artboard.immutableModelObject(), nil));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将selectionStrings数组转为数组JSON字符串</span></span><br><span class="line"><span class="keyword">var</span> selectionsString = <span class="string">'['</span> + selectionStrings.join(<span class="string">','</span>) + <span class="string">']'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此时selectionsString字符串即为当前选中的所有画板的json数组字符串形式。</span></span><br></pre></td></tr></table></figure>

<h3 id="解码为画板"><a href="#解码为画板" class="headerlink" title="解码为画板"></a>解码为画板</h3><p>接上一节的<code>selectionsString</code>。</p>
<p>先将<code>selectionsString</code>转为<code>page</code>的json数据，然后解析为一个新的<code>page</code>，并居中展示。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> selectionsString = res.layers,</span><br><span class="line">    pageUUID = NSUUID.UUID().UUIDString(),</span><br><span class="line">    <span class="comment">// 用page的JSON包裹selectionsString，同时生成一个新的UUID</span></span><br><span class="line">    pageString = <span class="string">'&#123;"_class":"page","do_objectID":"'</span> + pageUUID + <span class="string">'","layers":'</span> + selectionsString + <span class="string">'&#125;'</span>,</span><br><span class="line">    data = NSString.alloc().initWithString(pageString).dataUsingEncoding_(<span class="number">4</span>),</span><br><span class="line">    <span class="comment">// 将JSON解码</span></span><br><span class="line">    unarchive = MSJSONDataUnarchiver.unarchiveObjectWithData(data),</span><br><span class="line">    <span class="comment">// 生成新的page</span></span><br><span class="line">    newPage = MSPage.alloc().initWithImmutableModelObject(unarchive),</span><br><span class="line">    <span class="comment">// 插入一个新的page</span></span><br><span class="line">    page = MSDocument.currentDocument().addBlankPage();</span><br><span class="line"><span class="comment">// 将生成的page所有的layers转移到新的page里面</span></span><br><span class="line">page.addLayers(newPage.layers());</span><br><span class="line"><span class="comment">// 为page设置哥名字</span></span><br><span class="line">page.setName(res.project);</span><br><span class="line"><span class="comment">// page剧中</span></span><br><span class="line">MSDocument.currentDocument().contentDrawView().centerLayersInCanvas();</span><br><span class="line">MSDocument.currentDocument().pageTreeLayoutDidChange();</span><br></pre></td></tr></table></figure>

<h3 id="其他代码"><a href="#其他代码" class="headerlink" title="其他代码"></a>其他代码</h3><p>关于别的后端操作啊 什么的我认为并不是核心代码。那代码谁都会写。。毕竟我写这个的时候只有2周的摸索经验😂，还是不聊这个了。</p>
<ul>
<li><code>sync-npm</code> 插件相关的目录，采用<a href="https://github.com/skpm/skpm" target="_blank" rel="noopener">skpm</a>构建</li>
<li><code>sync-server</code> 插件对应的服务端代码，采用<a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node-js</a>构建</li>
</ul>
<h2 id="目前还存在的问题"><a href="#目前还存在的问题" class="headerlink" title="目前还存在的问题"></a>目前还存在的问题</h2><ul>
<li>如果是带图片的画板，并且较多的时候，<code>selectionsString</code>会很大，传输速度有点慢。。</li>
<li>UI交互有点吃藕。。最好开发一套macOS的UI，但是我还是只菜鸡。。</li>
<li>项目的代码我只是简简单单的连学带写2周做出来的。。写的不是一般的渣，见谅。。</li>
</ul>
<h2 id="你可能需要的参考资料"><a href="#你可能需要的参考资料" class="headerlink" title="你可能需要的参考资料"></a>你可能需要的参考资料</h2><ul>
<li>Sketch的头文件：<a href="https://github.com/abynim/Sketch-Headers" target="_blank" rel="noopener">Sketch-Headers</a>，可以省去自己<a href="http://stevenygard.com/projects/class-dump/" target="_blank" rel="noopener">class-dump</a>的麻烦.</li>
<li>插件开发神器：<a href="https://github.com/skpm/skpm" target="_blank" rel="noopener">skpm</a></li>
<li>用来调试很不错：<a href="https://github.com/skpm/sketch-dev-tools" target="_blank" rel="noopener">Sketch DevTools</a></li>
<li>官方开发文档：<a href="https://developer.sketchapp.com/" target="_blank" rel="noopener">Sketch Developer</a></li>
<li>插件开发社区：<a href="https://sketchplugins.com/" target="_blank" rel="noopener">Sketch Developers</a></li>
<li>插件使用的语言：<a href="https://github.com/ccgus/CocoaScript" target="_blank" rel="noopener">CocoaScript</a>，但是并不仅限这一种哟</li>
<li>推荐搜索引擎: <a href="https://www.google.com/" target="_blank" rel="noopener">Google</a>，别问我为什么用Google不用百度，我是不会告诉你sketch插件开发本来资料就少，国内更少的。。</li>
</ul>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>老规矩：<a href="https://github.com/madordie/sync-sketch-plugin" target="_blank" rel="noopener">madordie/sync-sketch-plugin</a></p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Sketchplugin</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitment/Gitalk自动初始化</title>
    <url>/post/blog-gitment-auto-setup/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>一个ruby脚本解放你双手啪啪啪的敲键盘三分钟～</p>
<p>PS.</p>
<ul>
<li>ruby新手，轻拍。。</li>
<li>三是虚指。。</li>
</ul>
<a id="more"></a>

<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>之前看到人家的私站都是用的<a href="https://github.com/" target="_blank" rel="noopener">GitHub</a>做的评论系统。。很想要，但是人家没有用<a href="https://pages.github.com/" target="_blank" rel="noopener">pages</a>这样的玩意。。</p>
<p>今天看到<a href="http://awhisper.github.io/" target="_blank" rel="noopener">味精</a>大佬的RSS跪了，然后看到人家用的是GitHub的评论。。顿时觉得想要，23333</p>
<p>然后看了一哈 是这个：<a href="https://github.com/imsun/gitment" target="_blank" rel="noopener">gitment</a></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>这个我就不说了，作者有写中文文档，看一眼就明白了。</p>
<p>列一下我的使用<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">NexT主题</a>的配置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Gitment</span></span><br><span class="line"><span class="comment"># Introduction: https://imsun.net/posts/gitment-introduction/</span></span><br><span class="line"><span class="attr">gitment:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mint:</span> <span class="literal">true</span> <span class="comment"># RECOMMEND, A mint on Gitment, to support count, language and proxy_gateway</span></span><br><span class="line">  <span class="attr">count:</span> <span class="literal">true</span> <span class="comment"># Show comments count in post meta area</span></span><br><span class="line">  <span class="attr">lazy:</span> <span class="literal">false</span> <span class="comment"># Comments lazy loading with a button</span></span><br><span class="line">  <span class="attr">cleanly:</span> <span class="literal">false</span> <span class="comment"># Hide 'Powered by ...' on footer, and more</span></span><br><span class="line">  <span class="attr">language:</span> <span class="comment"># Force language, or auto switch by theme</span></span><br><span class="line">  <span class="attr">github_user:</span> <span class="string">xxxxxx</span> <span class="comment"># MUST HAVE, Your Github ID</span></span><br><span class="line">  <span class="attr">github_repo:</span> <span class="string">xxxxxx</span> <span class="comment"># MUST HAVE, The repo you use to store Gitment comments</span></span><br><span class="line">  <span class="attr">client_id:</span> <span class="string">xxxxxx</span> <span class="comment"># MUST HAVE, Github client id for the Gitment</span></span><br><span class="line">  <span class="attr">client_secret:</span> <span class="string">xxxxxx</span> <span class="comment"># EITHER this or proxy_gateway, Github access secret token for the Gitment</span></span><br><span class="line">  <span class="attr">proxy_gateway:</span> <span class="comment"># Address of api proxy, See: https://github.com/aimingoo/intersect</span></span><br><span class="line">  <span class="attr">redirect_protocol:</span> <span class="comment"># Protocol of redirect_uri with force_redirect_protocol when mint enabled</span></span><br></pre></td></tr></table></figure>

<h2 id="Gitment"><a href="#Gitment" class="headerlink" title="Gitment"></a>Gitment</h2><p>关于作者的<a href="https://github.com/imsun/gitment/issues/8" target="_blank" rel="noopener">初始化评论框方案讨论</a>还在讨论中。。。</p>
<p>但是我要用。。等是不可能等的了。</p>
<p>看到<a href="https://draveness.me/git-comments-initialize" target="_blank" rel="noopener">自动初始化 Gitalk 和 Gitment 评论</a>的脚本想着刚好我的也是自动发布、备份，这不是刚好嘛。。</p>
<p>但是存在多次执行就会多次创建的问题。这不是我想要的。</p>
<h3 id="第一版：支持多次执行"><a href="#第一版：支持多次执行" class="headerlink" title="第一版：支持多次执行"></a>第一版：支持多次执行</h3><p>GitHub提供较为完善的API，用我这水水的rb水平，大致可以完善如下：</p>
<figure class="highlight rb"><table><tr><td class="code"><pre><span class="line"><span class="comment"># from : https://madordie.github.io/post/blog-gitment-auto-setup</span></span><br><span class="line"><span class="comment"># 另外，token已放在.git-token文件下，防止泄漏。。</span></span><br><span class="line"></span><br><span class="line">username = <span class="string">"madordie"</span> <span class="comment"># GitHub 用户名</span></span><br><span class="line">token = <span class="string">`cat .git-token`</span>  <span class="comment"># GitHub Token</span></span><br><span class="line">repo_name = <span class="string">"madordie.github.io"</span> <span class="comment"># 存放 issues</span></span><br><span class="line">sitemap_url = <span class="string">"https://raw.githubusercontent.com/madordie/madordie.github.io/master/sitemap.xml"</span> <span class="comment"># sitemap 此处由于github.io不是立马生效，但是仓库是立马生效的，所以此处应该更换为仓库的raw</span></span><br><span class="line">kind = <span class="string">"gitment"</span> <span class="comment"># "Gitalk" or "gitment"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'open-uri'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'faraday'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'active_support'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'active_support/core_ext'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sitemap-parser'</span></span><br><span class="line"></span><br><span class="line">puts <span class="string">"正在检索URL"</span></span><br><span class="line"></span><br><span class="line">sitemap = SitemapParser.new sitemap_url</span><br><span class="line">urls = sitemap.to_a</span><br><span class="line"></span><br><span class="line">puts <span class="string">"检索到文章共<span class="subst">#&#123;urls.count&#125;</span>个"</span></span><br><span class="line"></span><br><span class="line">conn = Faraday.new(<span class="symbol">:url</span> =&gt; <span class="string">"https://api.github.com"</span>) <span class="keyword">do</span> <span class="params">|conn|</span></span><br><span class="line">  conn.basic_auth(username, token)</span><br><span class="line">  conn.headers[<span class="string">'Accept'</span>] = <span class="string">"application/vnd.github.symmetra-preview+json"</span></span><br><span class="line">  conn.adapter  Faraday.default_adapter</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">commenteds = Array.new</span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">  if [ ! -f .commenteds ]; then</span></span><br><span class="line"><span class="string">    touch .commenteds</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">File.open(<span class="string">".commenteds"</span>, <span class="string">"r"</span>) <span class="keyword">do</span> <span class="params">|file|</span></span><br><span class="line">  file.each_line <span class="keyword">do</span> <span class="params">|line|</span></span><br><span class="line">    commenteds.push line</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">urls.each_with_index <span class="keyword">do</span> <span class="params">|url, index|</span></span><br><span class="line">  url = url.gsub(<span class="regexp">/index.html$/</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> commenteds.<span class="keyword">include</span>?(<span class="string">"<span class="subst">#&#123;url&#125;</span>\n"</span>) == <span class="literal">false</span></span><br><span class="line">    url_key = Digest::MD5.hexdigest(URI.parse(url).path)</span><br><span class="line">    response = conn.get <span class="string">"/search/issues?q=label:<span class="subst">#&#123;url_key&#125;</span>+state:open+repo:<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    puts <span class="string">"正在创建: <span class="subst">#&#123;url&#125;</span>"</span></span><br><span class="line">    <span class="keyword">if</span> JSON.parse(response.body)[<span class="string">'total_count'</span>] &gt; <span class="number">0</span></span><br><span class="line">      puts <span class="string">"\t↳ 已存在"</span></span><br><span class="line">      <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">      title = open(url).read.scan(<span class="regexp">/&lt;title&gt;(.*?)&lt;\/title&gt;/</span>).first.first.force_encoding(<span class="string">'UTF-8'</span>)</span><br><span class="line"></span><br><span class="line">      response = conn.post(<span class="string">"/repos/<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>/issues"</span>) <span class="keyword">do</span> <span class="params">|req|</span></span><br><span class="line">        req.body = &#123; <span class="symbol">body:</span> url, <span class="symbol">labels:</span> [kind, url], <span class="symbol">title:</span> title &#125;.to_json</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span> JSON.parse(response.body)[<span class="string">'number'</span>] &gt; <span class="number">0</span></span><br><span class="line">        <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">        puts <span class="string">"\t↳ 已创建成功"</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        puts <span class="string">"\t↳ <span class="subst">#&#123;response.body&#125;</span>"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>脚本OK，还需要安装一些库用这个就行：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo gem install faraday activesupport sitemap-parser</span><br></pre></td></tr></table></figure>

<p>正常情况都会安装成功，那么跑一下脚本吧：</p>
<figure class="highlight rb"><table><tr><td class="code"><pre><span class="line">ruby comment.rb</span><br></pre></td></tr></table></figure>

<p>第一次运行请求多，稍微等一会。表急。。</p>
<p>跑完之后如果你的链接总长度都是 <code>&lt;= 50</code> 字符，那么真嗨，这就行了。</p>
<p>但是如果以后有可能 <code>&gt; 50</code>，或者不确定以后会不会写一个链接贼长的文章，那么你可能还要往下再看一下。。</p>
<h3 id="第二版：兼容文章链接很长长长"><a href="#第二版：兼容文章链接很长长长" class="headerlink" title="第二版：兼容文章链接很长长长"></a>第二版：兼容文章链接很长长长</h3><p>关于这个的讨论很多，在issues中搜一下大约这样：<a href="https://github.com/imsun/gitment/issues?utf8=%E2%9C%93&q=is%253Aissue+validation+Failed" target="_blank" rel="noopener">Error: Validation Failed</a>。</p>
<p>这个<code>Error: Validation Failed</code>就是label太长。</p>
<p>关于这个问题在<a href="https://developer.github.com/v3/issues/labels/#create-a-label" target="_blank" rel="noopener">API: Create a label</a>并未提及。</p>
<p>但是在任何一个仓库下，按照<code>Issues -&gt; New label</code>的时候，输入的<code>Label name</code>是有限制的，输入超过<code>50</code>个自符之后便无法再接收输入。就酱，没找到什么文档。。</p>
<p>看了这个<a href="https://github.com/imsun/gitment/issues/116" target="_blank" rel="noopener">Validation Failed ID长度问题建议</a>之后觉得，MD5一下吧那就。。</p>
<p>为了选择一个KEY去MD5，顺便解决一下<a href="https://github.com/imsun/gitment/issues/168" target="_blank" rel="noopener">同一个页面，带锚点#more会初始化一条新的issue</a>这个问题，</p>
<p>所以KEY使用<a href="https://github.com/imsun/gitment/issues/68" target="_blank" rel="noopener">关于hexo博客单篇文章初始化两次的问题</a>中提出的<code>window.location.pathname</code>吧，但是关于<code>/</code>的讨论，我这里貌似并没有看到，我的都是有的😂。。如果看到的话再更，或者保险期间，先按照这种方案更新一下。</p>
<p>将上面的做完，现在的rb应该长这个样子:</p>
<figure class="highlight rb"><table><tr><td class="code"><pre><span class="line"><span class="comment"># from : https://madordie.github.io/post/blog-gitment-auto-setup</span></span><br><span class="line"><span class="comment"># 另外，token已放在.git-token文件下,并被.gitignore标记，防止泄漏。。</span></span><br><span class="line"></span><br><span class="line">username = <span class="string">"madordie"</span> <span class="comment"># GitHub 用户名</span></span><br><span class="line">token = <span class="string">`cat .git-token`</span>  <span class="comment"># GitHub Token</span></span><br><span class="line">repo_name = <span class="string">"madordie.github.io"</span> <span class="comment"># 存放 issues</span></span><br><span class="line">sitemap_url = <span class="string">"https://madordie.github.io/sitemap.xml"</span> <span class="comment"># sitemap</span></span><br><span class="line">kind = <span class="string">"gitment"</span> <span class="comment"># "Gitalk" or "gitment"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'open-uri'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'faraday'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'active_support'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'active_support/core_ext'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sitemap-parser'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'digest'</span></span><br><span class="line"></span><br><span class="line">puts <span class="string">"正在检索URL"</span></span><br><span class="line"></span><br><span class="line">sitemap = SitemapParser.new sitemap_url</span><br><span class="line">urls = sitemap.to_a</span><br><span class="line"></span><br><span class="line">puts <span class="string">"检索到文章共<span class="subst">#&#123;urls.count&#125;</span>个"</span></span><br><span class="line"></span><br><span class="line">conn = Faraday.new(<span class="symbol">:url</span> =&gt; <span class="string">"https://api.github.com"</span>) <span class="keyword">do</span> <span class="params">|conn|</span></span><br><span class="line">  conn.basic_auth(username, token)</span><br><span class="line">  conn.headers[<span class="string">'Accept'</span>] = <span class="string">"application/vnd.github.symmetra-preview+json"</span></span><br><span class="line">  conn.adapter  Faraday.default_adapter</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">commenteds = Array.new</span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">  if [ ! -f .commenteds ]; then</span></span><br><span class="line"><span class="string">    touch .commenteds</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">File.open(<span class="string">".commenteds"</span>, <span class="string">"r"</span>) <span class="keyword">do</span> <span class="params">|file|</span></span><br><span class="line">  file.each_line <span class="keyword">do</span> <span class="params">|line|</span></span><br><span class="line">      commenteds.push line</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">urls.each_with_index <span class="keyword">do</span> <span class="params">|url, index|</span></span><br><span class="line">  url.gsub!(<span class="regexp">/index.html$/</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> commenteds.<span class="keyword">include</span>?(<span class="string">"<span class="subst">#&#123;url&#125;</span>\n"</span>) == <span class="literal">false</span></span><br><span class="line">    url_key = Digest::MD5.hexdigest(URI.parse(url).path)</span><br><span class="line">    response = conn.get <span class="string">"/search/issues?q=label:<span class="subst">#&#123;url_key&#125;</span>+state:open+repo:<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> JSON.parse(response.body)[<span class="string">'total_count'</span>] &gt; <span class="number">0</span></span><br><span class="line">      <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      puts <span class="string">"正在创建: <span class="subst">#&#123;url&#125;</span>"</span></span><br><span class="line">      title = open(url).read.scan(<span class="regexp">/&lt;title&gt;(.*?)&lt;\/title&gt;/</span>).first.first.force_encoding(<span class="string">'UTF-8'</span>)</span><br><span class="line">      response = conn.post(<span class="string">"/repos/<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>/issues"</span>) <span class="keyword">do</span> <span class="params">|req|</span></span><br><span class="line">        req.body = &#123; <span class="symbol">body:</span> url, <span class="symbol">labels:</span> [kind, url_key], <span class="symbol">title:</span> title &#125;.to_json</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span> JSON.parse(response.body)[<span class="string">'number'</span>] &gt; <span class="number">0</span></span><br><span class="line">        <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">        puts <span class="string">"\t↳ 已创建成功"</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        puts <span class="string">"\t↳ <span class="subst">#&#123;response.body&#125;</span>"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>同时别忘了修改对应的网页。。我这里使用的是<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">NexT.Pisces v5.1.4</a></p>
<p>需要修改<code>/themes/next/layout/_third-party/comments/gitment.swig</code>文件，由于JS不支持MD5,所以还需要引入一个JS，于是乎大约这样：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    &#123;% if theme.gitment.mint %&#125;</span><br><span class="line">        &#123;% set CommentsClass &#x3D; &quot;Gitmint&quot; %&#125;</span><br><span class="line">        &lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;https:&#x2F;&#x2F;aimingoo.github.io&#x2F;gitmint&#x2F;style&#x2F;default.css&quot;&gt;</span><br><span class="line">        &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;aimingoo.github.io&#x2F;gitmint&#x2F;dist&#x2F;gitmint.browser.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">+       &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;blueimp-md5&#x2F;2.10.0&#x2F;js&#x2F;md5.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">        &#123;% set CommentsClass &#x3D; &quot;Gitment&quot; %&#125;</span><br><span class="line">        &lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;https:&#x2F;&#x2F;imsun.github.io&#x2F;gitment&#x2F;style&#x2F;default.css&quot;&gt;</span><br><span class="line">        &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;imsun.github.io&#x2F;gitment&#x2F;dist&#x2F;gitment.browser.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">+       &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;blueimp-md5&#x2F;2.10.0&#x2F;js&#x2F;md5.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">...</span><br><span class="line">        var gitment &#x3D; new &#123;&#123;CommentsClass&#125;&#125;(&#123;</span><br><span class="line">-           id: document.location.href,</span><br><span class="line">+           id: md5(window.location.pathname.replace(&#x2F;index.html&#x2F;, &quot;&quot;)),</span><br><span class="line">            owner: &#39;&#123;&#123; theme.gitment.github_user &#125;&#125;&#39;,</span><br><span class="line">            repo: &#39;&#123;&#123; theme.gitment.github_repo &#125;&#125;&#39;,</span><br></pre></td></tr></table></figure>

<p>至于这个MD5的引入，我是随便搜的一个。。这个<code>if theme.gitment.mint</code>我并不知道在哪里配置的，所以俩都加上吧。</p>
<p>执行一下脚本吧，应该齐活了。</p>
<h2 id="Gitalk"><a href="#Gitalk" class="headerlink" title="Gitalk"></a>Gitalk</h2><p>好气啊, <a href="https://github.com/next-theme/hexo-theme-next" target="_blank" rel="noopener">Next主题</a>升级之后不支持Gitment了, 大概是因为上面种种问题吧, 所以,被迫来到了<a href="https://github.com/gitalk/gitalk" target="_blank" rel="noopener">Gitalk</a></p>
<p>真香警告.</p>
<p>回归本心,诉求就一个: 从<code>gitment</code>兼容至<code>gitalk</code>.</p>
<p>脚本需要配置项:</p>
<ul>
<li>.git-token = 放置token 切记注意添加<code>.gitignore</code></li>
<li>username = “madordie” # GitHub 用户名</li>
<li>token = <code>cat .git-token</code>  # GitHub Token</li>
<li>repo_name = “madordie.github.io” # 存放 issues</li>
<li>sitemap_url = “<a href="https://raw.githubusercontent.com/madordie/madordie.github.io/master/sitemap.xml&quot;" target="_blank" rel="noopener">https://raw.githubusercontent.com/madordie/madordie.github.io/master/sitemap.xml&quot;</a> # sitemap</li>
<li>kind = “Gitalk” # “Gitalk” or “gitment”</li>
</ul>
<p>然后, 脚本会识别<code>kind</code>是否已经添加, 如果没有添加会追一个<code>label</code>, 以确保能正常执行</p>
<figure class="highlight rb"><table><tr><td class="code"><pre><span class="line"><span class="comment"># from : https://madordie.github.io/post/blog-gitment-auto-setup</span></span><br><span class="line"><span class="comment"># 另外，token已放在.git-token文件下，防止泄漏。。</span></span><br><span class="line"></span><br><span class="line">username = <span class="string">"madordie"</span> <span class="comment"># GitHub 用户名</span></span><br><span class="line">token = <span class="string">`cat .git-token`</span>  <span class="comment"># GitHub Token</span></span><br><span class="line">repo_name = <span class="string">"madordie.github.io"</span> <span class="comment"># 存放 issues</span></span><br><span class="line">sitemap_url = <span class="string">"https://raw.githubusercontent.com/madordie/madordie.github.io/master/sitemap.xml"</span> <span class="comment"># sitemap</span></span><br><span class="line">kind = <span class="string">"Gitalk"</span> <span class="comment"># "Gitalk" or "gitment"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'open-uri'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'faraday'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'active_support'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'active_support/core_ext'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'sitemap-parser'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'digest'</span></span><br><span class="line"></span><br><span class="line">puts <span class="string">"正在检索URL"</span></span><br><span class="line"></span><br><span class="line">sitemap = SitemapParser.new sitemap_url</span><br><span class="line">urls = sitemap.to_a</span><br><span class="line"></span><br><span class="line">puts <span class="string">"检索到文章共<span class="subst">#&#123;urls.count&#125;</span>个"</span></span><br><span class="line"></span><br><span class="line">conn = Faraday.new(<span class="symbol">:url</span> =&gt; <span class="string">"https://api.github.com/"</span>) <span class="keyword">do</span> <span class="params">|conn|</span></span><br><span class="line">  conn.basic_auth(username, token)</span><br><span class="line">  conn.headers[<span class="string">'Accept'</span>] = <span class="string">"application/vnd.github.symmetra-preview+json"</span></span><br><span class="line">  conn.adapter  Faraday.default_adapter</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">commenteds = Array.new</span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">  if [ ! -f .commenteds ]; then</span></span><br><span class="line"><span class="string">    touch .commenteds</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">File.open(<span class="string">".commenteds"</span>, <span class="string">"r"</span>) <span class="keyword">do</span> <span class="params">|file|</span></span><br><span class="line">  file.each_line <span class="keyword">do</span> <span class="params">|line|</span></span><br><span class="line">      commenteds.push line</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">urls.each_with_index <span class="keyword">do</span> <span class="params">|url, index|</span></span><br><span class="line">  url = url.gsub(<span class="regexp">/index.html$/</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> commenteds.<span class="keyword">include</span>?(<span class="string">"<span class="subst">#&#123;url&#125;</span>\n"</span>) == <span class="literal">false</span></span><br><span class="line">    url_key = Digest::MD5.hexdigest(URI.parse(url).path)</span><br><span class="line">    response = conn.get <span class="string">"/search/issues?q=label:<span class="subst">#&#123;url_key&#125;</span>+state:open+repo:<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    puts <span class="string">"正在创建: <span class="subst">#&#123;url&#125;</span> -&gt; [<span class="subst">#&#123;url_key&#125;</span>, <span class="subst">#&#123;kind&#125;</span>]"</span></span><br><span class="line">    labels = JSON.parse(response.body)[<span class="string">"items"</span>]</span><br><span class="line">      .map &#123; <span class="params">|item|</span></span><br><span class="line">        item[<span class="string">"labels"</span>].map &#123; <span class="params">|label|</span> label[<span class="string">"name"</span>] &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      .flatten</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> labels.<span class="keyword">include</span>?(url_key)</span><br><span class="line">      <span class="keyword">if</span> labels.<span class="keyword">include</span>?(kind)</span><br><span class="line">        puts <span class="string">"\t↳ 已存在"</span></span><br><span class="line">        <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        issue_id = JSON.parse(response.body)[<span class="string">"items"</span>]</span><br><span class="line">          .map &#123; <span class="params">|item|</span> item[<span class="string">"number"</span>] &#125;</span><br><span class="line">          .first</span><br><span class="line"></span><br><span class="line">        puts <span class="string">"\t↳ 正在为评论(<span class="subst">#&#123;issue_id&#125;</span>)增加`<span class="subst">#&#123;kind&#125;</span>`标签"</span></span><br><span class="line">        response = conn.post(<span class="string">"/repos/<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>/issues/<span class="subst">#&#123;issue_id&#125;</span>/labels"</span>) <span class="keyword">do</span> <span class="params">|req|</span></span><br><span class="line">          req.body = &#123; <span class="symbol">labels:</span> [kind] &#125;.to_json</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> response.status == <span class="number">200</span></span><br><span class="line">          <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">          puts <span class="string">"\t\t↳ 已增加成功"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          puts <span class="string">"\t↳ <span class="subst">#&#123;response.body&#125;</span>"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      title = open(url).read.scan(<span class="regexp">/&lt;title&gt;(.*?)&lt;\/title&gt;/</span>).first.first.force_encoding(<span class="string">'UTF-8'</span>)</span><br><span class="line">      response = conn.post(<span class="string">"/repos/<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>/issues"</span>) <span class="keyword">do</span> <span class="params">|req|</span></span><br><span class="line">        req.body = &#123; <span class="symbol">body:</span> url, <span class="symbol">labels:</span> [kind, url_key], <span class="symbol">title:</span> title &#125;.to_json</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span> JSON.parse(response.body)[<span class="string">'number'</span>] &gt; <span class="number">0</span></span><br><span class="line">        <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">        puts <span class="string">"\t↳ 已创建成功"</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        puts <span class="string">"\t↳ <span class="subst">#&#123;response.body&#125;</span>"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><ul>
<li>文中提到的关于链接<code>/</code>飘忽不定的事情我没碰到，我是直接取的<a href="https://madordie.github.io/sitemap.xml">sitemap</a>，貌似每个文章都带了<code>/</code></li>
<li>文中的引用啥的我都标记了链接，如有漏掉、不明白，麻烦告诉我一哈，我去补一下</li>
<li>我只是个小小的iOS，对ruby、js懂得不多，rb写的不好的地方轻拍</li>
<li>哦对了，这脚本全部在这里：<a href="https://github.com/madordie/madordie.github.io/blob/master/comment.rb" target="_blank" rel="noopener">comment.rb</a>。同时，这个脚本我又放在了自动发布的shell脚本里面，同样shell写的很水。。放在了这里：<a href="https://github.com/madordie/madordie.github.io/blob/master/deploy.sh" target="_blank" rel="noopener">deploy.sh</a>，而且是很早之前就写了的。。</li>
<li>如果还有什么问题，可以拉出来讨论一哈 ;)</li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>blog</tag>
        <tag>gitment</tag>
        <tag>gitalk</tag>
      </tags>
  </entry>
  <entry>
    <title>sonarqube-note</title>
    <url>/post/sonarqube-note/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>Get Started in Two Minutes</p>
<ol>
<li>Download and unzip the SonarQube distribution (let’s say in “C:\sonarqube” or “/etc/sonarqube”)</li>
<li>Start the SonarQube server:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># On Windows, execute:</span><br><span class="line">C:\sonarqube\bin\windows-x86-xx\StartSonar.bat</span><br><span class="line"> </span><br><span class="line"># On other operating system, execute:</span><br><span class="line">&#x2F;etc&#x2F;sonarqube&#x2F;bin&#x2F;[OS]&#x2F;sonar.sh console</span><br></pre></td></tr></table></figure></li>
<li>Download and unzip the SonarQube Scanner (let’s say in “C:\sonar-scanner” or “/etc/sonar-scanner”)</li>
<li>Download and unzip some project samples (let’s say in “C:\sonar-scanning-examples” or “/etc/sonar-scanning-examples”)</li>
<li>Analyze a project:<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># On Windows:</span><br><span class="line">cd C:\sonar-scanning-examples\sonarqube-scanner</span><br><span class="line">C:\sonar-scanner\bin\sonar-scanner.bat</span><br><span class="line"> </span><br><span class="line"># On other operating system:</span><br><span class="line">cd &#x2F;etc&#x2F;sonar-scanning-examples&#x2F;sonarqube-scanner</span><br><span class="line">&#x2F;etc&#x2F;sonar-scanner&#x2F;bin&#x2F;sonar-scanner</span><br></pre></td></tr></table></figure></li>
<li>Browse the results at <a href="http://localhost:9000/" target="_blank" rel="noopener">http://localhost:9000</a> (default System administrator credentials are admin/admin)</li>
</ol>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><ul>
<li><a href="https://docs.sonarqube.org/display/HOME/SonarQube+Platform" target="_blank" rel="noopener">docs.sonarqube.org</a></li>
<li></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>构建</tag>
        <tag>Sonarqube</tag>
      </tags>
  </entry>
  <entry>
    <title>开发小记</title>
    <url>/post/note/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>开发中的小笔记。记录开发中的点滴滴点。</p>
<a id="more"></a>


<h2 id="批量替换json文件中的注释"><a href="#批量替换json文件中的注释" class="headerlink" title="批量替换json文件中的注释"></a>批量替换json文件中的注释</h2><p>备份至.bat</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ perl -i.bat -lpe <span class="string">'s/\/\/[^"]+$//g'</span> xx</span><br></pre></td></tr></table></figure>


<h2 id="批量正则替换的另一种思路"><a href="#批量正则替换的另一种思路" class="headerlink" title="批量正则替换的另一种思路"></a>批量正则替换的另一种思路</h2>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;base&#x2F;sh</span><br><span class="line">find . -name &#39;*.swift&#39; | while read file; do</span><br><span class="line">  perl -i -lpe &#39;s&#x2F;if \(([^\)].*)\) \&#123;&#x2F;if $1 \&#123;&#x2F;g&#39; $file</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="批量删除空格组成的空行中的空格"><a href="#批量删除空格组成的空行中的空格" class="headerlink" title="批量删除空格组成的空行中的空格"></a>批量删除空格组成的空行中的空格</h2>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;base&#x2F;sh</span><br><span class="line">find . -name &#39;*.swift&#39; | while read file; do</span><br><span class="line">  sed -i &#39;&#39; &#39;s&#x2F;^[[:space:]][[:space:]]*$&#x2F;&#x2F;g&#39; $file</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="获取代码执行时间"><a href="#获取代码执行时间" class="headerlink" title="获取代码执行时间"></a>获取代码执行时间</h2>  <figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">#<span class="keyword">import</span> &lt;mach/mach_time.h&gt;</span><br><span class="line"><span class="keyword">static</span> <span class="type">NSMutableDictionary</span> *__times;</span><br><span class="line"><span class="keyword">static</span> inline void debug_start_of(<span class="type">NSString</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">  __times = __times ?: [<span class="type">NSMutableDictionary</span> new];</span><br><span class="line"></span><br><span class="line">  uint64_t start = mach_absolute_time();</span><br><span class="line">  __times[key] = @(start);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> inline void debug_stop_of(<span class="type">NSString</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (__times) &#123;</span><br><span class="line">    uint64_t end = mach_absolute_time();</span><br><span class="line">    uint64_t start = [__times[key] unsignedLongLongValue];</span><br><span class="line">    <span class="keyword">if</span> (start != <span class="number">0</span>) &#123;</span><br><span class="line">      uint64_t elapsed = end - start;</span><br><span class="line">      mach_timebase_info_data_t info;</span><br><span class="line">      <span class="keyword">if</span> (mach_timebase_info(&amp;info) != <span class="type">KERN_SUCCESS</span>) &#123;</span><br><span class="line">        printf(<span class="string">"mach_timebase_info failed\n"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      uint64_t nanosecs = elapsed * info.numer / info.denom;</span><br><span class="line">      uint64_t millisecs = nanosecs / <span class="number">1000000</span>;</span><br><span class="line"></span><br><span class="line">      printf(<span class="string">"[DEBUG code rt] %s:%llu ms\n"</span>, [key cStringUsingEncoding:<span class="type">NSUTF8StringEncoding</span>], millisecs);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      printf(<span class="string">"[DEBUG code rt] %s error: no start\n"</span>, [key cStringUsingEncoding:<span class="type">NSUTF8StringEncoding</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NAN"><a href="#NAN" class="headerlink" title="NAN"></a>NAN</h2><ul>
<li><p><code>A</code>对<code>B</code>除余时，如果<code>B == 0</code> 则会造成NAN，<code>truncatingRemainder(dividingBy:)</code>是<code>swift</code>的方法，也会造成此问题</p>
</li>
<li><p>当<code>NSUInteger 0 - 1</code>时，运算结果为 NAN，iOS中有一个宏<code>isnan(x)</code>返回是否为nan。另外这里有一篇文章<a href="http://blog.csdn.net/toss156/article/details/7101885" target="_blank" rel="noopener">Objective-C 中 判断 NaN</a>大致记录了一下</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  math.h  #56</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__GNUC__)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span>    HUGE_VAL     __builtin_huge_val()</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span>    HUGE_VALF    __builtin_huge_valf()</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span>    HUGE_VALL    __builtin_huge_vall()</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span>    NAN          __builtin_nanf(<span class="meta-string">"0x7fc00000"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span>    HUGE_VAL     1e500</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span>    HUGE_VALF    1e50f</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span>    HUGE_VALL    1e5000L</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span>    NAN          __nan()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>另外，NAN不能直接判断 == 需要调用下面的宏。否则会发生莫名其妙的问题</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">  <span class="comment">//  math.h  #178</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> isnan(x)                                                         \</span></span><br><span class="line">    ( <span class="keyword">sizeof</span>(x) == <span class="keyword">sizeof</span>(<span class="keyword">float</span>)  ? __inline_isnanf((<span class="keyword">float</span>)(x))          \</span><br><span class="line">    : <span class="keyword">sizeof</span>(x) == <span class="keyword">sizeof</span>(<span class="keyword">double</span>) ? __inline_isnand((<span class="keyword">double</span>)(x))         \</span><br><span class="line">                                  : __inline_isnanl((<span class="keyword">long</span> <span class="keyword">double</span>)(x)))</span><br></pre></td></tr></table></figure>

</li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>笔记</tag>
      </tags>
  </entry>
  <entry>
    <title>优雅的使用SwiftLint</title>
    <url>/post/elegant-to-use-swiftlint/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>接入了SwiftLine，修改2000+的warning、300+error的一点笔记心得。</p>
<a id="more"></a>

<h1 id="SwiftLint"><a href="#SwiftLint" class="headerlink" title="SwiftLint"></a>SwiftLint</h1><blockquote>
<h2 id="SwiftLint-1"><a href="#SwiftLint-1" class="headerlink" title="SwiftLint"></a><a href="https://github.com/realm/SwiftLint" target="_blank" rel="noopener">SwiftLint</a></h2><p>A tool to enforce Swift style and conventions, loosely based on GitHub’s Swift Style Guide.<br>  SwiftLint hooks into Clang and SourceKit to use the AST representation of your source files for more accurate results.<br>  SwiftLint 是一个用于强制检查 Swift 代码风格和规定的一个工具，基本上以 GitHub’s Swift 代码风格指南为基础。<br>  SwiftLint Hook 了 Clang 和 SourceKit 从而能够使用 AST 来表示源代码文件的更多精确结果。</p>
</blockquote>
<h2 id="对原有代码格式化"><a href="#对原有代码格式化" class="headerlink" title="对原有代码格式化"></a>对原有代码格式化</h2><h3 id="自动格式化"><a href="#自动格式化" class="headerlink" title="自动格式化"></a>自动格式化</h3>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">swiftlint autocorrect</span><br></pre></td></tr></table></figure>

<h3 id="TrailingWhitespaceRule"><a href="#TrailingWhitespaceRule" class="headerlink" title="TrailingWhitespaceRule"></a>TrailingWhitespaceRule</h3><h4 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h4><blockquote>
<p>xxx.swift:34: warning: Trailing Whitespace Violation: Lines should not have trailing whitespace. (trailing_whitespace)</p>
</blockquote>
<p>  规则实现：<a href="https://github.com/realm/SwiftLint/blob/master/Source/SwiftLintFramework/Rules/TrailingWhitespaceRule.swift" target="_blank" rel="noopener">TrailingWhitespaceRule.swift</a></p>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><p>  Xcode中的”空白行”。其实并不空白，含有空的字符。最明显的表现为git提交的时候会有明显的黄色警告。</p>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><p>  Xcode中有选项可以直接控制，具体路径为<br>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Xcode </span><br><span class="line">-&gt; Preferences</span><br><span class="line">-&gt; Text Editing</span><br><span class="line">-&gt; While editing</span><br><span class="line">-&gt; [V] Including whitespace-only lines</span><br></pre></td></tr></table></figure></p>
<h3 id="ColonRule"><a href="#ColonRule" class="headerlink" title="ColonRule"></a>ColonRule</h3><h4 id="现象-1"><a href="#现象-1" class="headerlink" title="现象"></a>现象</h4><blockquote>
<p>xxx.swift:13:71: warning: Colon Violation: Colons should be next to the identifier when specifying a type. (colon)</p>
</blockquote>
<h4 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h4><p>  变量方法的 <code>: </code> 的右边应该有一个空格才能识别出来，且左侧不能留空格。所以写代码的时候随手写上还是比较好的。。<br>  栗子：<br>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;  OK:</span><br><span class="line">var responseData: [String : Any]? &#x3D; nil &#x2F;&#x2F; 返回结果，请求之前为nil</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  warning: 第一个&#39;:&#39;处左侧有空格</span><br><span class="line">var responseData : [String : Any]? &#x3D; nil &#x2F;&#x2F; 返回结果，请求之前为nil</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  warning: 第一个&#39;:&#39;处右侧无空格</span><br><span class="line">var responseData:[String : Any]? &#x3D; nil &#x2F;&#x2F; 返回结果，请求之前为nil</span><br></pre></td></tr></table></figure></p>
<h4 id="解决办法-1"><a href="#解决办法-1" class="headerlink" title="解决办法"></a>解决办法</h4><p>  规范书写</p>
<h3 id="LineLengthRule"><a href="#LineLengthRule" class="headerlink" title="LineLengthRule"></a>LineLengthRule</h3><h4 id="现象-2"><a href="#现象-2" class="headerlink" title="现象"></a>现象</h4><blockquote>
<p>xxx.swift:90: warning: Line Length Violation: Line should be 100 characters or less: currently 101 characters (line_length)</p>
</blockquote>
<h4 id="原因-2"><a href="#原因-2" class="headerlink" title="原因"></a>原因</h4><p>  行数超了呗。。</p>
<h4 id="解决办法-2"><a href="#解决办法-2" class="headerlink" title="解决办法"></a>解决办法</h4><ul>
<li>方法名字写的简单易懂</li>
</ul>
<h3 id="ControlStatementRule"><a href="#ControlStatementRule" class="headerlink" title="ControlStatementRule"></a>ControlStatementRule</h3><h4 id="现象-3"><a href="#现象-3" class="headerlink" title="现象"></a>现象</h4><blockquote>
<p>xxx.swift:169:21: warning: Control Statement Violation: if,for,while,do statements shouldn’t wrap their conditionals in parentheses. (control_statement)</p>
</blockquote>
<p>  规则实现<a href="https://github.com/realm/SwiftLint/blob/master/Source/SwiftLintFramework/Rules/ControlStatementRule.swift" target="_blank" rel="noopener">ControlStatementRule</a></p>
<h4 id="原因-3"><a href="#原因-3" class="headerlink" title="原因"></a>原因</h4><p>  swift中<code>if,for,while,do</code> 语句不应该用<code>()</code></p>
<h3 id="UnusedClosureParameterRule"><a href="#UnusedClosureParameterRule" class="headerlink" title="UnusedClosureParameterRule"></a>UnusedClosureParameterRule</h3><h4 id="现象-4"><a href="#现象-4" class="headerlink" title="现象"></a>现象</h4><blockquote>
<p>xxx.swift:103:62: warning: Unused Closure Parameter Violation: Unused parameter “response” in a closure should be replaced with _. (unused_closure_parameter)</p>
</blockquote>
<p>  规则实现<a href="https://github.com/realm/SwiftLint/blob/master/Source/SwiftLintFramework/Rules/UnusedClosureParameterRule.swift" target="_blank" rel="noopener">UnusedClosureParameterRule</a></p>
<h4 id="原因-4"><a href="#原因-4" class="headerlink" title="原因"></a>原因</h4><p>  <code>response</code> 没有使用，建议替换为 <code>_</code>。</p>
<h3 id="CyclomaticComplexityRule"><a href="#CyclomaticComplexityRule" class="headerlink" title="CyclomaticComplexityRule"></a>CyclomaticComplexityRule</h3><h4 id="现象-5"><a href="#现象-5" class="headerlink" title="现象"></a>现象</h4><blockquote>
<p>xxx.swift:69:5: warning: Cyclomatic Complexity Violation: Function should have complexity 10 or less: currently complexity equals 14 (cyclomatic_complexity)</p>
</blockquote>
<p>  规则实现<a href="https://github.com/realm/SwiftLint/blob/master/Source/SwiftLintFramework/Rules/CyclomaticComplexityRule.swift" target="_blank" rel="noopener">CyclomaticComplexityRule</a></p>
<h4 id="原因-5"><a href="#原因-5" class="headerlink" title="原因"></a>原因</h4><p>  😂，他说你这函数写的太复杂了。看实现是说不能有过多的<code>if {}</code></p>
<h3 id="OpeningBraceRule"><a href="#OpeningBraceRule" class="headerlink" title="OpeningBraceRule"></a>OpeningBraceRule</h3><h4 id="现象-6"><a href="#现象-6" class="headerlink" title="现象"></a>现象</h4><blockquote>
<p>xxx.swift:221:34: warning: Opening Brace Spacing Violation: Opening braces should be preceded by a single space and on the same line as the declaration. (opening_brace)</p>
</blockquote>
<p>  规则实现<a href="https://github.com/realm/SwiftLint/blob/master/Source/SwiftLintFramework/Rules/OpeningBraceRule.swift" target="_blank" rel="noopener">OpeningBraceRule</a></p>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>  <code>{}</code>的前面要有空格隔开</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>构建</tag>
        <tag>SwiftLint</tag>
      </tags>
  </entry>
  <entry>
    <title>正则表达式学习笔记</title>
    <url>/post/bruch-up-regular-expressions/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>正则表达式基础学习笔记。</p>
<a id="more"></a>

<h1 id="前面"><a href="#前面" class="headerlink" title="前面"></a>前面</h1><p>  上次找了个很好的文章，可是手残没保存。。找不到了😭，现在重新找了一个文章：<a href="https://luke0922.gitbooks.io/learnregularexpressionin30minutes/content/index.html" target="_blank" rel="noopener">正则表达式30分钟入门教程</a><br>  正如作者说的：</p>
<blockquote>
<h1 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h1><p>本文非原创，是改编自<a href="http://deerchao.net/tutorials/regex/regex.htm#mission" target="_blank" rel="noopener">《正则表达式30分钟入门教程》</a>，因为原作者的排版个人不是很喜欢，而且内容上个人觉得有些地方需要改进，所以在 gitbook 上开了一本书。</p>
</blockquote>
<p>  OSC的<a href="http://tool.oschina.net/regex" target="_blank" rel="noopener">在线正则表达式测试</a></p>
<h1 id="开搞"><a href="#开搞" class="headerlink" title="开搞"></a>开搞</h1><h2 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h2><ul>
<li><code>\</code> : 转义</li>
<li><code>\b</code> : 单词开始或结束</li>
<li><code>^</code> : 字符串开始</li>
<li><code>$</code> : 字符串结束</li>
<li><code>\d</code> : 一个数字</li>
<li><code>\s</code> : 任意空白字符：空格、制表符、换行符、中文全角空格、等</li>
<li><code>\w</code> : 字母/数字/下划线/汉字 可见字符</li>
<li><code>.</code> : 除换行符以外的任意字符</li>
</ul>
<h2 id="重复"><a href="#重复" class="headerlink" title="重复"></a>重复</h2><ul>
<li><code>{n}</code> : 前置位重复匹配 [n] 次</li>
<li><code>{n,m}</code> : 前置位重复匹配 [n-m] 次</li>
<li><code>{n,}</code> : 前置位重复匹配 [n-∞] 次</li>
<li><code>*</code> : 数量区间：[0-N]</li>
<li><code>+</code> : 数量区间：[1-N]</li>
<li><code>?</code> : 数量区间：[0-1]</li>
</ul>
<h2 id="字符类"><a href="#字符类" class="headerlink" title="字符类"></a>字符类</h2><ul>
<li><code>[nml]</code> : 可以匹配到 n/m/l</li>
</ul>
<h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><ul>
<li><code>|</code> : __或__语句。存在逻辑短路</li>
<li><code>(m)</code> : __分组__语句。子式，可以指定重复什么的</li>
</ul>
<h2 id="反义"><a href="#反义" class="headerlink" title="反义"></a>反义</h2><ul>
<li><code>\W</code> : 任意__不是__（字符、数字、下划线、汉字）</li>
<li><code>\S</code> : 任意<strong>不是</strong> 空白符</li>
<li><code>\D</code> : 任意<strong>不是</strong> 数字</li>
<li><code>\B</code> : 任意<strong>不是</strong> 单词开头或结尾</li>
<li><code>\^x</code> : 除x以外的任意字符</li>
<li><code>[\^abc]</code> : 除abc这几个字母以外的任意字符</li>
</ul>
<h2 id="后向引用"><a href="#后向引用" class="headerlink" title="后向引用"></a>后向引用</h2><p>  <code>(\w+)</code>这样用<code>()</code>的部分称为一个分组，其匹配到的内容可以使用<code>\n</code>来表示，<code>n</code>代表该分组为第n个分组。分组下标从<code>1</code>开始。<br>  也可以自定义子表达式组名: <code>(?&lt;Word&gt;M) \k&lt;Word&gt;</code> : 或 <code>(?&#39;Word&#39;M) \k&#39;Word&#39;</code>，其中M为子式。</p>
<h2 id="常用分组语法"><a href="#常用分组语法" class="headerlink" title="常用分组语法"></a>常用分组语法</h2><h3 id="捕获"><a href="#捕获" class="headerlink" title="捕获"></a>捕获</h3><ul>
<li><code>(exp)</code> : 匹配exp,并捕获文本到自动命名的组里</li>
<li><code>(?exp)</code> : 匹配exp,并捕获文本到名称为name的组里，也可以写成(?’name’exp)</li>
<li><code>(?:exp)</code> : 匹配exp,不捕获匹配的文本，也不给此分组分配组号</li>
</ul>
<h3 id="零宽断言"><a href="#零宽断言" class="headerlink" title="零宽断言"></a>零宽断言</h3><ul>
<li><code>(?=exp)</code> : 匹配exp前面的位置</li>
<li><code>(?&lt;=exp)</code> : 匹配exp后面的位置</li>
<li><code>(?!exp)</code> : 匹配后面跟的不是exp的位置</li>
<li><code>(?&lt;!exp)</code> : 匹配前面不是exp的位置</li>
</ul>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><ul>
<li><code>(?#comment)</code> : 这种类型的分组不对正则表达式的处理产生任何影响，用于提供注释让人阅读</li>
</ul>
<h2 id="贪婪与懒惰"><a href="#贪婪与懒惰" class="headerlink" title="贪婪与懒惰"></a>贪婪与懒惰</h2><p>  贪婪：匹配的尽可能长<br>  懒惰：匹配的尽可能短</p>
<ul>
<li><code>*?</code> : 重复任意次，但尽可能少重复</li>
<li><code>+?</code> : 重复1次或更多次，但尽可能少重复</li>
<li><code>??</code> : 重复0次或1次，但尽可能少重复</li>
<li><code>{n,m}?</code> : 重复n到m次，但尽可能少重复</li>
<li><code>{n,}?</code> : 重复n次以上，但尽可能少重复</li>
</ul>
<h2 id="平衡组-递归匹配"><a href="#平衡组-递归匹配" class="headerlink" title="平衡组/递归匹配"></a>平衡组/递归匹配</h2><p>  # 我开始看不懂了😂</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li><code>\a</code> : 报警字符(打印它的效果是电脑嘀一声)</li>
<li><code>\b</code> : 通常是单词分界位置，但如果在字符类里使用代表退格</li>
<li><code>\t</code> : 制表符，Tab</li>
<li><code>\r</code> : 回车</li>
<li><code>\v</code> : 竖向制表符</li>
<li><code>\f</code> : 换页符</li>
<li><code>\n</code> : 换行符</li>
<li><code>\e</code> : Escape</li>
<li><code>\0nn</code> : ASCII代码中八进制代码为nn的字符</li>
<li><code>\xnn</code> : ASCII代码中十六进制代码为nn的字符</li>
<li><code>\unnnn</code> : Unicode代码中十六进制代码为nnnn的字符</li>
<li><code>\cN</code> : ASCII控制字符。比如\cC代表Ctrl+C</li>
<li><code>\A</code> : 字符串开头(类似^，但不受处理多行选项的影响)</li>
<li><code>\Z</code> : 字符串结尾或行尾(不受处理多行选项的影响)</li>
<li><code>\z</code> : 字符串结尾(类似$，但不受处理多行选项的影响)</li>
<li><code>\G</code> : 当前搜索的开头</li>
<li><code>\p{name}</code> : Unicode中命名为name的字符类，例如\p{IsGreek}</li>
<li><code>(?&gt;exp)</code> : 贪婪子表达式</li>
<li><code>(?&lt;x&gt;-&lt;y&gt;exp)</code> : 平衡组</li>
<li><code>(?im-nsx:exp)</code> : 在子表达式exp中改变处理选项</li>
<li><code>(?im-nsx)</code> : 为表达式后面的部分改变处理选项</li>
<li><code>(?(exp)yes|no)</code> : 把exp当作零宽正向先行断言，如果在这个位置能匹配，使用yes作为此组的表达式；否则使用no</li>
<li><code>(?(exp)yes)</code> : 同上，只是使用空表达式作为no</li>
<li><code>(?(name)yes|no)</code> : 如果命名为name的组捕获到了内容，使用yes作为表达式；否则使用no</li>
<li><code>(?(name)yes)</code> : 同上，只是使用空表达式作为no</li>
</ul>
<h2 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h2><ul>
<li>5-12位QQ：<code>^\d{5,12}$</code></li>
<li>IPv4地址：<code>((2[0-4]\d|25[0-5]|[01]?\d\d?)\.){3}(2[0-4]\d|25[0-5]|[01]?\d\d?)</code></li>
<li><code>go go</code>、<code>kitty kitty</code>这样的叠词：<code>\b(\w+)\b\s+\1\b</code></li>
<li>后向引用：<code>\b(\w+)\b\s+\1\b</code> == <code>\b(?&lt;Word&gt;\w+)\b\s+\k&lt;Word&gt;\b</code> == <code>\b(?&#39;Word&#39;\w+)\b\s+\k&#39;Word&#39;\b</code></li>
</ul>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>  知识研究了一下语法，还未详细测试。思考：这玩意真心厉害😂。</p>
<hr>
<p><a href="../reprinted-regular-mind-map">思维导图</a></p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>科学上网之搬瓦工ss搭建笔记</title>
    <url>/post/bandwagonhost-note/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>原来吧，用用goagent、Lantern、XX-Net，确实，这玩意只能Google出来结果，但是有的站点打不开才是最骚的。。<br>同事搞了个搬瓦工挺便宜，于是乎就也搞了一个。不过强迫症犯了，尝试了各种SS版本以及各种优化，目的是找个流畅点的版本进行__科学上网__。</p>
<a id="more"></a>

<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><ul>
<li><p>红线越不得！红线越不得！红线越不得！重要的事情说3遍。</p>
</li>
<li><p>参看第一条</p>
</li>
<li><p>参看第一条</p>
</li>
<li><p>参看第一条</p>
<p>2017 07 18 say goog bay !</p>
</li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>ss</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义数据填充Sketch插件</title>
    <url>/post/format-sketchplugin/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="先来个README-md"><a href="#先来个README-md" class="headerlink" title="先来个README.md"></a>先来个README.md</h2><blockquote>
<h2 id="format-sketchplugin"><a href="#format-sketchplugin" class="headerlink" title="format-sketchplugin"></a><a href="https://github.com/madordie/format-sketchplugin" target="_blank" rel="noopener">format-sketchplugin</a></h2></blockquote>
<blockquote>
<p>为Sketch自动生成自定义填充数据源插件。</p>
</blockquote>
<blockquote>
<p><img src="https://github.com/madordie/format-sketchplugin/blob/master/Images/Untitled.gif?raw=true" alt="预览"></p>
</blockquote>
<blockquote>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2></blockquote>
<blockquote>
<ul>
<li>下载<a href="https://github.com/madordie/format-sketchplugin/releases" target="_blank" rel="noopener">Release</a>上的包，并双击打开</li>
</ul>
</blockquote>
<ul>
<li>选择要随机填充的文本数据(支持多选，文本数据按照回车进行随机，会默认删除空数据)</li>
<li>选择随机填充的图片文件夹(只支持单选文件夹，选中文件夹内的<code>.png</code>、 <code>.PNG</code>、 <code>.jpg</code>、 <code>.JPG</code>、 <code>.jpeg</code>、 <code>.JPEG</code>、 <code>.gif</code>、 <code>.GIF</code>文件将会被识别并作为数据源)</li>
<li>将插件生成目录拖拽至窗口即完成设置</li>
<li>文本、图片文件夹 可在保存前重复多次选择</li>
<li>点击<code>制作</code>，即可在生成目录看到插件生成</li>
</ul>
<blockquote>
<h2 id="生成说明"><a href="#生成说明" class="headerlink" title="生成说明"></a>生成说明</h2></blockquote>
<blockquote>
<ul>
<li>文本数据按照文本文件名作为标示</li>
</ul>
</blockquote>
<ul>
<li>图片文件夹按照图片文件夹名作为标示</li>
<li>保存时，文本数据会读取至插件内</li>
<li>保存时，图片文件夹会复制至插件内(不识别子目录，并只拷贝可识别的素材)</li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Sketchplugin</tag>
      </tags>
  </entry>
  <entry>
    <title>关于转载的文章</title>
    <url>/post/about-reprint-article/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>一点删除原链接的转载文章的牢骚</p>
<a id="more"></a>

<h1 id="缘由"><a href="#缘由" class="headerlink" title="缘由"></a>缘由</h1><p>前两天看到朋友圈一个哥们转载了许多关于iOS的一些文章，很是兴奋，去围观。突然发现这文笔绝对是经过校对的。心中大喜，以为淘到宝了（因为文章并没有署名转载出处，所以应该是原创）。之后看了一下他的另一个文章，刚好我百度过这个文章的原作者的最后一个系列的，于是我又翻阅了一下看看是不是不一样，结果和我想的一样，除了删除了作者的署名之外其他的都是一样的。于是关掉了网页，心中默默的鄙视。</p>
<h1 id="关于转载的别人文章"><a href="#关于转载的别人文章" class="headerlink" title="关于转载的别人文章"></a>关于转载的别人文章</h1><p>对于一些大神的技术文章都是喜欢的，爱不释手的那种，我也是。有的能转载的我就转载，不能转载的，我会复制下来，放在我自己的文件夹中，为的是方便查询。在转载的时候我会特意标示转载的地址。而且一般情况下我会在文章的开始写上几句简单的主要的思想（比如：<a href="http://www.cnblogs.com/madordie/p/5159597.html" target="_blank" rel="noopener">《[转]蓝牙开发》</a>、<a href="http://www.cnblogs.com/madordie/p/4322044.html" target="_blank" rel="noopener">《[搬运] mac下安装GDB》</a>、<a href="http://www.cnblogs.com/madordie/p/4322042.html" target="_blank" rel="noopener">《［搬运］MAC 下安装 brew》</a>），当然有时候没来得及的就忘了😂（比如：<a href="http://www.cnblogs.com/madordie/p/4357685.html" target="_blank" rel="noopener">《[搬运] iOS 7 侧滑返回手势使用和错误集》</a>）。</p>
<p>还有关于文章的排版，殊不知原作者为了让读者更好的阅读会对排版做的比较好，有的人为了阅读方便会去阅读原作者的文章。比如说我这种强迫症。</p>
<h1 id="我对删除原链的转载文章态度"><a href="#我对删除原链的转载文章态度" class="headerlink" title="我对删除原链的转载文章态度"></a>我对删除原链的转载文章态度</h1><p>然后说一下我对于那些抄袭的，然后删除了原链接的人鄙视一下。每一篇文章都是别人花费了大量的精力去完成的，有的为了让读者能够更清楚的理解，所以会在发布的时候找别人去读一读，看能不能理解其中云云。然而对文章的原链接保存是一种对别人劳动成果的尊重，对原作者最基本的尊重。</p>
<p>别的不想多说了。转载请注明出处。谢谢！<br>且行且珍惜。</p>
]]></content>
      <categories>
        <category>牢骚</category>
      </categories>
  </entry>
  <entry>
    <title>iOS自动化-Jenkins环境搭建</title>
    <url>/post/ios-automation-jenkins-configuration/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><ul>
<li><a href="../ios-automation-jenkins-configuration">iOS自动化-Jenkins环境搭建</a></li>
<li><a href="../ios-automation-jenkins-build">iOS自动化-Jenkins编译工程</a></li>
</ul>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p> <strong>Jenkins</strong><br><em>Build great things at any scale</em><br>The leading open source automation server, Jenkins provides hundreds of plugins to support building, deploying and automating any project.</p>
</blockquote>
<p>如<a href="https://jenkins.io/" target="_blank" rel="noopener">官网</a>所说<code>Build great things at any scale</code></p>
<p>从这篇文章中你将会实现：</p>
<ul>
<li>在Mac上多种方案安装并启动jenkins</li>
<li>在局域网中正常访问jenkins</li>
</ul>
<a id="more"></a>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>当然你首先需要一个macOS的系统，为后来的构建做基础。</p>
<p>Jenkins中可以使用<code>pkg</code>、<code>war</code>的方式运行，当然还有在<a href="https://jenkins.io/doc/book/getting-started/installing/" target="_blank" rel="noopener">Installing Jenkins</a>中提供一些安装方式：</p>
<blockquote>
<p> <strong>macOS</strong><br>To install from the website, using a package:</p>
</blockquote>
<blockquote>
<ul>
<li>Download the latest package</li>
<li>Open the package and follow the instructions</li>
</ul>
</blockquote>
<blockquote>
<p>Jenkins can also be installed using brew:</p>
</blockquote>
<blockquote>
<ul>
<li>Install the latest release version<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">brew install jenkins </span><br></pre></td></tr></table></figure></li>
<li>Install the LTS version<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">brew install jenkins-lts </span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p>这里使用<code>brew</code>，因为<strong>很方便</strong>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ brew update &amp;&amp; brew install jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新</span></span><br><span class="line">$ brew update &amp; brew upgrade jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台运行 还支持`stop`、`restart`等 (这种方式还是有差别的，下面会说明)</span></span><br><span class="line">$ brew services start jenkins</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>建议先来看一波<code>--help</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ jenkins --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><p>直接运行<code>jenkins</code>命令，可以看到日志输出，但是不能退出命令。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ jenkins</span><br></pre></td></tr></table></figure>

<p>经过漫长的初始化，会将</p>
<ul>
<li><code>~/.jenkins</code>目录作为<code>JENKINS_HOME</code></li>
<li><code>localhost:8080</code>作为默认URL</li>
</ul>
<p>终端输出<code>Started initialization</code>一行之后就可以正常打开了。</p>
<p>在浏览器打开<a href="http://10.12.12.10:8080/" target="_blank" rel="noopener">http://10.12.12.10:8080</a>就可以正常加载啦～</p>
<p>退出运行：<code>control + C</code> 组合键。</p>
<h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><p>直接<code>open</code>，看不到日志输出，所对应的运行环境和方案一相同。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ open /usr/<span class="built_in">local</span>/opt/jenkins/libexec/jenkins.war</span><br></pre></td></tr></table></figure>

<p>命令结束，稍等片刻(初始化相关目录、环境)，在浏览器打开<a href="http://10.12.12.10:8080/" target="_blank" rel="noopener">http://10.12.12.10:8080</a>就可以正常加载啦～</p>
<h3 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a>方案三</h3><p>使用<code>brew</code>直接挂在后台作为服务运行起来</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ sudo brew services start jenkins</span><br></pre></td></tr></table></figure>

<p><code>brew</code>还提供其他的参数，比如说<code>restart</code>、<code>list</code>、<code>stop</code> 等等。</p>
<p>此方案和上面的运行环境是不一样的，会有些权限的差别。</p>
<h3 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h3><p>使用<code>launchctl</code>、<code>nohup</code> 等其他方案进行的后台运行，同方案三差不多。</p>
<p>需要说的是<code>launchctl</code>是macOS下系统提供的后台运行方案，<code>brew</code>等，均来自于此。</p>
<p>在<code>launchctl</code>后台中需要一个<code>plist</code>，但是<code>brew</code>已经做好了，放置在<code>~/Library/LaunchAgents/homebrew.mxcl.jenkins.plist</code>。需要说的是<code>launchctl</code>是macOS下系统提供的后台运行方案，<code>brew</code>等，均来自于此，具体的配置参数都和<code>launchctl</code>一样的，搜索一下很多。<code>brew</code>为我们已经准备好了一个，直接使用<code>方案三</code>就行。</p>
<p>具体操作可以Google一下，很多的～</p>
<h2 id="安装完成后的配置"><a href="#安装完成后的配置" class="headerlink" title="安装完成后的配置"></a>安装完成后的配置</h2><p>在Jenkins初始化完毕为了验证管理员身份，需要将Jenkins机器上的一个字符串输入到<a href="http://10.12.12.10:8080/" target="_blank" rel="noopener">http://10.12.12.10:8080</a>中进行验证，具体文件目录在输入的界面就能看到，不要大惊小怪。</p>
<p>之后开始选择安装插件。这里可以选择推荐的～～，也可以自己勾选。为了方便，这里直接选择推荐的方案进行安装。</p>
<p>经过漫长的等待，终于将插件安装完毕，并启动了起来～～</p>
<p>Jenkins权限，嗯，这个很重要，可以去<code>系统管理 -&gt; Configure Global Security</code>  中进行设置。</p>
<p>接下来开始去配置工程吧！传送门：<a href="../ios-automation-jenkins-build">iOS自动化-Jenkins编译工程</a></p>
<h2 id="可能会碰到的错误"><a href="#可能会碰到的错误" class="headerlink" title="可能会碰到的错误"></a>可能会碰到的错误</h2><h3 id="Error-Permission-denied"><a href="#Error-Permission-denied" class="headerlink" title="Error: Permission denied - ***"></a>Error: Permission denied - ***</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ brew services start jenkins</span><br><span class="line">Error: Permission denied - ~/Library/LaunchAgents/homebrew.mxcl.jenkins.plist</span><br></pre></td></tr></table></figure>
<p>这种很明显<code>Permission denied</code>，在命令行前添加<code>sudo</code>，然后输入密码即可。如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ sudo brew services start jenkins</span><br></pre></td></tr></table></figure>

<h3 id="方案二后的地址哪里来的？"><a href="#方案二后的地址哪里来的？" class="headerlink" title="方案二后的地址哪里来的？"></a><code>方案二</code>后的地址哪里来的？</h3><p>这里推荐的安装方案是<code>brew install jenkins</code></p>
<p>通过下面的方式找到<code>brew</code>安装的位置</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ brew services list</span><br><span class="line">Name       Status  User Plist</span><br><span class="line">beanstalkd stopped</span><br><span class="line">influxdb   stopped</span><br><span class="line">jenkins    started keith  ~/Library/LaunchAgents/homebrew.mxcl.jenkins.plist</span><br><span class="line">nginx      stopped</span><br><span class="line">sonarqube  stopped</span><br><span class="line">FDDdeiMac:~ FDD$ cat ~/Library/LaunchAgents/homebrew.mxcl.jenkins.plist</span><br><span class="line">...</span><br><span class="line">&lt;string&gt;/usr/<span class="built_in">local</span>/opt/jenkins/libexec/jenkins.war&lt;/string&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="给Jenkins绑定一个IP"><a href="#给Jenkins绑定一个IP" class="headerlink" title="给Jenkins绑定一个IP"></a>给Jenkins绑定一个IP</h3><p>讲道理这个不应该在这里聊的😂，不过还是说一下吧。。</p>
<p>一般局域网中都是直接自动获取IP信息的也就是DHCP，但是Jenkins总改IP也不好。。于是绑定一下吧。</p>
<p>在mac 中 <code>系统偏好设置 -&gt; 网络</code> 记录下来当前获取到的IP。</p>
<p>在<code>高级</code>中将<code>使用DHCP</code>修改为<code>使用DHCP(手动设定地址)</code>，然后将上面的地址填进去就好啦～</p>
<p>当然你也可以指定其他的地址，只要别人没有占用😂，你开心就好～</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>构建</tag>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS自动化-Jenkins编译工程</title>
    <url>/post/ios-automation-jenkins-build/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><ul>
<li><a href="../ios-automation-jenkins-configuration">iOS自动化-Jenkins环境搭建</a></li>
<li><a href="../ios-automation-jenkins-build">iOS自动化-Jenkins编译工程</a></li>
</ul>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Jenkins环境已搭建好，现在我们来开始愉快的为iOS打包吧～</p>
<p>从这个文章中你将要实现以下功能：</p>
<ul>
<li>在Jenkins创建工程</li>
<li>build出ipa</li>
<li>将ipa上传至fir</li>
<li>钉钉机器人群通知</li>
<li>将dsym上传至bugly</li>
</ul>
<a id="more"></a>

<h2 id="脚本环境安装"><a href="#脚本环境安装" class="headerlink" title="脚本环境安装"></a>脚本环境安装</h2><p>这里大多数操作都是用脚本来进行的，不为别的，就为自由和以后～</p>
<h3 id="fastlane"><a href="#fastlane" class="headerlink" title="fastlane"></a>fastlane</h3><p>此乃自动化神器。<a href="https://docs.fastlane.tools/" target="_blank" rel="noopener">文档在此</a>。<a href="https://github.com/fastlane/fastlane" target="_blank" rel="noopener">开源哟～</a></p>
<p>此处主要用来编译、打包。</p>
<p>安装方法：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ brew cask install fastlane</span><br></pre></td></tr></table></figure>

<p>此神器除了上述功能，还提供很多很多很多很多功能，包括自定义神马的都支持。需要的可以去文档里面翻翻。</p>
<p>在Xcode9 我使用的版本2.14.1打包出问题了。。具体在这里详见<a href="../debug-xcode9-build-ipa">Xcode9编译失败</a>。于是呼采用了<code>xcodebuild</code>进行打包</p>
<h3 id="fir-im-cli"><a href="#fir-im-cli" class="headerlink" title="fir.im-cli"></a>fir.im-cli</h3><p><a href="https://fir.im/" target="_blank" rel="noopener">fir.im</a>提供的应用内测托管工具。<a href="https://github.com/FIRHQ/fir-cli/blob/master/README.md" target="_blank" rel="noopener">开源官网</a>。</p>
<p>安装方法：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ gem install fir-cli</span><br></pre></td></tr></table></figure>

<p>此工具也提供打包ipa、apk、上传符号表至BugHD、等功能。但是我们在这里选择了<code>fastlane gym</code></p>
<p>上传加速：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ sh -c <span class="string">"<span class="variable">$(curl -sSL https://gist.githubusercontent.com/trawor/5dda140dee86836b8e60/raw/turbo-qiniu.sh)</span>"</span></span><br></pre></td></tr></table></figure>

<p>上传加速代码已经<a href="http://blog.fir.im/turbo-qiniu/" target="_blank" rel="noopener">开源至此</a>。</p>
<p><a href="http://bughd.com/" target="_blank" rel="noopener">BugHD</a>: 已停止线上免费服务，开始卖私有部署了。</p>
<p>另外，fir 也有<a href="http://blog.fir.im/jenkins/" target="_blank" rel="noopener">Jenkins插件</a>，但是这里选择脚本方式。</p>
<h2 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h2><p>所有的插件可以在<code>系统管理 -&gt; 插件管理</code>中进行安装、卸载、降级、更新、等操作。</p>
<p>确保以下插件已经被安装：</p>
<ul>
<li>源代码管理：<a href="https://wiki.jenkins.io/display/JENKINS/Git+Plugin" target="_blank" rel="noopener">Git Plugin</a></li>
<li>编译脚本环境变量：<a href="http://wiki.hudson-ci.org/display/HUDSON/Tool+Environment+Plugin" target="_blank" rel="noopener">Tool Environment Plugin</a></li>
</ul>
<p>嗯，开始创建工程，然后配置打包吧！</p>
<h2 id="工程相关配置"><a href="#工程相关配置" class="headerlink" title="工程相关配置"></a>工程相关配置</h2><p>左侧的<code>新建(New Item)</code>我就不说了吧～，点击输入项目名字，然后选择第一个<code>构建一个自由风格的软件项目</code>就行啦～～</p>
<p>此处项目名字暂且成为<code>test</code>。这里只说一些比较重要的，没有活不成的那种配置。别的自己研究一下或者点击右侧❓就能看到介绍。</p>
<h3 id="源码管理"><a href="#源码管理" class="headerlink" title="源码管理"></a>源码管理</h3><p>此处点击<code>Git</code>，展开之后输入<code>Repository URL</code>即可。</p>
<p><code>Repository URL</code>输入完毕之后点击别处，Jenkins的Git插件会自动校验该URL是否能够clone下来代码。出现红色就自己根据错误修改一下咯。。</p>
<p>另外此处支持<code>ssh</code> 的方式，大致样式为：<code>ssh://sunjigang@github.com:29418/projects/aaa</code>。</p>
<p><code>Branches to build</code> 写上你的构建分支～，根据自己需求来，<code>master</code>一般为仓库的默认分支。</p>
<h3 id="构建触发器"><a href="#构建触发器" class="headerlink" title="构建触发器"></a>构建触发器</h3><p>此处表示该项目的构建触发条件。（可选）</p>
<p>我们这里说一下<code>Poll SCM</code>：</p>
<p>定时检查源码变更。条件是 一定要配置<code>Git</code>这样的源码管理。</p>
<p>例子：</p>
<ul>
<li><code>H/15 * * * *</code>：每15分钟构建一次</li>
<li><code>0 2 * * *</code>： 每天2:00构建一次</li>
</ul>
<h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p>此处为构建的核心😂。当然，我们为了自由，此处全部使用<code>shell</code>脚本。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 工程名</span></span><br><span class="line">workspace=<span class="string">'xxx.xcworkspace'</span></span><br><span class="line"><span class="comment"># 构建scheme</span></span><br><span class="line">scheme=<span class="string">'xxx'</span></span><br><span class="line"><span class="comment"># 打包类型：app-store, ad-hoc, package, enterprise, development, and developer-id.</span></span><br><span class="line">export_method=<span class="string">'enterprise'</span></span><br><span class="line"><span class="comment"># fir的token，在fir-&gt;用户-&gt;token 获取</span></span><br><span class="line">fir_token=<span class="string">'c5077e0368888b9750ae848b9fe00***'</span></span><br><span class="line"><span class="comment"># fir上传短链接，效果为 https://fir.im/xxx</span></span><br><span class="line">fir_url=<span class="string">'xxx'</span></span><br><span class="line"><span class="comment"># 钉钉机器人token</span></span><br><span class="line">dingtalk_token=<span class="string">'6d09e43ddc62e540be914ff2e901e28b921d55c5ad457f6f3571f9f881287***'</span></span><br><span class="line"><span class="comment"># 钉钉机器人发送的内容</span></span><br><span class="line">dingtalk_content=<span class="string">"iOSXXX已经上传至 http://fir.im/<span class="variable">$&#123;fir_url&#125;</span> ,吧啦吧啦吧啦～"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建</span></span><br><span class="line">fastlane gym</span><br><span class="line">    --workspace <span class="variable">$workspace</span> \</span><br><span class="line">    --scheme <span class="variable">$scheme</span> \</span><br><span class="line">    --export_method <span class="variable">$export_method</span> \</span><br><span class="line">    clean</span><br><span class="line"></span><br><span class="line"><span class="comment"># fir</span></span><br><span class="line">ipa=$(<span class="built_in">pwd</span>)/$(ls *.ipa)</span><br><span class="line">git <span class="built_in">log</span> -10 &gt; git.log</span><br><span class="line">fir p <span class="variable">$ipa</span> -T <span class="variable">$fir_token</span> -s <span class="variable">$fir_url</span> -c git.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 钉钉通知</span></span><br><span class="line">curl <span class="string">"https://oapi.dingtalk.com/robot/send?access_token=<span class="variable">$&#123;dingtalk_token&#125;</span>"</span> -H <span class="string">'Content-Type: application/json'</span>    -d <span class="string">'</span></span><br><span class="line"><span class="string">    &#123;"msgtype": "text",</span></span><br><span class="line"><span class="string">        "text": &#123;</span></span><br><span class="line"><span class="string">            "content":$&#123;dingtalk_content&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;'</span></span><br></pre></td></tr></table></figure>

<p>至此 已经完成了打包、上传fir、钉钉机器人通知。</p>
<p>上述脚本只是配置的例子，可以根据自己需求，自己编写和配置。特别是</p>
<ul>
<li><code>.xcworkspace</code>的位置，要找清楚呀</li>
<li><code>scheme</code>无法找到是因为你在提交代码的时候没有将其设置为shared</li>
<li><code>fastlane gym</code> 支持很多参数，是对<code>xcodebuild</code>的封装，<a href="https://github.com/fastlane/fastlane/tree/master/gym" target="_blank" rel="noopener">源码及文档在此</a></li>
</ul>
<h3 id="上传dSYM至Bugly"><a href="#上传dSYM至Bugly" class="headerlink" title="上传dSYM至Bugly"></a>上传dSYM至Bugly</h3><p>这个还是有点点复杂的，因为bugly并未提供完整的cli工具链，需要手动跑jar包。不过都是可以完成的。</p>
<p>为了隔离开打包和上传，这里在Jenkins上新建一个项目用来上传dSYM</p>
<p>其中需要衔接的地方就是上面的输出要作为这个的输出。所以需要前后对应位置。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 路径主要用来提取Info.plist以及dsym文件</span></span><br><span class="line">path=<span class="string">'/Users/FDD/.jenkins/workspace/fdd-ios-app/fdd-app-ios/Fangduoduo'</span></span><br><span class="line"><span class="comment"># scheme name</span></span><br><span class="line">scheme=<span class="string">'Fangduoduo_ent'</span></span><br><span class="line"><span class="comment"># ipa bundleId</span></span><br><span class="line">package=<span class="string">'xx.xx.com'</span></span><br><span class="line"><span class="comment"># bugly id</span></span><br><span class="line">bugly_id=<span class="string">'9xxx'</span></span><br><span class="line"><span class="comment"># bugly key</span></span><br><span class="line">bugly_key=<span class="string">'wHzxcxxx'</span></span><br><span class="line"></span><br><span class="line">rm -rf *dSYM*</span><br><span class="line">cp <span class="variable">$&#123;path&#125;</span>/Fangduoduo/Fangduoduo_ent-Info.plist ./Info.plist</span><br><span class="line">cp -rf <span class="variable">$&#123;path&#125;</span>/build/*.xcarchive/dSYMs .</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------ post dsym ------------ #</span></span><br><span class="line"></span><br><span class="line">app_infoplist_path=<span class="string">'Info.plist'</span></span><br><span class="line">version=$(/usr/libexec/PlistBuddy -c <span class="string">"print CFBundleVersion"</span> <span class="variable">$&#123;app_infoplist_path&#125;</span>)</span><br><span class="line"></span><br><span class="line">java -jar ./bugly/buglySymboliOS.jar \</span><br><span class="line">	-i dSYMs/<span class="variable">$&#123;scheme&#125;</span>.app.dSYM \</span><br><span class="line">    -dsym \</span><br><span class="line">    -u \</span><br><span class="line">    -id <span class="variable">$&#123;bugly_id&#125;</span> \</span><br><span class="line">    -key <span class="variable">$&#123;bugly_key&#125;</span> \</span><br><span class="line">    -package <span class="variable">$&#123;package&#125;</span> \</span><br><span class="line">    -version <span class="variable">$&#123;version&#125;</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># @bugly jar执行的时候返回状态码有问题。已反馈，但是不见修改。。</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># ------------ UUID ------------ #</span></span><br><span class="line"></span><br><span class="line">unzip -o ./dSYMs/<span class="variable">$&#123;scheme&#125;</span>.app.dSYM.zip</span><br><span class="line">xcrun dwarfdump --uuid ./<span class="variable">$&#123;scheme&#125;</span> &gt;&gt; ./uuids-<span class="variable">$&#123;version&#125;</span>.txt</span><br></pre></td></tr></table></figure>

<p>值得说的是，如果上面的报错，那么检查一下是不是路径什么的写错了。。。</p>
<p>如果还有问题，可以在<a href="../../about">关于</a>中找到我。</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>构建</tag>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Xcode9编译失败</title>
    <url>/post/debug-xcode9-build-ipa/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="错误输出"><a href="#错误输出" class="headerlink" title="错误输出"></a>错误输出</h2><blockquote>
<p>error: exportArchive: “Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features.</p>
</blockquote>
<blockquote>
<p>Error Domain=IDEProvisioningErrorDomain Code=9 “”Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features.” UserInfo={NSLocalizedDescription=”Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features., NSLocalizedRecoverySuggestion=Add a profile to the “provisioningProfiles” dictionary in your Export Options property list.}</p>
</blockquote>
<a id="more"></a>

<h2 id="错误原因"><a href="#错误原因" class="headerlink" title="错误原因"></a>错误原因</h2><p>在升级Xcode9正式版之后，Jenkins也就升级了，于是乎用原来的套路打包之后就是上面的错误 5555…</p>
<p>如果使用<code>xcodebuild</code>进行处理，那么这个会发生在选择证书的步骤，错误大致就是这样。</p>
<p><code>$xcodebuild --help</code> 可以看到一些信息，而且在最后还特意提出了一个“-exportOptionsPlist”参数。具体内容见<code>xcodebuild --help</code></p>
<h2 id="解决问题才是关键"><a href="#解决问题才是关键" class="headerlink" title="解决问题才是关键"></a>解决问题才是关键</h2><ol>
<li><p>使用xcode9进行一次<code>archive</code></p>
</li>
<li><p>选择相关证书啊神马的，保持<code>thinning</code>不变就好</p>
</li>
<li><p>导出</p>
</li>
<li><p>导出目录有一个<code>ExportOptionsPlist.plist</code>，这个就是打包时候需要的plist</p>
</li>
</ol>
<h2 id="脚本构建"><a href="#脚本构建" class="headerlink" title="脚本构建"></a>脚本构建</h2><p><code>ipa</code>即为目标变量，具体的参看<a href="../build-ipa-sh">打包脚本</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">rm -rf ./build/*</span><br><span class="line">cat &lt;&lt; EOF &gt; ./build/exportOptionsPlist.plist</span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC <span class="string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;</span><br><span class="line">&lt;plist version=<span class="string">"1.0"</span>&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">    &lt;key&gt;compileBitcode&lt;/key&gt;</span><br><span class="line">    &lt;<span class="literal">true</span>/&gt;</span><br><span class="line">    &lt;key&gt;method&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;enterprise&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;provisioningProfiles&lt;/key&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">        &lt;key&gt;ershoufanglzg.fangdd.com&lt;/key&gt;</span><br><span class="line">        &lt;string&gt;ershoufanglzg_dis&lt;/string&gt;</span><br><span class="line">    &lt;/dict&gt;</span><br><span class="line">    &lt;key&gt;signingCertificate&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;iPhone Distribution&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;signingStyle&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;manual&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;stripSwiftSymbols&lt;/key&gt;</span><br><span class="line">    &lt;<span class="literal">true</span>/&gt;</span><br><span class="line">    &lt;key&gt;teamID&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;J3B467DURT&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;thinning&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;&amp;lt;none&amp;gt;&lt;/string&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">xcodebuild -archivePath <span class="string">"./build/xxx.xcarchive"</span> -workspace Fangduoduo.xcworkspace -sdk iphoneos -scheme <span class="string">"Fangduoduo_ent"</span> -configuration <span class="string">"Release Inhouse"</span> archive</span><br><span class="line">xcodebuild -exportArchive -archivePath <span class="string">"./build/xxx.xcarchive"</span> -exportPath <span class="string">"./build/"</span> -exportOptionsPlist ./build/exportOptionsPlist.plist</span><br><span class="line"></span><br><span class="line">ipa=$(<span class="built_in">pwd</span>)/$(ls ./build/*.ipa)</span><br></pre></td></tr></table></figure>

<h2 id="xcodebuild-–help"><a href="#xcodebuild-–help" class="headerlink" title="xcodebuild –help"></a>xcodebuild –help</h2><blockquote>
<p>Available keys for -exportOptionsPlist:</p>
</blockquote>
<blockquote>
<p>compileBitcode : Bool</p>
</blockquote>
<blockquote>
<p>For non-App Store exports, should Xcode re-compile the app from bitcode? Defaults to YES.</p>
</blockquote>
<blockquote>
<p>embedOnDemandResourcesAssetPacksInBundle : Bool</p>
</blockquote>
<blockquote>
<p>For non-App Store exports, if the app uses On Demand Resources and this is YES, asset packs are embedded in the app bundle so that the app can be tested without a server to host asset packs. Defaults to YES unless onDemandResourcesAssetPacksBaseURL is specified.</p>
</blockquote>
<blockquote>
<p>iCloudContainerEnvironment : String</p>
</blockquote>
<blockquote>
<p>If the app is using CloudKit, this configures the “com.apple.developer.icloud-container-environment” entitlement. Available options vary depending on the type of provisioning profile used, but may include: Development and Production.</p>
</blockquote>
<blockquote>
<p>installerSigningCertificate : String</p>
</blockquote>
<blockquote>
<p>For manual signing only. Provide a certificate name, SHA-1 hash, or automatic selector to use for signing. Automatic selectors allow Xcode to pick the newest installed certificate of a particular type. The available automatic selectors are “Mac Installer Distribution” and “Developer ID Installer”. Defaults to an automatic certificate selector matching the current distribution method.</p>
</blockquote>
<blockquote>
<p>manifest : Dictionary</p>
</blockquote>
<blockquote>
<p>For non-App Store exports, users can download your app over the web by opening your distribution manifest file in a web browser. To generate a distribution manifest, the value of this key should be a dictionary with three sub-keys: appURL, displayImageURL, fullSizeImageURL. The additional sub-key assetPackManifestURL is required when using on-demand resources.</p>
</blockquote>
<blockquote>
<p>method : String</p>
</blockquote>
<blockquote>
<p>Describes how Xcode should export the archive. Available options: app-store, package, ad-hoc, enterprise, development, developer-id, and mac-application. The list of options varies based on the type of archive. Defaults to development.</p>
</blockquote>
<blockquote>
<p>onDemandResourcesAssetPacksBaseURL : String</p>
</blockquote>
<blockquote>
<p>For non-App Store exports, if the app uses On Demand Resources and embedOnDemandResourcesAssetPacksInBundle isn’t YES, this should be a base URL specifying where asset packs are going to be hosted. This configures the app to download asset packs from the specified URL.</p>
</blockquote>
<blockquote>
<p>provisioningProfiles : Dictionary</p>
</blockquote>
<blockquote>
<p>For manual signing only. Specify the provisioning profile to use for each executable in your app. Keys in this dictionary are the bundle identifiers of executables; values are the provisioning profile name or UUID to use.</p>
</blockquote>
<blockquote>
<p>signingCertificate : String</p>
</blockquote>
<blockquote>
<p>For manual signing only. Provide a certificate name, SHA-1 hash, or automatic selector to use for signing. Automatic selectors allow Xcode to pick the newest installed certificate of a particular type. The available automatic selectors are “Mac App Distribution”, “iOS Developer”, “iOS Distribution”, “Developer ID Application”, and “Mac Developer”. Defaults to an automatic certificate selector matching the current distribution method.</p>
</blockquote>
<blockquote>
<p>signingStyle : String</p>
</blockquote>
<blockquote>
<p>The signing style to use when re-signing the app for distribution. Options are manual or automatic. Apps that were automatically signed when archived can be signed manually or automatically during distribution, and default to automatic. Apps that were manually signed when archived must be manually signed during distribtion, so the value of signingStyle is ignored.</p>
</blockquote>
<blockquote>
<p>stripSwiftSymbols : Bool</p>
</blockquote>
<blockquote>
<p>Should symbols be stripped from Swift libraries in your IPA? Defaults to YES.</p>
</blockquote>
<blockquote>
<p>teamID : String</p>
</blockquote>
<blockquote>
<p>The Developer Portal team to use for this export. Defaults to the team used to build the archive.</p>
</blockquote>
<blockquote>
<p>thinning : String</p>
</blockquote>
<blockquote>
<p>For non-App Store exports, should Xcode thin the package for one or more device variants? Available options: <none> (Xcode produces a non-thinned universal app), <thin-for-all-variants> (Xcode produces a universal app and all available thinned variants), or a model identifier for a specific device (e.g. “iPhone7,1”). Defaults to <none>.</p>
</blockquote>
<blockquote>
<p>uploadBitcode : Bool</p>
</blockquote>
<blockquote>
<p>For App Store exports, should the package include bitcode? Defaults to YES.</p>
</blockquote>
<blockquote>
<p>uploadSymbols : Bool</p>
</blockquote>
<blockquote>
<p>For App Store exports, should the package include symbols? Defaults to YES.</p>
</blockquote>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>构建</tag>
        <tag>DEBUG</tag>
      </tags>
  </entry>
  <entry>
    <title>DEBUG - Xcode解析.crash</title>
    <url>/post/debug-xcode8-analysis-crash-file/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>5步解析<code>.crash</code>文件</p>
<a id="more"></a>

<h1 id="Xcode中解析-crash文件"><a href="#Xcode中解析-crash文件" class="headerlink" title="Xcode中解析.crash文件"></a>Xcode中解析.crash文件</h1><ol>
<li>导出<code>x.crash</code>文件，放置在<code>目录A</code>下</li>
<li>复制<code>工程名.app.dSYM</code>到<code>目录A</code></li>
<li>配置环境变量，运行<code>export DEVELOPER_DIR=/Applications/Xcode.app/Contents/Developer</code></li>
<li>拷贝脚本文件，运行<code>cp /Applications/Xcode.app/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/symbolicatecrash 目录A</code></li>
<li>到<code>目录A</code>解析，运行<code>./symbolicatecrash x.crash 工程名.app.dSYM &gt; 自定义输出结果文件名</code></li>
</ol>
<h1 id="注"><a href="#注" class="headerlink" title="注"></a>注</h1><ul>
<li>这里最重要的是<code>symbolicatecrash</code>文件，<code>symbolicatecrash</code>在手解析不愁。</li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>DEBUG</tag>
      </tags>
  </entry>
  <entry>
    <title>class的class-static-func使用Self作为返回值</title>
    <url>/post/class-static-func-return-self/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="一个问题"><a href="#一个问题" class="headerlink" title="一个问题"></a>一个问题</h1><ul>
<li>Xcode: Version 11.4.1 (11E503a)</li>
<li>swift: Swift 5</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MDButton</span>: <span class="title">UIButton</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 为了更清楚展示问题,代码经过精简</span></span><br><span class="line">    <span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">make</span>() -&gt; <span class="title">Self</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">MDButton</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码无法编译:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ViewController.swift: error: cannot convert return expression of type &#39;MDButton&#39; to return type &#39;Self&#39;</span><br><span class="line">        return MDButton()</span><br><span class="line">               ^~~~~~~~~~</span><br><span class="line">                          as! Self</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h1 id="查找关于Self的新特性"><a href="#查找关于Self的新特性" class="headerlink" title="查找关于Self的新特性"></a>查找关于<code>Self</code>的新特性</h1><p><a href="https://github.com/apple/swift-evolution/blob/master/proposals/0068-universal-self.md" target="_blank" rel="noopener">Proposal: SE-0068</a>这里有说到关于这个<code>Self</code>的问题.</p>
<p>其目的是为了解决:</p>
<blockquote>
<ul>
<li><code>dynamicType</code> remains an exception to Swift’s lowercased keywords rule. This change eliminates a special case that’s out of step with Swift’s new standards.</li>
<li><code>Self</code> is shorter and clearer in its intent. It mirrors <code>self</code>, which refers to the current instance.</li>
<li>It provides an easier way to access static members. As type names grow large, readability suffers. <code>MyExtremelyLargeTypeName.staticMember</code> is unwieldy to type and read.</li>
<li>Code using hardwired type names is less portable than code that automatically knows its type.</li>
<li>Renaming a type means updating any <code>TypeName</code> references in code.</li>
<li>Using <code>self.dynamicType</code> fights against Swift’s goals of concision and clarity in that it is both noisy and esoteric.</li>
</ul>
</blockquote>
<p>所以说该问题在<code>struct</code>中并不存在,也就是下面的代码完全没有问题:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xxx</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">make</span><span class="params">()</span></span> -&gt; <span class="type">Self</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> xxx()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="究竟如何修改"><a href="#究竟如何修改" class="headerlink" title="究竟如何修改"></a>究竟如何修改</h1><p>好吧,上面测试过这几个关键字之后,尝试修改函数内的返回对象吧.此时既然<code>Self</code>是<code>dynamicType</code>,那么可以使用<code>self</code>去调用初始化方法就行了吧, 于是:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MDButton2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">     <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">make</span>() -&gt; <span class="title">Self</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 或 return self.init()</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">Self</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="一点看法"><a href="#一点看法" class="headerlink" title="一点看法"></a>一点看法</h1><p>首先, 整个过程(包括Xcode的提示)不使用<code>as!</code>的解决方案, 对,我就是那个坚决不使用<code>as!</code>的人(刷题除外).</p>
<p>然后, 可以翻一下这个<code>Self</code>的实现<a href="https://github.com/apple/swift/pull/22863" target="_blank" rel="noopener">apple/swift#22863</a>,内容比较多.</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>DEBUG</tag>
        <tag>Swift</tag>
      </tags>
  </entry>
  <entry>
    <title>debug-_SwiftValue-unsignedIntegerValue</title>
    <url>/post/debug-SwiftValue-unsignedIntegerValue/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>crash:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let attr &#x3D; try? NSMutableAttributedString(data: data,</span><br><span class="line">                                          options: [NSDocumentTypeDocumentAttribute: NSHTMLTextDocumentType,</span><br><span class="line">                                                    NSCharacterEncodingDocumentAttribute: String.Encoding.utf8],</span><br><span class="line">                                          documentAttributes:nil)</span><br><span class="line">&#x2F;&#x2F; log:</span><br><span class="line">2017-04-17 14:04:38.140 [41275:463875] -[_SwiftValue unsignedIntegerValue]: unrecognized selector sent to instance 0x608000256620</span><br></pre></td></tr></table></figure>

<a id="more"></a>



<p>WTF! 这个方法启动时不能直接调用，要异步？</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>DEBUG</tag>
      </tags>
  </entry>
  <entry>
    <title>DEBUG - swift中取出通知中的frame</title>
    <url>/post/debug-swift-notifa-frame/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>swift中获取OC存储的Frame两种获取方案。</p>
<a id="more"></a>

<h1 id="Swift下在Notification-userInfo取Frame，Debug和Release情况下还不一样。。"><a href="#Swift下在Notification-userInfo取Frame，Debug和Release情况下还不一样。。" class="headerlink" title="Swift下在Notification.userInfo取Frame，Debug和Release情况下还不一样。。"></a>Swift下在Notification.userInfo取Frame，Debug和Release情况下还不一样。。</h1><p>  –&gt;更新于2016.12.1</p>
<p>  __ Version 8.1 (8B62) __</p>
  <figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">keyboardShow</span><span class="params">(sender: Notification)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> endFrame = <span class="type">CGRect</span>.zero        </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> frame = sender.userInfo?[<span class="type">UIKeyboardFrameEndUserInfoKey</span>] <span class="keyword">as</span>? <span class="type">CGRect</span> &#123;</span><br><span class="line">        endFrame = frame</span><br><span class="line">        <span class="comment">//  *** Debug是可以通过的。但是Release无法通过。</span></span><br><span class="line">        <span class="type">NSLog</span>(<span class="string">"&lt;&lt;&lt;INFO&gt;&gt;&gt;: as CGRect"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> value = sender.userInfo?[<span class="type">UIKeyboardFrameEndUserInfoKey</span>] <span class="keyword">as</span>? <span class="type">NSValue</span> &#123;</span><br><span class="line">        endFrame = value.cgRectValue</span><br><span class="line">        <span class="comment">//  *** Release会取出NSValue</span></span><br><span class="line">        <span class="type">NSLog</span>(<span class="string">"&lt;&lt;&lt;INFO&gt;&gt;&gt;: as NSValue"</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>  由于Release无法调试，所以费了不少劲。首先Swift中的字典已经可以存放值类型，其本身也是值类型。所以我首先选择了第一种写法<code>let frame = sender.userInfo?[UIKeyboardFrameEndUserInfoKey] as? CGRect</code>, 但是Release情况下却发生解包失败的情况。所以采用OC的传统写法<code>let value = sender.userInfo?[UIKeyboardFrameEndUserInfoKey] as? NSValue</code>。就能解析出来。但是总感觉OC的方法不够swift😂。。。</p>
<p>  有同事直接强制转换为NSValue是没有问题的，于是乎试了一下，发现直接校验NSValue就可以。但是swift中感觉不应该有这个转换了，毕竟本身就可以存储CGRect..</p>
<p>  猜测原因：目前阶段Swift的字典和OC的字典数据结构还并未完全一致。。</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>DEBUG</tag>
      </tags>
  </entry>
  <entry>
    <title>DEBUG - UIView.h#190</title>
    <url>/post/debug-uiview-m-190/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>CRASH:<br><code>void UIViewReportBrokenSuperviewChain(UIView *__strong, UIView *__strong, BOOL)()</code></p>
<a id="more"></a>

<h1 id="UIView-m-190-UIViewReportBrokenSuperviewChain"><a href="#UIView-m-190-UIViewReportBrokenSuperviewChain" class="headerlink" title="UIView.m:190 - UIViewReportBrokenSuperviewChain"></a>UIView.m:190 - UIViewReportBrokenSuperviewChain</h1><h2 id="异常信息："><a href="#异常信息：" class="headerlink" title="异常信息："></a>异常信息：</h2>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*** Assertion failure in void UIViewReportBrokenSuperviewChain(UIView *__strong, UIView *__strong, BOOL)(), &#x2F;BuildRoot&#x2F;Library&#x2F;Caches&#x2F;com.apple.xbs&#x2F;Sources&#x2F;UIKit&#x2F;UIKit-3599.6.1&#x2F;UIView.m:190</span><br><span class="line">invalid mode &#39;kCFRunLoopCommonModes&#39; provided to CFRunLoopRunSpecific - break on _CFRunLoopError_RunCalledWithInvalidMode to debug. This message will only appear once per execution.</span><br><span class="line">libc++abi.dylib: terminate_handler unexpectedly threw an exception</span><br></pre></td></tr></table></figure>

<h2 id="异常分析"><a href="#异常分析" class="headerlink" title="异常分析"></a>异常分析</h2><p>  APP crash在<br>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[keyWindow addSubview:weakSelf];</span><br></pre></td></tr></table></figure><br>  <a href="#%E9%94%99%E8%AF%AF%E5%A0%86%E6%A0%88">错误堆栈信息</a>。</p>
<p>  但是真正造成crash的代码为：</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[self.layer insertSublayer:xxxView.layer atIndex:0];</span><br></pre></td></tr></table></figure>


<p>  解决方案：<br>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[self layoutIfNeeded];</span><br><span class="line">[self.layer insertSublayer:xxxView.layer atIndex:0];</span><br></pre></td></tr></table></figure></p>
<p>  原因分析：<br>  下面这个说的很在理</p>
<blockquote>
<p><a href="http://stackoverflow.com/questions/39565424/swift-uiviewreportbrokensuperviewchain-cause-by-layer-manipulation" target="_blank" rel="noopener">http://stackoverflow.com/questions/39565424/swift-uiviewreportbrokensuperviewchain-cause-by-layer-manipulation</a></p>
<p>I had this issue with a library when moving over to Xcode 8 (Material-Controls-For-iOS - MDTextField). I found that the problem was coming from where the layer of one view (which had no superview) was being added to another.</p>
<p>It looks like this may be the case for yourself also - your toolbar being created has not been added to a superview first. The fix I used was to add the view as a subview of the view that the layer was being added to, so in your case adding the toolbar as a subview of myModelView should stop the error.</p>
</blockquote>
<h2 id="碰到该问题的还有"><a href="#碰到该问题的还有" class="headerlink" title="碰到该问题的还有"></a>碰到该问题的还有</h2><ul>
<li><a href="http://technology.ezeenow.com/Posts/119474/Unity_Prime31_prompt_for_photo_is_crashing_on_iOS_10_and_XCode_8" target="_blank" rel="noopener">Google出来的一个，但是并未看到相关回复。。。</a></li>
<li><a href="http://www.th7.cn/Program/IOS/201609/975582.shtml" target="_blank" rel="noopener">IOS10上崩溃错误“View has lost track of its superview, most (并未找到原贴)</a></li>
<li><a href="http://stackoverflow.com/questions/39565424/swift-uiviewreportbrokensuperviewchain-cause-by-layer-manipulation" target="_blank" rel="noopener">stackoverflow(这个分析的很到位)</a></li>
</ul>
<h2 id="错误堆栈-lt-脱敏-gt"><a href="#错误堆栈-lt-脱敏-gt" class="headerlink" title="错误堆栈 &lt;脱敏&gt;"></a><a name="错误堆栈">错误堆栈 &lt;脱敏&gt;</a></h2>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*** Assertion failure in void UIViewReportBrokenSuperviewChain(UIView *__strong, UIView *__strong, BOOL)(), &#x2F;BuildRoot&#x2F;Library&#x2F;Caches&#x2F;com.apple.xbs&#x2F;Sources&#x2F;UIKit&#x2F;UIKit-3599.6.1&#x2F;UIView.m:190</span><br><span class="line">invalid mode &#39;kCFRunLoopCommonModes&#39; provided to CFRunLoopRunSpecific - break on _CFRunLoopError_RunCalledWithInvalidMode to debug. This message will only appear once per execution.</span><br><span class="line">libc++abi.dylib: terminate_handler unexpectedly threw an exception</span><br><span class="line"></span><br><span class="line">(lldb) bt</span><br><span class="line">* thread #1: tid &#x3D; 0x87c18, 0x000000018238c524 libobjc.A.dylib&#96;objc_exception_throw, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; breakpoint 1.2</span><br><span class="line">    frame #0: 0x000000018238c524 libobjc.A.dylib&#96;objc_exception_throw</span><br><span class="line">    frame #1: 0x0000000183954094 CoreFoundation&#96;+[NSException raise:format:arguments:] + 104</span><br><span class="line">    frame #2: 0x00000001843de898 Foundation&#96;-[NSAssertionHandler handleFailureInFunction:file:lineNumber:description:] + 88</span><br><span class="line">    frame #3: 0x0000000189a7cf9c UIKit&#96;UIViewReportBrokenSuperviewChain + 472</span><br><span class="line">    frame #4: 0x0000000189a7d658 UIKit&#96;_UIViewTopDownSubtreeTraversal + 1496</span><br><span class="line">    frame #5: 0x000000018a0f3390 UIKit&#96;-[UIView(UIConstraintBasedLayout_EngineDelegate) _invalidateSystemLayoutSizeFittingSizeAtEngineDelegateLevel] + 232</span><br><span class="line">    frame #6: 0x00000001843832ac Foundation&#96;-[NSISEngine tryToAddConstraintWithMarker:expression:integralizationAdjustment:mutuallyExclusiveConstraints:] + 920</span><br><span class="line">    frame #7: 0x0000000184382dcc Foundation&#96;-[NSLayoutConstraint _addLoweredExpression:toEngine:integralizationAdjustment:lastLoweredConstantWasRounded:mutuallyExclusiveConstraints:] + 284</span><br><span class="line">    frame #8: 0x00000001843809e0 Foundation&#96;-[NSLayoutConstraint _addToEngine:integralizationAdjustment:mutuallyExclusiveConstraints:] + 272</span><br><span class="line">    frame #9: 0x000000018989cfdc UIKit&#96;__57-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:]_block_invoke_2 + 396</span><br><span class="line">    frame #10: 0x0000000184380510 Foundation&#96;-[NSISEngine withBehaviors:performModifications:] + 168</span><br><span class="line">    frame #11: 0x000000018989cde8 UIKit&#96;__57-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:]_block_invoke + 564</span><br><span class="line">    frame #12: 0x00000001897995e0 UIKit&#96;-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:] + 224</span><br><span class="line">    frame #13: 0x000000018989cf14 UIKit&#96;__57-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:]_block_invoke_2 + 196</span><br><span class="line">    frame #14: 0x0000000184380510 Foundation&#96;-[NSISEngine withBehaviors:performModifications:] + 168</span><br><span class="line">    frame #15: 0x000000018989cde8 UIKit&#96;__57-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:]_block_invoke + 564</span><br><span class="line">    frame #16: 0x00000001897995e0 UIKit&#96;-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:] + 224</span><br><span class="line">    frame #17: 0x000000018989cf14 UIKit&#96;__57-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:]_block_invoke_2 + 196</span><br><span class="line">    frame #18: 0x0000000184380510 Foundation&#96;-[NSISEngine withBehaviors:performModifications:] + 168</span><br><span class="line">    frame #19: 0x000000018989cde8 UIKit&#96;__57-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:]_block_invoke + 564</span><br><span class="line">    frame #20: 0x00000001897995e0 UIKit&#96;-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:] + 224</span><br><span class="line">    frame #21: 0x000000018989cf14 UIKit&#96;__57-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:]_block_invoke_2 + 196</span><br><span class="line">    frame #22: 0x0000000184380510 Foundation&#96;-[NSISEngine withBehaviors:performModifications:] + 168</span><br><span class="line">    frame #23: 0x000000018989cde8 UIKit&#96;__57-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:]_block_invoke + 564</span><br><span class="line">    frame #24: 0x00000001897995e0 UIKit&#96;-[UIView(AdditionalLayoutSupport) _switchToLayoutEngine:] + 224</span><br><span class="line">    frame #25: 0x00000001898a4bb0 UIKit&#96;-[UIWindow(UIConstraintBasedLayout) _switchToLayoutEngine:] + 72</span><br><span class="line">    frame #26: 0x00000001898a4b04 UIKit&#96;-[UIWindow(UIConstraintBasedLayout) _initializeLayoutEngine] + 256</span><br><span class="line">    frame #27: 0x00000001898a4910 UIKit&#96;-[UIView(UIConstraintBasedLayout) _layoutEngine_windowDidChange] + 132</span><br><span class="line">    frame #28: 0x00000001897996dc UIKit&#96;-[UIView(Internal) _didMoveFromWindow:toWindow:] + 200</span><br><span class="line">    frame #29: 0x0000000189798d90 UIKit&#96;__45-[UIView(Hierarchy) _postMovedFromSuperview:]_block_invoke + 156</span><br><span class="line">    frame #30: 0x0000000189798be8 UIKit&#96;-[UIView(Hierarchy) _postMovedFromSuperview:] + 792</span><br><span class="line">    frame #31: 0x00000001897a4ad0 UIKit&#96;-[UIView(Internal) _addSubview:positioned:relativeTo:] + 1788</span><br><span class="line">    frame #32: 0x00000001897a43bc UIKit&#96;-[UIView(Hierarchy) addSubview:] + 828</span><br><span class="line">  * frame #33: 0x00000001004f78ec Project_ent&#96;__31-[EsfCommentReportView show]_block_invoke((null)&#x3D;&lt;unavailable&gt;) + 228 at EsfCommentReportView.m:293</span><br><span class="line">    frame #34: 0x00000001897d2b88 UIKit&#96;+[UIView(UIViewAnimationWithBlocks) _setupAnimationWithDuration:delay:view:options:factory:animations:start:animationStateGenerator:completion:] + 660</span><br><span class="line">    frame #35: 0x00000001897d28e8 UIKit&#96;+[UIView(UIViewAnimationWithBlocks) animateWithDuration:animations:] + 56</span><br><span class="line">    frame #36: 0x00000001004f77a0 Project_ent&#96;-[EsfCommentReportView show](self&#x3D;0x000000015fe32020, _cmd&#x3D;&quot;show&quot;) + 492 at EsfCommentReportView.m:291</span><br><span class="line">    frame #37: 0x0000000100858a04 Project_ent&#96;__53-[BuyerAdviserProfileViewController reportAction:]_block_invoke((null)&#x3D;&lt;unavailable&gt;) + 308 at BuyerAdviserProfileViewController.m:174</span><br><span class="line">    frame #38: 0x00000001003f93e4 Project_ent&#96;+[MyLoginViewController ifShouldLoginFromViewController:sourceType:afterCheckOrLogin:cancelLogin:](self&#x3D;MyLoginViewController, _cmd&#x3D;&quot;ifShouldLoginFromViewController:sourceType:afterCheckOrLogin:cancelLogin:&quot;, viewController&#x3D;0x000000015fd2e320, sourceType&#x3D;2, afterCheckOrLogin&#x3D;0x00000001008588d0, cancelLogin&#x3D;(null)) + 236 at MyLoginViewController.m:123</span><br><span class="line">    frame #39: 0x00000001003f92b0 Project_ent&#96;+[MyLoginViewController ifShouldLoginFromViewController:afterCheckOrLogin:cancelLogin:](self&#x3D;MyLoginViewController, _cmd&#x3D;&quot;ifShouldLoginFromViewController:afterCheckOrLogin:cancelLogin:&quot;, viewController&#x3D;0x000000015fd2e320, afterCheckOrLogin&#x3D;0x00000001008588d0, cancelLogin&#x3D;(null)) + 156 at MyLoginViewController.m:114</span><br><span class="line">    frame #40: 0x00000001003f9124 Project_ent&#96;+[MyLoginViewController ifShouldLoginFromViewController:afterCheckOrLogin:](self&#x3D;MyLoginViewController, _cmd&#x3D;&quot;ifShouldLoginFromViewController:afterCheckOrLogin:&quot;, viewController&#x3D;0x000000015fd2e320, afterCheckOrLogin&#x3D;0x00000001008588d0) + 120 at MyLoginViewController.m:104</span><br><span class="line">    frame #41: 0x0000000100858870 Project_ent&#96;-[BuyerAdviserProfileViewController reportAction:](self&#x3D;0x000000015fd2e320, _cmd&#x3D;&quot;reportAction:&quot;, button&#x3D;0x000000015fe26650) + 452 at BuyerAdviserProfileViewController.m:156</span><br><span class="line">    frame #42: 0x00000001897d27b0 UIKit&#96;-[UIApplication sendAction:to:from:forEvent:] + 96</span><br><span class="line">    frame #43: 0x00000001897d2730 UIKit&#96;-[UIControl sendAction:to:forEvent:] + 80</span><br><span class="line">    frame #44: 0x00000001897bcbe4 UIKit&#96;-[UIControl _sendActionsForEvents:withEvent:] + 452</span><br><span class="line">    frame #45: 0x00000001897d201c UIKit&#96;-[UIControl touchesEnded:withEvent:] + 584</span><br><span class="line">    frame #46: 0x00000001897d1b44 UIKit&#96;-[UIWindow _sendTouchesForEvent:] + 2484</span><br><span class="line">    frame #47: 0x00000001897ccd8c UIKit&#96;-[UIWindow sendEvent:] + 2988</span><br><span class="line">    frame #48: 0x000000018979d858 UIKit&#96;-[UIApplication sendEvent:] + 340</span><br><span class="line">    frame #49: 0x0000000189f8acb8 UIKit&#96;__dispatchPreprocessedEventFromEventQueue + 2736</span><br><span class="line">    frame #50: 0x0000000189f84720 UIKit&#96;__handleEventQueue + 784</span><br><span class="line">    frame #51: 0x0000000183902278 CoreFoundation&#96;__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 24</span><br><span class="line">    frame #52: 0x0000000183901bc0 CoreFoundation&#96;__CFRunLoopDoSources0 + 524</span><br><span class="line">    frame #53: 0x00000001838ff7c0 CoreFoundation&#96;__CFRunLoopRun + 804</span><br><span class="line">    frame #54: 0x000000018382e048 CoreFoundation&#96;CFRunLoopRunSpecific + 444</span><br><span class="line">    frame #55: 0x00000001852b1198 GraphicsServices&#96;GSEventRunModal + 180</span><br><span class="line">    frame #56: 0x0000000189808628 UIKit&#96;-[UIApplication _run] + 684</span><br><span class="line">    frame #57: 0x0000000189803360 UIKit&#96;UIApplicationMain + 208</span><br><span class="line">    frame #58: 0x0000000100a3db78 Project_ent&#96;main + 460 at main.swift:24</span><br><span class="line">    frame #59: 0x00000001828105b8 libdyld.dylib&#96;start + 4</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>DEBUG</tag>
      </tags>
  </entry>
  <entry>
    <title>从一个常见的崩溃开始</title>
    <url>/post/debug-sth-from-crash/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>昨天下班时候一朋友碰到一个下面的崩溃，但是全局断点却无法断到指定位置。鉴于不信邪的态度，决定尝试一番。然后将此事记录如下文。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*** Terminating app due to uncaught exception &#39;NSInvalidArgumentException&#39;, reason: &#39;-[__NSCFConstantString hasPrefix:]: nil argument&#39;</span><br><span class="line">*** First throw call stack:</span><br><span class="line">(0x18521ed8c .....)</span><br><span class="line">libc++abi.dylib: terminating with uncaught exception of type NSException</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="崩溃表现"><a href="#崩溃表现" class="headerlink" title="崩溃表现"></a>崩溃表现</h2><p>那老哥说他的APP运行之后，什么都不做，等待10s之后就会闪退，闪退的最重要信息是上面，栈结构上没有函数信息，只有地址。</p>
<p>打开全局断点，也无法直接断到指定的函数，这个信息我留了一张图，大致如下：(已脱敏)</p>
<p><img src="/images/2018-07-25-10-52-38.png" alt="崩溃截图"></p>
<h2 id="先简单的分析一下"><a href="#先简单的分析一下" class="headerlink" title="先简单的分析一下"></a>先简单的分析一下</h2><ul>
<li>崩溃原因很明确:<code>-[__NSCFConstantString hasPrefix:]: nil argument</code>。</li>
<li><code>__NSCFConstantString</code>为<code>NSString</code>类簇里面的一个类，常见的类似的还有很多。</li>
<li><code>- (BOOL)hasPrefix:(NSString *)str;</code>中<code>nil argument</code>，也就是<code>str</code>为<code>nil</code>。</li>
<li><code>First throw call stack</code>下方均为地址，说明此函数应该在一个<code>.a/.framework</code>中。</li>
<li><code>APP运行之后，什么都不做，等待10s之后就会闪退</code>说明此崩溃为异步调用，至于是不是定时调用，这个真不好说。</li>
<li>由于我技术有限，别的好像提炼不出有用信息了。。</li>
</ul>
<h2 id="复现一下崩溃"><a href="#复现一下崩溃" class="headerlink" title="复现一下崩溃"></a>复现一下崩溃</h2><p>先来个简单的代码，验证一下 ** <code>- (BOOL)hasPrefix:(NSString *)str;</code>中<code>nil argument</code>，也就是<code>str</code>为<code>nil</code>。 **</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, @([<span class="string">@""</span> hasPrefix:<span class="literal">nil</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行一下，结果很意料之中，得出如下：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">Untitled.m:<span class="number">4</span>:<span class="number">29</span>: warning: null passed to a callee that requires a non-null argument [-Wnonnull]</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, @([<span class="string">@""</span> hasPrefix:<span class="literal">nil</span>]));</span><br><span class="line">                            ^         ~~~</span><br><span class="line"><span class="number">1</span> warning generated.</span><br><span class="line">Terminated due to signal: ABORT TRAP (<span class="number">6</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">44</span>:<span class="number">50.569</span> Untitled[<span class="number">53770</span>:<span class="number">899141</span>] *** Terminating app due to uncaught exception <span class="string">'NSInvalidArgumentException'</span>, reason: <span class="string">'-[__NSCFConstantString hasPrefix:]: nil argument'</span></span><br><span class="line">*** First throw call stack:</span><br><span class="line">(</span><br><span class="line">	<span class="number">0</span>   CoreFoundation                      <span class="number">0x00007fff30aae2db</span> __exceptionPreprocess + <span class="number">171</span></span><br><span class="line">	<span class="number">1</span>   libobjc.A.dylib                     <span class="number">0x00007fff57c58c76</span> objc_exception_throw + <span class="number">48</span></span><br><span class="line">	<span class="number">2</span>   CoreFoundation                      <span class="number">0x00007fff30b3fd7d</span> +[<span class="built_in">NSException</span> raise:format:] + <span class="number">205</span></span><br><span class="line">	<span class="number">3</span>   CoreFoundation                      <span class="number">0x00007fff30a01840</span> -[__NSCFString hasPrefix:] + <span class="number">96</span></span><br><span class="line">	<span class="number">4</span>   Untitled                            <span class="number">0x000000010787fd60</span> main + <span class="number">64</span></span><br><span class="line">	<span class="number">5</span>   libdyld.dylib                       <span class="number">0x00007fff58872015</span> start + <span class="number">1</span></span><br><span class="line">)</span><br><span class="line">libc++abi.dylib: terminating with uncaught exception of type <span class="built_in">NSException</span></span><br></pre></td></tr></table></figure>

<p>经过<code>1 warning generated</code>之后，果断崩溃了，还有明确的崩溃时候栈结构。</p>
<p>好，问题确定了就是这个<code>1 warning generated</code>造成的。改下就完事咯～～</p>
<h2 id="寻找问题"><a href="#寻找问题" class="headerlink" title="寻找问题"></a>寻找问题</h2><h3 id="尝试解除warning"><a href="#尝试解除warning" class="headerlink" title="尝试解除warning"></a>尝试解除warning</h3><p>远程进去之后我震惊了，<code>warning: 999+</code>。先快速找到问题，要什么自行车。。</p>
<p>Xcode中全局搜索<code>hasPrefix</code>关键字，带变量的全部加上断点。</p>
<p>run一下，问题依旧如此。。正如上面说的一样：</p>
<blockquote>
<p><code>First throw call stack</code>下方均为地址，说明此函数应该在一个<code>.a/.framework</code>中。</p>
</blockquote>
<p>GO DIE…</p>
<p>PS.</p>
<ul>
<li>关于<code>hasPrefix</code>函数的<a href="https://developer.apple.com/documentation/foundation/nsstring/1410309-hasprefix?language=objc" target="_blank" rel="noopener">OC声明</a>、<a href="https://developer.apple.com/documentation/foundation/nsstring/1410309-hasprefix" target="_blank" rel="noopener">swift声明</a>均为完整字符串，所以安心全局搜索就能找到代码中已存在的<code>hasPrefix</code>函数</li>
<li>顺便搜了一下该项目不包含第三方<code>.a</code>, 但是<code>.framework</code>不少。。有<a href="https://cocoapods.org/" target="_blank" rel="noopener">CocoaPods</a>集成有直接拖进来的。。</li>
</ul>
<h3 id="尝试Method-Swizzling一下"><a href="#尝试Method-Swizzling一下" class="headerlink" title="尝试Method Swizzling一下"></a>尝试Method Swizzling一下</h3><p>这玩意既然在别人的framework中，那就更新一下咯，但是全部更新并不可取。。</p>
<p>framework的更新可能导致一些不可预估的可变因素。比如说API修改、内部逻辑变更导致外部使用不兼容、某些开发者喜欢直接修改framework、等。</p>
<p>所以先确定是哪个framework。</p>
<p>Method Swizzling。将其<code>-[__NSCFConstantString hasPrefix:]: nil argument</code>直接过滤<code>nil</code>，岂不美滋滋～～</p>
<p>好了先测试一下：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MySafeString</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MySafeString</span></span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    Class originalClass = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSCFConstantString"</span>);</span><br><span class="line">    Class swizzledClass = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">    SEL originalSelector = <span class="keyword">@selector</span>(hasPrefix:);</span><br><span class="line">    SEL swizzledSelector = <span class="keyword">@selector</span>(safe_hasPrefix:);</span><br><span class="line">    Method originalMethod = class_getInstanceMethod(originalClass, originalSelector);</span><br><span class="line">    Method swizzledMethod = class_getInstanceMethod(swizzledClass, swizzledSelector);</span><br><span class="line">    </span><br><span class="line">    IMP originalIMP = method_getImplementation(originalMethod);</span><br><span class="line">    IMP swizzledIMP = method_getImplementation(swizzledMethod);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *originalType = method_getTypeEncoding(originalMethod);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *swizzledType = method_getTypeEncoding(swizzledMethod);</span><br><span class="line">    </span><br><span class="line">    class_replaceMethod(originalClass,swizzledSelector,originalIMP,originalType);</span><br><span class="line">    class_replaceMethod(originalClass,originalSelector,swizzledIMP,swizzledType);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)safe_hasPrefix:(<span class="built_in">NSString</span> *)str &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> [<span class="keyword">self</span> safe_hasPrefix:str];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, @([<span class="string">@""</span> hasPrefix:<span class="literal">nil</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">Untitled.m:<span class="number">33</span>:<span class="number">29</span>: warning: null passed to a callee that requires a non-null argument [-Wnonnull]</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, @([<span class="string">@""</span> hasPrefix:<span class="literal">nil</span>]));</span><br><span class="line">                            ^         ~~~</span><br><span class="line"><span class="number">1</span> warnings generated.</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-25</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">20.634</span> Untitled[<span class="number">54520</span>:<span class="number">926937</span>] <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>不崩溃了，赶紧粘过去，并在<code>- (BOOL)safe_hasPrefix:(NSString *)str</code>中的<code>return YES;</code>打上断点。</p>
<p>内心得到了极大的满足～ 美滋滋～～～</p>
<p>2分钟后。</p>
<p>断点停了，向<code>- (BOOL)safe_hasPrefix:(NSString *)str</code>的<code>str</code>传nil的调用者是<code>[MOBFErrorReportService writeHTTPErrorMsg:error:]</code>。</p>
<p>将<code>MOBFErrorReportService</code>放入<a href="https://www.google.com/" target="_blank" rel="noopener">Google</a>看到第二个就是这个<a href="http://bbs.mob.com/thread-23618-1-1.html" target="_blank" rel="noopener">[MOBFDevice duid] - BUG提交- Mob官方论坛</a>。文中指出<code>SDK 版本: ShareSDKVersion-3.5.1</code>。</p>
<p>好了看一下<code>ShareSDK</code>这个库。emmm 这个库是拖拽进去的。老哥说这项目接手之后没更新过这个库。</p>
<p>事已至此，确定是<code>ShareSDK</code>的问题。</p>
<p>更新之，问题解决～  真心的美滋滋～～</p>
<p>PS.</p>
<ul>
<li>上文中关于类簇的 Method Swizzling，详见<a href="http://www.tanhao.me/code/160723.html/" target="_blank" rel="noopener">Method Swizzling的各种姿势</a>。</li>
</ul>
<h2 id="寻找的过程部分特写"><a href="#寻找的过程部分特写" class="headerlink" title="寻找的过程部分特写"></a>寻找的过程部分特写</h2><p>上面的逻辑并不是一气呵成，而是由于粗心也走了部分弯路，特列出来引以为戒。</p>
<h3 id="看到全局断点真的走不到时"><a href="#看到全局断点真的走不到时" class="headerlink" title="看到全局断点真的走不到时"></a>看到全局断点真的走不到时</h3><p>由于代码是公司代码，也没有demo,所以布吉岛为啥确实断点不会走。。。</p>
<p>MMP 看到了<code>First throw call stack</code>之后第一反应是，这些地址应该可以还原到对应的位置。</p>
<p>然后想到了逆向里面的骚操作。顿时想逆向分析一下。。。</p>
<p>但由于看了一下<code>.app</code>中的可执行文件有 ** 40M ** ,算了算了，IDA载入的有点慢，这要好久才能分析完。。</p>
<p>想了想天要下雨，媳妇和娃都在外面。果断放弃分析一波的冲动，来<code>Method Swizzling</code>会更快。</p>
<h3 id="看走眼的-Method-Swizzling"><a href="#看走眼的-Method-Swizzling" class="headerlink" title="看走眼的 Method Swizzling"></a>看走眼的 Method Swizzling</h3><p>之前看过这个<a href="http://www.tanhao.me/code/160723.html/" target="_blank" rel="noopener">Method Swizzling的各种姿势</a>文章，印象深刻。</p>
<p>由于 ** Method Swizzling ** 风险不那么容易控制，所以并没用类簇相关的。</p>
<p>一顿<code>cmd c / cmd v</code>之后改了类名就扔了过去。当时大约这个样子：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)safe_hasPrefix:(<span class="built_in">NSString</span> *)str &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 此处会发生循环调用，是错误的示例</span></span><br><span class="line">        <span class="keyword">return</span> [(<span class="built_in">NSString</span> *)<span class="keyword">self</span> hasPrefix:str];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如我刚在上面的备注一样。</p>
<p>脑袋一热，这类簇会不会有别的坑，然后过分的自信忽略了<code>safe_</code>前缀，并写了个C的前缀比较：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)safe_hasPrefix:(<span class="built_in">NSString</span> *)str &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((<span class="built_in">NSString</span> *)<span class="keyword">self</span>).length &lt; str.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 此处逻辑并未经过很多的测试用例测试，只是临时修补。实际方案应该直接调用safe_hasPrefix</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *str1 = [str cStringUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *str2 = [(<span class="built_in">NSString</span> *)<span class="keyword">self</span> cStringUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> idx = str.length; idx &gt;= <span class="number">0</span>; idx--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str1[idx] != str2[idx]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一番梭哈之后，定位到了问题。</p>
<p>但是今天复盘的时候想到这个类簇的IMP正常的操作也不可能出现循环调用。。。。</p>
<p>然后发现昨天的一番梭哈真的是弱智。。惭愧惭愧。。。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><ul>
<li>解决问题的方案在于知识面的宽度。（一直为我没有通过<code>First throw call stack</code>直接定位而害羞）</li>
<li>着急下班的时候别写太多逻辑，容易漏。要么别着急，要么万分小心。</li>
<li>集成第三方SDK别瞎胡闹，使用代码直接集成(除非万不得已)。尽量使用<a href="https://cocoapods.org/" target="_blank" rel="noopener">CocoaPods</a>这样的工具。</li>
<li>代码中的 ** warning ** 记得消一下。成天<code>999+</code> 容易漏掉关键信息。</li>
<li>开发的第三方SDK一定要注意测试覆盖率。</li>
<li>swift大法好。swift不用<code>!</code>绝对不会有机会出现<code>func hasPrefix(_ str: String) -&gt; Bool</code>中参数<code>str</code>传空的可能 :)</li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>DEBUG</tag>
      </tags>
  </entry>
  <entry>
    <title>侧滑导航栏消失问题笔记</title>
    <url>/post/push-pop-navigation-bar-hidden/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>如果前页面和后页面不同，则会出现轻微侧滑时导航栏莫名其妙没了😂</p>
<p><a href="https://github.com/madordie/Demo-PushAndPop" target="_blank" rel="noopener">Demo-PushAndPop</a></p>
<a id="more"></a>

<h2 id="Demo-PushAndPop"><a href="#Demo-PushAndPop" class="headerlink" title="Demo-PushAndPop"></a>Demo-PushAndPop</h2><p>[已解决] 隐藏导航栏+改变状态栏样式时出现导航栏莫名其妙没了</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p><img src="https://github.com/madordie/Demo-PushAndPop/blob/master/Untitled.gif?raw=true" alt="snapshot"></p>
<p>当<code>ViewController.swift</code>实现</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">var</span> preferredStatusBarStyle: <span class="type">UIStatusBarStyle</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> .lightContent</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>时，两个<code>ViewController</code>对应的<code>UIStatusBarStyle</code>不同，则会出现如上图。<code>UIStatusBarStyle</code>一致则正常。</p>
<h2 id="解决关键"><a href="#解决关键" class="headerlink" title="解决关键"></a>解决关键</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NavigationController</span>: <span class="title">UINavigationController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> childViewControllerForStatusBarStyle: <span class="type">UIViewController?</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> topViewController</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只需要将<code>childViewControllerForStatusBarStyle</code>设置为<code>UINavigationController.topViewController</code>即可。</p>
<h2 id="另外"><a href="#另外" class="headerlink" title="另外"></a>另外</h2><p>附上<code>BViewController</code>中相关代码。在切换的两个<code>UIViewController</code>的<code>preferredStatusBarStyle</code>一样时，不需要设置<code>UINavigationController.childViewControllerForStatusBarStyle</code>。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> navigationBarHidden = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewWillAppear(animated)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> navigationController = navigationController  <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> navigationController.isNavigationBarHidden != navigationBarHidden &#123;</span><br><span class="line">            navigationController.setNavigationBarHidden(navigationBarHidden, animated: animated)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillDisappear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewWillDisappear(animated)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> navigationController = navigationController  <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> last = navigationController.viewControllers.last <span class="keyword">as</span>? <span class="type">BViewController</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> last.navigationBarHidden != navigationBarHidden &#123;</span><br><span class="line">            navigationController.setNavigationBarHidden(last.navigationBarHidden, animated: animated)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><ul>
<li>@木头 <code>viewWillAppear</code>更换为<code>viewDidAppear</code>然后调试，在Demo中测试也可以曲线救国。</li>
<li>@Harry 提供的终极大法～</li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>DEBUG</tag>
      </tags>
  </entry>
  <entry>
    <title>如何快速查找ipa内的符号引用</title>
    <url>/post/how-to-quickly-find-symbol-references-in-ipa/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote>
<p>ITMS-90809: Deprecated API Usage - Apple will stop accepting submissions of apps that use UIWebView APIs . See <a href="https://developer.apple.com/documentation/uikit/uiwebview" target="_blank" rel="noopener">https://developer.apple.com/documentation/uikit/uiwebview</a> for more information.</p>
</blockquote>
<p>熟悉不?</p>
<a id="more"></a>

<h2 id="源码级别引用"><a href="#源码级别引用" class="headerlink" title="源码级别引用"></a>源码级别引用</h2><p>有些时候, 我们需要查找我们的<code>.ipa</code>里面什么地方使用了某个API, 而常规操作是在Xcode的<code>Navigation -&gt; Find</code>里面直接search一下就可以查到源码上哪些地方直接调用了该API.</p>
<p>而往往这种情况下可以解决问题的话就不会跑去<code>Google</code>了.</p>
<h2 id="二进制级别引用"><a href="#二进制级别引用" class="headerlink" title="二进制级别引用"></a>二进制级别引用</h2><p>APP总会通过各种手段集成些别人的第三方库, 而此库究竟干了什么我们一般并不能十分了解(如果能了解大概人家就开源了吧). 这个时候要如何查找这些库有没有使用某API该咋办呢?</p>
<h3 id="定位究竟有谁在包含"><a href="#定位究竟有谁在包含" class="headerlink" title="定位究竟有谁在包含"></a>定位究竟有谁在包含</h3><p>我们提交<code>App Store</code>都是打包成<code>.ipa</code>提交,所以我们先将<code>.ipa</code>重命名<code>.zip</code>并解压. 然后假设我们需要找的是<code>UIWebView</code>, <code>Terminal</code>搞开,到解压后的目录.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╭─Bingo@madordie xxx.app</span><br><span class="line">╰─&gt;$ find . -print0 | xargs -0 grep -s <span class="string">'UIWebView'</span></span><br></pre></td></tr></table></figure>

<p>便得到<code>xxx.app</code>内所有包含<code>UIWebView</code>字符的文件(包括Mach-O). 这个时候输出的行<code>Binary file ./XXXX/YYYY matches</code>即为匹配到了.</p>
<p>此时定位到<code>XXXX/YYYY</code>内含有<code>UIWebView</code>.</p>
<p>另外: 上述命令在项目主目录执行也可以搜索到, 只不过除了<code>Navigation -&gt; Find</code>里search的还有其他的, 内容如果多的话可以再用<code>grep</code>过滤一次.</p>
<p>比如只关心<code>Binary file</code>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╭─Bingo@madordie project-main-path</span><br><span class="line">╰─&gt;$ find . -print0 | xargs -0 grep -s <span class="string">'UIWebView'</span> | grep <span class="string">'^Binary'</span></span><br></pre></td></tr></table></figure>

<h3 id="这个API在Mach-O中是什么"><a href="#这个API在Mach-O中是什么" class="headerlink" title="这个API在Mach-O中是什么"></a>这个API在Mach-O中是什么</h3><h4 id="有字符串吗"><a href="#有字符串吗" class="headerlink" title="有字符串吗"></a>有字符串吗</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╭─Bingo@madordie xxx.app</span><br><span class="line">╰─&gt;$ strings ./XXXX/YYYY | grep <span class="string">'UIWebView'</span></span><br><span class="line">T@<span class="string">"UIWebView"</span>,R,N,V_webView</span><br><span class="line">UIWebViewDelegate</span><br><span class="line">B40@0:8@<span class="string">"UIWebView"</span>16@<span class="string">"NSURLRequest"</span>24q32</span><br><span class="line">v24@0:8@<span class="string">"UIWebView"</span>16</span><br><span class="line">v32@0:8@<span class="string">"UIWebView"</span>16@<span class="string">"NSError"</span>24</span><br><span class="line">@<span class="string">"UIWebView"</span></span><br></pre></td></tr></table></figure>

<h4 id="有symbol吗"><a href="#有symbol吗" class="headerlink" title="有symbol吗"></a>有symbol吗</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">╭─Bingo@madordie xxx.app</span><br><span class="line">╰─&gt;$ nm ./XXXX/YYYY | grep <span class="string">'UIWebView'</span></span><br><span class="line">                 U _OBJC_CLASS_<span class="variable">$_UIWebView</span></span><br></pre></td></tr></table></figure>

<h3 id="值得说一下"><a href="#值得说一下" class="headerlink" title="值得说一下"></a>值得说一下</h3><p>通过上面的操作基本上可以检索出来App Store查到的API, 但是说其他的字符串拼接/加密的方案去绕过的话,那么就问问作者吧…</p>
<p>真不行使用逆向分析工具去分析也可以. 但是个人觉得稍微有点大材小用 :)</p>
<p>上面使用的命令的文档均可通过<code>man xxx</code>、<code>xxx --help</code>、Google等方式查询就不啰嗦了.</p>
<h3 id="UIWebView的废弃通告"><a href="#UIWebView的废弃通告" class="headerlink" title="UIWebView的废弃通告"></a>UIWebView的废弃通告</h3><p><a href="https://developer.apple.com/cn/news/?id=12232019b" target="_blank" rel="noopener">更新使用网页视图的 App</a></p>
<blockquote>
<p>更新使用网页视图的 App<br>2019 年 12 月 23 日</p>
<p>如果您的 app 仍在使用已弃用的 UIWebView API 嵌入网络内容，我们强烈建议您尽快更新为 WKWebView 以提升安全性和稳定性。WKWebView 可将网页处理限制在 app 的网页视图中，从而确保不安全的网站内容不会影响到 app 的其他部分。此外，iOS、macOS 和 Mac Catalyst 均支持 WKWebView。</p>
<p>2020 年 4 月起 App Store 将不再接受使用 UIWebView 的新 app，2020 年 12 月起将不再接受使用 UIWebView 的 app 更新。</p>
</blockquote>
]]></content>
      <categories>
        <category>iOS</category>
        <category>macOS</category>
      </categories>
      <tags>
        <tag>DEBUG</tag>
        <tag>tool</tag>
      </tags>
  </entry>
  <entry>
    <title>如何正确的连续推新页面</title>
    <url>/post/push-queue-for-navigation/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="题记"><a href="#题记" class="headerlink" title="题记"></a>题记</h2><p>当使用某个页面还没有进行viewDidAppear:的时候再进行一次推页面是不安全的。苹果在iPhone5C iOS7.1.2中Push时给出的警告：</p>
<blockquote>
<p>“nested push animation can result in corrupted navigation bar. Finishing up a navigation transition in an unexpected state. Navigation Bar subview tree might get corrupted.”</p>
</blockquote>
<p>这说明这个不安全的操作可能会导致应用Crash，Crash统计系统统计的原因为：</p>
<blockquote>
<p>“Can’t add self as subview”。</p>
</blockquote>
<p>本文尝试解决该Crash，实现嵌套安全的去推页面。</p>
<a id="more"></a>

<h2 id="问题所在"><a href="#问题所在" class="headerlink" title="问题所在"></a>问题所在</h2><p>苹果给出的警告中指出嵌套推页面可能导致导航栏损坏，其导航栏子视图树可能损坏。也就是说当我对VC1进行Push出VC2时候要注意，必须要等到VC1显示周期完全结束，才能进行PushVC2操作。</p>
<p>此问题的发生并不是简单的一个代码块中使用同一个导航控制器进行连续Push操作。回想一下<code>ViewController</code>的生命周期。其实标志着<code>ViewController</code>完全显示的是<code>viewDidAppear:</code>调用，那么在此方法生命周期之前的方法中进行Push均有可能造成“nested push animation can result in corrupted navigation bar”。</p>
<p>由于iOS7.1.2的iPhone5C被升级，无法必现此BUG，所以没有截图。可以自己找个测一下。。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="方案一：通过延时避开此时间段。"><a href="#方案一：通过延时避开此时间段。" class="headerlink" title="方案一：通过延时避开此时间段。"></a>方案一：通过延时避开此时间段。</h3><p>在很多源码中会看到这样一行代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;  0.1是我随手写的。。是一个根据自己情况估算上一个PUSH的耗时，</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    [self.navigationController pushViewController:vc animated:YES];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如上代码，在<a href="https://github.com/search?utf8=%E2%9C%93&q=dispatch_after+pushViewController%253A&type=Code&ref=searchresults" target="_blank" rel="noopener">GitHub中很常见</a>，起初并不懂其用意，当遇到这个问题时候我才明白。</p>
<p>还有一种代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;  objccn.io</span><br><span class="line">dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    &#x2F;&#x2F; Some UIKit call that had timing issues but works fine</span><br><span class="line">    &#x2F;&#x2F; in the next runloop.</span><br><span class="line">    [self updatePopoverSize];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这种代码是切换到下个代码周期，来避开嵌套的时序问题。<a href="https://objccn.io/issue-2-4/" target="_blank" rel="noopener">objc.io</a>有这么个文章说了这个问题的弊端：</p>
<blockquote>
<p>用 <code>dispatch_async</code> 修复时序问题</p>
</blockquote>
<blockquote>
<p>在使用 UIKit 的时候遇到了一些时序上的麻烦？很多时候，这样进行“修正”看来非常完美：</p>
</blockquote>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">   &#x2F;&#x2F; Some UIKit call that had timing issues but works fine</span><br><span class="line">   &#x2F;&#x2F; in the next runloop.</span><br><span class="line">   [self updatePopoverSize];</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>
<p>千万别这么做！相信我，这种做法将会在之后你的 app 规模大一些的时候让你找不着北。这种代码非常难以调试，并且你很快就会陷入用更多的 dispatch 来修复所谓的莫名其妙的”时序问题”。审视你的代码，并且找到合适的地方来进行调用（比如在 viewWillAppear 里调用，而不是 viewDidLoad 之类的）才是解决这个问题的正确做法。我在自己的代码中也还留有一些这样的 hack，但是我为它们基本都做了正确的文档工作，并且对应的 issue 也被一一记录过。</p>
</blockquote>
<p>记住这不是真正的 <code>GCD</code> 特性，而只是一个在 <code>GCD</code> 下很容易实现的常见反面模式。事实上你可以使用 <code>performSelector:afterDelay:</code> 方法来实现同样的操作，其中 <code>delay</code> 是在对应时间后的 <code>runloop</code>。</p>
<p>其实这样设计很简单，目的就是通过<code>GCD</code>的延迟提交来“巧妙”的避开Push的时间，很显然这个时间对于机型、系统版本、当前手机状况来说很难把握。但是不得不说的是确实有些作用，那就是能避开部分问题。所以本来小概率发生的事情，这个再过滤一些，这个BUG就微乎其微了。</p>
<h3 id="方案二：强制在viewDidAppear-之后进行Push。"><a href="#方案二：强制在viewDidAppear-之后进行Push。" class="headerlink" title="方案二：强制在viewDidAppear:之后进行Push。"></a>方案二：强制在<code>viewDidAppear:</code>之后进行Push。</h3><p>不得不说这样的做法我曾经用过一个页面，不多说，麻烦程度自己测一下。</p>
<p>如果说多人合作项目呢，如果说页面比较多、工作比较忙呢？呵呵哒</p>
<h3 id="方案三：对UINavigationController所Push的VC进行队列化。"><a href="#方案三：对UINavigationController所Push的VC进行队列化。" class="headerlink" title="方案三：对UINavigationController所Push的VC进行队列化。"></a>方案三：对<code>UINavigationController</code>所Push的VC进行队列化。</h3><p>对于VC是否已经Push结束，<code>UINavigationController</code>最清楚，而这一结果刚好通过代理传递出来。所以可以利用这一点对Push的VCs进行队列化，防止其进行嵌套Push。</p>
<p>那么问题就可以得到很好的解决。</p>
<p>对 方案三 的详细封装</p>
<p>对于该问题的最简单的、便于合作、便于更改的就是方案三了，对方案三进行展开可得如下步骤：</p>
<p>设置<code>UINavigationController</code>的代理，并实现<code>willShowViewController</code>、<code>didShowViewController</code>方法。</p>
<p>拦截到<code>UINavigationController</code>的Push方法，通过步骤1的代理判断到是否正在Show,如果不在Show则显示，如果正在Show则把当前的VC入队列。<br>在didShowViewController中判断队列中是否有数据，如果有则说明发生了重叠，该队列中第一个进行Push。<br>为了更好的兼容所遇到的Push情况，使用0.5秒作为兜底，对队列进行放开。<br>结束，就是这样子。</p>
<p>说下我实现的方法，其实重点在于如何拦截Push操作。</p>
<p>我最开始采用了继承<code>UINavigationController</code>的方法，因为继承但一，不会干扰其他的类。值得一赞。</p>
<p>对于要解决其问题，所有的都需要进行继承，过于麻烦，于是增加了第二种方案：HOOK。</p>
<p>两种方案为了达到统一的效果，所以拉出其中的代理，就完成了统一。</p>
<p><a href="https://github.com/madordie/KTJPushQueueForNavigation.git" target="_blank" rel="noopener">代码＋Demo</a></p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>debug</tag>
      </tags>
  </entry>
  <entry>
    <title>如何实现AppStore查看更多的方法</title>
    <url>/post/appstore-truncate/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="UITextView-More"><a href="#UITextView-More" class="headerlink" title="UITextView-More"></a><a href="https://github.com/madordie/UITextView-More" target="_blank" rel="noopener">UITextView-More</a></h2><p>使用UITextKit 实现“更多”的折叠效果</p>
<p><img src="https://github.com/madordie/UITextView-More/blob/master/Untitled.gif?raw=true" alt="预览"></p>
<a id="more"></a>

<h2 id="主要代码"><a href="#主要代码" class="headerlink" title="主要代码"></a>主要代码</h2><h3 id="获取最后一行Rect"><a href="#获取最后一行Rect" class="headerlink" title="获取最后一行Rect"></a>获取最后一行Rect</h3><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> lastRect = <span class="type">CGRect</span>.zero</span><br><span class="line">layoutManager.enumerateEnclosingRects(forGlyphRange: <span class="type">NSRange</span>(location: <span class="number">0</span>, length: textStorage.string.characters.<span class="built_in">count</span>), withinSelectedGlyphRange: <span class="type">NSRange</span>(location: <span class="type">NSNotFound</span>, length: <span class="number">0</span>), <span class="keyword">in</span>: textContainer, using: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] (rect, isStop) <span class="keyword">in</span></span><br><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> _self = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"><span class="keyword">var</span> newRect = rect</span><br><span class="line">newRect.origin.y += _self.textContainerInset.top</span><br><span class="line">lastRect = newRect</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">print</span>(lastRect)</span><br></pre></td></tr></table></figure>

<h3 id="增加-exclusionPaths"><a href="#增加-exclusionPaths" class="headerlink" title="增加 exclusionPaths"></a>增加 <code>exclusionPaths</code></h3><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">textContainer.exclusionPaths = [<span class="type">UIBezierPath</span>.<span class="keyword">init</span>(rect: rect)]</span><br></pre></td></tr></table></figure>

<h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h2><ul>
<li><code>UITextView</code>默认携带左右边距，通过<code>UITextView.textContainer.lineFragmentPadding</code>获取</li>
<li><code>UITextView</code>默认携带上下左右边距(<code>UITextView.textContainerInset</code>)，其中左右和<code>lineFragmentPadding</code>相加</li>
<li>此处并没有对<a href="https://github.com/madordie/UITextView-More/blob/master/TruncateTextView.swift" target="_blank" rel="noopener">TruncateTextView</a>进行过多的设置，主要是因为继承在UITextView下，<a href="https://github.com/madordie/UITextView-More/blob/master/Untitled.gif" target="_blank" rel="noopener">GIF</a>中的这部分设置放在了<a href="https://github.com/madordie/UITextView-More/blob/master/Demo-AppStore-More/ViewController.swift" target="_blank" rel="noopener">ViewController.swift</a>中</li>
<li>此处使用的是<code>frame</code>，可以在<code>UIView.sizeToFit()</code>之后获取到<code>UIView</code>的<code>Size</code>。约束也大抵如此</li>
</ul>
<hr>
<ul>
<li>感谢<a href="https://github.com/lexiaoyao20" target="_blank" rel="noopener">乐逍遥</a>提供的例子，才找到了<code>open func truncatedGlyphRange(inLineFragmentForGlyphAt glyphIndex: Int) -&gt; NSRange</code>方法😂</li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>效果</tag>
      </tags>
  </entry>
  <entry>
    <title>Swift 编译时性能优化笔记</title>
    <url>/post/swift-build-times/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Xcode在编译Swift代码的时候速度会越来越慢，就此查找原因，并列出自己的优化思路。</p>
<a id="more"></a>

<h3 id="Xcode8-2"><a href="#Xcode8-2" class="headerlink" title="Xcode8.2"></a>Xcode8.2</h3><p>添加<code>User-Defind</code>新的<code>SWIFT_WHOLE_MODULE_OPTIMIZATION = YES</code>可以过滤为修改framework。</p>
<h3 id="针对运算符-的优化"><a href="#针对运算符-的优化" class="headerlink" title="针对运算符??的优化"></a>针对运算符<code>??</code>的优化</h3><p>在使用<code>??</code>时，并不是所有的都需要优化，包裹在循环中的<code>??</code>会比较耗时比较厉害，目前不知道为啥，估计编译的时候需要检查的此时比较多吧😂。</p>
<h4 id="尝试显式解包"><a href="#尝试显式解包" class="headerlink" title="尝试显式解包"></a>尝试显式解包</h4><p><strong>思路__：<code>??</code>编译慢，就不用<code>??</code>，直接使用<code>if else</code><br>__实施</strong>: 由于工程中使用的<code>??</code>比较多，所以比较修改起来比较麻烦。但是可以解决问题。真不行写方法转化调用喽。。</p>
<h4 id="错误的尝试了重载运算符-方式"><a href="#错误的尝试了重载运算符-方式" class="headerlink" title="错误的尝试了重载运算符??方式"></a>错误的尝试了重载运算符<code>??</code>方式</h4><p><strong>思路</strong>: <code>??</code>运算符编译耗时较多，直觉是<code>??</code>实现有复杂的操作,重新按照显式解包的方案进行实现。<br><strong>实施</strong>: </p>
<ul>
<li>分析<code>??</code>的使用场景，左侧为T?,右侧为T，返回值T</li>
<li>重载函数名定义<code>public func ?? &lt;T&gt;(left: T?, right: T) -&gt; T</code></li>
<li>实现</li>
<li>编译</li>
<li>error：<code>Ambiguous use of operator &#39;??&#39;</code></li>
<li>思考：这丫的在重载运算符的时候不能使用泛型吧。。</li>
<li>更改函数为<code>public func ?? &lt;Any&gt;(left: Any?, right: Any) -&gt; Any</code></li>
<li>PL. OK了，可是问题来了，系统的<code>??</code>是可以返回对应的类型，可是这样重载之后返回一个<code>Any</code>，代码中如果出现<code>let str = str1 ?? &quot;&quot;</code>则str类型就变为<code>Any</code>而不是<code>String</code>。<strong>巨坑</strong></li>
<li>顾不了那么多了，真不行一个一个跑。于是先修改一个较为严重的<code>String</code>类型。</li>
<li>尝试编译，结果时间惊人的没有变化。。依旧居高不下</li>
<li>以失败告终。。</li>
</ul>
<p><strong>总结</strong>: 这个<code>??</code>耗时较多并不是因为<code>??</code>的实现有问题，__猜测__是在为<code>??</code>准备左右参数的时候需要进行一层层的解包确定类型，再加上<code>??</code>可能有重载版本，进行类型匹配的时候比较耗时。</p>
<h4 id="尝试扩展方法进行优化"><a href="#尝试扩展方法进行优化" class="headerlink" title="尝试扩展方法进行优化"></a>尝试扩展方法进行优化</h4><p><strong>思路</strong>: 既然运算符会导致编译慢，那么就尝试使用方法直接进行转换。<br><strong>实现</strong>: 代码如下：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Operator</span> </span>&#123;</span><br><span class="line">    <span class="comment">///  ==&gt; ??</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> `<span class="title">try</span>`&lt;T&gt;<span class="params">(<span class="number">_</span> origin: T?, <span class="number">_</span> then: T)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> value = origin <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> then</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试发现上述方法可以优化时间。</p>
<hr>
<h3 id="以下原文出自：关于-Swift-编译时性能优化的一些思考"><a href="#以下原文出自：关于-Swift-编译时性能优化的一些思考" class="headerlink" title="以下原文出自：关于 Swift 编译时性能优化的一些思考"></a>以下原文出自：<a href="https://github.com/yllziv/gold-miner/blob/1bfbb3deefd27138097415422bec2bb7e98e9715/TODO/regarding-swift-build-time-optimizations.md" target="_blank" rel="noopener">关于 Swift 编译时性能优化的一些思考</a></h3><hr>
<blockquote>
<ul>
<li>原文链接 : <a href="https://medium.com/@RobertGummesson/regarding-swift-build-time-optimizations-fc92cdd91e31#.w81y3zhjr" target="_blank" rel="noopener">Regarding Swift build time optimizations</a></li>
</ul>
</blockquote>
<ul>
<li>原文作者 : <a href="https://medium.com/@RobertGummesson" target="_blank" rel="noopener">Robert Gummesson</a></li>
<li>译文出自 : <a href="https://github.com/xitu/gold-miner" target="_blank" rel="noopener">掘金翻译计划</a></li>
<li>译者 : <a href="http://www.yanglonglong.com/" target="_blank" rel="noopener">杨龙龙</a></li>
<li>校对者: <a href="https://github.com/shenAlexy" target="_blank" rel="noopener">申冠华</a>, <a href="https://github.com/Jack-Kingdom" target="_blank" rel="noopener">Jack King</a></li>
</ul>
<p><img src="http://ww3.sinaimg.cn/large/005SiNxygw1f3p3jimjllj31jk0dwqft.jpg"></p>
<h4 id="关于-Swift-编译时性能优化的一些思考"><a href="#关于-Swift-编译时性能优化的一些思考" class="headerlink" title="关于 Swift 编译时性能优化的一些思考"></a>关于 Swift 编译时性能优化的一些思考</h4><p>上周，我读了 <a href="https://medium.com/@nickoneill" target="_blank" rel="noopener">@nickoneill</a> 一篇优秀的帖子 <a href="https://medium.com/swift-programming/speeding-up-slow-swift-build-times-922feeba5780#.k0pngnkns" target="_blank" rel="noopener">Speeding Up Slow Swift Build Times</a> 之后，我发现用一个略不同以往的角度去读Swift代码，并不是很难。</p>
<p>一行之前很简洁的代码，现在却出现了新的问题——它是否应该重构为9行代码来达到更快的编译速度？ (<em>nil coalescing 运算符就是一个例子</em>)孰轻孰重？简洁的代码还是对编译器友好的代码？ 我觉得，它取决于项目的大小和开发者的想法。</p>
<h4 id="但请等等…-这里有一个Xcode插件"><a href="#但请等等…-这里有一个Xcode插件" class="headerlink" title="但请等等… 这里有一个Xcode插件"></a>但请等等… 这里有一个Xcode插件</h4><p>在讲一些例子之前，我首先想到了通过手工提取日志信息是非常耗时的事情。通过命令行工具实现会相对容易一些，但是我把它往前推进了一步：集成为<a href="https://github.com/RobertGummesson/BuildTimeAnalyzer-for-Xcode" target="_blank" rel="noopener">Xcode插件</a>。</p>
<p><img src="http://ww1.sinaimg.cn/large/005SiNxygw1f3p3hhivppj30m809lwis.jpg"></p>
<p>在这个例子中，最初的目的仅仅是识别并修复代码中最耗时的地方，但是现在我觉得它成为了一个必须要迭代的过程。这样我才可以更加高效地构建代码，并且防止在项目中出现耗时的函数。</p>
<h4 id="不少惊喜"><a href="#不少惊喜" class="headerlink" title="不少惊喜"></a>不少惊喜</h4><p>我经常在不同的 Git 分支中跳转，并且等待一个暖慢的项目编译简直是在浪费我的生命。因此我思考了很长时间，一个玩具项目（大约两万行 Swift 代码）会编译如此长的时间。</p>
<p>当我知道是什么原因导致它如此慢之后，我不得不承认我震惊了，一行代码居然需要几秒的编译时间。</p>
<p>让我们来看几个例子。</p>
<h4 id="Nil-合并运算符"><a href="#Nil-合并运算符" class="headerlink" title="Nil 合并运算符"></a>Nil 合并运算符</h4><p>编译器肯定不喜欢这里的第一种方法。在展开下面两处简写的代码之后，构建时间减少了 **99.4%**。</p>
<pre><code>// 构建时间： 5238.3ms
return CGSize(width: size.width + (rightView?.bounds.width ?? 0) + (leftView?.bounds.width ?? 0) + 22, height: bounds.height)

// 构建时间： 32.4ms
var padding: CGFloat = 22
if let rightView = rightView {
    padding += rightView.bounds.width
}

if let leftView = leftView {
    padding += leftView.bounds.width
}
return CGSizeMake(size.width + padding, bounds.height)</code></pre>
<h4 id="ArrayOfStuff-Stuff"><a href="#ArrayOfStuff-Stuff" class="headerlink" title="ArrayOfStuff + [Stuff]"></a>ArrayOfStuff + [Stuff]</h4><p>这个看起来像下面这样：</p>
<pre><code>return ArrayOfStuff + [Stuff]  
// 而不是  
ArrayOfStuff.append(stuff)  
return ArrayOfStuff</code></pre>
<p>我经常这么做，并且它影响了每次构建的时间。下面是最糟糕的一个例子，改写后构建时间可以减少 **97.9%**。</p>
<pre><code>// 构建时间： 1250.3ms
let systemOptions = [ 7, 14, 30, -1 ]
let systemNames = (0...2).map{ String(format: localizedFormat, systemOptions[$0]) } + [NSLocalizedString(&quot;everything&quot;, comment: &quot;&quot;)]
// Some code in-between 
labelNames = Array(systemNames[0..&lt;count]) + [systemNames.last!]

// 构建时间： 25.5ms
let systemOptions = [ 7, 14, 30, -1 ]
var systemNames = systemOptions.dropLast().map{ String(format: localizedFormat, $0) }
systemNames.append(NSLocalizedString(&quot;everything&quot;, comment: &quot;&quot;))
// Some code in-between
labelNames = Array(systemNames[0..&lt;count])
labelNames.append(systemNames.last!)</code></pre>
<h4 id="三元运算符"><a href="#三元运算符" class="headerlink" title="三元运算符"></a>三元运算符</h4><p>仅仅是通过替换三元运算符为 if else 语句就能减少 <strong>92.9%</strong> 的构建时间。如果使用一个for循环替换 <em>map</em> 函数，它又能减少另一个 75%（但是我的眼睛可就受不了咯😉）。</p>
<pre><code>// 构建时间： 239.0ms
let labelNames = type == 0 ? (1...5).map{type0ToString($0)} : (0...2).map{type1ToString($0)}

// 构建时间： 16.9ms
var labelNames: [String]
if type == 0 {
    labelNames = (1...5).map{type0ToString($0)}
} else {
    labelNames = (0...2).map{type1ToString($0)}
}</code></pre>
<h4 id="转换-CGFloat-到-CGFloat"><a href="#转换-CGFloat-到-CGFloat" class="headerlink" title="转换 CGFloat 到 CGFloat"></a>转换 CGFloat 到 CGFloat</h4><p>这里我所说的并不一定正确。变量已经使用了 CGFloat 并且有一些括号也是多余的。在清理了这些冗余之后，构建时间能减少 **99.9%**。</p>
<pre><code>// 构建时间： 3431.7 ms
return CGFloat(M_PI) * (CGFloat((hour + hourDelta + CGFloat(minute + minuteDelta) / 60) * 5) - 15) * unit / 180

// 构建时间： 3.0ms
return CGFloat(M_PI) * ((hour + hourDelta + (minute + minuteDelta) / 60) * 5 - 15) * unit / 180</code></pre>
<h4 id="Round"><a href="#Round" class="headerlink" title="Round()"></a>Round()</h4><p>这个一个非常奇怪的例子，下面的例子中变量是一个局部变量与实例变量的混合。这个问题可能不是四舍五入本身，而是结合代码的方法。去掉四舍五入的方法大概能减少 <strong>97.6%</strong> 的构建时间。</p>
<pre><code>// 构建时间： 1433.7ms
let expansion = a — b — c + round(d * 0.66) + e
// 构建时间： 34.7ms
let expansion = a — b — c + d * 0.66 + e</code></pre>
<p>注意：所有的测试都在 MacBook Air (13-inch, Mid 2013)中进行。</p>
<h4 id="尝试它"><a href="#尝试它" class="headerlink" title="尝试它"></a>尝试它</h4><p>无论你是否面临过构建时间太长的问题，编写对编译器友好的代码都是非常有用的。我确定你自己会在其中找到一些惊喜。作为参考，这里有完整的代码，在我的工程中可以5秒内完成编译…</p>
<pre><code>import UIKit

class CMExpandingTextField: UITextField {

    func textFieldEditingChanged() {
        invalidateIntrinsicContentSize()
    }

    override func intrinsicContentSize() -&gt; CGSize {
        if isFirstResponder(), let text = text {
            let size = text.sizeWithAttributes(typingAttributes)
            return CGSize(width: size.width + (rightView?.bounds.width ?? 0) + (leftView?.bounds.width ?? 0) + 22, height: bounds.height)
        }
        return super.intrinsicContentSize()
    }
}</code></pre>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>RxSwift语法笔记</title>
    <url>/post/rx-dictionary/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>记录RxSwift在使用过程中的一些常用语法。</p>
<a id="more"></a>

<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>按照<a href="https://blog.callmewhy.com/2015/09/21/rxswift-getting-started-0/" target="_blank" rel="noopener">RxSwift 入坑手册 Part0 - 基础概念</a>格式进行补充。</p>
<h2 id="SupportCode"><a href="#SupportCode" class="headerlink" title="SupportCode"></a>SupportCode</h2><p>在进入正题之前，先看下项目里的 <code>SupportCode.swift</code> ，主要为 <code>playground</code> 提供了两个便利函数。</p>
<p>一个是 <code>example</code> 函数，专门用来写示例代码的，统一输出 log 便于标记浏览，同时还能保持变量不污染全局：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">example</span><span class="params">(description: String, action: <span class="params">()</span></span></span> -&gt; ()) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n--- \(description) example ---"</span>)</span><br><span class="line">    action()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一个是 <code>delay</code> 函数，通过 <code>dispatch_after</code> 用来演示延时的：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">delay</span><span class="params">(delay:Double, closure:<span class="params">()</span></span></span>-&gt;()) &#123;</span><br><span class="line">    dispatch_after(</span><br><span class="line">        dispatch_time(</span><br><span class="line">            <span class="type">DISPATCH_TIME_NOW</span>,</span><br><span class="line">            <span class="type">Int64</span>(delay * <span class="type">Double</span>(<span class="type">NSEC_PER_SEC</span>))</span><br><span class="line">        ),</span><br><span class="line">        dispatch_get_main_queue(), closure)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>主要介绍了 Rx 的基础： <code>Observable</code> 。 <code>Observable&lt;Element&gt;</code> 是观察者模式中被观察的对象，相当于一个事件序列 (<code>GeneratorType</code>) ，会向订阅者发送新产生的事件信息。事件信息分为三种：</p>
<ul>
<li>Next(value) 表示新的事件数据。</li>
<li>Completed 表示事件序列的完结。</li>
<li>Error 同样表示完结，但是代表异常导致的完结。<br>（打个岔：协议命名，想起来上午汤哥在微博说的一段话：</li>
</ul>
<blockquote>
<p>另外，我觉得 protocol 名字用形容词会更加语义分明，比如 Swift : Flyable, Killable, Visible。全用名词的话显得比较生硬，比如 Swift : Head, Wings, Ass。</p>
</blockquote>
<h3 id="empty"><a href="#empty" class="headerlink" title="empty"></a>empty</h3><p><code>empty</code> 是一个空的序列，它只发送 <code>.Completed</code> 消息。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"empty"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> emptySequence: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; = empty()</span><br><span class="line">    <span class="keyword">let</span> subscription = emptySequence</span><br><span class="line">        .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(event)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- empty example ---</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>


<h3 id="never"><a href="#never" class="headerlink" title="never"></a>never</h3><p><code>never</code> 是没有任何元素、也不会发送任何事件的空序列。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"never"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> neverSequence: <span class="type">Observable</span>&lt;<span class="type">String</span>&gt; = never()</span><br><span class="line">    <span class="keyword">let</span> subscription = neverSequence</span><br><span class="line">        .subscribe &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"This block is never called."</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--- never example ---</span><br></pre></td></tr></table></figure>
<h3 id="just"><a href="#just" class="headerlink" title="just"></a>just</h3><p><code>just</code> 是只包含一个元素的序列，它会先发送 <code>.Next(value)</code> ，然后发送 <code>.Completed</code> 。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"just"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> singleElementSequence = just(<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">let</span> subscription = singleElementSequence</span><br><span class="line">        .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(event)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- just example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">32</span>)</span><br><span class="line"><span class="type">Completed</span></span><br><span class="line">sequenceOf</span><br></pre></td></tr></table></figure>

<p><code>sequenceOf</code> 可以把一系列元素转换成事件序列。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"sequenceOf"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceOfElements<span class="comment">/* : Observable&lt;Int&gt; */</span> = sequenceOf(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">let</span> subscription = sequenceOfElements</span><br><span class="line">        .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(event)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- sequenceOf example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Completed</span></span><br><span class="line">from</span><br></pre></td></tr></table></figure>

<p><code>from</code> 是通过 <code>asObservable()</code> 方法把 Swift 中的序列 (<code>SequenceType</code>) 转换成事件序列。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"from"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceFromArray = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>].asObservable()</span><br><span class="line">    <span class="keyword">let</span> subscription = sequenceFromArray</span><br><span class="line">        .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(event)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- from example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">4</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">5</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p><code>create</code> 可以通过闭包创建序列，通过 <code>.on(e: Event)</code> 添加事件。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"create"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> myJust = &#123; (singleElement: <span class="type">Int</span>) -&gt; <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> create &#123; observer <span class="keyword">in</span></span><br><span class="line">            observer.on(.<span class="type">Next</span>(singleElement))</span><br><span class="line">            observer.on(.<span class="type">Completed</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="type">NopDisposable</span>.instance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> subscription = myJust(<span class="number">5</span>)</span><br><span class="line">        .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(event)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- create example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">5</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="failWith"><a href="#failWith" class="headerlink" title="failWith"></a>failWith</h3><p><code>failWith</code> 创建一个没有元素的序列，只会发送失败 (<code>.Error</code>) 事件。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"failWith"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> error = <span class="type">NSError</span>(domain: <span class="string">"Test"</span>, code: -<span class="number">1</span>, userInfo: <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">let</span> erroredSequence: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; = failWith(error)</span><br><span class="line">    <span class="keyword">let</span> subscription = erroredSequence</span><br><span class="line">        .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(event)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- failWith example ---</span><br><span class="line"><span class="type">Error</span>(<span class="type">Error</span> <span class="type">Domain</span>=<span class="type">Test</span> <span class="type">Code</span>=-<span class="number">1</span> <span class="string">"The operation couldn’t be completed. (Test error -1.)"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="deferred"><a href="#deferred" class="headerlink" title="deferred"></a>deferred</h3><p><code>deferred</code> 会等到有订阅者的时候再通过工厂方法创建 <code>Observable</code> 对象，每个订阅者订阅的对象都是内容相同而完全独立的序列。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"deferred"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> deferredSequence: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; = deferred &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"creating"</span>)</span><br><span class="line">        <span class="keyword">return</span> create &#123; observer <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"emmiting"</span>)</span><br><span class="line">            observer.on(.<span class="type">Next</span>(<span class="number">0</span>))</span><br><span class="line">            observer.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">            observer.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="type">NopDisposable</span>.instance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"go"</span>)</span><br><span class="line">    deferredSequence</span><br><span class="line">        .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(event)</span><br><span class="line">    &#125;</span><br><span class="line">    deferredSequence</span><br><span class="line">        .subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(event)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- deferred example ---</span><br><span class="line">go</span><br><span class="line">creating</span><br><span class="line">emmiting</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line">creating</span><br><span class="line">emmiting</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>为什么需要 <code>defferd</code> 这样一个奇怪的家伙呢？其实这相当于是一种延时加载，因为在添加监听的时候数据未必加载完毕，例如下面这个例子：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"TestDeferred"</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> value: <span class="type">String?</span> = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">var</span> subscription: <span class="type">Observable</span>&lt;<span class="type">String?</span>&gt; = just(value)</span><br><span class="line">    <span class="comment">// got value</span></span><br><span class="line">    value = <span class="string">"Hello!"</span></span><br><span class="line">    subscription.subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(event)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="type">TestDeferred</span> example ---</span><br><span class="line"><span class="type">Next</span>(<span class="literal">nil</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<p>如果使用 <code>deffered</code> 则可以正常显示想要的数据：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"TestDeferred"</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> value: <span class="type">String?</span> = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">var</span> subscription: <span class="type">Observable</span>&lt;<span class="type">String?</span>&gt; = deferred &#123;</span><br><span class="line">        <span class="keyword">return</span> just(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// got value</span></span><br><span class="line">    value = <span class="string">"Hello!"</span></span><br><span class="line">    subscription.subscribe &#123; event <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(event)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="type">TestDeferred</span> example ---</span><br><span class="line"><span class="type">Next</span>(<span class="type">Optional</span>(<span class="string">"Hello!"</span>))</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h2 id="Subjects"><a href="#Subjects" class="headerlink" title="Subjects"></a>Subjects</h2><p>接下来是关于 <code>Subject</code> 的内容。 <code>Subject</code> 可以看做是一种代理和桥梁。它既是订阅者又是订阅源，这意味着它既可以订阅其他 <code>Observable</code> 对象，同时又可以对它的订阅者们发送事件。</p>
<p>如果把 <code>Observable</code> 理解成不断输出事件的水管，那 <code>Subject</code> 就是套在上面的水龙头。它既怼着一根不断出水的水管，同时也向外面输送着新鲜水源。如果你直接用水杯接着水管的水，那可能导出来什么王水胶水完全把持不住；如果你在水龙头下面接着水，那你可以随心所欲的调成你想要的水速和水温。</p>
<p>（好吧上面一段文档里没有，是我瞎掰的，如果理解错了还望打脸(￣ε(#￣)☆╰╮(￣▽￣///))</p>
<p>在开始下面的代码之前，先定义一个辅助函数用于输出数据：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeSequenceToConsole</span>&lt;O: ObservableType&gt;<span class="params">(name: String, sequence: O)</span></span> &#123;</span><br><span class="line">    sequence</span><br><span class="line">        .subscribe &#123; e <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Subscription: \(name), event: \(e)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PublishSubject"><a href="#PublishSubject" class="headerlink" title="PublishSubject"></a>PublishSubject</h3><p><code>PublishSubject</code> 会发送订阅者从订阅之后的事件序列。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"PublishSubject"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> subject = <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    writeSequenceToConsole(<span class="string">"1"</span>, sequence: subject)</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"a"</span>))</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"b"</span>))</span><br><span class="line">    writeSequenceToConsole(<span class="string">"2"</span>, sequence: subject)</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"c"</span>))</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"d"</span>))</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="type">PublishSubject</span> example ---</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(a)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(b)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(<span class="built_in">c</span>)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(<span class="built_in">c</span>)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(d)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(d)</span><br></pre></td></tr></table></figure>

<h3 id="ReplaySubject"><a href="#ReplaySubject" class="headerlink" title="ReplaySubject"></a>ReplaySubject</h3><p><code>ReplaySubject</code> 在新的订阅对象订阅的时候会补发所有已经发送过的数据队列， <code>bufferSize</code> 是缓冲区的大小，决定了补发队列的最大值。如果 <code>bufferSize</code> 是1，那么新的订阅者出现的时候就会补发上一个事件，如果是2，则补两个，以此类推。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"ReplaySubject"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> subject = <span class="type">ReplaySubject</span>&lt;<span class="type">String</span>&gt;.create(bufferSize: <span class="number">1</span>)</span><br><span class="line">    writeSequenceToConsole(<span class="string">"1"</span>, sequence: subject)</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"a"</span>))</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"b"</span>))</span><br><span class="line">    writeSequenceToConsole(<span class="string">"2"</span>, sequence: subject)</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"c"</span>))</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"d"</span>))</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="type">ReplaySubject</span> example ---</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(a)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(b)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(b) <span class="comment">// 补了一个 b</span></span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(<span class="built_in">c</span>)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(<span class="built_in">c</span>)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(d)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(d)</span><br></pre></td></tr></table></figure>

<h3 id="BehaviorSubject"><a href="#BehaviorSubject" class="headerlink" title="BehaviorSubject"></a>BehaviorSubject</h3><p><code>BehaviorSubject</code> 在新的订阅对象订阅的时候会发送最近发送的事件，如果没有则发送一个默认值。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"BehaviorSubject"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> subject = <span class="type">BehaviorSubject</span>(value: <span class="string">"z"</span>)</span><br><span class="line">    writeSequenceToConsole(<span class="string">"1"</span>, sequence: subject)</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"a"</span>))</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"b"</span>))</span><br><span class="line">    writeSequenceToConsole(<span class="string">"2"</span>, sequence: subject)</span><br><span class="line">    subject.on(.<span class="type">Next</span>(<span class="string">"c"</span>))</span><br><span class="line">    subject.on(.<span class="type">Completed</span>)</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="type">BehaviorSubject</span> example ---</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(z)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(a)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(b)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(b)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(<span class="built_in">c</span>)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(<span class="built_in">c</span>)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Completed</span></span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h3><p><code>Variable</code> 是基于 <code>BehaviorSubject</code> 的一层封装，它的优势是：不会被显式终结。即：不会收到 <code>.Completed</code> 和 <code>.Error</code> 这类的终结事件，它会主动在析构的时候发送 <code>.Complete</code> 。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"Variable"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> variable = <span class="type">Variable</span>(<span class="string">"z"</span>)</span><br><span class="line">    writeSequenceToConsole(<span class="string">"1"</span>, sequence: variable)</span><br><span class="line">    variable.value = <span class="string">"a"</span></span><br><span class="line">    variable.value = <span class="string">"b"</span></span><br><span class="line">    writeSequenceToConsole(<span class="string">"2"</span>, sequence: variable)</span><br><span class="line">    variable.value = <span class="string">"c"</span></span><br><span class="line">&#125;</span><br><span class="line">--- <span class="type">Variable</span> example ---</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(z)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(a)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(b)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(b)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Next</span>(<span class="built_in">c</span>)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Next</span>(<span class="built_in">c</span>)</span><br><span class="line"><span class="type">Subscription</span>: <span class="number">1</span>, event: <span class="type">Completed</span></span><br><span class="line"><span class="type">Subscription</span>: <span class="number">2</span>, event: <span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h2 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h2><p>我们可以对序列做一些转换，类似于 <code>Swift</code> 中 <code>CollectionType</code> 的各种转换。在以前的坑中曾经提到过，可以参考：<a href="https://blog.callmewhy.com/2015/05/11/functional-reactive-programming-1/#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%9A%84%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">函数式的函数</a>。</p>
<h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p><code>map</code> 就是对每个元素都用函数做一次转换，挨个映射一遍。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"map"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> originalSequence = sequenceOf(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">    originalSequence</span><br><span class="line">        .<span class="built_in">map</span> &#123; $<span class="number">0</span> * <span class="number">2</span> &#125;</span><br><span class="line">        .subscribe &#123; <span class="built_in">print</span>($<span class="number">0</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="built_in">map</span> example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">4</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">6</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap"></a>flatMap</h3><p><code>map</code> 在做转换的时候很容易出现『升维』的情况，即：转变之后，从一个序列变成了一个序列的序列。</p>
<p>什么是『升维』？在集合中我们可以举这样一个例子，我有一个好友列表 <code>[p1, p2, p3]</code>，那么如果要获取我好友的好友的列表，可以这样做：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">myFriends.<span class="built_in">map</span> &#123; $<span class="number">0</span>.getFriends() &#125;</span><br></pre></td></tr></table></figure>
<p>结果就成了 <code>[[p1-1, p1-2, p1-3], [p2-1], [p3-1, p3-2]]</code> ，这就成了好友的好友列表的列表了。这就是一个『升维』的例子。</p>
<p>（以上内容文档中依旧没有，依旧是我瞎掰的，依旧欢迎有错误当面打脸(￣ε(#￣)☆╰╮(￣▽￣///))</p>
<p>在 <code>Swift</code> 中，我们可以用 <code>flatMap</code> 过滤掉 <code>map</code> 之后的 <code>nil</code> 结果。在 <code>Rx</code> 中， <code>flatMap</code> 可以把一个序列转换成一组序列，然后再把这一组序列『拍扁』成一个序列。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"flatMap"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceInt = sequenceOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">let</span> sequenceString = sequenceOf(<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"--"</span>)</span><br><span class="line">    sequenceInt</span><br><span class="line">        .flatMap &#123; int <span class="keyword">in</span></span><br><span class="line">            sequenceString</span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- flatMap example ---</span><br><span class="line"><span class="type">Next</span>(<span class="type">A</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="type">B</span>)</span><br><span class="line"><span class="type">Next</span>(--)</span><br><span class="line"><span class="type">Next</span>(<span class="type">A</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="type">B</span>)</span><br><span class="line"><span class="type">Next</span>(--)</span><br><span class="line"><span class="type">Next</span>(<span class="type">A</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="type">B</span>)</span><br><span class="line"><span class="type">Next</span>(--)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="scan"><a href="#scan" class="headerlink" title="scan"></a>scan</h3><p><code>scan</code> 有点像 <code>reduce</code> ，它会把每次的运算结果累积起来，作为下一次运算的输入值。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"scan"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceToSum = sequenceOf(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    sequenceToSum</span><br><span class="line">        .scan(<span class="number">0</span>) &#123; acum, elem <span class="keyword">in</span></span><br><span class="line">            acum + elem</span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- scan example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">6</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">10</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">15</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h2 id="Filtering"><a href="#Filtering" class="headerlink" title="Filtering"></a>Filtering</h2><p>除了上面的各种转换，我们还可以对序列进行过滤。</p>
<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p><code>filter</code> 只会让符合条件的元素通过。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"filter"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> subscription = sequenceOf(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>)</span><br><span class="line">        .<span class="built_in">filter</span> &#123;</span><br><span class="line">            $<span class="number">0</span> % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="built_in">filter</span> example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">4</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">6</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">8</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="distinctUntilChanged"><a href="#distinctUntilChanged" class="headerlink" title="distinctUntilChanged"></a>distinctUntilChanged</h3><p><code>distinctUntilChanged</code> 会废弃掉重复的事件。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"distinctUntilChanged"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> subscription = sequenceOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">        .distinctUntilChanged()</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- distinctUntilChanged example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">4</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="take"><a href="#take" class="headerlink" title="take"></a>take</h3><p><code>take</code> 只获取序列中的前 <code>n</code> 个事件，在满足数量之后会自动 <code>.Completed</code> 。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"take"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> subscription = sequenceOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">        .take(<span class="number">3</span>)</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- take example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="throttle-VS-debounce"><a href="#throttle-VS-debounce" class="headerlink" title="throttle VS. debounce"></a>throttle VS. debounce</h3><p><code>throttle</code> 和 <code>debounce</code> 目的都是控制某个时间段内事件序列的速度。但是又有差别：</p>
<ul>
<li><code>debounce</code> : <code>空闲控制</code>  空闲时间必须 <code>&gt;=</code> 固定的时间，事件序列才会被放行</li>
<li><code>throttle</code> : <code>频率控制</code>  事件序列满足 <code>1/delay</code> 才会被放行</li>
</ul>
<p>一般的按钮点击、用户输入、等都属于频率控制，应该使用 <code>throttle</code> 。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> searchResults = searchBar.rx.text.orEmpty</span><br><span class="line">    .throttle(<span class="number">0.3</span>, scheduler: <span class="type">MainScheduler</span>.instance)</span><br><span class="line">    .distinctUntilChanged()</span><br><span class="line">    .flatMapLatest &#123; query -&gt; <span class="type">Observable</span>&lt;[<span class="type">Repository</span>]&gt; <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> query.isEmpty &#123;</span><br><span class="line">            <span class="keyword">return</span> .just([])</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> searchGitHub(query)</span><br><span class="line">            .catchErrorJustReturn([])</span><br><span class="line">    &#125;</span><br><span class="line">    .observeOn(<span class="type">MainScheduler</span>.instance)</span><br></pre></td></tr></table></figure>

<h2 id="Combining"><a href="#Combining" class="headerlink" title="Combining"></a>Combining</h2><p>这部分是关于序列的运算，可以将多个序列源进行组合拼装成一个新的事件序列。</p>
<h3 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h3><p><code>startWith</code> 会在队列开始之前插入一个事件元素。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"startWith"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> subscription = sequenceOf(<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">        .startWith(<span class="number">3</span>)</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- startWith example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">4</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">5</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">6</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h3><p>如果存在两条事件队列，需要同时监听，那么每当有新的事件发生的时候，<code>combineLatest</code> 会将每个队列的最新的一个元素进行合并。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"combineLatest 1"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> intOb1 = <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> intOb2 = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    combineLatest(intOb1, intOb2) &#123;</span><br><span class="line">        <span class="string">"\($0) \($1)"</span></span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    intOb1.on(.<span class="type">Next</span>(<span class="string">"A"</span>))</span><br><span class="line">    intOb2.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    intOb1.on(.<span class="type">Next</span>(<span class="string">"B"</span>))</span><br><span class="line">    intOb2.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">&#125;</span><br><span class="line">--- combineLatest <span class="number">1</span> example ---</span><br><span class="line"><span class="type">Next</span>(<span class="type">A</span> <span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="type">B</span> <span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="type">B</span> <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><p><code>zip</code> 人如其名，就是合并两条队列用的，不过它会等到两个队列的元素一一对应地凑齐了之后再合并，正如<a href="http://weibo.com/mrgreenhand" target="_blank" rel="noopener">百折不撓的米斯特菜</a>所提醒的， <code>zip</code> 就像是拉链一样，两根拉链拉着拉着合并到了一根上：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"zip 1"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> intOb1 = <span class="type">PublishSubject</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> intOb2 = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    <span class="built_in">zip</span>(intOb1, intOb2) &#123;</span><br><span class="line">        <span class="string">"\($0) \($1)"</span></span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    intOb1.on(.<span class="type">Next</span>(<span class="string">"A"</span>))</span><br><span class="line">    intOb2.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    intOb1.on(.<span class="type">Next</span>(<span class="string">"B"</span>))</span><br><span class="line">    intOb1.on(.<span class="type">Next</span>(<span class="string">"C"</span>))</span><br><span class="line">    intOb2.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="built_in">zip</span> <span class="number">1</span> example ---</span><br><span class="line"><span class="type">Next</span>(<span class="type">A</span> <span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="type">B</span> <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><p><code>merge</code> 就是 <code>merge</code> 啦，把两个队列按照顺序组合在一起。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"merge 1"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> subject1 = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> subject2 = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    sequenceOf(subject1, subject2)</span><br><span class="line">        .merge()</span><br><span class="line">        .subscribeNext &#123; int <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(int)</span><br><span class="line">        &#125;</span><br><span class="line">    subject1.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    subject1.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">    subject2.on(.<span class="type">Next</span>(<span class="number">3</span>))</span><br><span class="line">    subject1.on(.<span class="type">Next</span>(<span class="number">4</span>))</span><br><span class="line">    subject2.on(.<span class="type">Next</span>(<span class="number">5</span>))</span><br><span class="line">&#125;</span><br><span class="line">--- merge <span class="number">1</span> example ---</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure>

<h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><p>当你的事件序列是一个事件序列的序列 (<code>Observable&lt;Observable&lt;T&gt;&gt;</code>) 的时候，（可以理解成二维序列？），可以使用 <code>switch</code> 将序列的序列平铺成一维，并且在出现新的序列的时候，自动切换到最新的那个序列上。和 <code>merge</code> 相似的是，它也是起到了将多个序列『拍平』成一条序列的作用。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"switchLatest"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> var1 = <span class="type">Variable</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">let</span> var2 = <span class="type">Variable</span>(<span class="number">200</span>)</span><br><span class="line">    <span class="comment">// var3 is like an Observable&lt;Observable&lt;Int&gt;&gt;</span></span><br><span class="line">    <span class="keyword">let</span> var3 = <span class="type">Variable</span>(var1)</span><br><span class="line">    <span class="keyword">let</span> d = var3</span><br><span class="line">        .switchLatest()</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    var1.value = <span class="number">1</span></span><br><span class="line">    var1.value = <span class="number">2</span></span><br><span class="line">    var1.value = <span class="number">3</span></span><br><span class="line">    var1.value = <span class="number">4</span></span><br><span class="line">    var3.value = var2</span><br><span class="line">    var2.value = <span class="number">201</span></span><br><span class="line">    var1.value = <span class="number">5</span></span><br><span class="line">    var3.value = var1</span><br><span class="line">    var2.value = <span class="number">202</span></span><br><span class="line">    var1.value = <span class="number">6</span></span><br><span class="line">&#125;</span><br><span class="line">--- switchLatest example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">4</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">200</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">201</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">5</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">6</span>)</span><br></pre></td></tr></table></figure>

<p>注意，虽然都是『拍平』，但是和 <code>flatmap</code> 是不同的， <code>flatmap</code> 是将一条序列变成另一条序列，而这变换过程会让维度变高，所以需要『拍平』，而 <code>switch</code> 是将本来二维的序列（序列的序列）拍平成了一维的序列。</p>
<h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h2><p>在事件序列中，遇到异常也是很正常的事情，有以下几种处理异常的手段。</p>
<h3 id="catchError"><a href="#catchError" class="headerlink" title="catchError"></a>catchError</h3><p><code>catchError</code> 可以捕获异常事件，并且在后面无缝接上另一段事件序列，丝毫没有异常的痕迹。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"catchError 1"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceThatFails = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> recoverySequence = sequenceOf(<span class="number">100</span>, <span class="number">200</span>)</span><br><span class="line">    sequenceThatFails</span><br><span class="line">        .catchError &#123; error <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> recoverySequence</span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    sequenceThatFails.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    sequenceThatFails.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">    sequenceThatFails.on(.<span class="type">Error</span>(<span class="type">NSError</span>(domain: <span class="string">"Test"</span>, code: <span class="number">0</span>, userInfo: <span class="literal">nil</span>)))</span><br><span class="line">&#125;</span><br><span class="line">--- catchError <span class="number">1</span> example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">100</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">200</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h3><p><code>retry</code> 顾名思义，就是在出现异常的时候会再去从头订阅事件序列，妄图通过『从头再来』解决异常。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"retry"</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">count</span> = <span class="number">1</span> <span class="comment">// bad practice, only for example purposes</span></span><br><span class="line">    <span class="keyword">let</span> funnyLookingSequence: <span class="type">Observable</span>&lt;<span class="type">Int</span>&gt; = create &#123; observer <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> error = <span class="type">NSError</span>(domain: <span class="string">"Test"</span>, code: <span class="number">0</span>, userInfo: <span class="literal">nil</span>)</span><br><span class="line">        observer.on(.<span class="type">Next</span>(<span class="number">0</span>))</span><br><span class="line">        observer.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">count</span> &lt; <span class="number">2</span> &#123;</span><br><span class="line">            observer.on(.<span class="type">Error</span>(error))</span><br><span class="line">            <span class="built_in">count</span>++</span><br><span class="line">        &#125;</span><br><span class="line">        observer.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">        observer.on(.<span class="type">Completed</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NopDisposable</span>.instance</span><br><span class="line">    &#125;</span><br><span class="line">    funnyLookingSequence</span><br><span class="line">        .retry()</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- retry example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h2 id="Utility"><a href="#Utility" class="headerlink" title="Utility"></a>Utility</h2><p>这里列举了针对事件序列的一些方法。</p>
<h3 id="subscribe"><a href="#subscribe" class="headerlink" title="subscribe"></a>subscribe</h3><p><code>subscribe</code> 在前面已经接触过了，有新的事件就会触发。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"subscribe"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceOfInts = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    sequenceOfInts</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Completed</span>)</span><br><span class="line">&#125;</span><br><span class="line">--- subscribe example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="subscribeNext"><a href="#subscribeNext" class="headerlink" title="subscribeNext"></a>subscribeNext</h3><p><code>subscribeNext</code> 也是订阅，但是只订阅 <code>.Next</code> 事件。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"subscribeNext"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceOfInts = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    sequenceOfInts</span><br><span class="line">        .subscribeNext &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Completed</span>)</span><br><span class="line">&#125;</span><br><span class="line">--- subscribeNext example ---</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="subscribeCompleted"><a href="#subscribeCompleted" class="headerlink" title="subscribeCompleted"></a>subscribeCompleted</h3><p><code>subscribeCompleted</code> 是只订阅 <code>.Completed</code> 完成事件。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"subscribeCompleted"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceOfInts = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    sequenceOfInts</span><br><span class="line">        .subscribeCompleted &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"It's completed"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Completed</span>)</span><br><span class="line">&#125;</span><br><span class="line">--- subscribeCompleted example ---</span><br><span class="line"><span class="type">It's</span> completed</span><br></pre></td></tr></table></figure>

<h3 id="subscribeError"><a href="#subscribeError" class="headerlink" title="subscribeError"></a>subscribeError</h3><p><code>subscribeError</code> 只订阅 <code>.Error</code> 失败事件。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"subscribeError"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceOfInts = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    sequenceOfInts</span><br><span class="line">        .subscribeError &#123; error <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Error</span>(<span class="type">NSError</span>(domain: <span class="string">"Examples"</span>, code: -<span class="number">1</span>, userInfo: <span class="literal">nil</span>)))</span><br><span class="line">&#125;</span><br><span class="line">--- subscribeError example ---</span><br><span class="line"><span class="type">Error</span> <span class="type">Domain</span>=<span class="type">Examples</span> <span class="type">Code</span>=-<span class="number">1</span> <span class="string">"The operation couldn’t be completed. (Examples error -1.)"</span></span><br></pre></td></tr></table></figure>

<h3 id="doOn"><a href="#doOn" class="headerlink" title="doOn"></a>doOn</h3><p><code>doOn</code> 可以监听事件，并且在事件发生之前调用。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"doOn"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequenceOfInts = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    sequenceOfInts</span><br><span class="line">        .doOn &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Intercepted event \($0)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    sequenceOfInts.on(.<span class="type">Completed</span>)</span><br><span class="line">&#125;</span><br><span class="line">--- doOn example ---</span><br><span class="line"><span class="type">Intercepted</span> event <span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Intercepted</span> event <span class="type">Completed</span></span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h2 id="Conditional"><a href="#Conditional" class="headerlink" title="Conditional"></a>Conditional</h2><p>我们可以对多个事件序列做一些复杂的逻辑判断。</p>
<h3 id="takeUntil"><a href="#takeUntil" class="headerlink" title="takeUntil"></a>takeUntil</h3><p><code>takeUntil</code> 其实就是 <code>take</code> ，它会在终于等到那个事件之后触发 <code>.Completed</code> 事件。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"takeUntil"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> originalSequence = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> whenThisSendsNextWorldStops = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    originalSequence</span><br><span class="line">        .takeUntil(whenThisSendsNextWorldStops)</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    originalSequence.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    originalSequence.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">    whenThisSendsNextWorldStops.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    originalSequence.on(.<span class="type">Next</span>(<span class="number">3</span>))</span><br><span class="line">&#125;</span><br><span class="line">--- takeUntil example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h3 id="takeWhile"><a href="#takeWhile" class="headerlink" title="takeWhile"></a>takeWhile</h3><p><code>takeWhile</code> 则是可以通过状态语句判断是否继续 <code>take</code> 。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"takeWhile"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> sequence = <span class="type">PublishSubject</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    sequence</span><br><span class="line">        .takeWhile &#123; int <span class="keyword">in</span></span><br><span class="line">            int &lt; <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    sequence.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    sequence.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">    sequence.on(.<span class="type">Next</span>(<span class="number">3</span>))</span><br><span class="line">&#125;</span><br><span class="line">--- takeWhile example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h2 id="Aggregate"><a href="#Aggregate" class="headerlink" title="Aggregate"></a>Aggregate</h2><p>我们可以对事件序列做一些集合运算。</p>
<h3 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h3><p><code>concat</code> 可以把多个事件序列合并起来。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"concat"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> var1 = <span class="type">BehaviorSubject</span>(value: <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">let</span> var2 = <span class="type">BehaviorSubject</span>(value: <span class="number">200</span>)</span><br><span class="line">    <span class="comment">// var3 is like an Observable&lt;Observable&lt;Int&gt;&gt;</span></span><br><span class="line">    <span class="keyword">let</span> var3 = <span class="type">BehaviorSubject</span>(value: var1)</span><br><span class="line">    <span class="keyword">let</span> d = var3</span><br><span class="line">        .concat()</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    var1.on(.<span class="type">Next</span>(<span class="number">1</span>))</span><br><span class="line">    var1.on(.<span class="type">Next</span>(<span class="number">2</span>))</span><br><span class="line">    var3.on(.<span class="type">Next</span>(var2))</span><br><span class="line">    var2.on(.<span class="type">Next</span>(<span class="number">201</span>))</span><br><span class="line">    var1.on(.<span class="type">Next</span>(<span class="number">3</span>))</span><br><span class="line">    var1.on(.<span class="type">Completed</span>)</span><br><span class="line">    var2.on(.<span class="type">Next</span>(<span class="number">202</span>))</span><br><span class="line">&#125;</span><br><span class="line">--- concat example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">0</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">3</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">201</span>)</span><br><span class="line"><span class="type">Next</span>(<span class="number">202</span>)</span><br></pre></td></tr></table></figure>

<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>这里的 <code>reduce</code> 和 <code>CollectionType</code> 中的 <code>reduce</code> 是一个意思，都是指通过对一系列数据的运算最后生成一个结果。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">example(<span class="string">"reduce"</span>) &#123;</span><br><span class="line">    sequenceOf(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>)</span><br><span class="line">        .<span class="built_in">reduce</span>(<span class="number">0</span>, +)</span><br><span class="line">        .subscribe &#123;</span><br><span class="line">            <span class="built_in">print</span>($<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">--- <span class="built_in">reduce</span> example ---</span><br><span class="line"><span class="type">Next</span>(<span class="number">45</span>)</span><br><span class="line"><span class="type">Completed</span></span><br></pre></td></tr></table></figure>

<h2 id="Connectable"><a href="#Connectable" class="headerlink" title="Connectable"></a>Connectable</h2><p>坑待填，Xcode 里这个操场跑不起来了。</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>响应式编程</tag>
        <tag>RxSwift</tag>
      </tags>
  </entry>
  <entry>
    <title>UIFont字体信息</title>
    <url>/post/uifont-infos/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>iOS系统下字体信息。</p>
<a id="more"></a>

<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul>
<li>iOS12.0(16A5357b)</li>
<li>iPhone6</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> label = <span class="type">UILabel</span>()</span><br><span class="line">label.text = <span class="string">"这是啥"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> format: (<span class="type">UIFont</span>) -&gt; [<span class="type">String</span>: <span class="type">Any</span>] = &#123; (font) <span class="keyword">in</span></span><br><span class="line">    label.font = font</span><br><span class="line">    label.sizeToFit()</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">"font.familyName"</span>: font.familyName,</span><br><span class="line">            <span class="string">"font.fontName"</span>: font.fontName,</span><br><span class="line">            <span class="string">"font.pointSize"</span>: font.pointSize,</span><br><span class="line">            <span class="string">"font.ascender"</span>: font.ascender,</span><br><span class="line">            <span class="string">"font.descender"</span>: font.descender,</span><br><span class="line">            <span class="string">"font.capHeight"</span>: font.capHeight,</span><br><span class="line">            <span class="string">"font.xHeight"</span>: font.xHeight,</span><br><span class="line">            <span class="string">"font.lineHeight"</span>: font.lineHeight,</span><br><span class="line">            <span class="string">"font.leading"</span>: font.leading,</span><br><span class="line">            <span class="string">"label.sizeToFit"</span>: label.frame.height]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> json: [<span class="type">String</span>: [[<span class="type">String</span>: <span class="type">Any</span>]]] = [:]</span><br><span class="line"><span class="keyword">for</span> family <span class="keyword">in</span> <span class="type">UIFont</span>.familyNames &#123;</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="type">UIFont</span>.fontNames(forFamilyName: family) &#123;</span><br><span class="line">        <span class="keyword">var</span> list: [[<span class="type">String</span>: <span class="type">Any</span>]] = []</span><br><span class="line">        <span class="keyword">for</span> size <span class="keyword">in</span> <span class="number">5</span>...<span class="number">60</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> font = <span class="type">UIFont</span>.<span class="keyword">init</span>(name: name, size: <span class="type">CGFloat</span>(size)) <span class="keyword">else</span> &#123; <span class="keyword">continue</span> &#125;</span><br><span class="line">            list.append(format(font))</span><br><span class="line">        &#125;</span><br><span class="line">        json[<span class="string">"\(family) -&gt; \(name)"</span>] = list</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="type">String</span>(data:(<span class="keyword">try</span>? <span class="type">JSONSerialization</span>.data(withJSONObject: json, options: .prettyPrinted)) ?? <span class="type">Data</span>(), encoding: .utf8)!)</span><br></pre></td></tr></table></figure>

<h2 id="长长的数据"><a href="#长长的数据" class="headerlink" title="长长的数据"></a>长长的数据</h2><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然而数据太多加载不出来。。</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>UIFont</tag>
      </tags>
  </entry>
  <entry>
    <title>UI素材与代码解耦的讨论与思考</title>
    <url>/post/ui-source-and-code-decoupling/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>个人对UI素材和代码的解耦的一些粗浅的看法。比如：解耦方案、是否该解耦。</p>
<a id="more"></a>

<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>  群里听到有人讨论这个话题，当时觉得比较新鲜，就十分好奇的请教了两位经验丰富的@kkk、@AK，虽然未得其中真髓，但是也得到一些自己的思考。总结一下两人的方案，以及自己的思考，</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>  代码内部引入的素材属于设计管理，代码则是码农管理，从这个角度来说两个工做都有码农管理则是一种耦合，为了减轻设计师频繁更换素材而带来的码农的无休止的协作，所以可以进行着方面的解藕。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>  哪坏哪补。有问题就会有解决方案。群中说的<a href="#%E6%96%B9%E6%A1%88%E4%B8%80">方案一</a>由于当时不方便，所以并没有弄明白。<a href="#%E6%96%B9%E6%A1%88%E4%BA%8C">方案二</a>、<a href="#%E6%96%B9%E6%A1%88%E4%B8%89">方案三</a>是自己的一些解决方案。</p>
<h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a><a name="方案一">方案一</a></h3><p>  群中讨论的是素材、代码放在一个仓库，分支不同，使用脚本进行整合(其实并没有想明白怎么弄。。下周请教一下)。另外，@夏汁泡泡 还有一个简化就是这个处理的脚本可以放在<a href="https://developer.apple.com/library/ios/recipes/xcode_help-project_editor/Articles/AddingaRunScriptBuildPhase.html" target="_blank" rel="noopener">Add Run Script Build Phase</a>，暴露出来已知的问题：</p>
<ul>
<li>操作麻烦</li>
<li>图片可能重复</li>
<li>命名规范</li>
</ul>
<h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a><a name="方案二">方案二</a></h3><p>  按照Pods的集成方式，可以将素材看作一个第三方库，直接将素材做成一个bundle，采用Pods私有库或者其他方式放入工程。暴露出来已知的问题：</p>
<ul>
<li>什么时候更新这个bundle</li>
<li>多人合作时这个bundle冲突问题</li>
<li>命名规范</li>
</ul>
<h3 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a><a name="方案三">方案三</a></h3><p>  工程使用<code>xcassets</code>进行素材打包，然后使用子库进行持续集成。这样，设计师的素材可以放在另一个独立素材仓库，内含更新脚本，直接将素材生成对应的<code>xcassets</code>结构，并上传至子库。这样设计师做完素材直接扔在文件夹中，自动或手动跑一下脚本即可更新到素材仓库。暴露出来已知的问题：</p>
<ul>
<li>由于没有测试过，不知道如果素材比较多的话会不会发生冲突。因该不会吧，都是加文件或者修改😂 (有时间去研究一下之后更新)</li>
<li>命名规范的问题依旧存在</li>
</ul>
<h3 id="方案四"><a href="#方案四" class="headerlink" title="方案四"></a><a name="方案四">方案四</a></h3><p>  __ 字体库 __。最近同事提出关于用字体库去存储素材图片的方案。感觉非常的赞，虽然并未实践，但是这种方案就像emoji一样，不但减少了相同图片内容之间存在多个不同尺寸版本的问题，也能够比较好的进行压缩管理。设计师需要做的就是做出一套字体库，然后将所有的素材图全部按照设计字体的方案进行设计和制作，这样在使用的时候只需要导入一个字体文件就好了。对于这个字体文件如何管理都好说，毕竟只有一个字体文件。字体库的制作方面还不是很了解，所以只提着么一下吧嘿嘿。。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>  好了，重要的问题来了，上面的问题都是存在命名规范的问题。此问题如何化解呢？</p>
<p>  素材的引入需根据素材名写入代码中，那么如何才能不用素材名呢？那时不可能的😝，毕竟你要有一个唯一标识符去标志着一个素材。可能有的人说可以做一个json用来保存代码的命名和素材的命名呀，我只想说MDZZ，那不是有两套需要维护的命名规则么。。得不偿失。</p>
<p>  这个命名的问题其实不能复杂化。参看iOS的项目国际化操作，使用一个key作为文案的唯一标识符，需要显示该文案，通过这个唯一标识符就能直接取到。回头看下素材，是不是也能炮制一个呢？</p>
<p>  如果素材名字有统一的规则，就不需要这样的key作为统一标识符，直接使用素材名字即可，这样维护一套素材命名规则总比两套更容易维护。所以，直接使用素材名即可。</p>
<p>  如果素材不能统一命名规则，那么这样的对照文件存在也是很不错的。话又说回来，要进行UI素材和代码的解耦，素材名都不能统一，还如何解耦，此问题也不存在了。。</p>
<p>  退一步，我们的目的是让素材让设计师自己维护，代码不去维护素材。设计师和码农的耦合在于图片本身的交换比较烦。不论采用哪种解耦方案，都是把图片的耦合转换为图片名字的耦合(也可以理解为素材对应的KEY的耦合)。结果是 __ 为了解除一个耦合,而引入了一个新的耦合 __ 。个人认为这样是不靠谱的。。除非有强力的人去推动设计师走标准的命名。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>  其实这个问题大可不必纠结，如果有强力的人去推动这个标准持续走下去那么这个问题才有价值。如果真的要进行题中说的代码解耦的话，我认为第三种是比较靠谱的。 __ 命名标准、命名标准、命名标准… __。</p>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>  经验有限，如果有更好的方案，望告知。拜谢！</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>Xcode打包脚本</title>
    <url>/post/build-ipa-sh/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Jenkins自动构建脚本解决方案。</p>
<a id="more"></a>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>2017.9.26更新：<br>xcode9更新又无法构建咯</p>
<p>2017.6.14更新:<br><a href="https://github.com/supermarin/xcpretty" target="_blank" rel="noopener">xcpretty</a>格式化输出日志。很溜，输出效果和 <code>fastlane</code> 差不多哈哈</p>
<p>2017.1.13更新：<br>  好吧，其实有更加强悍的打包工具，虽然早有耳闻但是没弄。然后最近搭建了一下，这打包脚本也不用了，毕竟有成套工具嘛。嘿嘿<br>  不过最后上传osc的脚本还是很可以的。<br>  传送门：<a href="../fastlane-note">Fastlane自动化笔记</a></p>
<h2 id="Xcode8"><a href="#Xcode8" class="headerlink" title="Xcode8"></a>Xcode8</h2><p>好悲催，Xcode8更新之后Jenkins打包失败了。。由于代码库中使用了swift3语法，故必须使用Xcode8。。</p>
<p>先来重点：可用脚本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   追上fir API token 自动上传</span></span><br><span class="line"><span class="comment">#   基于当前代码进行打包打包目录：MyProject/build/MyProject_ent.ipa</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> MyProject</span><br><span class="line"></span><br><span class="line">rm -rf ./build/*</span><br><span class="line"></span><br><span class="line">xcodebuild -archivePath <span class="string">"./build/xxx.xcarchive"</span> -workspace MyProject.xcworkspace -sdk iphoneos -scheme <span class="string">"MyProject_ent"</span> -configuration <span class="string">"Release Inhouse"</span> archive</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&lt;?xml version="</span>1.0<span class="string">" encoding="</span>UTF-8<span class="string">"?&gt;&lt;!DOCTYPE plist PUBLIC "</span>-//Apple//DTD PLIST 1.0//EN<span class="string">" "</span>http://www.apple.com/DTDs/PropertyList-1.0.dtd<span class="string">"&gt;&lt;plist version="</span>1.0<span class="string">"&gt;&lt;dict&gt;&lt;key&gt;method&lt;/key&gt;&lt;string&gt;enterprise&lt;/string&gt;&lt;key&gt;compileBitcode&lt;/key&gt;&lt;string&gt;YES&lt;/string&gt;&lt;/dict&gt;&lt;/plist&gt;"</span> &gt; ./build/exportOptionsPlist.plist</span><br><span class="line"></span><br><span class="line">xcodebuild -exportArchive -archivePath <span class="string">"./build/xxx.xcarchive"</span> -exportPath <span class="string">"./build/"</span> -exportOptionsPlist ./build/exportOptionsPlist.plist</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> build/</span><br><span class="line"></span><br><span class="line">fir i ./MyProject_ent.ipa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$1</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    git <span class="built_in">log</span> -10 &gt; git.log</span><br><span class="line">    fir p ./MyProject_ent.ipa -T <span class="variable">$1</span> -c git.log</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>之前漏掉了一个错误：<code>The flag -exportFormat cannot be specified along with -exportOptionsPlist</code> 导致了最终包签名错误，而无法安装。</p>
<p>exportOptionsPlist参考的<a href="https://testerhome.com/topics/4619" target="_blank" rel="noopener">iOS 打包总结</a></p>
<h2 id="手动上传"><a href="#手动上传" class="headerlink" title="手动上传"></a>手动上传</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">#   追上fir API token 自动上传</span><br><span class="line">#   基于当前代码进行打包打包目录：xxxx&#x2F;build&#x2F;xxxx_ent.ipa</span><br><span class="line"></span><br><span class="line">workspace_name&#x3D;xxxx</span><br><span class="line">scheme_name&#x3D;xxxx_ent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd $workspace_name</span><br><span class="line"></span><br><span class="line">rm -rf .&#x2F;build&#x2F;*</span><br><span class="line"></span><br><span class="line">xcodebuild clean -workspace $workspace_name.xcworkspace -scheme $scheme_nam -configuration Release | xcpretty</span><br><span class="line"></span><br><span class="line">xcodebuild archive -archivePath &quot;.&#x2F;build&#x2F;xxx.xcarchive&quot; -workspace $workspace_name.xcworkspace -sdk iphoneos -scheme $scheme_name -configuration &quot;Release Inhouse&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; .&#x2F;build&#x2F;exportOptionsPlist.plist</span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">        &lt;key&gt;method&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;string&gt;enterprise&lt;&#x2F;string&gt;</span><br><span class="line">        &lt;key&gt;compileBitcode&lt;&#x2F;key&gt;</span><br><span class="line">            &lt;false&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">xcodebuild -exportArchive -archivePath &quot;.&#x2F;build&#x2F;xxx.xcarchive&quot; -exportOptionsPlist &quot;.&#x2F;build&#x2F;exportOptionsPlist.plist&quot; -exportPath &quot;.&#x2F;build&#x2F;&quot;</span><br><span class="line"></span><br><span class="line">cd build&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git log -10 &gt; git.log</span><br><span class="line"></span><br><span class="line">#拷贝ipa到临时文件夹中</span><br><span class="line">cp .&#x2F;$scheme_name.ipa .&#x2F;tmp.zip</span><br><span class="line">#将ipa解压</span><br><span class="line">unzip tmp.zip</span><br><span class="line"></span><br><span class="line">#app文件中Info.plist文件路径</span><br><span class="line">app_infoplist_path&#x3D;$(pwd)&#x2F;Payload&#x2F;*.app&#x2F;Info.plist</span><br><span class="line">#取bundleIdentifier</span><br><span class="line">bundleIdentifier&#x3D;$(&#x2F;usr&#x2F;libexec&#x2F;PlistBuddy -c &quot;print CFBundleIdentifier&quot; $&#123;app_infoplist_path&#125;)</span><br><span class="line">#取build值</span><br><span class="line">bundleVersion&#x3D;$(&#x2F;usr&#x2F;libexec&#x2F;PlistBuddy -c &quot;print CFBundleVersion&quot; $&#123;app_infoplist_path&#125;)</span><br><span class="line">#显示名称</span><br><span class="line">ipa_name&#x3D;$workspace_name</span><br><span class="line"></span><br><span class="line">#ipa下载url</span><br><span class="line">ipa_download_url&#x3D;&quot;https:&#x2F;&#x2F;***&#x2F;install_ipa&#x2F;raw&#x2F;master&#x2F;xxxx_ent.ipa&quot;</span><br><span class="line">#itms-services协议串</span><br><span class="line">ios_install_url&#x3D;&quot;itms-services:&#x2F;&#x2F;?action&#x3D;download-manifest&amp;url&#x3D;https:&#x2F;&#x2F;***&#x2F;install_ipa&#x2F;raw&#x2F;master&#x2F;xxxx_ent.plist&quot;</span><br><span class="line"></span><br><span class="line">#生成install.html文件</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; index.html</span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;UTF-8&quot; &#x2F;&gt;</span><br><span class="line">    &lt;title&gt;安装&lt;&#x2F;title&gt;</span><br><span class="line">  &lt;&#x2F;head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;p align&#x3D;center&gt;</span><br><span class="line">        &lt;font size&#x3D;&quot;8&quot;&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;$&#123;ios_install_url&#125;&quot;&gt;点击这里安装&lt;&#x2F;a&gt;</span><br><span class="line">        &lt;&#x2F;font&gt;</span><br><span class="line">    &lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#生成plist文件</span><br><span class="line">cat &lt;&lt; EOF &gt; $&#123;workspace_name&#125;.plist</span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">    &lt;key&gt;items&lt;&#x2F;key&gt;</span><br><span class="line">    &lt;array&gt;</span><br><span class="line">        &lt;dict&gt;</span><br><span class="line">            &lt;key&gt;assets&lt;&#x2F;key&gt;</span><br><span class="line">            &lt;array&gt;</span><br><span class="line">                &lt;dict&gt;</span><br><span class="line">                    &lt;key&gt;kind&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;software-package&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;key&gt;url&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;$&#123;ipa_download_url&#125;&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;&#x2F;dict&gt;</span><br><span class="line">                &lt;dict&gt;</span><br><span class="line">                    &lt;key&gt;kind&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;display-image&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;key&gt;needs-shine&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;true&#x2F;&gt;</span><br><span class="line">                    &lt;key&gt;url&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;http:&#x2F;&#x2F;git.oschina.net&#x2F;logo.svg&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;&#x2F;dict&gt;</span><br><span class="line">            &lt;dict&gt;</span><br><span class="line">                    &lt;key&gt;kind&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;full-size-image&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;key&gt;needs-shine&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;true&#x2F;&gt;</span><br><span class="line">                    &lt;key&gt;url&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;http:&#x2F;&#x2F;git.oschina.net&#x2F;logo.svg&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;&#x2F;dict&gt;</span><br><span class="line">            &lt;&#x2F;array&gt;&lt;key&gt;metadata&lt;&#x2F;key&gt;</span><br><span class="line">            &lt;dict&gt;</span><br><span class="line">                &lt;key&gt;bundle-identifier&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;$&#123;bundleIdentifier&#125;&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;key&gt;bundle-version&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;$&#123;bundleVersion&#125;&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;key&gt;kind&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;software&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;key&gt;subtitle&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;$&#123;ipa_name&#125;&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;key&gt;title&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;$&#123;ipa_name&#125;&lt;&#x2F;string&gt;</span><br><span class="line">            &lt;&#x2F;dict&gt;</span><br><span class="line">        &lt;&#x2F;dict&gt;</span><br><span class="line">    &lt;&#x2F;array&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">fir i $scheme_name.ipa</span><br></pre></td></tr></table></figure>

<h2 id="手动上传到OSC脚本"><a href="#手动上传到OSC脚本" class="headerlink" title="手动上传到OSC脚本"></a>手动上传到OSC脚本</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">root_path&#x3D;$(pwd)</span><br><span class="line">workspace_name&#x3D;Fangduoduo</span><br><span class="line">scheme_name&#x3D;XXX</span><br><span class="line"></span><br><span class="line"># 编译</span><br><span class="line">cd $root_path</span><br><span class="line">cd $workspace_name</span><br><span class="line"></span><br><span class="line">rm -rf .&#x2F;build&#x2F;*</span><br><span class="line"></span><br><span class="line">xcodebuild -archivePath .&#x2F;build&#x2F;$scheme_name.xcarchive -workspace $workspace_name.xcworkspace -sdk iphoneos -scheme $scheme_name -configuration &quot;Release Inhouse&quot; archive</span><br><span class="line"></span><br><span class="line">echo &quot;&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;&lt;plist version&#x3D;&quot;1.0&quot;&gt;&lt;dict&gt;&lt;key&gt;method&lt;&#x2F;key&gt;&lt;string&gt;enterprise&lt;&#x2F;string&gt;&lt;key&gt;compileBitcode&lt;&#x2F;key&gt;&lt;false&#x2F;&gt;&lt;&#x2F;dict&gt;&lt;&#x2F;plist&gt;&quot; &gt; .&#x2F;build&#x2F;exportOptionsPlist.plist</span><br><span class="line"></span><br><span class="line">xcodebuild -exportArchive -archivePath .&#x2F;build&#x2F;$scheme_name.xcarchive -exportOptionsPlist &quot;.&#x2F;build&#x2F;exportOptionsPlist.plist&quot; -exportPath &quot;.&#x2F;build&#x2F;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd build&#x2F;</span><br><span class="line"></span><br><span class="line">if [ ! -f $scheme_name.ipa ]; then</span><br><span class="line">    echo &quot;*** 无法打包 ***&quot;</span><br><span class="line">    exit -1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">fir i .&#x2F;$scheme_name.ipa</span><br><span class="line"></span><br><span class="line">git log -10 &gt; git.log</span><br><span class="line">git_log&#x3D;$(cat git.log)</span><br><span class="line"># fir 上传</span><br><span class="line">if [ -n &quot;$1&quot; ]; then</span><br><span class="line">    fir p .&#x2F;$scheme_name.ipa -T $1 -c git.log</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 校验HTML并上传</span><br><span class="line"></span><br><span class="line">public_git_path&#x3D;$root_path&#x2F;public_ipa_tmp&#x2F;</span><br><span class="line">public_git_root&#x3D;&quot;install_ipa&quot;</span><br><span class="line">public_git&#x3D;&quot;https:&#x2F;&#x2F;***&#x2F;install_ipa.git&quot;</span><br><span class="line">#ipa下载url</span><br><span class="line">ipa_download_url&#x3D;&quot;https:&#x2F;&#x2F;***&#x2F;install_ipa&#x2F;raw&#x2F;master&#x2F;XXX.ipa&quot;</span><br><span class="line">#itms-services协议串</span><br><span class="line">ios_install_url&#x3D;&quot;itms-services:&#x2F;&#x2F;?action&#x3D;download-manifest&amp;url&#x3D;https:&#x2F;&#x2F;***&#x2F;install_ipa&#x2F;raw&#x2F;master&#x2F;XXX.plist&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd $root_path&#x2F;</span><br><span class="line"># checkout path is OK</span><br><span class="line">if [ ! -e $public_git_path ]; then</span><br><span class="line">    mkdir $public_git_path</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -n $public_git_path ]; then</span><br><span class="line">    rm -rf $public_git_path</span><br><span class="line">fi</span><br><span class="line">mkdir $public_git_path</span><br><span class="line">cd $public_git_path</span><br><span class="line">git init</span><br><span class="line">git remote add origin $public_git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd $root_path&#x2F;$workspace_name&#x2F;build&#x2F;</span><br><span class="line"></span><br><span class="line">#拷贝ipa到临时文件夹中</span><br><span class="line">cp .&#x2F;$scheme_name.ipa .&#x2F;tmp.zip</span><br><span class="line">rm -rf Payload</span><br><span class="line">#将ipa解压</span><br><span class="line">unzip tmp.zip</span><br><span class="line"></span><br><span class="line">#app文件中Info.plist文件路径</span><br><span class="line">app_infoplist_path&#x3D;$(pwd)&#x2F;Payload&#x2F;*.app&#x2F;Info.plist</span><br><span class="line">#取bundleIdentifier</span><br><span class="line">bundleIdentifier&#x3D;$(&#x2F;usr&#x2F;libexec&#x2F;PlistBuddy -c &quot;print CFBundleIdentifier&quot; $&#123;app_infoplist_path&#125;)</span><br><span class="line">#取build值</span><br><span class="line">bundleVersion&#x3D;$(&#x2F;usr&#x2F;libexec&#x2F;PlistBuddy -c &quot;print CFBundleVersion&quot; $&#123;app_infoplist_path&#125;)</span><br><span class="line">#取shortVersionbuild值</span><br><span class="line">shortVersion&#x3D;$(&#x2F;usr&#x2F;libexec&#x2F;PlistBuddy -c &quot;print CFBundleShortVersionString&quot; $&#123;app_infoplist_path&#125;)</span><br><span class="line">#显示名称</span><br><span class="line">ipa_name&#x3D;$(&#x2F;usr&#x2F;libexec&#x2F;PlistBuddy -c &quot;print CFBundleDisplayName&quot; $&#123;app_infoplist_path&#125;)</span><br><span class="line">nowTime&#x3D;$(date +%Y-%m-%d\ %H:%M)</span><br><span class="line">log_url&#x3D;&quot;https:&#x2F;&#x2F;madordie.github.io&#x2F;uploads&#x2F;avatar.png&quot;</span><br><span class="line"></span><br><span class="line">#生成install.html文件</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; index.html</span><br><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;UTF-8&quot; &#x2F;&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width,initial-scale&#x3D;1,minimum-scale&#x3D;1,maximum-scale&#x3D;1,user-scalable&#x3D;0&quot;&gt;</span><br><span class="line">&lt;title&gt;$&#123;ipa_name&#125;安装&lt;&#x2F;title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">.containor &#123;</span><br><span class="line">    position: relative;</span><br><span class="line">    top: 0;</span><br><span class="line">    left: 0;</span><br><span class="line">    right: 0;</span><br><span class="line">    margin: 0 auto;</span><br><span class="line">    width: 100%;</span><br><span class="line">    max-width: 640px;</span><br><span class="line">    text-align: center;</span><br><span class="line">&#125;</span><br><span class="line">.logo &#123;</span><br><span class="line">    width: 120px;</span><br><span class="line">    margin-top: 30px;</span><br><span class="line">&#125;</span><br><span class="line">.title,</span><br><span class="line">.version_history,</span><br><span class="line">.update_time &#123;</span><br><span class="line">    text-align: center;</span><br><span class="line">    color: #999;</span><br><span class="line">    font-size: 16px;</span><br><span class="line">&#125;</span><br><span class="line">.title &#123;</span><br><span class="line">    margin-top: 10px;</span><br><span class="line">&#125;</span><br><span class="line">.version_history,</span><br><span class="line">.update_time &#123;</span><br><span class="line">    margin-top: 5px;</span><br><span class="line">&#125;</span><br><span class="line">.download &#123;</span><br><span class="line">    display: block;</span><br><span class="line">    width: 150px;</span><br><span class="line">    height: 30px;</span><br><span class="line">    line-height: 30px;</span><br><span class="line">    margin: 0 auto;</span><br><span class="line">    margin-top: 20px;</span><br><span class="line">    border: 1px solid #eee;</span><br><span class="line">    border-radius: 20px;</span><br><span class="line">    text-decoration: none;</span><br><span class="line">    color: #999;</span><br><span class="line">&#125;</span><br><span class="line">.log_title &#123;</span><br><span class="line">    margin-top: 20px;</span><br><span class="line">    font-size: 18px;</span><br><span class="line">    color: #333;</span><br><span class="line">&#125;</span><br><span class="line">.log &#123;</span><br><span class="line">    color: #aaa;</span><br><span class="line">    padding: 20px;</span><br><span class="line">    text-align: left;</span><br><span class="line">    font-size: 12px;</span><br><span class="line">    line-height: 15px;</span><br><span class="line">    white-space: pre-wrap;</span><br><span class="line">    word-wrap: break-word;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div class&#x3D;&quot;containor&quot;&gt;</span><br><span class="line">    &lt;img class&#x3D;&quot;logo&quot; src&#x3D;$&#123;log_url&#125; &#x2F;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;title&quot;&gt;$ipa_name&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;version_history&quot;&gt;$&#123;shortVersion&#125;(bundle:$&#123;bundleVersion&#125;)&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;div&gt;&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;update_time&quot;&gt;$&#123;nowTime&#125;&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;a class&#x3D;&quot;download&quot; href&#x3D;&quot;$&#123;ios_install_url&#125;&quot;&gt;点击这里安装&lt;&#x2F;a&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;log_title&quot;&gt;更新日志&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;log&quot;&gt; $&#123;git_log&#125; &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#生成plist文件</span><br><span class="line">cat &lt;&lt; EOF &gt; $&#123;scheme_name&#125;.plist</span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">    &lt;key&gt;items&lt;&#x2F;key&gt;</span><br><span class="line">    &lt;array&gt;</span><br><span class="line">        &lt;dict&gt;</span><br><span class="line">            &lt;key&gt;assets&lt;&#x2F;key&gt;</span><br><span class="line">            &lt;array&gt;</span><br><span class="line">                &lt;dict&gt;</span><br><span class="line">                    &lt;key&gt;kind&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;software-package&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;key&gt;url&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;$&#123;ipa_download_url&#125;&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;&#x2F;dict&gt;</span><br><span class="line">                &lt;dict&gt;</span><br><span class="line">                    &lt;key&gt;kind&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;display-image&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;key&gt;needs-shine&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;true&#x2F;&gt;</span><br><span class="line">                    &lt;key&gt;url&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;http:&#x2F;&#x2F;git.oschina.net&#x2F;logo.svg&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;&#x2F;dict&gt;</span><br><span class="line">            &lt;dict&gt;</span><br><span class="line">                    &lt;key&gt;kind&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;full-size-image&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;key&gt;needs-shine&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;true&#x2F;&gt;</span><br><span class="line">                    &lt;key&gt;url&lt;&#x2F;key&gt;</span><br><span class="line">                    &lt;string&gt;http:&#x2F;&#x2F;git.oschina.net&#x2F;logo.svg&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;&#x2F;dict&gt;</span><br><span class="line">            &lt;&#x2F;array&gt;&lt;key&gt;metadata&lt;&#x2F;key&gt;</span><br><span class="line">            &lt;dict&gt;</span><br><span class="line">                &lt;key&gt;bundle-identifier&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;$&#123;bundleIdentifier&#125;&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;key&gt;bundle-version&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;$&#123;bundleVersion&#125;&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;key&gt;kind&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;software&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;key&gt;subtitle&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;$&#123;ipa_name&#125;&lt;&#x2F;string&gt;</span><br><span class="line">                &lt;key&gt;title&lt;&#x2F;key&gt;</span><br><span class="line">                &lt;string&gt;$&#123;ipa_name&#125;&lt;&#x2F;string&gt;</span><br><span class="line">            &lt;&#x2F;dict&gt;</span><br><span class="line">        &lt;&#x2F;dict&gt;</span><br><span class="line">    &lt;&#x2F;array&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#fir i $scheme_name.ipa</span><br><span class="line">cp $scheme_name.ipa $public_git_path</span><br><span class="line">cp $scheme_name.plist $public_git_path</span><br><span class="line">cp index.html $public_git_path</span><br><span class="line"></span><br><span class="line">cd $public_git_path</span><br><span class="line">ls -l &gt; README.md</span><br><span class="line">if [ ! -e &quot;.&#x2F;.git&#x2F;&quot; ]; then</span><br><span class="line">    echo &quot;*** OSC的git目录不完整，无法上传，请联系开发! ***&quot;</span><br><span class="line">    exit -1</span><br><span class="line">fi</span><br><span class="line">echo &quot;commit and pushing ...&quot;</span><br><span class="line">git add .</span><br><span class="line">git commit -am $bundleVersion</span><br><span class="line">git push -f origin master</span><br></pre></td></tr></table></figure>

<h2 id="将符号表dsym上传至bugly"><a href="#将符号表dsym上传至bugly" class="headerlink" title="将符号表dsym上传至bugly"></a>将符号表dsym上传至bugly</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">path=<span class="string">'/Users/xx/.jenkins/workspace/xzx'</span></span><br><span class="line">schem=<span class="string">'xx'</span></span><br><span class="line">package=<span class="string">'xx'</span></span><br><span class="line">bugly_id=<span class="string">'xx'</span></span><br><span class="line">bugly_key=<span class="string">'xx'</span></span><br><span class="line"></span><br><span class="line">cp <span class="variable">$&#123;path&#125;</span>/xx/Info.plist ./Info.plist</span><br><span class="line">cp <span class="variable">$&#123;path&#125;</span>/xx.app.dSYM.zip ./dsym.zip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------ post dsym ------------ #</span></span><br><span class="line"></span><br><span class="line">unzip -o dsym.zip -d dsym</span><br><span class="line">app_infoplist_path=<span class="string">'Info.plist'</span></span><br><span class="line">version=$(/usr/libexec/PlistBuddy -c <span class="string">"print CFBundleVersion"</span> <span class="variable">$&#123;app_infoplist_path&#125;</span>)</span><br><span class="line"></span><br><span class="line">java -jar ./bugly/buglySymboliOS.jar \</span><br><span class="line">    -i dsym/<span class="variable">$&#123;scheme&#125;</span> \</span><br><span class="line">    -dsym \</span><br><span class="line">    -u \</span><br><span class="line">    -id <span class="variable">$&#123;bugly_id&#125;</span> \</span><br><span class="line">    -key <span class="variable">$&#123;bugly_key&#125;</span> \</span><br><span class="line">    -package <span class="variable">$&#123;package&#125;</span> \</span><br><span class="line">    -version <span class="variable">$&#123;version&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------ UUID ------------ #</span></span><br><span class="line"></span><br><span class="line">unzip -o ./dsym/<span class="variable">$&#123;scheme&#125;</span>.zip</span><br><span class="line">xcrun dwarfdump --uuid ./<span class="variable">$&#123;scheme&#125;</span> &gt;&gt; ./uuids-<span class="variable">$&#123;version&#125;</span>.txt</span><br></pre></td></tr></table></figure>

<h2 id="修改环境代码"><a href="#修改环境代码" class="headerlink" title="修改环境代码"></a>修改环境代码</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sed -i <span class="string">''</span> <span class="string">"s/#define RELEASE_MODE [[:digit:]]/#define RELEASE_MODE <span class="variable">$&#123;mode&#125;</span>/g"</span> ./Fangduoduo/config/AppConfig.h</span><br></pre></td></tr></table></figure>

<h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li><a href="http://flummox-engineering.blogspot.com/2016/01/installing-jenkins-os-x-homebrew.html" target="_blank" rel="noopener">Installing Jenkins OS X Homebrew</a></li>
</ul>
<h3 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">brew services start jenkins</span><br></pre></td></tr></table></figure>
<p>无法识别gerrit….</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nohup jenkins &gt; ~/fdd-backup/jenkins.log g 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>无法签名…</p>
<p>上面2个方案并不是不能运行，而是需要额外配置。。😂</p>
<hr>
<ul>
<li><a href="https://gxnotes.com/article/61107.html" target="_blank" rel="noopener">https://gxnotes.com/article/61107.html</a></li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>构建</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS11-beta</title>
    <url>/post/ios11-beta/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>iOS11 预览版安装体验笔记。</p>
<a id="more"></a>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>毕竟beta版，升级需谨慎。目前来看体验上还是有点卡的～～😂</p>
<p>卡顿让我实在无法忍受，并与6.15号重置回iOS10.3.2 。。。</p>
<p>9.13 GM出来了，再安装～～</p>
<p>适配有先后，iOS11马上就要发了，而iPhoneX还需要等一小段时间。所以iOS11的适配比iPhoneX有更高的优先级～</p>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="失效的automaticallyAdjustsScrollViewInsets"><a href="#失效的automaticallyAdjustsScrollViewInsets" class="headerlink" title="失效的automaticallyAdjustsScrollViewInsets"></a><a name='automaticallyAdjustsScrollViewInsets'>失效的<code>automaticallyAdjustsScrollViewInsets</code></a></h3><p>iOS11 版本中 __立即失效__。</p>
<p>最容易出问题的就是无导航的顶部刷新会莫名其妙的缩不进去～～</p>
<p><img src="/images/ios11-beta-1.jpg" alt="效果图"></p>
<p>还有就是如果没有使用这个<code>automaticallyAdjustsScrollViewInsets</code>，为了达到那种戳进去的代码直接设置<code>frame.y = 0</code>。这种操作不但会出现导航栏莫名其妙的戳出来，还有<code>UITableView.section.header</code>莫名错位的问题。</p>
<p><img src="/images/ios11-beta-2.gif" alt="效果图"></p>
<p>API 声明：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="meta">@available</span>(iOS <span class="number">2.0</span>, *)</span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">UIViewController</span> : <span class="title">UIResponder</span>, ... </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="meta">@available</span>(iOS, introduced: <span class="number">7.0</span>, deprecated: <span class="number">11.0</span>)</span><br><span class="line">	<span class="keyword">open</span> <span class="keyword">var</span> automaticallyAdjustsScrollViewInsets: <span class="type">Bool</span> <span class="comment">// Defaults to YES</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相应的的替换方案：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="meta">@available</span>(iOS <span class="number">2.0</span>, *)</span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">UIScrollView</span> : <span class="title">UIView</span>, ... </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">/* Configure the behavior of adjustedContentInset.</span></span><br><span class="line"><span class="comment">     Default is UIScrollViewContentInsetAdjustmentAutomatic.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@available</span>(iOS <span class="number">11.0</span>, *)</span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> contentInsetAdjustmentBehavior: <span class="type">UIScrollViewContentInsetAdjustmentBehavior</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="decisionHandler-allow-was-called-more-than-once"><a href="#decisionHandler-allow-was-called-more-than-once" class="headerlink" title="decisionHandler(.allow) was called more than once"></a><a name='decisionHandler'><code>decisionHandler(.allow)</code> was called more than once</a></h3><p>崩溃信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#0 Thread</span><br><span class="line">NSInternalInconsistencyException</span><br><span class="line">Completion handler passed to -[WKWebViewJavascriptBridge webView:decidePolicyForNavigationAction:decisionHandler:] was called more than once</span><br></pre></td></tr></table></figure>
<p>这是<a href="https://github.com/marcuswestin/WebViewJavascriptBridge" target="_blank" rel="noopener">WebViewJavascriptBridge</a>在iOS11上的一个<a href="https://github.com/marcuswestin/WebViewJavascriptBridge/issues/302" target="_blank" rel="noopener">Issues#302</a>。</p>
<p>据同事说可以通过如下代码解决：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="type">WebViewJavascriptBridgeBase</span>().isWebViewJavascriptBridgeURL(url) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">decisionHandler(.allow)</span><br></pre></td></tr></table></figure>

<p>测试了一下确实不崩溃了，但是具体的解决方案还要看作者的在<a href="https://github.com/marcuswestin/WebViewJavascriptBridge/issues/302" target="_blank" rel="noopener">Issues#302</a>中的回复。</p>
<h3 id="照片存储时候某些设备必crash"><a href="#照片存储时候某些设备必crash" class="headerlink" title="照片存储时候某些设备必crash"></a><a name='savePhoto'>照片存储时候某些设备必crash</a></h3><p>崩溃信息:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2017-09-29 11:36:17.338816+0800 Demo-iOS11-crash-save-photo[636:139456]</span><br><span class="line"> [access] This app has crashed because it attempted to access privacy-sensitive data without a usage description. </span><br><span class="line"> The app&#39;s Info.plist must contain an NSPhotoLibraryAddUsageDescription key with a string value explaining to the user how the app uses this data.</span><br></pre></td></tr></table></figure>

<p>是的，这个<a href="https://github.com/madordie/Demo-iOS11-crash-save-photo" target="_blank" rel="noopener">Demo</a>还有一个crash的提示。但是在大工程中，我并没有看到这样的玩意输出出来。。我做的复现操作较简单：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> img = <span class="type">UIImage</span>(named: <span class="string">"278.jpg"</span>)</span><br><span class="line"><span class="keyword">let</span> library = <span class="type">ALAssetsLibrary</span>()</span><br><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> orientation = <span class="type">ALAssetOrientation</span>(rawValue: img?.imageOrientation.rawValue ?? <span class="number">0</span>) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">library.writeImage(toSavedPhotosAlbum: img?.cgImage, orientation: orientation) &#123; (url, error) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> error != <span class="literal">nil</span> <span class="keyword">else</span> &#123; <span class="built_in">print</span>(<span class="string">"no crash"</span>); <span class="keyword">return</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就这么多代码，不管是打没打<code>Swift Error</code>、<code>All Exceptions</code>都无法定位到上面代码块，这才是最坑的。</p>
<p>上面代码漏了一句关键的代码：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">guard</span> <span class="type">ALAssetsLibrary</span>.authorizationStatus() == .authorized <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是上面代码之判断了是否有权限，但是在iOS11上并不会弹出什么授权提示。就算在<code>Info.plist</code>中添加<code>NSPhotoLibraryUsageDescription</code>依旧无济于事。</p>
<p>目前来看，iOS11中<strong>只有</strong>添加<code>NSPhotoLibraryAddUsageDescription</code>才可以。</p>
<h3 id="navigationItem-titleView-点击区域偏移"><a href="#navigationItem-titleView-点击区域偏移" class="headerlink" title="navigationItem.titleView 点击区域偏移"></a>navigationItem.titleView 点击区域偏移</h3><p>所设置的View需要实现：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">@implementation <span class="type">DNImageFoldTitleView</span></span><br><span class="line">- (<span class="type">CGSize</span>)intrinsicContentSize &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">UILayoutFittingExpandedSize</span>;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>iOS</category>
      </categories>
  </entry>
  <entry>
    <title>Fastlane自动化笔记</title>
    <url>/post/fastlane-note/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>之前在搭建Jenkins的时候，由于看到Fastlane的配置好复杂，那么多，而当时的需求就是自动打包。。所以没有用，现在想来好气！今天翻到InfoQ的一个文章，又详细的了解了Fastlane之后，觉得此大法甚好，解决很多痛点！决定搞通这一切！<br>回看之前的<a href="../build-ipa-sh">build-ipa-sh.md</a>确实比较僵硬。自动化还是很棒的。</p>
<a id="more"></a>

<h1 id="基本知识"><a href="#基本知识" class="headerlink" title="基本知识"></a>基本知识</h1><p>  (<a href="http://icyleaf.com/" target="_blank" rel="noopener">@icyleaf</a>)在<a href="https://icyleaf.com/2016/07/intro-fastlane-automation-for-ios-and-android/" target="_blank" rel="noopener">Fastlane - iOS 和 Android 的自动化构建工具</a>中说到：</p>
<blockquote>
<p>Fastlane 提供的流程的众多工具都是可以独立存在和使用（提供 cli 命令），也可以统一由 fastlane 来控制。它在使用中提出了两个概念：</p>
</blockquote>
<pre><code>- action: Fastlane 的插件，截至当前内置 165 个至多，不过每个动作的颗粒度大小不一。查看详情
- lane: Fastlane 的任务（或者可以理解为命令），一个可以包含多个 lanes，通过 fastlane cli 传入制定的 lane 来执行。</code></pre>
<p>  自我感觉这句话这个对理解和使用很重要！</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>  Fastlane已被Fabric收购，所以按照其安装也很随意(<a href="https://fabric.io/features/distribution" target="_blank" rel="noopener">戳我配置</a>)。<br>  对于打包，</p>
<h1 id="文章"><a href="#文章" class="headerlink" title="文章"></a>文章</h1><ul>
<li><a href="http://icyleaf.com/2016/07/fastlane-in-action/" target="_blank" rel="noopener">深入浅出 Fastlane 一看你就懂</a></li>
<li><a href="http://blog.fir.im/fir_im_weekly160505" target="_blank" rel="noopener">fir.im weekly - 「 持续集成 」实践教程合集</a></li>
<li><a href="https://everettjf.github.io/2015/09/08/ios-ci-with-fastlane" target="_blank" rel="noopener">使用fastlane实现iOS持续集成</a></li>
<li><a href="https://docs.fastlane.tools/" target="_blank" rel="noopener">fastlane docs</a></li>
<li><a href="https://github.com/fastlane/fastlane" target="_blank" rel="noopener">fastlane GitHub</a></li>
<li><a href="http://www.infoq.com/cn/articles/actual-combat-of-fastlane-part01" target="_blank" rel="noopener">Fastlane实战（一）：移动开发自动化之道</a></li>
<li><a href="http://www.infoq.com/cn/articles/actual-combat-of-fastlane-part02" target="_blank" rel="noopener">Fastlane实战（二）：Action和Plugin机制</a></li>
<li><a href="http://www.infoq.com/cn/articles/actual-combat-of-fastlane-part03" target="_blank" rel="noopener">Fastlane实战（三）：Fastlane在Android平台的应用</a></li>
<li><a href="http://www.infoq.com/cn/articles/fastlane-automatic-testing" target="_blank" rel="noopener">Fastlane实战（四）：自动化测试篇</a></li>
<li><a href="http://www.infoq.com/cn/articles/fastlane-pro-tips" target="_blank" rel="noopener">Fastlane实战（五）：高级用法</a></li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>构建</tag>
        <tag>Fastlane</tag>
      </tags>
  </entry>
  <entry>
    <title>准备食用RAC(ReactiveCocoa)的顾虑</title>
    <url>/post/reactivecocoa-ready-to-use/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>对于目前的项目，如果引用RAC，会对项目造成哪些影响的相关思考。</p>
<a id="more"></a>

<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>众所周知，RAC很火，有很多崇拜者。本文只是一个新手第一次使用RAC时候所顾忌的一些问题，如果有比较好的解决方案及时告知我，我会及时更改。</p>
<h1 id="OC简单食用方法"><a href="#OC简单食用方法" class="headerlink" title="OC简单食用方法"></a>OC简单食用方法</h1><p>先来个例子代码：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">RACSignal *RSignal = [[<span class="keyword">self</span>.R rac_newValueChannelWithNilValue:@<span class="number">0</span>] startWith:@(<span class="keyword">self</span>.R.value)];</span><br><span class="line">RACSignal *GSignal = [[<span class="keyword">self</span>.G rac_newValueChannelWithNilValue:@<span class="number">0</span>] startWith:@(<span class="keyword">self</span>.G.value)];</span><br><span class="line">RACSignal *BSignal = [[<span class="keyword">self</span>.B rac_newValueChannelWithNilValue:@<span class="number">0</span>] startWith:@(<span class="keyword">self</span>.B.value)];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span>*(^valueFormat)(<span class="built_in">NSNumber</span> *value) = ^(<span class="built_in">NSNumber</span> *value) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%.0f"</span>, [value doubleValue]*<span class="number">255</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">[RSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="keyword">self</span>.RVaule.text = valueFormat(x);</span><br><span class="line">&#125;];</span><br><span class="line">[GSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="keyword">self</span>.GValue.text = valueFormat(x);</span><br><span class="line">&#125;];</span><br><span class="line">[BSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="keyword">self</span>.BValue.text = valueFormat(x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>是不是超级简单！</p>
<h2 id="顾虑"><a href="#顾虑" class="headerlink" title="顾虑"></a>顾虑</h2><p>可是我有一个问题：</p>
<ul>
<li>OC属于运行时语法，这个里面的<code>id x</code>的不确定因素可能会导致类型识别出现错误。如果说项目是多人维护，那么A可能不知道B写的Signal走的类型是什么，所以这个问题就不适用于松散的多人开发。如果需要使用RAC恐怕需要在项目启动时进行规避这些不确定的问题才能引入。</li>
</ul>
<h1 id="Swift简单食用方法"><a href="#Swift简单食用方法" class="headerlink" title="Swift简单食用方法"></a>Swift简单食用方法</h1><p>在<a href="https://github.com/ReactiveCocoa/ReactiveCocoa" target="_blank" rel="noopener">ReactiveCocoa</a>的<a href="https://github.com/ReactiveCocoa/ReactiveCocoa#objective-c-and-swift" target="_blank" rel="noopener">README.md</a>中有这么一段话：</p>
<blockquote>
<h2 id="Objective-C-and-Swift"><a href="#Objective-C-and-Swift" class="headerlink" title="Objective-C and Swift"></a>Objective-C and Swift</h2></blockquote>
<p>  Although ReactiveCocoa was started as an Objective-C framework, as of [version<br>  3.0][CHANGELOG], all major feature development is concentrated on the [Swift API][].</p>
<blockquote>
</blockquote>
<p>  RAC’s [Objective-C API][] and Swift API are entirely separate, but there is<br>  a [bridge][Objective-C Bridging] to convert between the two. This<br>  is mostly meant as a compatibility layer for older ReactiveCocoa projects, or to<br>  use Cocoa extensions which haven’t been added to the Swift API yet.</p>
<blockquote>
</blockquote>
<p>  The Objective-C API will continue to exist and be supported for the foreseeable<br>  future, but it won’t receive many improvements. For more information about using<br>  this API, please consult our [legacy documentation][].</p>
<blockquote>
</blockquote>
<p>  <strong>We highly recommend that all new projects use the Swift API.</strong></p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>ReactiveCocoa</tag>
      </tags>
  </entry>
  <entry>
    <title>项目中的UITableView</title>
    <url>/post/about-project-tableview/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>前两天听到有人说多人合作的项目并不需要处理很多事情，只需要处理好自己的那部分业务逻辑就好了。感觉这是一个很不负责任的说法。</p>
<p>作为一个APP的开发者，自己负责的事其中的一个模块，但是都是这个APP的开发者，也要往里面塞代码，如果每个人都用不同的逻辑风格去组织代码。那么整个项目就是一坨坨坨，这个坨会影响项目的演进、日后的发展。</p>
<p>当然有的是看不出来的，比如说：当一个请假的人写的代码出现一个BUG，需要修复上线的时候，对于不同的代码风格，需要找到问题的关键代码，这个过程是撕心裂肺的，但是如果同一套代码风格，心中就会有一个大致的位置，去修改时候就会比较快速的定位问题。</p>
<a id="more"></a>

<h1 id="从协议入手"><a href="#从协议入手" class="headerlink" title="从协议入手"></a>从协议入手</h1><p><code>UITableView</code>是项目中非常常见的iOS高级控件，在页面中所有相似的页面几乎都是由该控件进行完成。其广泛运用的不止是使用方便，最主要的是内部的复用优化也是相当给力的。</p>
<h2 id="协议模式下的UITableView"><a href="#协议模式下的UITableView" class="headerlink" title="协议模式下的UITableView"></a>协议模式下的UITableView</h2><p><code>UITableView</code>是典型的 <strong>协议-代理模式</strong> ，比例<code>id &lt;UITableViewDataSource&gt; dataSource</code>和<code>id &lt;UITableViewDelegate&gt; delegate</code>，所以使用对于这种比较规整的列表来说把协议继续扩展到下一级也是可以的。</p>
<p>为了统一<code>UITableView.dataSource</code>和<code>UITableView.delegate</code>，构建如下协议：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  直接填充Cell的cellModel</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">CellModelProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)cellClassName;  <span class="comment">//  cellModel绑定的类名</span></span><br><span class="line">- (<span class="keyword">void</span>)cellModelForCell:(<span class="built_in">UITableViewCell</span> *)cell; <span class="comment">//  cellModel填充上面绑定的cell</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>


<p>那么只需要在代理中做如下设置:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark <span class="meta-string">&lt;UITableViewDelegate, UITableViewDataSource&gt;</span></span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span>*)tableView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span>*)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.viewModel.dataSource.count;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">UITableViewCell</span>*)tableView:(<span class="built_in">UITableView</span>*)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span>*)indexPath</span><br><span class="line">&#123;</span><br><span class="line">      <span class="keyword">id</span>&lt;CellModelProtocol&gt; cellModel = <span class="keyword">self</span>.viewModel.dataSource[indexPath.row];</span><br><span class="line">      <span class="built_in">UITableViewCell</span>* cell = [tableView dequeueReusableCellWithIdentifier:[cellModel cellClassName]];</span><br><span class="line">      cell.frame = tableView.bounds;</span><br><span class="line">      [cellModel cellModelForCell:cell];</span><br><span class="line">      [cell sizeToFit];</span><br><span class="line">      <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">CGFloat</span>)tableView:(<span class="built_in">UITableView</span>*)tableView heightForRowAtIndexPath:(<span class="built_in">NSIndexPath</span>*)indexPath</span><br><span class="line">&#123;</span><br><span class="line">      <span class="keyword">id</span>&lt;CellModelProtocol&gt; cellModel = <span class="keyword">self</span>.viewModel.dataSource[indexPath.row];</span><br><span class="line">      <span class="built_in">UITableViewCell</span>* cell = [tableView ktj_cacheHeightCellForReuseIDFA:[cellModel cellClassName]];</span><br><span class="line">      [cellModel cellModelForCell:cell];</span><br><span class="line">      <span class="keyword">return</span> [cell sizeThatFits:tableView.bounds.size].height;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而在cell中，默认在<code>sizeThatFits:</code>中进行布局的设置和算高即可。如下：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  xxxCell.m</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGSize</span>)sizeThatFits:(<span class="built_in">CGSize</span>)size &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGRect</span> frame = <span class="built_in">CGRectZero</span>;</span><br><span class="line">    <span class="comment">//  根据Cell的实际内容进行布局并设置高度</span></span><br><span class="line">    frame.origin = <span class="built_in">CGPointMake</span>(<span class="number">10</span>, <span class="number">15</span>);</span><br><span class="line">    frame.size = [<span class="keyword">self</span>.infoLabel sizeThatFits:<span class="built_in">CGSizeMake</span>(size.width-frame.origin.x*<span class="number">2</span>, size.height)];</span><br><span class="line">    <span class="keyword">self</span>.infoLabel.frame = frame;</span><br><span class="line">    </span><br><span class="line">    size.height = <span class="built_in">CGRectGetMaxY</span>(<span class="keyword">self</span>.infoLabel.frame)+frame.origin.y;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果cell采用autolayout，则计算采用<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell/blob/e3ee86ce419d18d3ff735056f1474f2863e43003/Classes/UITableView%2BFDTemplateLayoutCell.m" target="_blank" rel="noopener">UITableView-FDTemplateLayoutCell</a>的计算方法。</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UITableViewCell</span> (<span class="title">KTJCellAutoLayoutForSize</span>)</span></span><br><span class="line"><span class="comment">//  autolout布局计算高度</span></span><br><span class="line">- (<span class="built_in">CGSize</span>)ktj_ALCellSizeThatFits:(<span class="built_in">CGSize</span>)size &#123;</span><br><span class="line">    <span class="comment">// Add a hard width constraint to make dynamic content views (like labels) expand vertically instead</span></span><br><span class="line">    <span class="comment">// of growing horizontally, in a flow-layout manner.</span></span><br><span class="line">    <span class="built_in">NSLayoutConstraint</span> *tempWidthConstraint =</span><br><span class="line">    [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:<span class="keyword">self</span>.contentView</span><br><span class="line">                                 attribute:<span class="built_in">NSLayoutAttributeWidth</span></span><br><span class="line">                                 relatedBy:<span class="built_in">NSLayoutRelationEqual</span></span><br><span class="line">                                    toItem:<span class="literal">nil</span></span><br><span class="line">                                 attribute:<span class="built_in">NSLayoutAttributeNotAnAttribute</span></span><br><span class="line">                                multiplier:<span class="number">1.0</span></span><br><span class="line">                                  constant:size.width];</span><br><span class="line">    [<span class="keyword">self</span>.contentView addConstraint:tempWidthConstraint];</span><br><span class="line">    <span class="comment">// Auto layout engine does its math</span></span><br><span class="line">    size = [<span class="keyword">self</span>.contentView systemLayoutSizeFittingSize:<span class="built_in">UILayoutFittingCompressedSize</span>];</span><br><span class="line">    size.height += <span class="number">1</span>;</span><br><span class="line">    [<span class="keyword">self</span>.contentView removeConstraint:tempWidthConstraint];</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>另外在<code>&lt;UITableViewDelegate, UITableViewDataSource&gt;</code>中只写了1组，只有cell，没有header、footer的情况，如果需要，炮制即可。</p>
<p>说一下这个其中的<code>ktj_cacheHeightCellForReuseIDFA:</code>类别方法。这个方法是为了算高进行缓存的一个cell，这个cell保存在 <code>NSCache</code>中。所以为了统一，需要在数据初始化时候注册所有的cell。当然你也可以根据类名直接生成，这个自主决定。</p>
<p>说到算高，需要说一下这其中的<code>dequeueReusableCellWithIdentifier:</code>方法。该方法是从tableView的缓存池中取出指定ID的cell。请注意是 <strong>取出</strong> ，并且<code>UITableView</code>并没有暴露出如何放进缓存池，也没有必要暴露出放进缓存池的方法。</p>
<p>而且<code>UITableView</code>只有一个地方能够接收Cell那就是<code>tableView:cellForRowAtIndexPath:</code>。所以请保证<code>dequeueReusableCellWithIdentifier:</code>取出的方法 <strong>需要通过<code>tableView:cellForRowAtIndexPath:</code>返回给<code>UITableView</code></strong> 。这就是我上面说的<code>ktj_cacheHeightCellForReuseIDFA:</code>方法为何要做一个 cache去缓存我取出的cell，目的是为了减少cell的浪费。</p>
<p>同理，对于<code>UITableView</code>的<code>headerView</code>、<code>footerView</code>来说，可以炮制以上协议、方法。不再赘述</p>
<p>PS.</p>
<ol>
<li><a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell" target="_blank" rel="noopener">UITableView-FDTemplateLayoutCell</a>: <a href="https://github.com/sunnyxx" target="_blank" rel="noopener">sunnyxx</a>打造的优化UITableView的一个库，6000的star，很赞。</li>
</ol>
<h1 id="规范化的代码风格"><a href="#规范化的代码风格" class="headerlink" title="规范化的代码风格"></a>规范化的代码风格</h1><p>对于多人开发，最崩溃的事情就要数去读别人的代码。就算不是多人开发，接手别人的代码也是让人最崩溃的事情。如果有不用考虑这件事的叫我！</p>
<p>不同的公司可以有不同的代码风格，但是一个公司的代码风格需要保持一致，这样就不会出现一人请假，无人能接受项目的尴尬局面，就算能接，也是需要为了加一个逻辑判断，需要花费很大的精力去处理。</p>
<p>至于其中的代码不统一的坑，恐怕要等踩过才知道吧😂。</p>
<h1 id="业务逻辑的拆分"><a href="#业务逻辑的拆分" class="headerlink" title="业务逻辑的拆分"></a>业务逻辑的拆分</h1><p>对于复杂的业务逻辑，对其拆分是非常重要的，不拆分很可能写出来的代码一个文件 &gt;1000 行。复杂的业务逻辑对于写出来需要一气呵成，修改起来也就出现了牵一发动全身(虽然拆分完成之后可能也会关键逻辑代码不可拆分，但是会好很多)。</p>
<h2 id="筛选重构"><a href="#筛选重构" class="headerlink" title="筛选重构"></a>筛选重构</h2><p>筛选主要处理的是筛选项，针对众多筛选条件拆分为不同的业务逻辑模块是必须的。遵照拆分的原则，于是乎根据UI划分出来位置、价格、户型、筛选、排序这么几个模块。针对每个模块自行处理选中数据、UI展示。对外只暴露选中项输入和选中回调。</p>
<p>对于每个数据大致都可分为一个列表，然后可选中1项或多项。于是乎，这个代码如果不拉出来是要写好多次的，拉出来，但是选中需要把选中的逻辑扔出来，方便自定义。</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>UITableView</tag>
      </tags>
  </entry>
  <entry>
    <title>「转」Unowned 还是 Weak？生命周期和性能对比</title>
    <url>/post/swiftgg-unowned-or-weak-lifetime-and-performance/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote>
<p>作者：Umberto Raimondi，原文链接，原文日期：2016-10-27<br>译者：shanks；校对：Crystal Sun；定稿：CMB</p>
</blockquote>
<p>每当处理循环引用（retain cycles）时，需要考量对象生命周期来选择unowned或者weak标识符，这已经成为了一个共识。但是有时仍然会心存疑问，在具体的使用中应该选择哪一个，或者退一步讲，保守的只使用 weak 是不是一个好的选择呢？</p>
<p>本文首先对循环引用的基础知识做一个简要介绍，然后会分析 Swift 源代码的一些片段，讲解 unowned 和 weak 在生命周期和性能上的差异点，希望看完本文以后，在的使用场景中，能使用正确的弱引用类型。</p>
<a id="more"></a>

<h2 id="目录"><a href="#目录" class="headerlink" title="目录:"></a>目录:</h2><ul>
<li>基础知识</li>
<li>问题来了: unowened 还是 weak?</li>
<li>性能：深度探索</li>
<li>捕获列表处理解析</li>
<li>结论</li>
<li>脚注</li>
</ul>
<blockquote>
<p>从 GitHub 或者 zipped 获取本文相关的 Playground 代码。然后从这里获取闭包案例和 SIL，SILGen 以及 LLVM IR 的输出。</p>
</blockquote>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>众所周知，Swift 利用古老并且有效的自动引用计数（ARC, Automatic Reference Counting）来管理内存，带来的后果和在 Objective-C 中使用的情况类似，需要手动使用弱引用来解决循环引用问题。</p>
<p>如果对 ARC 不了解，只需要知道的是，每一个引用类型实例都有一个引用计数与之关联，这个引用计数用来记录这个对象实例正在被变量或常量引用的总次数。当引用计数变为 0 时，实例将会被析构，实例占有的内存和资源都将变得重新可用。</p>
<p>当有两个实例通过某种形式互相引用时，就会形成循环引用（比如：两个类实例都有一个属性指向对方的类实例；双向链表中两个相邻的节点实例等…）, 由于两个实例的引用计数都一直大于 0， 循环引用将会阻止这些实例的析构。</p>
<p>为了解决这个问题，和其他一些有类似问题的语言一样， 在 Swift 中，弱引用 的概念被提了出来，弱引用不会被 ARC 计算，也就是说，当一个弱引用指向一个引用类型实例时，引用计数不会增加。</p>
<p>弱引用不会阻止实例的析构, 只需要记住的是，在任何情况下，弱引用都不会拥有它指向的对象。在正式的场景中不是什么大问题，但是在我们处理这类引用的时候，需要意识到这一点。</p>
<p>在 Swift 中有 2 种 弱 引用形式，unowned 和 weak。</p>
<p>虽然它们的作用类似，但与它们相关实例生命周期的假设会略有不同，并且具有不同的性能特征。</p>
<p>为了举例说明循环引用，这里不使用大家期望看到的类之间的循环引用，而使用闭包的上下文案例，这在 Objective-C 日常开发中处理循环引用时经常会遇到的情况。和类的循环引用类似，通过创建一个强引用指向外部实例，或捕获它，阻止它析构。</p>
<p>在 Objective-C ，按照标准的做法，定义一个弱引用指向闭包外部的实例，然后在闭包内部定义强引用指向这个实例，在闭包执行期间使用它。当然，有必要在使用前检查引用的有效性。</p>
<p>为了更方便的处理循环引用，Swift 引入了一个新的概念，用于简化和更加明显地表达在闭包内部外部变量的捕获：捕获列表（capture list）。使用捕获列表，可以在函数的头部定义和指定那些需要用在内部的外部变量，并且指定引用类型(译者注：这里是指 unowned 和 weak）。</p>
<p>接下来举一些例子，在各种情况下捕获变量的表现。</p>
<p>当不使用捕获列表时，闭包将会创建一个外部变量的强引用：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> i1 = <span class="number">1</span>, i2 = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fStrong = &#123;</span><br><span class="line">    i1 += <span class="number">1</span></span><br><span class="line">    i2 += <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fStrong()</span><br><span class="line"><span class="built_in">print</span>(i1,i2) <span class="comment">//Prints 2 and 3</span></span><br></pre></td></tr></table></figure>

<p>闭包内部对变量的修改将会改变外部原始变量的值，这与预期是一致的。</p>
<p>使用捕获列表，闭包内部会创建一个新的可用常量。如果没有指定常量修饰符，闭包将会简单地拷贝原始值到新的变量中，对于值类型和引用类型都是一样的。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fCopy = &#123; [i1] <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(i1,i2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fStrong()</span><br><span class="line"><span class="built_in">print</span>(i1,i2) <span class="comment">//打印结果是 2 和 3  </span></span><br><span class="line"></span><br><span class="line">fCopy()  <span class="comment">//打印结果是 1 和 3</span></span><br></pre></td></tr></table></figure>

<p>在上面的例子中，在调用 fStrong 之前定义函数 fCopy ,在该函数定义的时候，私有常量已经被创建了。正如你所看到的，当调用第二个函数时候，仍然打印 i1 的原始值。</p>
<p>对于外部引用类型的变量，在捕获列表中指定 weak 或 unowned，这个常量将会被初始化为一个弱引用，指向原始值，这种指定的捕获方式就是用来处理循环引用的方式。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> value = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c1 = aClass()</span><br><span class="line"><span class="keyword">var</span> c2 = aClass()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fSpec = &#123; [<span class="keyword">unowned</span> c1, <span class="keyword">weak</span> c2] <span class="keyword">in</span></span><br><span class="line">    c1.value += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> c2 = c2 &#123;</span><br><span class="line">        c2.value += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fSpec()</span><br><span class="line"><span class="built_in">print</span>(c1.value,c2.value) <span class="comment">//Prints 2 and 2</span></span><br></pre></td></tr></table></figure>

<p>两个 aClass 捕获实例的不同的定义方式，决定了它们在闭包中不同的使用方式。</p>
<p>unowned 引用使用的场景是，原始实例永远不会为 nil，闭包可以直接使用它，并且直接定义为显式解包可选值。当原始实例被析构后，在闭包中使用这个捕获值将导致崩溃。</p>
<p>如果捕获原始实例在使用过程中可能为 nil ，必须将引用声明为 weak， 并且在使用之前验证这个引用的有效性。</p>
<h2 id="问题来了-unowened-还是-weak"><a href="#问题来了-unowened-还是-weak" class="headerlink" title="问题来了: unowened 还是 weak?"></a>问题来了: unowened 还是 weak?</h2><p>在实际使用中如何选择这两种弱引用类型呢？</p>
<p>这个问题的答案可以简单由原始对象和引用它的闭包的生命周期来解释。</p>
<p><img src="/images/unownedbig.png" alt="unownedbig"></p>
<p>有两个可能出现的场景：</p>
<ul>
<li><p>闭包和捕获对象的生命周期相同，所以对象可以被访问，也就意味着闭包也可以被访问。外部对象和闭包有相同的生命周期(比如：对象和它的父对象的简单返回引用）。在这种情况下，你应该把引用定义为 unowned。</p>
<p>  一个经典的案例是: [unowned self], 主要用在闭包中，这种闭包主要在他们的父节点上下文中做一些事情，没有在其他地方被引用或传递，不能作用在父节点之外。</p>
</li>
<li><p>闭包的生命周期和捕获对象的生命周期相互独立，当对象不能再使用时，闭包依然能够被引用。这种情况下，你应该把引用定义为 weak，并且在使用它之前验证一下它是否为 nil（请不要对它进行强制解包).</p>
<p>  一个经典的案例是: [weak delegate = self.delegate!]，可以在某些使用闭包的场景中看到，闭包使用的是完全无关（生命周期独立）的代理对象。</p>
</li>
</ul>
<p>当无法确认两个对象之间生命周期的关系时，是否不应该去冒险选择一个无效 unowned 引用？而是保守选择 weak 引用是一个更好的选择？<br>答案是否定的，不仅仅是因为对象生命周期了解是一件必要的事情，而且这两个修饰符在性能特性上也有很大的不同。</p>
<p>弱引用最常见的实现是，每次一个新的引用生成时，都会把每个弱引用和它指向的对象信息存储到一个附加表中。</p>
<p>当没有任何强引用指向一个对象时，Swift 运行时会启动析构过程，但是在这之前，运行时会把所有相关的弱引用置为 nil 。弱引用的这种实现方式我们称之为”零和弱引用”。</p>
<p>这种实现有实际的开销，考虑到需要额外实现的数据结构，需要确保在并发访问情况下，对这个全局引用结构所有操作的正确性。一旦析构过程开始了，在任何环境中，都不允许访问弱引用所指向的对象了。</p>
<p>弱引用（包括 unowned 和一些变体的 weak)在 Swift 使用了更简单和快速的实现机制。</p>
<p>Swift 中的每个对象保持了两个引用计数器，一个是强引用计数器，用来决定 ARC 什么时候可以安全地析构这个对象，另外一个附加的弱引用计数器，用来计算创建了多少个指向这个对象的 unowned 或者 weak 引用，当这个计数器为零时，这个对象将被 析构 。</p>
<p>需要重点理解的是，只有等到所有 unowned 引用被释放后，这个对象才会被真正地析构，然后对象将会保持未解析可访问状态，当析构发生后，对象的内容才会被回收。</p>
<p>每当 unowned 引用被定义时，对应的 unowned 引用计数会进行原子级别地增加(使用原子gcc/llvm操作，进行一系列快速且线程安全的基本操作，例如：增加，减少，比较，交换等)，以保证线程安全。在增加计数之前，会检查强引用计数以确保对象是有效的。</p>
<p>试图访问一个无效的对象，将会导致错误的断言，你的应用在运行时中会报错(这就是为什么这里的 unownd 实现方式叫做 unowned(safe) 实现)<br>为了更好的优化，应用编译时带有 -OFast，unowned 引用不会去验证引用对象的有效性，unowned 引用的行为就会像 Objective-C 中的 __unsafe_unretained 一样。如果引用对象无效，unowned 引用将会指向已经释放垃圾内存（这种实现称之 unowned(unsafe)）。</p>
<p>当一个 unowned 引用被释放后，如果这时没有其他强引用或 unowned 引用指向这个对象，那么最终这个对象将被析构。这就是为什么一个引用对象不能在强引用计数器等于零的情况下，被析构的原因，所有的引用计数器必须能够被访问用来验证 unowned 引用和强引用数量。</p>
<p>Swift 的 weak 引用添加了附加层，间接地把 unowned 引用包裹到了一个可选容器里面，在指向的对象析构之后变成空的情况下，这样处理会更加的清晰。但是需要付出的代价是，附加的机制需要正确地处理可选值。</p>
<p>考虑到以上因素，在对象关系生命周期允许的情况下，优先选择使用 unowned 引用。但是这不是此故事的结局，接下来比较一下两者性能1上的差别。</p>
<h2 id="性能：深度探索"><a href="#性能：深度探索" class="headerlink" title="性能：深度探索"></a>性能：深度探索</h2><p>在查看 Swift 项目源码验证之前，需要理解 ARC 如何管理这两种引用类型，并且还需要解释 swiftc，LLVM 和 SIL 的相关知识。</p>
<p>接下来试着简要介绍本文所需要的必备知识点，如果想了解更多，将在最后的脚注中找到一些有用的链接。</p>
<p>使用一个图来解释 swiftc 整个编译过程的包含的模块：</p>
<p><img src="/images/swiftc.png" alt="swiftc"></p>
<p>Swiftc 和 clang 一样构建在 LLVM 上，遵循 clang 编译器相似的编译流程。</p>
<p>在编译过程的第一部分，使用一个特定语言前端进行管理，swift 源代码被解释生成一个抽象语法树(AST)表达2，然后抽象语法树的结果从语义角度进行分析，找出语义错误。</p>
<p>在这个点上，对于其他的基于 LLVM 的编译器来讲，在通过一个附加步骤对源代码进行静态分析后（必要时可以显示错误和警告），接着 IRGen 模块 会把 AST 的内容会转换成一个轻量的和底层的机器无关的表示，我们称之为 LLVM IR(LLVM 中间表示)。</p>
<p>尽管两个模块都需要做一些相同检查，但是这两个模块是区分开的，在两个模块之间也存在许多重复的代码。</p>
<p>IR 是一种静态单赋值形式（SSA-form）一致语言，可以看做注入了 LLVM 的虚拟机下的 RISC 类型汇编语言。基于 SSA 将简化接下来的编译过程，从语言前端提供的中间表达会在 IR 进行多重优化。</p>
<p>需要重点注意的是，IR 其中一个特点是，它具有三种不同的形式：内存表达（内部使用），序列化位代码形式（你已经知道的位代码形式）和可读形式。</p>
<p>最后一种形式非常有用，用来验证 IR 代码的最终结构，这个结构将会传入到整个过程中的最后一步，将会从机器独立的 IR 代码转换成平台相关的表达(比如：x86，ARM 等等)。最后一步将被 LLVM 平台后端执行。</p>
<p>那么 swiftc 和其他基于 LLVM 的编译器有什么不同呢？<br>swiftc 和其他编译器从结构形式上的差别主要体现在一个附加组件，这个附加组件是 SILGen ，在 IRGen 之前，执行代码的监测和优化，生成一个高级的中间表达，我们称之为 SIL （Swift Intermediate Language，Swift 中间语言），最后 SIL 将会转换成 LLVM IR。这一步加强了在单个软件模块上所有具体语言的检查，并且简化了 IRGen。</p>
<p>从 AST 到 IR 的转换分为两个步骤。SILGen 把 AST 源代码转换为原始 SIL ，然后编译器进行 Swift 语法检查（需要时打印错误或者警告信息），优化有效的原始 SIL ，通过一些步骤最后生成标准化 SIL 。如上面的示意图显示那样，标准化 SIL 的最后转化为 LLVM IR。</p>
<p>再次强调，SIL 是一个 SSA 类型语言，使用附加的结构扩展了 Swift 的语法。它依赖 Swift 的类型系统，并且能理解 Swift 的定义，但是需要重点记住的是，当编译一个手写的 SIL 源码（是的，可以手动写 SIL 然后编译它）时，高阶的 Swift 代码或者函数内容将被编译器忽略。</p>
<p>在接下来的章节，我们将分析一个标准化 SIL 的案例，来理解 unowned 和 weak 引用如何被编译器处理。一个包含捕获列表的基本闭包的例子，查看这个例子生成的 SIL 代码，可以看到被编译器添加的所有 ARC 相关的函数调用。</p>
<blockquote>
<p>从 GitHub 或者 zipped 获取本文相关的 Playground 代码。然后从这里获取闭包案例和 SIL ，SILGen 以及 LLVM IR 的输出。</p>
</blockquote>
<h2 id="捕获列表处理解析"><a href="#捕获列表处理解析" class="headerlink" title="捕获列表处理解析"></a>捕获列表处理解析</h2><p>接下来看看一个简单的 Swift 的例子，定义两个类变量，然后在一个闭包中对他们进行弱引用的捕获：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> value = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c1 = aClass()</span><br><span class="line"><span class="keyword">var</span> c2 = aClass()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fSpec = &#123; </span><br><span class="line">    [<span class="keyword">unowned</span> c1, <span class="keyword">weak</span> c2] <span class="keyword">in</span></span><br><span class="line">    c1.value = <span class="number">42</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> c2o = c2 &#123;</span><br><span class="line">        c2o.value = <span class="number">42</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fSpec()</span><br></pre></td></tr></table></figure>

<p>通过 xcrun swiftc -emit-sil sample.swift 编译 swift 源代码，生成标准化 SIL 代码。原始SIL 可以使用 -emit-silgen 选项来生成。</p>
<p>运行以上命令以后，会发现 swiftc 产生了许多代码。通过查看 swiftc 输出代码的片段，学习一下基本的 SIL 指令，理解整个结构。</p>
<p>在下面代码中需要的地方添加了一些多行注释（编译器也生成了一些单行注释），希望这些注释已经足够说清楚发生了什么：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  此文件包含典型 SIL 代码</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">sil_stage canonical             </span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  只有在 SIL 内部使用的特殊的导入</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">import</span> Builtin                  </span><br><span class="line"><span class="keyword">import</span> Swift</span><br><span class="line"><span class="keyword">import</span> SwiftShims</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	三个全局变量的定义，包括 c1，c2 和 闭包 fSpec。</span></span><br><span class="line"><span class="comment">  	@_Tv4clos2c1CS_6aClass是变量的符号，$aClass 是它的类型（类型前缀为$)。</span></span><br><span class="line"><span class="comment">  	变量名在这里看起来很乱，但是在后面的代码中将变得更加可读。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// c1</span></span><br><span class="line">sil_global hidden @_Tv4sample2c1CS_6aClass : $aClass</span><br><span class="line"></span><br><span class="line"><span class="comment">// c2</span></span><br><span class="line">sil_global hidden @_Tv4sample2c2CS_6aClass : $aClass</span><br><span class="line"></span><br><span class="line"><span class="comment">// fSpec</span></span><br><span class="line">sil_global hidden @_Tv4sample5fSpecFT_T_ : $@callee_owned () -&gt; ()</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  层次作用域定义表示原始代码的位置。</span></span><br><span class="line"><span class="comment">  每个 SIL 指示将会指向它生成的 `sil_scope`。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">sil_scope <span class="number">1</span> &#123;  parent @main : $<span class="meta">@convention</span>(<span class="built_in">c</span>) (<span class="type">Int32</span>, <span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Optional</span>&lt;<span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Int8</span>&gt;&gt;&gt;) -&gt; <span class="type">Int32</span> &#125;</span><br><span class="line">sil_scope <span class="number">2</span> &#123; loc <span class="string">"sample.swift"</span>:<span class="number">14</span>:<span class="number">1</span> parent <span class="number">1</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	自动生成的 @main 函数包含了我们原始全部作用域的代码。</span></span><br><span class="line"><span class="comment"> 	这里沿用了熟悉的 c main() 函数结构，接收参数个数和参数数组两个输入，这个函数遵循 c 调用约定。</span></span><br><span class="line"><span class="comment">  	这个函数包含了需要调用闭包的指令。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// main</span></span><br><span class="line">sil @main : $<span class="meta">@convention</span>(<span class="built_in">c</span>) (<span class="type">Int32</span>, <span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Optional</span>&lt;<span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Int8</span>&gt;&gt;&gt;) -&gt; <span class="type">Int32</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  入口定义头部为 % 符号，后面跟随一个数字 id。</span></span><br><span class="line"><span class="comment">  每当一个新的入口定义时（或者函数开头定义函数参数），编译器在入口行尾根据它的值（叫做 users）添加一个注释。</span></span><br><span class="line"><span class="comment">  对于其他指令，需要提供 id 号。</span></span><br><span class="line"><span class="comment">  在这里，入口 0 将被用来计算入口 4 的内容，入口 1 将被用来创建入口 10 的值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// %0                                             // user: %4</span></span><br><span class="line"><span class="comment">// %1                                             // user: %10</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  每一个函数被分解成一系列的基本指令块，每一个指令块结束于一个终止指令（一个分支或者一个返回）。</span></span><br><span class="line"><span class="comment">  这一系列的指令块表示函数所有可能的执行路径。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">bb0(%<span class="number">0</span> : $<span class="type">Int32</span>, %<span class="number">1</span> : $<span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Optional</span>&lt;<span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Int8</span>&gt;&gt;&gt;):</span><br><span class="line">...</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    每一个 SIL 指令都包含一个引用，指向源代码的位置，包括指令具体从源代码中哪个地方来，属于哪一个作用域。</span></span><br><span class="line"><span class="comment">    在后面分析具体的方法会看到这些内容。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  unowned_retain %<span class="number">27</span> : $@sil_unowned aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">14</span>, scope <span class="number">2</span> <span class="comment">// id: %28</span></span><br><span class="line">  store %<span class="number">27</span> to %<span class="number">2</span> : $*@sil_unowned aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">14</span>, scope <span class="number">2</span> <span class="comment">// id: %29</span></span><br><span class="line">  %<span class="number">30</span> = alloc_box $@sil_weak <span class="type">Optional</span>&lt;aClass&gt;, <span class="keyword">var</span>, name <span class="string">"c2"</span>, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">23</span>, scope <span class="number">2</span> <span class="comment">// users: %46, %44, %43, %31</span></span><br><span class="line">  %<span class="number">31</span> = project_box %<span class="number">30</span> : $@box @sil_weak <span class="type">Optional</span>&lt;aClass&gt;, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">23</span>, scope <span class="number">2</span> <span class="comment">// user: %35</span></span><br><span class="line">  %<span class="number">32</span> = load %<span class="number">19</span> : $*aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">23</span>, scope <span class="number">2</span> <span class="comment">// users: %34, %33</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  下面是一系列自动生成的`aClass`的方法，包括： init/deinit, setter/getter 和其他一些工具方法。</span></span><br><span class="line"><span class="comment">  每个方法前的注释是编译器添加的，用来说明代码的具体作用。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  隐藏方法只在它们模块中可见。</span></span><br><span class="line"><span class="comment">  @convention(方法名)是 Swift 中方法调用默认的约定，在尾部有一个附加的参数指向它自己。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// aClass.__deallocating_deinit</span></span><br><span class="line">sil hidden @_TFC4clos6aClassD : $<span class="meta">@convention</span>(method) (@owned aClass) -&gt; () &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  @guaranteed 参数表示保证在整个周期内调用此方法都有效。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// aClass.deinit</span></span><br><span class="line">sil hidden @_TFC4clos6aClassd : $<span class="meta">@convention</span>(method) (@guaranteed aClass) -&gt; @owned <span class="type">Builtin</span>.<span class="type">NativeObject</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  [transparent] 修饰的方法是内联的小方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// aClass.value.getter</span></span><br><span class="line">sil hidden [transparent] @_TFC4clos6aClassg5valueSi : $<span class="meta">@convention</span>(method) (@guaranteed aClass) -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// aClass.value.setter</span></span><br><span class="line">sil hidden [transparent] @_TFC4clos6aClasss5valueSi : $<span class="meta">@convention</span>(method) (<span class="type">Int</span>, @guaranteed aClass) -&gt; () &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// aClass.value.materializeForSet</span></span><br><span class="line">sil hidden [transparent] @_TFC4clos6aClassm5valueSi : $<span class="meta">@convention</span>(method) (<span class="type">Builtin</span>.<span class="type">RawPointer</span>, @<span class="keyword">inout</span> <span class="type">Builtin</span>.<span class="type">UnsafeValueBuffer</span>, @guaranteed aClass) -&gt; (<span class="type">Builtin</span>.<span class="type">RawPointer</span>, <span class="type">Optional</span>&lt;<span class="type">Builtin</span>.<span class="type">RawPointer</span>&gt;) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  @owned 修饰符表示这个对象将被调用者拥有。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// aClass.init() -&gt; aClass</span></span><br><span class="line">sil hidden @_TFC4clos6aClasscfT_S0_ : $<span class="meta">@convention</span>(method) (@owned aClass) -&gt; @owned aClass &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// aClass.__allocating_init() -&gt; aClass</span></span><br><span class="line">sil hidden @_TFC4clos6aClassCfT_S0_ : $<span class="meta">@convention</span>(method) (@thick aClass.<span class="type">Type</span>) -&gt; @owned aClass &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  接下面是闭包代码段</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// (closure #1)</span></span><br><span class="line">sil shared @_TF4closU_FT_T_ : $<span class="meta">@convention</span>(thin) (@owned @sil_unowned aClass, @owned @box @sil_weak <span class="type">Optional</span>&lt;aClass&gt;) -&gt; () &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* 关于闭包的 SIL 代码， 见下文 */</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">  sil_vtable 定义所有关于 aClass 类的虚函数表。</span></span><br><span class="line"><span class="comment">  sil_vtable 包含了期望的所有自动生成的方法。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">sil_vtable aClass &#123;</span><br><span class="line">  #aClass.<span class="keyword">deinit</span>!deallocator: _TFC4clos6aClassD	<span class="comment">// aClass.__deallocating_deinit</span></span><br><span class="line">  #aClass.value!getter.<span class="number">1</span>: _TFC4clos6aClassg5valueSi	<span class="comment">// aClass.value.getter</span></span><br><span class="line">  #aClass.value!setter.<span class="number">1</span>: _TFC4clos6aClasss5valueSi	<span class="comment">// aClass.value.setter</span></span><br><span class="line">  #aClass.value!materializeForSet.<span class="number">1</span>: _TFC4clos6aClassm5valueSi	<span class="comment">// aClass.value.materializeForSet</span></span><br><span class="line">  #aClass.<span class="keyword">init</span>!initializer.<span class="number">1</span>: _TFC4clos6aClasscfT_S0_	<span class="comment">// aClass.init() -&gt; aClass</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在回到主函数，看看两个类实例如何被获取到，并如何传递给调用他们的闭包。</p>
<p>在这里，所有标识都被重新整理，使得代码片段更加可读。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main</span></span><br><span class="line">sil @main : $<span class="meta">@convention</span>(<span class="built_in">c</span>) (<span class="type">Int32</span>, <span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Optional</span>&lt;<span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Int8</span>&gt;&gt;&gt;) -&gt; <span class="type">Int32</span> &#123;</span><br><span class="line"><span class="comment">// %0                                             // user: %4</span></span><br><span class="line"><span class="comment">// %1                                             // user: %10</span></span><br><span class="line">bb0(%<span class="number">0</span> : $<span class="type">Int32</span>, %<span class="number">1</span> : $<span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Optional</span>&lt;<span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Int8</span>&gt;&gt;&gt;):</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    全局变量的引用使用三个入口来放置。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  %<span class="number">13</span> = global_addr @clos.c1 : $*aClass, loc <span class="string">"sample.swift"</span>:<span class="number">5</span>:<span class="number">5</span>, scope <span class="number">1</span> <span class="comment">// users: %26, %17</span></span><br><span class="line">  ...</span><br><span class="line">  %<span class="number">19</span> = global_addr @clos.c2 : $*aClass, loc <span class="string">"sample.swift"</span>:<span class="number">6</span>:<span class="number">5</span>, scope <span class="number">1</span> <span class="comment">// users: %32, %23</span></span><br><span class="line">  ...</span><br><span class="line">  %<span class="number">25</span> = global_addr @clos.fSpec : $*@callee_owned () -&gt; (), loc <span class="string">"sample.swift"</span>:<span class="number">8</span>:<span class="number">5</span>, scope <span class="number">1</span> <span class="comment">// users: %48, %45</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    c1 是 unowned_retained 的。</span></span><br><span class="line"><span class="comment">    下面的指令增加变量的 unowned 引用计数。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  %<span class="number">26</span> = load %<span class="number">13</span> : $*aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">14</span>, scope <span class="number">2</span> <span class="comment">// user: %27</span></span><br><span class="line">  %<span class="number">27</span> = ref_to_unowned %<span class="number">26</span> : $aClass to $@sil_unowned aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">14</span>, scope <span class="number">2</span> <span class="comment">// users: %47, %38, %39, %29, %28</span></span><br><span class="line">  unowned_retain %<span class="number">27</span> : $@sil_unowned aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">14</span>, scope <span class="number">2</span> <span class="comment">// id: %28</span></span><br><span class="line">  store %<span class="number">27</span> to %<span class="number">2</span> : $*@sil_unowned aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">14</span>, scope <span class="number">2</span> <span class="comment">// id: %29</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    对 c2 的处理会更加复杂一些。</span></span><br><span class="line"><span class="comment">	alloc_box 创建了一个这个变量的引用数容器，变量将会存在这个容器的堆中。</span></span><br><span class="line"><span class="comment">    容器创建以后，将会创建一个可选变量，指向 c2，并且可选变量会存储在容器里。容器会增加所包含值的技术，正如下面看到的一样，一旦容器被迁移，可选值就会被释放。</span></span><br><span class="line"><span class="comment">    在这里，c2 的值将被存储在这个可选值中，对象将暂时strong_retained 然后释放。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  %<span class="number">30</span> = alloc_box $@sil_weak <span class="type">Optional</span>&lt;aClass&gt;, <span class="keyword">var</span>, name <span class="string">"c2"</span>, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">23</span>, scope <span class="number">2</span> <span class="comment">// users: %46, %44, %43, %31</span></span><br><span class="line">  %<span class="number">31</span> = project_box %<span class="number">30</span> : $@box @sil_weak <span class="type">Optional</span>&lt;aClass&gt;, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">23</span>, scope <span class="number">2</span> <span class="comment">// user: %35</span></span><br><span class="line">  %<span class="number">32</span> = load %<span class="number">19</span> : $*aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">23</span>, scope <span class="number">2</span> <span class="comment">// users: %34, %33</span></span><br><span class="line">  strong_retain %<span class="number">32</span> : $aClass, loc <span class="string">"sample.swift"</span>:<span class="number">9</span>:<span class="number">23</span>, scope <span class="number">2</span> <span class="comment">// id: %33</span></span><br><span class="line">  %<span class="number">34</span> = <span class="class"><span class="keyword">enum</span> <span class="title">$Optional</span>&lt;<span class="title">aClass</span>&gt;, #<span class="title">Optional</span>.<span class="title">some</span>!<span class="title">enumelt</span>.1, %32 : <span class="title">$aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":9:23, <span class="title">scope</span> 2 // <span class="title">users</span>: %36, %35</span></span><br><span class="line"><span class="class">  <span class="title">store_weak</span> %34 <span class="title">to</span> [<span class="title">initialization</span>] %31 : <span class="title">$</span>*@<span class="title">sil_weak</span> <span class="title">Optional</span>&lt;<span class="title">aClass</span>&gt;, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":9:23, <span class="title">scope</span> 2 // <span class="title">id</span>: %35</span></span><br><span class="line"><span class="class">  <span class="title">release_value</span> %34 : <span class="title">$Optional</span>&lt;<span class="title">aClass</span>&gt;, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":9:23, <span class="title">scope</span> 2 // <span class="title">id</span>: %36</span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    获取到闭包的引用。</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  // <span class="title">function_ref</span> (<span class="title">closure</span> #1)</span></span><br><span class="line"><span class="class">  %37 = <span class="title">function_ref</span> @<span class="title">sample</span>.(<span class="title">closure</span> #1) : <span class="title">$</span>@<span class="title">convention</span>(<span class="title">thin</span>) (@<span class="title">owned</span> @<span class="title">sil_unowned</span> <span class="title">aClass</span>, @<span class="title">owned</span> @<span class="title">box</span> @<span class="title">sil_weak</span> <span class="title">Optional</span>&lt;<span class="title">aClass</span>&gt;) -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">user</span>: %44</span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    <span class="title">c1</span> 将被标记为 <span class="title">tagged</span>，并且变量变为 <span class="title">unowned_retained</span>。</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  <span class="title">strong_retain_unowned</span> %27 : <span class="title">$</span>@<span class="title">sil_unowned</span> <span class="title">aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">id</span>: %38</span></span><br><span class="line"><span class="class">  %39 = <span class="title">unowned_to_ref</span> %27 : <span class="title">$</span>@<span class="title">sil_unowned</span> <span class="title">aClass</span> <span class="title">to</span> <span class="title">$aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">users</span>: %42, %40</span></span><br><span class="line"><span class="class">  %40 = <span class="title">ref_to_unowned</span> %39 : <span class="title">$aClass</span> <span class="title">to</span> <span class="title">$</span>@<span class="title">sil_unowned</span> <span class="title">aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">users</span>: %44, %41</span></span><br><span class="line"><span class="class">  <span class="title">unowned_retain</span> %40 : <span class="title">$</span>@<span class="title">sil_unowned</span> <span class="title">aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">id</span>: %41</span></span><br><span class="line"><span class="class">  <span class="title">strong_release</span> %39 : <span class="title">$aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">id</span>: %42</span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    包含 <span class="title">c2</span> 的可选值容器是 <span class="title">strong_retained</span> 的。</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  <span class="title">strong_retain</span> %30 : <span class="title">$</span>@<span class="title">box</span> @<span class="title">sil_weak</span> <span class="title">Optional</span>&lt;<span class="title">aClass</span>&gt;, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">id</span>: %43</span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    创建一个闭包对象，绑定方法到参数中。</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  %44 = <span class="title">partial_apply</span> %37(%40, %30) : <span class="title">$</span>@<span class="title">convention</span>(<span class="title">thin</span>) (@<span class="title">owned</span> @<span class="title">sil_unowned</span> <span class="title">aClass</span>, @<span class="title">owned</span> @<span class="title">box</span> @<span class="title">sil_weak</span> <span class="title">Optional</span>&lt;<span class="title">aClass</span>&gt;) -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">user</span>: %45</span></span><br><span class="line"><span class="class">  <span class="title">store</span> %44 <span class="title">to</span> %25 : <span class="title">$</span>*@<span class="title">callee_owned</span> () -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":8:13, <span class="title">scope</span> 2 // <span class="title">id</span>: %45</span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">    对 <span class="title">c1</span> 和 <span class="title">c2</span> 的容器变量进行释放（使用 对应匹配的 *<span class="title">_release</span> 方法）。</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  <span class="title">strong_release</span> %30 : <span class="title">$</span>@<span class="title">box</span> @<span class="title">sil_weak</span> <span class="title">Optional</span>&lt;<span class="title">aClass</span>&gt;, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":14:1, <span class="title">scope</span> 2 // <span class="title">id</span>: %46</span></span><br><span class="line"><span class="class">  <span class="title">unowned_release</span> %27 : <span class="title">$</span>@<span class="title">sil_unowned</span> <span class="title">aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":9:14, <span class="title">scope</span> 2 // <span class="title">id</span>: %47</span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">     加载原先存储的闭包对象，增加强引用然后调用它。</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">   %48 = <span class="title">load</span> %25 : <span class="title">$</span>*@<span class="title">callee_owned</span> () -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":17:1, <span class="title">scope</span> 2 // <span class="title">users</span>: %50, %49</span></span><br><span class="line"><span class="class">  <span class="title">strong_retain</span> %48 : <span class="title">$</span>@<span class="title">callee_owned</span> () -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":17:1, <span class="title">scope</span> 2 // <span class="title">id</span>: %49</span></span><br><span class="line"><span class="class">  %50 = <span class="title">apply</span> %48() : <span class="title">$</span>@<span class="title">callee_owned</span> () -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":17:7, <span class="title">scope</span> 2</span></span><br><span class="line"><span class="class">  ...</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>

<p>闭包有一个更加复杂的结构：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  闭包参数被标记为 @sil, 指定参数如何被计数，有一个 unowned 的 aClass 类变量 c2, 和另外一个包含 c2 的可选值容器。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// (closure #1)</span></span><br><span class="line">sil shared @clos.fSpec: $<span class="meta">@convention</span>(thin) (@owned @sil_unowned aClass, @owned @box @sil_weak <span class="type">Optional</span>&lt;aClass&gt;) -&gt; () &#123;</span><br><span class="line"><span class="comment">// %0                                             // users: %24, %6, %5, %2</span></span><br><span class="line"><span class="comment">// %1                                             // users: %23, %3</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  下面的函数包含三块，后面两块的执行依赖可选值 c2 具体的值。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">bb0(%<span class="number">0</span> : $@sil_unowned aClass, %<span class="number">1</span> : $@box @sil_weak <span class="type">Optional</span>&lt;aClass&gt;):</span><br><span class="line">...</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    c1 被强计数。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  strong_retain_unowned %<span class="number">0</span> : $@sil_unowned aClass, loc <span class="string">"sample.swift"</span>:<span class="number">10</span>:<span class="number">5</span>, scope <span class="number">17</span> <span class="comment">// id: %5</span></span><br><span class="line">  %<span class="number">6</span> = unowned_to_ref %<span class="number">0</span> : $@sil_unowned aClass to $aClass, loc <span class="string">"sample.swift"</span>:<span class="number">10</span>:<span class="number">5</span>, scope <span class="number">17</span> <span class="comment">// users: %11, %10, %9</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    使用内部自带包，传入一个整型字面量到整型结构中，初始化了一个值为 42 的整型值。</span></span><br><span class="line"><span class="comment">    这个值将被设置为 c1 的新值，完成以后这个变量将会被释放。</span></span><br><span class="line"><span class="comment">    在这里，我们第一次看到 class_method 指令，用于获取 vtable 中的函数引用。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  %<span class="number">7</span> = integer_literal $<span class="type">Builtin</span>.<span class="type">Int64</span>, <span class="number">42</span>, loc <span class="string">"sample.swift"</span>:<span class="number">10</span>:<span class="number">16</span>, scope <span class="number">17</span> <span class="comment">// user: %8</span></span><br><span class="line">  %<span class="number">8</span> = <span class="class"><span class="keyword">struct</span> <span class="title">$Int</span> (%7 : <span class="title">$Builtin</span>.<span class="title">Int64</span>), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":10:16, <span class="title">scope</span> 17 // <span class="title">user</span>: %10</span></span><br><span class="line"><span class="class">  %9 = <span class="title">class_method</span> %6 : <span class="title">$aClass</span>, #<span class="title">aClass</span>.<span class="title">value</span>!<span class="title">setter</span>.1 : (<span class="title">aClass</span>) -&gt; (<span class="title">Int</span>) -&gt; () , <span class="title">$</span>@<span class="title">convention</span>(<span class="title">method</span>) (<span class="title">Int</span>, @<span class="title">guaranteed</span> <span class="title">aClass</span>) -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":10:14, <span class="title">scope</span> 17 // <span class="title">user</span>: %10</span></span><br><span class="line"><span class="class">  %10 = <span class="title">apply</span> %9(%8, %6) : <span class="title">$</span>@<span class="title">convention</span>(<span class="title">method</span>) (<span class="title">Int</span>, @<span class="title">guaranteed</span> <span class="title">aClass</span>) -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":10:14, <span class="title">scope</span> 17</span></span><br><span class="line"><span class="class">  <span class="title">strong_release</span> %6 : <span class="title">$aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":10:16, <span class="title">scope</span> 17 // <span class="title">id</span>: %11</span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    接下来讨论 <span class="title">c2</span>。</span></span><br><span class="line"><span class="class">    获取可选值，然后根据它的内容执行接下来的分支语句。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">If</span> <span class="title">the</span> <span class="title">optional</span> <span class="title">has</span> <span class="title">a</span> <span class="title">value</span> <span class="title">the</span> <span class="title">bb2</span> <span class="title">block</span> <span class="title">will</span> <span class="title">be</span> <span class="title">executed</span> <span class="title">before</span> <span class="title">jumping</span> </span></span><br><span class="line"><span class="class">    <span class="title">to</span> <span class="title">bb3</span>, <span class="title">if</span> <span class="title">it</span> <span class="title">doesn</span>'<span class="title">t</span> <span class="title">after</span> <span class="title">a</span> <span class="title">brief</span> <span class="title">jump</span> <span class="title">to</span> <span class="title">bb1</span>, <span class="title">the</span> <span class="title">function</span> <span class="title">will</span> <span class="title">proceed</span> <span class="title">to</span> <span class="title">bb3</span> <span class="title">releasing</span></span></span><br><span class="line"><span class="class">    <span class="title">the</span> <span class="title">retained</span> <span class="title">parameters</span>.</span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  %12 = <span class="title">load_weak</span> %3 : <span class="title">$</span>*@<span class="title">sil_weak</span> <span class="title">Optional</span>&lt;<span class="title">aClass</span>&gt;, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":11:18, <span class="title">scope</span> 18 // <span class="title">user</span>: %13</span></span><br><span class="line"><span class="class">  <span class="title">switch_enum</span> %12 : <span class="title">$Optional</span>&lt;<span class="title">aClass</span>&gt;, <span class="title">case</span> #<span class="title">Optional</span>.<span class="title">some</span>!<span class="title">enumelt</span>.1: <span class="title">bb2</span>, <span class="title">default</span> <span class="title">bb1</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":11:18, <span class="title">scope</span> 18 // <span class="title">id</span>: %13</span></span><br><span class="line"><span class="class">  <span class="title">bb1</span>:                                              // <span class="title">Preds</span>: <span class="title">bb0</span></span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    跳转到闭包的结尾。</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  <span class="title">br</span> <span class="title">bb3</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":11:18, <span class="title">scope</span> 16        // <span class="title">id</span>: %14</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">// %15                                            // <span class="title">users</span>: %21, %20, %19, %16</span></span><br><span class="line"><span class="class"><span class="title">bb2</span>(%15 : <span class="title">$aClass</span>):                               // <span class="title">Preds</span>: <span class="title">bb0</span></span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    调用 <span class="title">aClass</span> 的 <span class="title">setter</span>，设置它的值为 42.</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  ...</span></span><br><span class="line"><span class="class">  %17 = <span class="title">integer_literal</span> <span class="title">$Builtin</span>.<span class="title">Int64</span>, 42, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":12:21, <span class="title">scope</span> 19 // <span class="title">user</span>: %18</span></span><br><span class="line"><span class="class">  %18 = <span class="title">struct</span> <span class="title">$Int</span> (%17 : <span class="title">$Builtin</span>.<span class="title">Int64</span>), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":12:21, <span class="title">scope</span> 19 // <span class="title">user</span>: %20</span></span><br><span class="line"><span class="class">  %19 = <span class="title">class_method</span> %15 : <span class="title">$aClass</span>, #<span class="title">aClass</span>.<span class="title">value</span>!<span class="title">setter</span>.1 : (<span class="title">aClass</span>) -&gt; (<span class="title">Int</span>) -&gt; () , <span class="title">$</span>@<span class="title">convention</span>(<span class="title">method</span>) (<span class="title">Int</span>, @<span class="title">guaranteed</span> <span class="title">aClass</span>) -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":12:19, <span class="title">scope</span> 19 // <span class="title">user</span>: %20</span></span><br><span class="line"><span class="class">  %20 = <span class="title">apply</span> %19(%18, %15) : <span class="title">$</span>@<span class="title">convention</span>(<span class="title">method</span>) (<span class="title">Int</span>, @<span class="title">guaranteed</span> <span class="title">aClass</span>) -&gt; (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":12:19, <span class="title">scope</span> 19</span></span><br><span class="line"><span class="class">  <span class="title">strong_release</span> %15 : <span class="title">$aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":13:5, <span class="title">scope</span> 18 // <span class="title">id</span>: %21</span></span><br><span class="line"><span class="class">  <span class="title">br</span> <span class="title">bb3</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":13:5, <span class="title">scope</span> 18         // <span class="title">id</span>: %22</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">bb3</span>:                                              // <span class="title">Preds</span>: <span class="title">bb1</span> <span class="title">bb2</span></span></span><br><span class="line"><span class="class">  /*</span></span><br><span class="line"><span class="class">    释放所有获取的变量然后返回。</span></span><br><span class="line"><span class="class">  */</span></span><br><span class="line"><span class="class">  <span class="title">strong_release</span> %1 : <span class="title">$</span>@<span class="title">box</span> @<span class="title">sil_weak</span> <span class="title">Optional</span>&lt;<span class="title">aClass</span>&gt;, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":14:1, <span class="title">scope</span> 17 // <span class="title">id</span>: %23</span></span><br><span class="line"><span class="class">  <span class="title">unowned_release</span> %0 : <span class="title">$</span>@<span class="title">sil_unowned</span> <span class="title">aClass</span>, <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":14:1, <span class="title">scope</span> 17 // <span class="title">id</span>: %24</span></span><br><span class="line"><span class="class">  %25 = <span class="title">tuple</span> (), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":14:1, <span class="title">scope</span> 17 // <span class="title">user</span>: %26</span></span><br><span class="line"><span class="class">  <span class="title">return</span> %25 : <span class="title">$</span>(), <span class="title">loc</span> "<span class="title">sample</span>.<span class="title">swift</span>":14:1, <span class="title">scope</span> 17 // <span class="title">id</span>: %26</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在这里，忽略掉不同的 ARC 指令带来的性能的差异点，对不同阶段每种类型的捕获变量做一个快速的对比：</p>
<table>
<thead>
<tr>
<th>动作</th>
<th>Unowned</th>
<th>Weak</th>
</tr>
</thead>
<tbody><tr>
<td>预先调用 #1</td>
<td>对象进行 unowned_retain</td>
<td>创建一个容器，并且对象进行 strong_retain 操作。创建一个可选值，存入到容器中，然后释放可选值</td>
</tr>
<tr>
<td>预先调用 #2</td>
<td>strong_retain_unowned，unowned_retain 和 strong_release</td>
<td>strong_retain</td>
</tr>
<tr>
<td>闭包执行</td>
<td>strong_retain_unowned，unowned_release</td>
<td>load_weak, 打开可选值, strong_release</td>
</tr>
<tr>
<td>调用之后</td>
<td>unowned_release</td>
<td>strong_release</td>
</tr>
</tbody></table>
<p>正如上面看到的 SIL 代码段那样，处理 weak 引用会涉及到更多的工作，因为需要处理引用需要的可选值。</p>
<p>参照官方文档的描述，这里对涉及到的所有 ARC 指令做一个简要的解释：</p>
<ul>
<li>unowned_retain：增加堆对象中的 unowned 引用计数。</li>
<li>strong_retain_unowned ：断言对象的强引用计数大于 0，然后增加这个引用计数。</li>
<li>strong_retain：增加对象的强引用计数。</li>
<li>load_weak：不是真正的 ARC 调用，但是它将增加可选值指向对象的强引用计数。</li>
<li>strong_release：减少对象的强引用计数。如果释放操作把对象强引用计数变为0，对象将被销毁，然后弱引用将被清除。当整个强引用计数和 unowned 引用计数都为0时，对象的内存才会被释放。</li>
<li>unowned_release：减少对象的 unowned 引用计数。当整个强引用计数和 unowned 引用计数都为 0 时，对象的内存才会被释放。</li>
</ul>
<p>接下来深入到 Swift 运行时看看，这些指令都是如何被实现的，相关的代码文件有：HeapObject.cpp，HeapObject.h，RefCount.h 和 Heap.cpp、 SwiftObject.mm 中的少量定义。容器实现可以在 MetadataImpl.h 找到，但是本文不展开讨论。</p>
<p>这些文件中定义大多数的 ARC 方法都有三种变体，一种是对 Swift 对象的基础实现，另外两种实现是针对非原生 Swift 对象的：桥接对象和未知对象。后面两种变体这里不予讨论。</p>
<p>第一个讨论指令集和 unowned 引用相关。</p>
<p>在 HeapObject.cpp 文件中间可以看到对 unowned_retain 和 unowned_release 的实现方法：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">SWIFT_RT_ENTRY_VISIBILITY</span></span><br><span class="line">void swift::swift_unownedRetain(<span class="type">HeapObject</span> *object)</span><br><span class="line">    <span class="type">SWIFT_CC</span>(<span class="type">RegisterPreservingCC_IMPL</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!object)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  object-&gt;weakRefCount.increment();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">SWIFT_RT_ENTRY_VISIBILITY</span></span><br><span class="line">void swift::swift_unownedRelease(<span class="type">HeapObject</span> *object)</span><br><span class="line">    <span class="type">SWIFT_CC</span>(<span class="type">RegisterPreservingCC_IMPL</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!object)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (object-&gt;weakRefCount.decrementShouldDeallocate()) &#123;</span><br><span class="line">    <span class="comment">// Only class objects can be weak-retained and weak-released.</span></span><br><span class="line">    auto metadata = object-&gt;metadata;</span><br><span class="line">    <span class="built_in">assert</span>(metadata-&gt;isClassObject());</span><br><span class="line">    auto classMetadata = static_cast&lt;const <span class="type">ClassMetadata</span>*&gt;(metadata);</span><br><span class="line">    <span class="built_in">assert</span>(classMetadata-&gt;isTypeMetadata());</span><br><span class="line">    <span class="type">SWIFT_RT_ENTRY_CALL</span>(swift_slowDealloc)</span><br><span class="line">        (object, classMetadata-&gt;getInstanceSize(),</span><br><span class="line">         classMetadata-&gt;getInstanceAlignMask());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>swift_unownedRetain 是 unowned_retain 的具体实现，简单地进行 unowned 引用计数的原子增加操作（这里定义为weakRefCount），swift_unownedRelease 更加复杂，原因之前也描述过，当没有其他 unowned 引用存在时，它需要执行对象的析构操作。</p>
<p>但是整体来讲都不复杂，在这里可以看到 doDecrementShouldDeallocate 方法，这个方法在上面代码中被一个命名类似的方法调用了。这个方法没有做太多，swift_slowDealloc 只是释放给定的指针。</p>
<p>到此已经有了一个对象的 unowned 引用，另外一个指令，strong_retain_unowned 用来创建一个强引用：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">SWIFT_RT_ENTRY_VISIBILITY</span></span><br><span class="line">void swift::swift_unownedRetainStrong(<span class="type">HeapObject</span> *object)</span><br><span class="line">    <span class="type">SWIFT_CC</span>(<span class="type">RegisterPreservingCC_IMPL</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!object)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="built_in">assert</span>(object-&gt;weakRefCount.getCount() &amp;&amp;</span><br><span class="line">         <span class="string">"object is not currently weakly retained"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (! object-&gt;refCount.tryIncrement())</span><br><span class="line">    _swift_abortRetainUnowned(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为弱引用应该指向了这个对象，要使用断言来验证对象是否被弱引用，一旦断言通过，将尝试进行增加强引用计数的操作。一旦对象在进程中已经被释放，尝试将会失败。</p>
<p>所有类似于 tryIncrement 通过某种形式修改引用计数的方法都放到 RefCount.h 中，需要使用原子操作进行这些任务。</p>
<p>接下来讨论下 weak 引用的的实现，正如之前看到的那样，swift_weakLoadStrong 用来获取容器中可选值中强引用的对象。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">HeapObject</span> *swift::swift_weakLoadStrong(<span class="type">WeakReference</span> *ref) &#123;</span><br><span class="line">  <span class="keyword">if</span> (ref-&gt;<span class="type">Value</span> == (uintptr_t)nullptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ref 可能被其他线程访问</span></span><br><span class="line">  auto ptr = __atomic_fetch_or(&amp;ref-&gt;<span class="type">Value</span>, <span class="type">WR_READING</span>, __ATOMIC_RELAXED);</span><br><span class="line">  <span class="keyword">while</span> (ptr &amp; <span class="type">WR_READING</span>) &#123;</span><br><span class="line">    short <span class="built_in">c</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (__atomic_load_n(&amp;ref-&gt;<span class="type">Value</span>, __ATOMIC_RELAXED) &amp; <span class="type">WR_READING</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (++<span class="built_in">c</span> == <span class="type">WR_SPINLIMIT</span>) &#123;</span><br><span class="line">        std::this_thread::yield();</span><br><span class="line">        <span class="built_in">c</span> -= <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ptr = __atomic_fetch_or(&amp;ref-&gt;<span class="type">Value</span>, <span class="type">WR_READING</span>, __ATOMIC_RELAXED);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  auto object = (<span class="type">HeapObject</span>*)(ptr &amp; ~<span class="type">WR_NATIVE</span>);</span><br><span class="line">  <span class="keyword">if</span> (object == nullptr) &#123;</span><br><span class="line">    __atomic_store_n(&amp;ref-&gt;<span class="type">Value</span>, (uintptr_t)nullptr, __ATOMIC_RELAXED);</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (object-&gt;refCount.isDeallocating()) &#123;</span><br><span class="line">    __atomic_store_n(&amp;ref-&gt;<span class="type">Value</span>, (uintptr_t)nullptr, __ATOMIC_RELAXED);</span><br><span class="line">    <span class="type">SWIFT_RT_ENTRY_CALL</span>(swift_unownedRelease)(object);</span><br><span class="line">    <span class="keyword">return</span> nullptr;</span><br><span class="line">  &#125;</span><br><span class="line">  auto result = swift_tryRetain(object);</span><br><span class="line">  __atomic_store_n(&amp;ref-&gt;<span class="type">Value</span>, ptr, __ATOMIC_RELAXED);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个实现中，获取一个强引用需要更多复杂同步操作，在多线程竞争严重的情况下，会带来性能损耗。</p>
<p>在这里第一次出现的 WeakReference 对象，是一个简单的结构体，包含一个整型值字段指向目标对象，目标对象是使用 HeapObject 类来承载的每一个运行时的 Swift 对象。</p>
<p>在 weak 引用询问当前线程设置的 WR_READING 标识之后，从 WeakReference 容器中获取 Swift 对象，如果对象不再有效，或者在等待获取资源时，它变成可以进行析构，当前的引用会被设置为 null。</p>
<p>如果对象依然有效，获取对象的尝试将会成功。</p>
<p>因此，从这个角度来讲，对 weak 引用的常规操作性能比 unowned 引用的更低（但是主要的问题还是在可选值操作上面）。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>保守的使用 weak 引用是否明智呢？答案是否定的，无论是从性能的角度还是代码清晰的角度而言。</p>
<p>使用正确的捕获修饰符类型，明确的表明代码中的生命周期特性，当其他人或者你自己在读你的代码时不容易误解。</p>
<h2 id="脚注"><a href="#脚注" class="headerlink" title="脚注"></a>脚注</h2><p>1、苹果第一次讨论 weak/unowned 争议可以查看这里，之后在 twitter 上 Joe Groff 对此也进行了讨论，并且被 Michael Tsai 总结成文。<br>这篇文章从意图角度出发，提供了完整并且可操作的解释。</p>
<p>2、从维基百科中可以找到关于 AST 的解释，还可以从 Slava Pestov 的这篇文章中看到关于 Swift 编译器中如何实现 AST 的一些细节。</p>
<p>3、关于 SIL 的更多信息，请查看详尽的官方 SIL 指南，还有 2015 LLVM 开发者会议的视频。Lex Chou 写的 SIL 快速指南可以点击这里查看。</p>
<p>4、查看在 Swift 中如何进行名称粉碎（name mangling）的细节，请查看 Lex Chou 的这篇文章。</p>
<p>5、Mike Ash 在他的 Friday Q&amp;A 中的一篇文章中讨论了如何实现 weak 引用的一种实践方法，这种方法与目前 Swift 的方法对比起来有一些过时，但是其中的解释依然值得参考。</p>
<blockquote>
<p>本文由 SwiftGG 翻译组翻译，已经获得作者翻译授权，最新文章请访问 <a href="http://swift.gg./" target="_blank" rel="noopener">http://swift.gg。</a></p>
</blockquote>
<hr>
<p>文章转自 <a href="http://swift.gg/2017/05/16/unowned-or-weak-lifetime-and-performance/" target="_blank" rel="noopener">SwiftGG</a></p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>Unowned与Weak</tag>
      </tags>
  </entry>
  <entry>
    <title>「转」iOS图片加载速度极限优化—FastImageCache解析</title>
    <url>/post/bang-fastimagecache/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>原文：<a href="http://blog.cnbang.net/tech/2578/" target="_blank" rel="noopener">iOS图片加载速度极限优化—FastImageCache解析</a></p>
<p><a href="https://github.com/path/FastImageCache" target="_blank" rel="noopener">FastImageCache</a>是Path团队开发的一个开源库，用于提升图片的加载和渲染速度，让基于图片的列表滑动起来更顺畅，来看看它是怎么做的。</p>
<a id="more"></a>

<h2 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h2><p>iOS从磁盘加载一张图片，使用UIImageVIew显示在屏幕上，需要经过以下步骤：</p>
<ol>
<li>从磁盘拷贝数据到内核缓冲区</li>
<li>从内核缓冲区复制数据到用户空间</li>
<li>生成UIImageView，把图像数据赋值给UIImageView</li>
<li>如果图像数据为未解码的PNG/JPG，解码为位图数据</li>
<li>CATransaction捕获到UIImageView layer树的变化</li>
<li>主线程Runloop提交CATransaction，开始进行图像渲染<br> 6.1 如果数据没有字节对齐，Core Animation会再拷贝一份数据，进行字节对齐。<br> 6.2 GPU处理位图数据，进行渲染。</li>
</ol>
<p>FastImageCache分别优化了2,4,6.1三个步骤：</p>
<ol>
<li>使用mmap内存映射，省去了上述第2步数据从内核空间拷贝到用户空间的操作。</li>
<li>缓存解码后的位图数据到磁盘，下次从磁盘读取时省去第4步解码的操作。</li>
<li>生成字节对齐的数据，防止上述第6.1步CoreAnimation在渲染时再拷贝一份数据。</li>
</ol>
<p>接下来具体介绍这三个优化点以及它的实现。</p>
<h3 id="内存映射"><a href="#内存映射" class="headerlink" title="内存映射"></a>内存映射</h3><p>平常我们读取磁盘上的一个文件，上层API调用到最后会使用系统方法read()读取数据，内核把磁盘数据读入内核缓冲区，用户再从内核缓冲区读取数据复制到用户内存空间，这里有一次内存拷贝的时间消耗，并且读取后整个文件数据就已经存在于用户内存中，占用了进程的内存空间。</p>
<p>FastImageCache采用了另一种读写文件的方法，就是用mmap把文件映射到用户空间里的虚拟内存，文件中的位置在虚拟内存中有了对应的地址，可以像操作内存一样操作这个文件，相当于已经把整个文件放入内存，但在真正使用到这些数据前却不会消耗物理内存，也不会有读写磁盘的操作，只有真正使用这些数据时，也就是图像准备渲染在屏幕上时，虚拟内存管理系统VMS才根据缺页加载的机制从磁盘加载对应的数据块到物理内存，再进行渲染。这样的文件读写文件方式少了数据从内核缓存到用户空间的拷贝，效率很高。</p>
<h3 id="解码图像"><a href="#解码图像" class="headerlink" title="解码图像"></a>解码图像</h3><p>一般我们使用的图像是JPG/PNG，这些图像数据不是位图，而是是经过编码压缩后的数据，使用它渲染到屏幕之前需要进行解码转成位图数据，这个解码操作是比较耗时的，并且没有GPU硬解码，只能通过CPU，iOS默认会在主线程对图像进行解码。很多库都解决了图像解码的问题，不过由于解码后的图像太大，一般不会缓存到磁盘，SDWebImage的做法是把解码操作从主线程移到子线程，让耗时的解码操作不占用主线程的时间。</p>
<p>FastImageCache也是在子线程解码图像，不同的是它会缓存解码后的图像到磁盘。因为解码后的图像体积很大，FastImageCache对这些图像数据做了系列缓存管理，详见下文实现部分。另外缓存的图像体积大也是使用内存映射读取文件的原因，小文件使用内存映射无优势，内存拷贝的量少，拷贝后占用用户内存也不高，文件越大内存映射优势越大。</p>
<h3 id="字节对齐"><a href="#字节对齐" class="headerlink" title="字节对齐"></a>字节对齐</h3><p>Core Animation在图像数据非字节对齐的情况下渲染前会先拷贝一份图像数据，官方文档没有对这次拷贝行为作说明，模拟器和Instrument里有高亮显示“copied images”的功能，但似乎它有bug，即使某张图片没有被高亮显示出渲染时被copy，从调用堆栈上也还是能看到调用了CA::Render::copy_image方法：</p>
<p><img src="/images/fastImageCache1.png" alt="fastImageCache1"></p>
<p>那什么是字节对齐呢，按我的理解，为了性能，底层渲染图像时不是一个像素一个像素渲染，而是一块一块渲染，数据是一块块地取，就可能遇到这一块连续的内存数据里结尾的数据不是图像的内容，是内存里其他的数据，可能越界读取导致一些奇怪的东西混入，所以在渲染之前CoreAnimation要把数据拷贝一份进行处理，确保每一块都是图像数据，对于不足一块的数据置空。大致图示：(pixel是图像像素数据，data是内存里其他数据)</p>
<p><img src="/images/fastImageCache2.png" alt="fastImageCache2"></p>
<p>块的大小应该是跟CPU cache line有关，ARMv7是32byte，A9是64byte，在A9下CoreAnimation应该是按64byte作为一块数据去读取和渲染，让图像数据对齐64byte就可以避免CoreAnimation再拷贝一份数据进行修补。FastImageCache做的字节对齐就是这个事情。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>FastImageCache把同个类型和尺寸的图像都放在一个文件里，根据文件偏移取单张图片，类似web的css雪碧图，这里称为ImageTable。这样做主要是为了方便统一管理图片缓存，控制缓存的大小，整个FastImageCache就是在管理一个个ImageTable的数据。整体实现的数据结构如图：</p>
<p><img src="/images/fastImageCache3.png" alt="fastImageCache3"></p>
<p>一些补充和说明：</p>
<h3 id="ImageTable"><a href="#ImageTable" class="headerlink" title="ImageTable"></a>ImageTable</h3><ol>
<li>一个ImageFormat对应一个ImageTable，ImageFormat指定了ImageTable里图像渲染格式/大小等信息，ImageTable里的图像数据都由ImageFormat规定了统一的尺寸，每张图像大小都是一样的。</li>
<li>一个ImageTable一个实体文件，并有另一个文件保存这个ImageTable的meta信息。</li>
<li>图像使用entityUUID作为唯一标示符，由用户定义，通常是图像url的hash值。ImageTable Meta的indexMap记录了entityUUID-&gt;entryIndex的映射，通过indexMap就可以用图像的entityUUID找到缓存数据在ImageTable对应的位置。</li>
</ol>
<h3 id="ImageTableEntry"><a href="#ImageTableEntry" class="headerlink" title="ImageTableEntry"></a>ImageTableEntry</h3><ol>
<li>ImageTable的实体数据是ImageTableEntry，每个entry有两部分数据，一部分是对齐后的图像数据，另一部分是meta信息，meta保存这张图像的UUID和原图UUID，用于校验图像数据的正确性。</li>
<li>Entry数据是按内存分页大小对齐的，数据大小是内存分页大小的整数倍，这样可以保证虚拟内存缺页加载时使用最少的内存页加载一张图像。</li>
<li>图像数据做了字节对齐处理，CoreAnimation使用时无需再处理拷贝。具体做法是CGBitmapContextCreate创建位图画布时bytesPerRow参数传64倍数。</li>
</ol>
<h3 id="Chunk"><a href="#Chunk" class="headerlink" title="Chunk"></a>Chunk</h3><ul>
<li>ImageTable和实体数据Entry间多了层Chunk，Chunk是逻辑上的数据划分，N个Entry作为一个Chunk，内存映射mmap操作是以chunk为单位的，每一个chunk执行一次mmap把这个chunk的内容映射到虚拟内存。为什么要多一层chunk呢，按我的理解，这样做是为了灵活控制mmap的大小和调用次数，若对整个ImageTable执行mmap，载入虚拟内存的文件过大，若对每个Entry做mmap，调用次数会太多。</li>
</ul>
<h3 id="缓存管理"><a href="#缓存管理" class="headerlink" title="缓存管理"></a>缓存管理</h3><ul>
<li>用户可以定义整个ImageTable里最大缓存的图像数量，在有新图像需要缓存时，如果缓存没有超过限制，会以chunk为单位扩展文件大小，顺序写下去。如果已超过最大缓存限制，会把最少使用的缓存替换掉，实现方法是每次使用图像都会把UUID插入到MRUEntries数组的开头，MRUEntries按最近使用顺序排列了图像UUID，数组里最后一个图像就是最少使用的。被替换掉的图片下次需要再使用时，再走一次取原图—解压—存储的流程。</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>FastImageCache适合用于tableView里缓存每个cell上同样规格的图像，优点是能极大加快第一次从磁盘加载这些图像的速度。但它有两个明显的缺点：一是占空间大。因为缓存了解码后的位图到磁盘，位图是很大的，宽高100<em>100的图像在2x的高清屏设备下就需要200</em>200*4byte/pixel=156KB，这也是为什么FastImageCache要大费周章限制缓存大小。二是接口不友好，需预定义好缓存的图像尺寸。FastImageCache无法像SDWebImage那样无缝接入UIImageView，使用它需要配置ImageTable，定义好尺寸，手动提供的原图，每种实体图像要定义一个FICEntity模型，使逻辑变复杂。</p>
<p>FastImageCache已经属于极限优化，做图像加载/渲染优化时应该优先考虑一些低代价高回报的优化点，例如CALayer代替UIImageVIew，减少GPU计算（去透明/像素对齐），图像子线程解码，避免Offscreen-Render等。在其他优化都做到位，图像的渲染还是有性能问题的前提下才考虑使用FastImageCache进一步提升首次加载的性能，不过字节对齐的优化倒是可以脱离FastImageCache直接运用在项目上，只需要在解码图像时bitmap画布的bytesPerRow设为64的倍数即可。</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>FastImageCache</tag>
      </tags>
  </entry>
  <entry>
    <title>「转」一张思维导图，让正则表达式不再难懂</title>
    <url>/post/reprinted-regular-mind-map/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><img src="/images/bruch-up-regular-expressions-1.png" alt="思维导图"></p>
<a id="more"></a>

<h2 id="字符"><a href="#字符" class="headerlink" title="字符"></a>字符</h2><ul>
<li><p>普通字符：字母、数字、汉字、下划线，匹配与之相同的一个字符</p>
</li>
<li><p>简单转义字符：\n（换行）,\t（制表）,\（\本身）和 ^…（^等有特殊作用的符号如要匹配自己的话要用转义）</p>
</li>
<li><p>标准字符集合<br>注意区分大小写，大写是相反的意思，匹配相反是不匹配</p>
<ul>
<li>\d<br>  任意一个数字，0~9</li>
<li>\w<br>  任意一个字母、数字、汉字或下划线，A<del>Z、a</del>z、0~9、_和任意一个汉字</li>
<li>\s<br>  任意空白符，包括空格、制表符、换行符</li>
<li>.<br>  小数点可以匹配任意一个字符，换行除外（如果要匹配包括”\n”在内的所有字符，一般用[\s\S]）</li>
</ul>
</li>
<li><p>自定义字符集合<br>[ ]方括号匹配方式，能够匹配方括号中的任意一个字符,^表示取反</p>
<ul>
<li>[ab5@]<br>  匹配”a”或”b”或”5”或”@”</li>
<li>[^abc]<br>  匹配a、b、c之外的任意字符</li>
<li>[f-k]<br>  匹配“f”到”k”之间的字符</li>
<li>[^A-F0-3]<br>  匹配“A”-“F”,”0”-“3”之外的任意一个字符</li>
</ul>
</li>
</ul>
<h2 id="量词-Quantifier"><a href="#量词-Quantifier" class="headerlink" title="量词(Quantifier)"></a>量词(Quantifier)</h2><p>修饰前面的一个表达式，如果要修饰多个表达式，就用( )把表达式包起来</p>
<ul>
<li>{n}<br>  表达式重复n次​</li>
<li>{m,n}<br>  表达式至少重复m次，最多重复n次<ul>
<li>贪婪模式 （默认）<br>匹配符合的最长的字符串</li>
<li>非贪婪模式 （在量词后面加 ? 例：{m,n}? )<br>  匹配符合的最短的字符串</li>
</ul>
</li>
<li>{m,}<br>  表达式至少重复m次</li>
<li>？<br>  匹配表达式0或1次，相当于{0,1}</li>
<li>+<br>  表达式至少出现一次，相当于{1,}</li>
<li>*<br>  表达式不出现或出现任意次，相当于{0,}</li>
</ul>
<h2 id="字符边界"><a href="#字符边界" class="headerlink" title="字符边界"></a>字符边界</h2><pre><code>零宽：匹配的不是字符而是位置，符合某种条件的位置</code></pre>
<ul>
<li>^<br>  与字符串开始的地方匹配</li>
<li>$<br>  与字符串结束的地方匹配</li>
<li>\b<br>  匹配一个单词的边界，当前位置前面的字符和后面的字符不全是\w</li>
</ul>
<h2 id="预搜索（零宽断言、环视）"><a href="#预搜索（零宽断言、环视）" class="headerlink" title="预搜索（零宽断言、环视）"></a>预搜索（零宽断言、环视）</h2><p>零宽：匹配的不是字符而是位置，符合某种条件的位置</p>
<ul>
<li>(?=exp)<br>  断言自身出现的位置的后面能匹配表达式exp</li>
<li>(?!exp)<br>  断言自身出现的位置的后面不能匹配表达式exp</li>
<li>(?&lt;=exp)<br>  断言自身出现的位置的前面能匹配表达式exp</li>
<li>(?&lt;!exp)<br>  断言自身出现的位置的前面不能匹配表达式exp</li>
</ul>
<h2 id="匹配模式"><a href="#匹配模式" class="headerlink" title="匹配模式"></a>匹配模式</h2><p>对文本的处理方式</p>
<ul>
<li>IGNORECASE 忽略大小写模式<br>  匹配时忽略大小写<br>  默认是区分大小写的</li>
<li>SINGLELINE 单行模式<br>  整个文本看作一个字符串，只有一个开头一个结尾<br>  使小数点”.”可以匹配包含换行符(\n)在内的任意字符</li>
<li>MULTILINE 多行模式<br>  每行都是一个字符串<br>  在多行模式下，如果需要仅匹配字符串开始和结束位置，可以使用\A和\Z</li>
</ul>
<h2 id="选择符和分组"><a href="#选择符和分组" class="headerlink" title="选择符和分组"></a>选择符和分组</h2><p>分支结构、捕获组合非捕获组</p>
<ul>
<li>| 分支结构​<br>  左右表达式之间“或”关系，匹配左边或右边</li>
<li>( ) 捕获组<br>  （1）、在被修饰匹配次数的时候，括号中的表达式可以作为整体被修饰<br>  （2）、取匹配结果的时候，括号中的表达式匹配到的内容可以被单独得到<br>  （3）、每一对括号会分配一个编号，使用（）的捕获根据左括号的顺序从1开始自动编号。捕获编号为零的第一个捕获是整个正则表达式模式匹配的文本<br>   反向引用：通过反向引用，可以对分组已捕获的字符串进行引用。</li>
<li>(?:Expression) 非捕获组<br>  一些表达式中，不得不使用（），但又不需要保存（）中子表达式匹配的内容，这时可以用非捕获组来抵消（）带来的副作用。</li>
</ul>
<hr>
<p>原文：<a href="https://my.oschina.net/u/3080373/blog/1550653" target="_blank" rel="noopener">一张思维导图，让正则表达式不再难懂</a></p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>「转」真实世界中的 Swift 性能优化</title>
    <url>/post/real-world-swift-performance/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>原文链接：<a href="https://realm.io/cn/news/real-world-swift-performance/" target="_blank" rel="noopener">真实世界中的 Swift 性能优化</a></p>
<a id="more"></a>

<hr>
<p>有太多的因素会导致您的应用变得缓慢。在本次讲演中，我们将自底向上地来探索应用的性能优化。来看一看在真实世界中进行数据解析、数据映射和数据存储的时候，Swift 的特性（协议、泛型、结构体和类）是如何影响应用性能的，我们将确定影响性能提升的瓶颈所在，并体验 Swift 带来的「迅捷」体验。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>今天我打算同大家谈论 Swift 性能优化方面的内容。当我们构建软件的时候，特别是移动软件，由于人们的精力、时间有限，人们往往更喜欢有一个流畅的用户体验，而不是等着您的应用在那加载。如果应用运行速度过慢，并且不能给用户带来他们所想要的结果的话，那么这会让人们感到不爽。因此，让您的代码能够快速运行是无比重要的一件事。</p>
<p>那么有什么因素会导致代码运行缓慢呢？当您在编写代码并选择架构的时候，深刻认识到这些架构所带来的影响是非常重要的。我将首先谈一谈：如何理解内联、动态调度与静态调度之间的权衡，以及相关结构是如何分配内存的，还有怎样选择最适合的架构。</p>
<h2 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h2><p>对象的内存分配 (allocation) 和内存释放 (deallocation) 是代码中最大的开销之一，同时通常也是不可避免的。Swift 会自行分配和释放内存，此外它存在两种类型的分配方式。</p>
<p>第一个是基于栈 (stack-based) 的内存分配。Swift 会尽可能选择在栈上分配内存。栈是一种非常简单的数据结构；数据从栈的底部推入 (push)，从栈的顶部弹出 (pop)。由于我们只能够修改栈的末端，因此我们可以通过维护一个指向栈末端的指针来实现这种数据结构，并且在其中进行内存的分配和释放只需要重新分配该整数即可。</p>
<p>第二个是基于堆 (heap-based) 的内存分配。这使得内存分配将具备更加动态的生命周期，但是这需要更为复杂的数据结构。要在堆上进行内存分配的话，您需要锁定堆当中的一个空闲块 (free block)，其大小能够容纳您的对象。因此，我们需要找到未使用的块，然后在其中分配内存。当我们需要释放内存的时候，我们就必须搜索何处能够重新插入该内存块。这个操作很缓慢。主要是为了线程安全，我们必须要对这些东西进行锁定和同步。</p>
<h2 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h2><p>我们还有引用计数 (reference counting) 的概念，这个操作相对不怎么耗费性能，但是由于使用次数很多，因此它带来的性能影响仍然是很大的。引用计数是 Objective-C 和 Swift 中用于确定何时该释放对象的安全机制。目前，Swift 当中的引用计数是强制自动管理的，这意味着它很容易被开发者们所忽略。然而，当您打开 Instrument 查看何处影响了代码运行的速度的时候，您会发现 20,000 多次的 Swift 持有 (retain) 和释放 (release)，这些操作占用了 90% 的代码运行时间！</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">perform</span><span class="params">(with object: Object)</span></span> &#123;</span><br><span class="line">    object.doAThing()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是因为如果有这样一个函数接收了一个对象作为参数，并且执行了这个对象的 doAThing() 方法，编译器会自动插入对象持有和释放操作，以确保在这个方法的生命周期当中，这个对象不会被回收掉。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">perform</span><span class="params">(with object: Object)</span></span> &#123;</span><br><span class="line">    __swift_retain(object)</span><br><span class="line">    object.doAThing()</span><br><span class="line">    __swift_release(object)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些对象持有和释放操作是原子操作 (atomic operations)，所以它们运转缓慢就很正常了。或者，是因为我们不知道如何让它们能够运行得更快一些。</p>
<h2 id="调度与对象"><a href="#调度与对象" class="headerlink" title="调度与对象"></a>调度与对象</h2><p>此外还有调度 (dispatch) 的概念。Swift 拥有三种类型的调度方式。Swift 会尽可能将函数内联 (inline)，这样的话使用这个函数将不会有额外的性能开销。这个函数可以直接调用。静态调度 (static dispatch) 本质上是通过 V-table 进行的查找和跳转，这个操作会花费一纳秒的时间。然后动态调度 (dynamic dispatch) 将会花费大概五纳秒的时间，如果您只有几个这样的方法调用的话，这实际上并不会带来多大的问题，问题是当您在一个嵌套循环或者执行上千次操作当中使用了动态调度的话，那么它所带来的性能耗费将成百上千地累积起来，最终影响应用性能。</p>
<p>Swift 同样也有两种类型的对象。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> section: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> item: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> i = <span class="type">Index</span>(section: <span class="number">1</span>,</span><br><span class="line">                item: <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>这是一个类，类当中的数据都会在堆上分配内存。您可以在此处看到，这里我们创建了一个名为 Index 的类。其中包含了两个属性，一个 section 和一个 item。当我们创建了这个对象的时候，堆上便创建了一个指向此 Index 的指针，因此在堆上便存放了这个 section 和 item 的数据和空间。</p>
<p>如果我们对其建立引用，就会发现我们现在有两个指向堆上相同区域的指针了，它们之间是共享内存的。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> section: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> item: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> i = <span class="type">Index</span>(section: <span class="number">1</span>,</span><br><span class="line">                item: <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> i2 = i</span><br></pre></td></tr></table></figure>
<p>这个时候，Swift 会自动插入对象持有操作。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> section: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> item: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> i = <span class="type">Index</span>(section: <span class="number">1</span>,</span><br><span class="line">                item: <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">__swift_retain(i)</span><br><span class="line"><span class="keyword">let</span> i2 = i</span><br></pre></td></tr></table></figure>
<h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><p>很多人都会说：要编写性能优异的 Swift 代码，最简单的方式就是使用结构体了，结构体通常是一个很好的结构，因为结构体会存储在栈上，并且通常会使用静态调度或者内联调度。</p>
<p>存储在栈上的 Swift 结构体将占用三个 Word 大小。如果您的结构体当中的数据数量低于三种的话，那么结构体的值会自动在栈上内联。Word 是 CPU 当中内置整数的大小，它是 CPU 所工作的区块。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Index</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> section: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> item: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> i = <span class="type">Index</span>(section: <span class="number">1</span>, item: <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>在这里您可以看到，当我们创建这个结构体的时候，带有 section 和 item 值得 Index 结构体将会直接下放到栈当中，这个时候不会有额外的内存分配发生。那么如果我们在别处将其赋值到另一个变量的时候，会发生什么呢？</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Index</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> section: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> item: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> i = <span class="type">Index</span>(section: <span class="number">1</span>, item: <span class="number">1</span>)</span><br><span class="line"><span class="keyword">let</span> i2 = i</span><br></pre></td></tr></table></figure>
<p>如果我们将 i 赋给 i2，这会将我们存储在栈当中的值直接再次复制一遍，这个时候并不会出现引用的情况。这就是所谓的「值类型」。</p>
<p>那么如果结构体当中存放了引用类型的话又会怎样呢？持有内联指针的结构体。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> u = <span class="type">User</span>(name: <span class="string">"Joe"</span>, id: <span class="string">"1234"</span>)</span><br></pre></td></tr></table></figure>
<p>当我们将其赋值给别的变量的时候，我们就持有了共享两个结构体的相同指针，因此我们必须要对这两个指针进行持有操作，而不是在对象上执行单独的持有操作。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> u = <span class="type">User</span>(name: <span class="string">"Joe"</span>,</span><br><span class="line">             id: <span class="string">"1234"</span>)</span><br><span class="line">__swift_retain(u.name._textStorage)</span><br><span class="line">__swift_retain(u.id._textStorage)</span><br><span class="line"><span class="keyword">let</span> u2 = u</span><br></pre></td></tr></table></figure>
<p>如果其中包含了类的话，那么性能耗费会更大。</p>
<h2 id="抽象类型"><a href="#抽象类型" class="headerlink" title="抽象类型"></a>抽象类型</h2><p>正如我们此前所述，Swift 提供了许多不同的抽象类型 (abstraction)，从而允许我们自行决定代码该如何运行，以及决定代码的性能特性。现在我们来看一看抽象类型是如何在实际环境当中使用的。这里有一段很简单的代码：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Circle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> radius: <span class="type">Double</span></span><br><span class="line">    <span class="keyword">let</span> center: <span class="type">Point</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">draw</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> circles = (<span class="number">1</span>..&lt;<span class="number">100_000_000</span>).<span class="built_in">map</span> &#123; <span class="number">_</span> <span class="keyword">in</span> <span class="type">Circle</span>(...) &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> circle <span class="keyword">in</span> circles &#123;</span><br><span class="line">    circle.draw()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个带有 radius 和 center 属性的 Circle 结构体。它将占用三个 Word 大小的空间，并存储在栈上。我们创建了一亿个 Circle，然后我们遍历这些 Circle 并调用这个函数。在我的电脑上，这段操作在发布模式下耗费了 0.3 秒的时间。那么当需求发生变更的时候，会发生什么事呢？</p>
<p>我们不仅需要绘圆，还需要能够处理多种类型的形状。让我们假设我们还需要绘线。我非常喜欢面向协议编程，因为它允许我在不使用继承的情况下实现多态性，并且它允许我们只需要考虑这个「抽象类型」即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protocol Drawable &#123;</span><br><span class="line">    func draw()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct Circle: Drawable &#123;</span><br><span class="line">    let radius: Double</span><br><span class="line">    let center: Point</span><br><span class="line">    func draw() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let drawables: [Drawable] &#x3D; (1..&lt;100_000_000).map &#123; _ in Circle(...) &#125;</span><br><span class="line"></span><br><span class="line">for drawable in drawables &#123;</span><br><span class="line">    drawable.draw()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要做的，就是将这个 draw 方法析取到协议当中，然后将数组的引用类型变更为这个协议，这样做导致这段代码花费了 4.0 秒的时间来运行。速率减慢了 1300%，这是为什么呢？</p>
<p>这是因为此前的代码可以被静态调度，从而在没有任何堆应用建立的情况下仍能够执行。这就是协议是如何实现的。</p>
<p>例如，如大家所见，这里是我们此前的 Circle 结构体。在这个 for 循环当中，Swift 编译器所做的就是前往 V-table 进行查找，或者直接将 draw 函数内联。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">struct Circle &#123;</span><br><span class="line">    let radius: Double</span><br><span class="line">    let center: Point</span><br><span class="line">    func draw() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var circles &#x3D; (1..&lt;100_000_000).map &#123; _ in Circle(...) &#125;</span><br><span class="line"></span><br><span class="line">for circle in circles &#123;</span><br><span class="line">    circle.draw()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们用协议来替代的时候，此时它并不知道这个对象是结构体还是类。因为这里可能是任何一个实现此协议的类型。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protocol Drawable &#123;</span><br><span class="line">    func draw()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct Circle: Drawable &#123;</span><br><span class="line">    let radius: Double</span><br><span class="line">    let center: Point</span><br><span class="line"></span><br><span class="line">    func draw() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var drawables: [Drawable] &#x3D; (1..&lt;100_000_000).map &#123; _ in return Circle(...) &#125;</span><br><span class="line"></span><br><span class="line">for drawable in drawables &#123;</span><br><span class="line">    drawable.draw()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们该如何去调度这个 draw 函数呢？答案就位于协议记录表 (protocol witness table，也称为虚函数表) 当中。它其中存放了您应用当中每个实现协议的对象名，并且在底层实现当中，这个表本质上充当了这些类型的别名。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protocol Drawable &#123;</span><br><span class="line">    func draw()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct Circle: Drawable &#123;</span><br><span class="line">    let radius: Double</span><br><span class="line">    let center: Point</span><br><span class="line"></span><br><span class="line">    func draw() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var drawables: [Drawable] &#x3D; (1..&lt;100_000_000).map &#123; _ in</span><br><span class="line">    return Circle(...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for drawable in drawables &#123;</span><br><span class="line">    drawable.draw()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里的代码当中，我们该如何获取协议记录表呢？答案就是从这个既有容器 (existential container) 当中获取，这个容器目前拥有一个三个字大小的结构体，并且存放在其内部的值缓冲区当中，此外还与协议记录表建立了引用关系。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">struct Circle: Drawable &#123;</span><br><span class="line">    let radius: Double</span><br><span class="line">    let center: Point</span><br><span class="line"></span><br><span class="line">    func draw() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里 Circle 类型存放在了三个字大小的缓冲区当中，并且不会被单独引用。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">struct Line: Drawable &#123;</span><br><span class="line">    let origin: Point</span><br><span class="line">    let end: Point</span><br><span class="line"></span><br><span class="line">    func draw() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>举个例子，对于我们的 Line 类型来说，它其中包含了四个字的存储空间，因为它拥有两个点类型。这个 Line 结构体需要超过四个字以上的存储空间。我们该如何处理它呢？这会对性能有影响么？好吧，它的确会：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protocol Drawable &#123;</span><br><span class="line">    func draw()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct Line: Drawable &#123;</span><br><span class="line">    let origin: Point</span><br><span class="line">    let end: Point</span><br><span class="line">    func draw() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let drawables: [Drawable] &#x3D; (1..&lt;100_000_000).map &#123; _ in Line(...) &#125;</span><br><span class="line"></span><br><span class="line">for drawable in drawables &#123;</span><br><span class="line">    drawable.draw()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这需要花费 45 秒钟的时间来运行。为什么这里要花这么久的时间呢，发生了什么事呢？</p>
<p>绝大部分的时间都花费在对结构体进行内存分配上了，因为现在它们无法存放在只有三个字大小的缓冲区当中了。因此这些结构会在堆上进行内存分配，此外这也与协议有一点关系。由于既有容器只能够存储三个字大小的结构体，或者也可以与对象建立引用关系，我们同样需要某种名为值记录表 (value witness table)。这就是我们用来处理任意值的东西。</p>
<p>因此在这里，编译器将创建一个值记录表，对每个���缓冲区、内敛结构体来说，都有三个字大小的缓冲区，然后它将负责对值或者类进行内存分配、拷贝、销毁和内存释放等操作。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func draw(drawable: Drawable) &#123;</span><br><span class="line">    drawable.draw()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let value: Drawable &#x3D; Line()</span><br><span class="line">draw(local: value)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Generates</span><br><span class="line">func draw(value: ECTDrawable) &#123;</span><br><span class="line">    var drawable: ECTDrawable &#x3D; ECTDrawable()</span><br><span class="line">    let vwt &#x3D; value.vwt</span><br><span class="line">    let pwt &#x3D; value.pwt</span><br><span class="line">    drawable.vwt &#x3D; value.vwt</span><br><span class="line">    drawable.pwt &#x3D; value.pwt</span><br><span class="line">    vwt.allocateBuffAndCopyValue(&amp;drawable, value)</span><br><span class="line">    pwt.draw(vwt.projectBuffer(&amp;drawable)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是一个例子，这就是这个过程的中间产物。如果我们只有一个 draw 函数，那么它将会接受我们创建的 Line 作为参数，因此我们将它传递给这个 draw 函数即可。</p>
<p>实际情况时，它将这个 Drawable 协议传递到既有容器当中，然后在函数内部再次进行创建。这会对值和协议记录表进行赋值，然后分配一个新的缓冲区，然后将其他结构、类或者类似对象的值拷贝进这个缓冲区当中。然后就使用协议记录表当中的 draw 函数，把真实的 Drable 对象传递给这个函数。</p>
<p>您可以看到，值记录表和协议记录表将会存放在栈上，而 Line 将会被存放在堆上，从而最后将线绘制出来。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>对我们进行数据建模的方式进行简单的更改将会对性能造成巨大的影响。让我们来看一看该如何来避免这些情况的发生。</p>
<p>首先让我们来说一说泛型。大家可能会说了，我给各位展示了协议会导致性能的下降，那么我们为什么还要使用泛型呢？答案在于：泛型允许我们做什么。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">struct Stack&lt;T: Type&gt; &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设我们这里有一个带有泛型 T 的 Stack 结构体，它受到一个协议类型的约束。编译器所要做的，就是将这个 T 提换成相应的协议，或者替换为我们传入的具体类型。这些操作会一直沿着函数链 (function chain) 执行，并且编译器会创建直接对此类型进行操作的专用版本。</p>
<p>这样我们就无需再使用值记录表或者协议记录表了，并且还移除了既有容器，这可能是一个非常好的解决方式，这使得我们仍然能够写出真正快速运行的泛型代码，并且还具备 Swift 所提供的良好多态性。这就是所谓的静态多态性 (static polymorphism)。</p>
<p>您还可以通过使用枚举来改进数据模型，而不是从服务器中获取大量的字符串。例如，假设您正在构建一个社交应用，您需要对账户建立状态的管理，以前您可能会使用字符串来进行控制。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">enum AccountStatus: String, RawRepresentable &#123;</span><br><span class="line">case .banned, .verified, incomplete</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们改用枚举的话，那么我们就无需进行内存分配了，当我们传递这个类型的时候，我们只是将枚举值进行传递，这是一个加快代码运行速度的好方法，同时也可以为整个应用程序提供更安全、更可读的代码。</p>
<p>此外，使用 u-模型或者演示者 (Presenter) 或者不同的抽象类型的形式，来构建特定类型的模型也是非常有用的，这使得我们能够精简掉应用当中许多不必要的部分。</p>
<p>好的，我的讲演到此结束，内容很短，感谢诸位的参与！</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS逆向-monkeydev工具</title>
    <url>/post/reverse-ios-monkeydev/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote>
<p>MonkeyDev wiki<br>这是一个为越狱和非越狱开发人员准备的工具，主要包括四个模块:</p>
</blockquote>
<blockquote>
<p> Logos Tweak</p>
</blockquote>
<blockquote>
<p>使用theos提供的logify.pl工具将*.xm文件转成*.mm文件进行编译，集成了CydiaSubstrate，可以使用MSHookMessageEx和MSHookFunction来Hook OC函数和指定地址。</p>
</blockquote>
<blockquote>
<p>CaptainHook Tweak</p>
</blockquote>
<blockquote>
<p>使用CaptainHook提供的头文件进行OC 函数的Hook，以及属性的获取。</p>
</blockquote>
<blockquote>
<p>Command-line Tool</p>
</blockquote>
<blockquote>
<p>可以直接创建运行于越狱设备的命令行工具</p>
</blockquote>
<blockquote>
<p>MonkeyApp</p>
</blockquote>
<blockquote>
<p>这是自动给第三方应用集成Reveal、Cycript和注入dylib的模块，支持调试dylib和第三方应用，支持Pod给第三放应用集成SDK，只需要准备一个砸壳后的ipa或者app文件即可。</p>
</blockquote>
<a id="more"></a>


<hr>
<ul>
<li><a href="https://github.com/AloneMonkey/MonkeyDev/wiki" target="_blank" rel="noopener">MonkeyDev wiki</a></li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS逆向-class-dump工具</title>
    <url>/post/reverse-ios-class-dump/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="安装class-dump"><a href="#安装class-dump" class="headerlink" title="安装class-dump"></a>安装class-dump</h2><p>去<a href="http://stevenygard.com/projects/class-dump/" target="_blank" rel="noopener">stevenygard.com</a>下载最新的包。</p>
<p>将包中的<code>class-dump</code>可执行文件复制到<code>/opt/class-dump</code>。(我的逆向相关工具均在这下面😂）</p>
<p>在<code>~/.base_profile</code>中添加<code>export PATH=/opt/class-dump:$PATH</code></p>
<p>运行<code>source ~/.base_profile</code></p>
<p>最后确认一下安装OK ：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> class-dump --v</span></span><br><span class="line">class-dump 3.5 (64 bit) compiled Nov 16 2013 12:22:33</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><p>使用一个记录一个吧～</p>
<h3 id="用来导出ipa-decrypted头文件"><a href="#用来导出ipa-decrypted头文件" class="headerlink" title="用来导出ipa/.decrypted头文件"></a>用来导出<code>ipa</code>/<code>.decrypted</code>头文件</h3><p>此处只能导出未加密的<code>ipa</code>，或者砸过壳的。<a href="../reverse-ios-dump-decrypted/">具体砸壳过程传送门</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls WeChat.decrypted</span></span><br><span class="line">WeChat.decrypted</span><br><span class="line"><span class="meta">$</span><span class="bash"> class-dump -H WeChat.decrypted -o ./Headers/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls Headers</span></span><br><span class="line">Headers</span><br></pre></td></tr></table></figure>

<p>即得头文件目录：<code>Headers</code></p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>关于日志打印和过滤的那点破事</title>
    <url>/post/reverse-ios-socat-watch-filter/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>前两天，重启电脑突然发现我的<code>iOS8</code>设备无法连接到<code>MacOS</code>了。。</p>
<p>MMP，也就是说没有办法使用Xcode调试、之前使用的日志查看也没有办法继续。。</p>
<p>具体报错如下：<br><code>Xcode&lt;Version 9.4 (9F1027a)&gt;</code>报错如下: (我安装过<code>Xcode10 beta1</code>)<br><img src="/images/2018-06-15-10-13-16.png" alt="Xcode报错"></p>
<p><code>iTunes</code>报错如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iTunes 无法连接 iPhone “iPhone”，因为收到来自此设备的无效响应。</span><br></pre></td></tr></table></figure>

<p><img src="/images/2018-06-15-10-06-16.png" alt="iTunes报错"></p>
<p><code>Apple Configurator2</code>报错如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">已收到设备上的意外响应。</span><br></pre></td></tr></table></figure>

<p><img src="/images/2018-06-15-10-09-33.png" alt="Apple Configurator2报错"></p>
<a id="more"></a>

<p>还是 先来聊一下日志打印的几种方案吧。</p>
<h2 id="手机可以连接到MacOS"><a href="#手机可以连接到MacOS" class="headerlink" title="手机可以连接到MacOS"></a>手机可以连接到MacOS</h2><p>这种情况是最常见的，就是能在Xcode下Debug….</p>
<h3 id="方案一：Console-app-控制台"><a href="#方案一：Console-app-控制台" class="headerlink" title="方案一：Console.app(控制台)"></a>方案一：Console.app(控制台)</h3><p>这是MacOS自带的日志神器～ 效果顶呱呱👍👍👍，截图如下：<br><img src="/images/2018-06-15-10-23-02.png" alt="Console.app"></p>
<p>具体用法我就不说了。。。毕竟都是中文😂</p>
<h3 id="方案二：LogGuru"><a href="#方案二：LogGuru" class="headerlink" title="方案二：LogGuru"></a>方案二：LogGuru</h3><p><a href="https://github.com/madordie/LogGuru" target="_blank" rel="noopener">madordie/LogGuru</a> 也不错，很久之前fork自<a href="https://github.com/FIRHQ/LogGuru" target="_blank" rel="noopener">FIRHQ/LogGuru</a>，增加了直接过滤的功能，要不然速度真的很慢。。</p>
<p>只要插入USB，即可显示日志，还是不错滴。。</p>
<p><img src="/images/2018-06-15-10-29-07.png" alt="原来的截图"></p>
<h3 id="方案三-其他的"><a href="#方案三-其他的" class="headerlink" title="方案三: 其他的"></a>方案三: 其他的</h3><p>还有很多方案，比如说命令行啊、其他的工具啊，我就不说了，我觉得 <strong>Console.app(控制台)</strong> 就够了😂</p>
<h2 id="手机无法链接进MacOS"><a href="#手机无法链接进MacOS" class="headerlink" title="手机无法链接进MacOS"></a>手机无法链接进MacOS</h2><p>也就是最开始说的报错的情况下，可以连接进MacOS的方案均无法使用。苦逼，只能让iOS打印日志了。。</p>
<p>下面都是 <strong>越狱环境</strong> 下的。。不越狱还有人用iOS8么😂</p>
<p>先来看个文档：<a href="https://www.theiphonewiki.com/wiki/System_Log" target="_blank" rel="noopener">The iPhone Wiki/System Log</a>,这里提供了很多方案，也非常全面，值得一试。</p>
<p>苦逼的事情是我手上的iOS8.4.1无法使用<code>syslogd to /var/log/syslog</code>插件，尝试使用<a href="https://www.theiphonewiki.com/wiki/System_Log#On-device_with_saving_to_a_file_via_a_Python_script" target="_blank" rel="noopener">On-device with saving to a file via a Python script</a>的方案去解决也并不如意。。</p>
<p>开始用<a href="https://www.theiphonewiki.com/wiki/System_Log#On-device_with_socat" target="_blank" rel="noopener">On-device with socat</a>（ 在<a href="http://bbs.iosre.com/" target="_blank" rel="noopener">iosre</a>中也有一个类似的文章：<a href="http://bbs.iosre.com/t/ios-socat/139" target="_blank" rel="noopener">iOS查看日志利器 —— socat</a>），说的都是相当的详细。</p>
<h3 id="socat的坑"><a href="#socat的坑" class="headerlink" title="socat的坑"></a>socat的坑</h3><h4 id="stop没有用"><a href="#stop没有用" class="headerlink" title="stop没有用"></a>stop没有用</h4><p>如<a href="http://bbs.iosre.com/t/ios-socat/139" target="_blank" rel="noopener">iOS查看日志利器 —— socat</a>所说：</p>
<blockquote>
<p>输入watch查看，输入stop停止（不过停止貌似没用，也不知道为啥，知道的请告诉我）</p>
</blockquote>
<p>这个真的是没有用，所以<code>watch</code>功能就很鸡肋。。</p>
<h4 id="没有办法实时过滤"><a href="#没有办法实时过滤" class="headerlink" title="没有办法实时过滤"></a>没有办法实时过滤</h4><p>文中提到了很多过滤条件，但是一旦开启过滤，就没有办法显示实时日志。。也就是说无法和<code>watch</code>共存。。。</p>
<h3 id="换个姿势使用socat"><a href="#换个姿势使用socat" class="headerlink" title="换个姿势使用socat"></a>换个姿势使用socat</h3><p><code>socat</code>的日志都在终端上，不着色不说还有上面的两个很影响使用的问题。。。于是乎，为了增加过滤功能，需要通过管道将输出接入另外的命令如：<code>grep</code>等。</p>
<p><code>socat</code>命令需要手动输入<code>watch</code>才能显示出实时命令，这个让管道并不能直接使用。这里需要借助<code>expect</code>命令。</p>
<p>好了所有的点都通了，大致步骤如下：</p>
<h4 id="在mac上安装expect"><a href="#在mac上安装expect" class="headerlink" title="在mac上安装expect"></a>在mac上安装expect</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">brew install expect</span><br></pre></td></tr></table></figure>

<h4 id="在mac的～-bash-profile配置"><a href="#在mac的～-bash-profile配置" class="headerlink" title="在mac的～/.bash_profile配置"></a>在mac的～/.bash_profile配置</h4><p>此处假设你的设备已经按照<a href="../reverse-ios-ssh">iOS逆向-设备ssh免密登录</a>配置好了：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> ios-<span class="function"><span class="title">socat</span></span>() &#123;</span><br><span class="line">    expect -c <span class="string">"</span></span><br><span class="line"><span class="string">        spawn ssh i5s \"socat - UNIX-CONNECT:/var/run/lockdown/syslog.sock\"</span></span><br><span class="line"><span class="string">        expect &#123;</span></span><br><span class="line"><span class="string">            \"&gt; \" &#123;send \"watch\n\";&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    interact"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ios-socat</code> 函数名，在命令行可以直接输入函数名调用该函数</li>
<li><code>i5s</code> 在<code>~/.ssh/config</code>中配置的名字</li>
</ul>
<p>如果没有配置ssh免密呢需要这样：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> ios-<span class="function"><span class="title">socat</span></span>() &#123;</span><br><span class="line">    expect -c <span class="string">"</span></span><br><span class="line"><span class="string">        spawn ssh -p22 root@ios's_ip \"socat - UNIX-CONNECT:/var/run/lockdown/syslog.sock\"</span></span><br><span class="line"><span class="string">        expect &#123;</span></span><br><span class="line"><span class="string">            \"*password: \" &#123;send \"mypassword\n\";&#125;</span></span><br><span class="line"><span class="string">            \"&gt; \" &#123;send \"watch\n\";&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    interact"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-p22</code> 端口号，22是默认不用写，但是其他的需要写。</li>
<li><code>ios&#39;s_ip</code> iOS设备的ip。</li>
<li><code>mypassword</code> iOS设备密码</li>
<li>这个我没测。。大致如此，我对<code>expect</code>的语法也不是很熟</li>
</ul>
<p>最后别忘了让<code>~/.bash_profile</code>生效：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>

<p>然后只需要在命令行输入<code>ios-socat</code>就可以看到蹭蹭蹭的日志打印咯。。至于用什么管道啊都不是问题。</p>
<p>比如：<br>只显示包含<code>iosre</code>关键字的日志</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ios-socat | grep iosre</span><br></pre></td></tr></table></figure>

<h4 id="晋级用法"><a href="#晋级用法" class="headerlink" title="晋级用法"></a>晋级用法</h4><ul>
<li><p>我的iOS设备通过<code>iproxy</code>来进行端口映射。具体用法移步<a href="https://www.google.com/search?q=iproxy&oq=iproxy" target="_blank" rel="noopener">Google</a></p>
</li>
<li><p>通过<code>ios-socat &gt; ~/Desktop/ios.log</code> 然后下载<a href="https://itunes.apple.com/cn/app/logtail/id1073404370?mt=12" target="_blank" rel="noopener">LogTail</a>，剩下的摸索一下咯</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2></li>
</ul>
<p>我还不清楚究竟什么原因导致了<code>收到来自此设备的无效响应</code>错误，布吉岛系统修改了什么。我尝试重新安装iTunes、Xcode都无效（据说陌陌的开发为这个无法调试直接将系统降级是可以的😂）。。有老铁懂得指点下～～</p>
<p>目前虽然上面都可以用，但是看个日志并不能满足我的野心，最后在移动硬盘里做了一个10.12的系统😂，用了Console.app…</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS逆向-砸壳(cycript/clutch)</title>
    <url>/post/reverse-ios-dump-decrypted/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ul>
<li>越狱设备</li>
</ul>
<p>目前有两种砸壳工具，并不肩并肩，一个不行就用另一个呗，俩都不行就Google吧～～</p>
<p>下面分别对<code>cycript</code>、<code>clutch</code>进行砸壳:</p>
<a id="more"></a>

<h1 id="使用cycript进行砸壳"><a href="#使用cycript进行砸壳" class="headerlink" title="使用cycript进行砸壳"></a>使用cycript进行砸壳</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li><code>Cydia</code>中搜索<code>cycript</code>并安装 </li>
</ul>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="制作并上传dumpdecrypted-dylib-（已经OK的可忽略"><a href="#制作并上传dumpdecrypted-dylib-（已经OK的可忽略" class="headerlink" title="制作并上传dumpdecrypted.dylib （已经OK的可忽略"></a>制作并上传<code>dumpdecrypted.dylib</code> （已经OK的可忽略</h3><h4 id="制作"><a href="#制作" class="headerlink" title="制作"></a>制作</h4><p>目前我制作目录暂时在<code>~/Desktop</code>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/stefanesser/dumpdecrypted.git ~/Desktop</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ～／Desktop/dumpdecrypted</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls dumpdecrypted.dylib</span></span><br></pre></td></tr></table></figure>

<p>没什么错误的话，即得<code>dumpdecrypted.dylib</code>。</p>
<h4 id="上传"><a href="#上传" class="headerlink" title="上传"></a>上传</h4><p>将<code>dumpdecrypted.dylib</code>放在越狱设备的<code>/var/root/</code>下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls dumpdecrypted.dylib</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> scp dumpdecrypted.dylib root@10.12.14.16:/var/root/</span></span><br><span class="line">root@10.12.14.16's password:</span><br><span class="line">dumpdecrypted.dylib                           100%  193KB   3.0MB/s   00:00</span><br><span class="line"><span class="meta">$</span></span><br></pre></td></tr></table></figure>

<h3 id="登录进越狱设备"><a href="#登录进越狱设备" class="headerlink" title="登录进越狱设备"></a>登录进越狱设备</h3><p>可以使用<code>ssh root@IP</code>进行登录。</p>
<p>当然也可以使用<code>ssh ipad</code>，这样免密登录登录。 <a href="../reverse-ios-ssh/">配置传送门</a></p>
<h3 id="找到可执行文件路径"><a href="#找到可执行文件路径" class="headerlink" title="找到可执行文件路径"></a>找到可执行文件路径</h3><p>这里以<code>WeChat</code>为例子啦～</p>
<p>记得先打开呀～～～</p>
<p><code>ps -e</code>： 显示所有程序<br><code>grep</code>: 这里是过滤一下。。具体用法Google。所有的程序有点多，我知道名字，所以直接过滤一下。也可忽略</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -e | grep WeChat</span></span><br><span class="line">705 ??         0:02.20 /var/mobile/Containers/Bundle/Application/3AE519BF-2FD2-43FC-A14B-2893190B8E1E/WeChat.app/WeChat</span><br><span class="line">707 ttys000    0:00.01 grep WeChat</span><br><span class="line"><span class="meta">$</span><span class="bash"> cycript -p 705</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cycript -p 705</span></span><br><span class="line"><span class="meta">cy#</span><span class="bash"> [[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask][0]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">"file:///var/mobile/Containers/Data/Application/54EF9A70-8E3A-4B6D-B7F4-554AB256C48B/Documents/"</span></span></span><br><span class="line"><span class="meta">cy#</span><span class="bash"> <span class="built_in">exit</span>(0)</span></span><br><span class="line">MS:Error: _krncall(mach_vm_read_overwrite(task, data, sizeof(*baton), reinterpret_cast&lt;mach_vm_address_t&gt;(baton), &amp;error)) =4</span><br><span class="line">*** _assert(status == 0):../Inject.cpp(143):InjectLibrary</span><br><span class="line"><span class="meta">$</span></span><br></pre></td></tr></table></figure>

<p>此处获得两个目录：</p>
<ul>
<li><code>/var/mobile/Containers/Bundle/Application/3AE519BF-2FD2-43FC-A14B-2893190B8E1E/WeChat.app/WeChat</code></li>
<li><code>/var/mobile/Containers/Data/Application/54EF9A70-8E3A-4B6D-B7F4-554AB256C48B/Documents/</code></li>
</ul>
<h3 id="开砸"><a href="#开砸" class="headerlink" title="开砸"></a>开砸</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp dumpdecrypted.dylib /var/mobile/Containers/Data/Application/54EF9A70-8E3A-4B6D-B7F4-554AB256C48B/Documents/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /var/mobile/Containers/Data/Application/54EF9A70-8E3A-4B6D-B7F4-554AB256C48B/Documents/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib /var/mobile/Containers/Bundle/Application/3AE519BF-2FD2-43FC-A14B-2893190B8E1E/WeChat.app/WeChat</span></span><br><span class="line">mach-o decryption dumper</span><br><span class="line"></span><br><span class="line">DISCLAIMER: This tool is only meant for security research purposes, not for application crackers.</span><br><span class="line"></span><br><span class="line">[+] detected 64bit ARM binary in memory.</span><br><span class="line">[+] offset to cryptid found: @0x1000c0ca8(from 0x1000c0000) = ca8</span><br><span class="line">[+] Found encrypted data at address 00004000 of length 51200000 bytes - type 1.</span><br><span class="line">[+] Opening /private/var/mobile/Containers/Bundle/Application/3AE519BF-2FD2-43FC-A14B-2893190B8E1E/WeChat.app/WeChat for reading.</span><br><span class="line">[+] Reading header</span><br><span class="line">[+] Detecting header type</span><br><span class="line">[+] Executable is a plain MACH-O image</span><br><span class="line">[+] Opening WeChat.decrypted for writing.</span><br><span class="line">[+] Copying the not encrypted start of the file</span><br><span class="line">[+] Dumping the decrypted data into the file</span><br><span class="line">[+] Copying the not encrypted remainder of the file</span><br><span class="line">[+] Setting the LC_ENCRYPTION_INFO-&gt;cryptid to 0 at offset ca8</span><br><span class="line">[+] Closing original file</span><br><span class="line">[+] Closing dump file</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls WeChat.decrypted</span></span><br><span class="line">WeChat.decrypted</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line">/var/mobile/Containers/Data/Application/54EF9A70-8E3A-4B6D-B7F4-554AB256C48B/Documents</span><br></pre></td></tr></table></figure>
<p>最后得到文件:</p>
<ul>
<li><code>/var/mobile/Containers/Data/Application/54EF9A70-8E3A-4B6D-B7F4-554AB256C48B/Documents/WeChat.decrypted</code></li>
</ul>
<h3 id="将-decrypted拷贝出来"><a href="#将-decrypted拷贝出来" class="headerlink" title="将*.decrypted拷贝出来"></a>将<code>*.decrypted</code>拷贝出来</h3><p>我这里直接使用<code>scp</code>吧～。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /Users/Madordie/Desktop/Madordie/iOS/xxx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> scp root@10.12.14.16:/var/mobile/Containers/Data/Application/54EF9A70-8E3A-4B6D-B7F4-554AB256C48B/Documents/WeChat.decrypted .</span></span><br><span class="line">root@10.12.14.16's password:</span><br><span class="line">WeChat.decrypted                              100%   61MB   4.7MB/s   00:12</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls WeChat.decrypted</span></span><br><span class="line">WeChat.decrypted</span><br></pre></td></tr></table></figure>
<p>至此在主机上得到：</p>
<ul>
<li><code>/Users/Madordie/Desktop/Madordie/iOS/xxx/WeChat.decrypted</code></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>为什么将<code>dumpdecrypted.dylib</code>  <code>copy</code> 至<code>*/Documents/</code>下？<br>  ：别的目录没有权限～～（<code>dumpdecrypted.dylib: stat() failed with errno=1</code> ）</li>
</ul>
<h1 id="使用clutch进行砸壳"><a href="#使用clutch进行砸壳" class="headerlink" title="使用clutch进行砸壳"></a>使用clutch进行砸壳</h1><h2 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h2><h3 id="下载上传clutch-无须重复做"><a href="#下载上传clutch-无须重复做" class="headerlink" title="下载上传clutch(无须重复做)"></a>下载上传clutch(无须重复做)</h3><p><code>clutch</code>可以从<a href="https://github.com/KJCracks/Clutch" target="_blank" rel="noopener">https://github.com/KJCracks/Clutch</a>下载编译。</p>
<p>当然也可以从<a href="https://github.com/KJCracks/Clutch/releases" target="_blank" rel="noopener">https://github.com/KJCracks/Clutch/releases</a>直接下载。</p>
<p>目前下载到目录<code>~/Clutch-2.0.4</code></p>
<p>上传到设备：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> scp Clutch-2.0.4 root@10.12.14.16:/usr/bin/</span></span><br><span class="line">root@10.12.14.16's password:</span><br><span class="line">Clutch-2.0.4                                  100% 1204KB   4.7MB/s   00:00</span><br></pre></td></tr></table></figure>

<h3 id="登录进越狱设备-1"><a href="#登录进越狱设备-1" class="headerlink" title="登录进越狱设备"></a>登录进越狱设备</h3><p>可以使用<code>ssh root@IP</code>进行登录。</p>
<p>当然也可以使用<code>ssh ipad</code>，这样免密登录登录。 <a href="../reverse-ios-ssh/">配置传送门</a></p>
<h3 id="修改权限"><a href="#修改权限" class="headerlink" title="修改权限"></a>修改权限</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /usr/bin</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv Clutch-2.0.4 clutch</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chmod +x clutch</span></span><br></pre></td></tr></table></figure>

<h3 id="砸壳"><a href="#砸壳" class="headerlink" title="砸壳"></a>砸壳</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> clutch -i</span></span><br><span class="line">Installed apps:</span><br><span class="line">1:   钉钉 &lt;com.laiwang.DingTalk&gt;</span><br><span class="line">2:   韩剧TV-最新热门韩剧大全 &lt;com.baoyun.hanju&gt;</span><br><span class="line">3:   PG Client - a better client for dribbble &lt;com.az.azdribbble&gt;</span><br><span class="line">4:   窝牛－设计装修我们的家 &lt;com.lingduohome.acorn&gt;</span><br><span class="line"><span class="meta">$</span><span class="bash"> clutch -d 1</span></span><br><span class="line">com.laiwang.DingTalk contains watchOS 2 compatible application. It's not possible to dump watchOS 2 apps with Clutch 2.0.4 at this moment.</span><br><span class="line">Zipping DingTalk.app</span><br><span class="line">ASLR slide: 0x10001c000</span><br><span class="line">Dumping &lt;DingTalk&gt; (arm64)</span><br><span class="line">Patched cryptid (64bit segment)</span><br><span class="line">Writing new checksum</span><br><span class="line">DONE: /private/var/mobile/Documents/Dumped/com.laiwang.DingTalk-iOS7.0-(Clutch-2.0.4).ipa</span><br><span class="line">Finished dumping com.laiwang.DingTalk in 40.6 seconds</span><br><span class="line"><span class="meta">$</span></span><br></pre></td></tr></table></figure>

<p>生成最终路径:</p>
<ul>
<li><code>/private/var/mobile/Documents/Dumped/com.laiwang.DingTalk-iOS7.0-(Clutch-2.0.4).ipa</code></li>
</ul>
<h3 id="传至本地"><a href="#传至本地" class="headerlink" title="传至本地"></a>传至本地</h3><p>注意路径中有<code>()</code>这样的字符，需要转义一下。如下：</p>
<p>在本地终端中使用<code>scp</code>拉取：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> scp root@10.12.14.16:<span class="string">'/private/var/mobile/Documents/Dumped/com.laiwang.DingTalk-iOS7.0-\(Clutch-2.0.4\).ipa'</span> .</span></span><br><span class="line">root@10.12.14.16's password:</span><br><span class="line">com.laiwang.DingTalk-iOS7.0-(Clutch-2.0.4).ip 100%   48MB   3.6MB/s   00:13</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls com.laiwang.DingTalk-iOS7.0-\(Clutch-2.0.4\).ipa</span></span><br><span class="line">com.laiwang.DingTalk-iOS7.0-(Clutch-2.0.4).ipa</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">pwd</span></span></span><br><span class="line">/Users/Madordie/Desktop/Madordie/ios-reverse</span><br></pre></td></tr></table></figure>
<p>至此在主机上得到：</p>
<ul>
<li><code>/Users/Madordie/Desktop/Madordie/ios-reverse/com.laiwang.DingTalk-iOS7.0-\(Clutch-2.0.4\).ipa</code></li>
</ul>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ul>
<li>并不是每一个都可以支持这种工具砸壳，失败了用第一种试试。。。</li>
</ul>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>目前发现这两种砸壳工具。但是并不是每一个APP都可以使用2种工具。有的只有一个有效，有的两个都有效，还有一种两个都失败的😂</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS逆向-创建Cydia源</title>
    <url>/post/reverse-ios-creat-cydia-sources/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>搭建自己的cydia源。</p>
<a id="more"></a>

<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li>Ubuntu 16.04 LTS</li>
</ul>
<h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><h4 id="dpkg-dev"><a href="#dpkg-dev" class="headerlink" title="dpkg-dev"></a>dpkg-dev</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install dpkg-dev</span><br><span class="line">$ dpkg-scanpackages --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">apt-get install nginx</span><br></pre></td></tr></table></figure>

<h3 id="开工"><a href="#开工" class="headerlink" title="开工"></a>开工</h3><h4 id="准备deb"><a href="#准备deb" class="headerlink" title="准备deb"></a>准备deb</h4><p>此处目录为<code>/opt/cydia/debs</code>，可以为别的，但是建议你也这样做:)。</p>
<h4 id="生成依赖"><a href="#生成依赖" class="headerlink" title="生成依赖"></a>生成依赖</h4><p>更新插件需要重新执行哟。。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/cydia</span><br><span class="line">$ dpkg-scanpackages -m ./debs /dev/null &gt; Packages</span><br><span class="line">$ bzip2 Packages</span><br></pre></td></tr></table></figure>

<h4 id="添加sources-list"><a href="#添加sources-list" class="headerlink" title="添加sources.list"></a>添加sources.list</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">"deb file:///opt/cydia ./debs/"</span> &gt;&gt; /etc/apt/sources.list</span><br></pre></td></tr></table></figure>

<p>ps. 注意路径信息</p>
<h4 id="更新一下"><a href="#更新一下" class="headerlink" title="更新一下"></a>更新一下</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ apt-get update</span><br></pre></td></tr></table></figure>

<h4 id="扔出去"><a href="#扔出去" class="headerlink" title="扔出去"></a>扔出去</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /var/www/html</span><br><span class="line">$ ln -s /opt/cydia cydia</span><br><span class="line">$ /etc/init.d/nginx start</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.saurik.com/id/7" target="_blank" rel="noopener">http://www.saurik.com/id/7</a></li>
<li><a href="https://bbs.feng.com/read-htm-tid-8052646.html" target="_blank" rel="noopener">https://bbs.feng.com/read-htm-tid-8052646.html</a></li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS逆向-设备ssh免密登录</title>
    <url>/post/reverse-ios-ssh/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><ul>
<li>已越狱设备</li>
<li>越狱设备安装OpenSSH(⚠️记得修改默认的’alpine’登录密码)</li>
<li>电脑和设备同局域网。（我这里设备IP：10.11.12.13，并且设置成静态IP了😂）</li>
</ul>
<a id="more"></a>

<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="生成RSA证书"><a href="#生成RSA证书" class="headerlink" title="生成RSA证书"></a>生成RSA证书</h3><p>我这里生成的证书为:<code>ipad</code>，可自己需要定义。（注意如果直接回车会覆盖<code>~/.ssh/id_rsa</code>）</p>
<p>执行命令<code>ssh-keygen</code>，如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~/.ssh/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/Users/Madordie/.ssh/id_rsa): ipad</span><br><span class="line">Enter passphrase (empty for no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved in ipad.</span><br><span class="line">Your public key has been saved in ipad.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:GpQBeAf+oqUzWlUhtItDcVyVFz2wd0EcIgD+BZLPK8U Madordie@Bingo.local</span><br><span class="line">The key's randomart image is:</span><br><span class="line">+---[RSA 2048]----+</span><br><span class="line">|  .+*+*++o++.o+. |</span><br><span class="line">|  .+o+o=...oo... |</span><br><span class="line">|  ..o.=+ .o ...  |</span><br><span class="line">| . . = .E. . .   |</span><br><span class="line">|  o = o.S.       |</span><br><span class="line">|   * ..o.        |</span><br><span class="line">|  *   ..         |</span><br><span class="line">| o o             |</span><br><span class="line">|.                |</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls ~/.ssh/ipad*</span></span><br><span class="line">/Users/Madordie/.ssh/ipad     /Users/Madordie/.ssh/ipad.pub</span><br></pre></td></tr></table></figure>

<h3 id="将公钥推送至越狱设备"><a href="#将公钥推送至越狱设备" class="headerlink" title="将公钥推送至越狱设备"></a>将公钥推送至越狱设备</h3><p>默认是没有<code>~/.ssh</code>目录的，暂时放置在<code>/var/root</code>下。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> scp ~/.ssh/ipad.pub root@10.11.12.13:/var/root</span></span><br></pre></td></tr></table></figure>

<p><code>scp</code> 默认端口为<code>22</code> 如果需要自定义端口可以在路径前添加<code>-P 端口号</code>参数。</p>
<h3 id="配置本机-ssh-config文件"><a href="#配置本机-ssh-config文件" class="headerlink" title="配置本机~/.ssh/config文件"></a>配置本机<code>~/.ssh/config</code>文件</h3><p>使用顺手的工具编辑<code>~/.ssh/config</code>文件。（没有就新建一个啦～</p>
<p>按照如下格式填写。默认<code>ssh</code>登录端口为<code>22</code>可以不写。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Host ipad</span><br><span class="line">    Hostname 10.11.12.13</span><br><span class="line">    User root</span><br><span class="line">    Port 22</span><br><span class="line">    PreferredAuthentications publickey</span><br><span class="line">    IdentityFile ~&#x2F;.ssh&#x2F;ipad</span><br></pre></td></tr></table></figure>

<h3 id="配置越狱设备"><a href="#配置越狱设备" class="headerlink" title="配置越狱设备"></a>配置越狱设备</h3><p>先用<code>ssh root@10.11.12.13</code>登录进设备(如果你没有修改密码那么默认是<code>alpine</code>,这个在<a href="https://cydia.saurik.com/openssh.html" target="_blank" rel="noopener">OpenSSH</a>上)。刚才我们将<code>ipad.pub</code>通过<code>scp</code>放在了<code>/var/root</code>下。</p>
<p>一般情况下<code>/var/root/.ssh</code>是不存在的，使用命令<code>mkdir -p /var/root/.ssh</code>即可创建。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat ipad.pub &gt;&gt; /var/root/.ssh/authorized_keys</span></span><br></pre></td></tr></table></figure>

<p>然后强迫症的可以使用<code>rm -rf ipad.pub</code>删除啦～</p>
<p>对了，退出<code>ssh</code>登录的设备使用：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">exit</span></span></span><br><span class="line">logout</span><br><span class="line">Connection to 10.11.12.13 closed.</span><br></pre></td></tr></table></figure>

<h3 id="赶紧测试一下远程登录效果"><a href="#赶紧测试一下远程登录效果" class="headerlink" title="赶紧测试一下远程登录效果"></a>赶紧测试一下远程登录效果</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh ipad</span></span><br></pre></td></tr></table></figure>

<p>然后你会发现你已经完成了免密码登录越狱设备。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实这并不是只有越狱iOS设备才能使用的免登录，而是<code>ssh</code>所支持的。用途也很方便～</p>
<p>PS. 这里面的IP地址(10.11.12.13) 是你设备的IP。如果超时的话或者ping不通或者网速比较差的话，可以采用<a href="http://iphonedevwiki.net/index.php/SSH_Over_USB" target="_blank" rel="noopener">usbmux</a>方案进行，文档已相当详细，此处不再赘述。</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>描述文件获取UDID</title>
    <url>/post/ios-tool-configurator-get-udid/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="UDID"><a href="#UDID" class="headerlink" title="UDID"></a>UDID</h3><p>对，就是在iTunes等工具上看到的UDID..</p>
<a id="more"></a>

<h3 id="工具及文档"><a href="#工具及文档" class="headerlink" title="工具及文档"></a>工具及文档</h3><p>嗯，Apple出的为数不多的mac app:<a href="https://itunes.apple.com/cn/app/apple-configurator-2/id1037126344?mt=12" target="_blank" rel="noopener">Apple Configurator 2</a></p>
<p>这个工具是有中文文档的：<a href="http://help.apple.com/configurator/mac/2.3/" target="_blank" rel="noopener">Apple Configurator 2 官方文档</a></p>
<p>当然还有比较暴力的直接写xml: <a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/iPhoneOTAConfiguration/ConfigurationProfileExamples/ConfigurationProfileExamples.html" target="_blank" rel="noopener">Apple的相关文档</a></p>
<hr>
<ul>
<li><a href="http://www.skyfox.org/safari-ios-device-udid.html" target="_blank" rel="noopener">通过Safari浏览器获取iOS设备UDID(设备唯一标识符)</a></li>
<li><a href="http://www.skyfox.org/ios-mobileconfig-sign.html" target="_blank" rel="noopener">为iOS的mobileconfig文件进行签名</a></li>
</ul>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>tool</tag>
        <tag>UDID</tag>
      </tags>
  </entry>
  <entry>
    <title>logio</title>
    <url>/post/logio-brief/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="log-io"><a href="#log-io" class="headerlink" title="log.io"></a>log.io</h1><p><a href="https://madordie.github.io/post/logio-brief-zh-cn/">中文</a></p>
<p>Real-time log monitoring in your browser.</p>
<a id="more"></a>

<h1 id="How-does-it-work"><a href="#How-does-it-work" class="headerlink" title="How does it work"></a>How does it work</h1><blockquote>
<p>Harvesters watch log files for changes, send new log messages to the server, which broadcasts to web clients. Log messages are tagged with stream, node, and log level information based on user configuration.</p>
<p>Log.io has no persistence layer. Harvesters are informed of file changes via inotify, and log messages hop from harvester to server to web client via TCP and socket.io, respectively.</p>
<p><img src="/images/2019-05-17-10-03-13.png" alt="work io"></p>
</blockquote>
<h2 id="Activate-streams-amp-nodes-to-watch-log-messages"><a href="#Activate-streams-amp-nodes-to-watch-log-messages" class="headerlink" title="Activate streams &amp; nodes to watch log messages"></a>Activate streams &amp; nodes to watch log messages</h2><blockquote>
<p><img src="/images/2019-05-17-10-12-25.png" alt="Activate streams &amp; nodes to watch log messages"></p>
</blockquote>
<h2 id="Simple-TCP-interface"><a href="#Simple-TCP-interface" class="headerlink" title="Simple TCP interface"></a><a name="Simple TCP interface">Simple TCP interface</a></h2><blockquote>
<p>Log.io uses a stateless TCP API to receive log messages.</p>
<p>Writing a third party harvester is easy. Open a TCP connection to the &gt; server and begin writing properly formatted messages to the socket.</p>
<p>Read the <a href="https://github.com/NarrativeScience/Log.io" target="_blank" rel="noopener">API documentation</a>.</p>
</blockquote>
<h3 id="Send-a-log-message"><a href="#Send-a-log-message" class="headerlink" title="Send a log message"></a>Send a log message</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+log|my_stream|my_node|info|this is log message\r\n</span><br></pre></td></tr></table></figure>

<h3 id="Register-a-new-node-with-stream-associations"><a href="#Register-a-new-node-with-stream-associations" class="headerlink" title="Register a new node, with stream associations"></a>Register a new node, with stream associations</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+node|my_node|my_stream1,my_stream2\r\n</span><br></pre></td></tr></table></figure>

<h3 id="Remove-a-node"><a href="#Remove-a-node" class="headerlink" title="Remove a node"></a>Remove a node</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-node|my_node\r\n</span><br></pre></td></tr></table></figure>

<h1 id="Install-Log-io"><a href="#Install-Log-io" class="headerlink" title="Install Log.io"></a>Install Log.io</h1><p>The original project <a href="https://github.com/NarrativeScience/Log.io" target="_blank" rel="noopener">NarrativeScience/Log.io</a> has been unavailable due to lack of maintenance for a long time.</p>
<p>Fortunately, the <a href="https://github.com/blacklabelops-legacy/logio" target="_blank" rel="noopener">blacklabelops-legacy/logio</a> can also be used.</p>
<p>So we can install the project like this：</p>
<h2 id="Install-and-start-docker"><a href="#Install-and-start-docker" class="headerlink" title="Install and start docker"></a>Install and start docker</h2><p>The <a href="https://docs.docker.com/install/" target="_blank" rel="noopener">docs.docker.com</a> is very detailed.</p>
<p>Support <a href="https://docs.docker.com/install/" target="_blank" rel="noopener">Cloud</a>、 <a href="https://docs.docker.com/docker-for-mac/install/" target="_blank" rel="noopener">MacOS</a> 、<a href="https://docs.docker.com/install/" target="_blank" rel="noopener">Linux</a> 、 <a href="https://docs.docker.com/docker-for-windows/install/" target="_blank" rel="noopener">Windows</a></p>
<h2 id="Pull-image"><a href="#Pull-image" class="headerlink" title="Pull image"></a>Pull image</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ docker pull blacklabelops/logio</span><br></pre></td></tr></table></figure>

<h2 id="Start-the-server"><a href="#Start-the-server" class="headerlink" title="Start the server"></a>Start the server</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">    -p 28778:28778 \</span><br><span class="line">    -p 28777:28777 \</span><br><span class="line">    --name logio \</span><br><span class="line">    blacklabelops/logio</span><br></pre></td></tr></table></figure>

<h2 id="Other-configure"><a href="#Other-configure" class="headerlink" title="Other configure"></a>Other configure</h2><p><a href="https://github.com/blacklabelops-legacy/logio" target="_blank" rel="noopener">blacklabelops-legacy/logio</a>.</p>
<h2 id="Complete"><a href="#Complete" class="headerlink" title="Complete"></a>Complete</h2><p>Browser: <a href="http://localhost:28778/" target="_blank" rel="noopener">http://localhost:28778/</a><br><img src="/images/2019-05-17-10-40-18.png" alt="log.io server"></p>
<p>Now we can write logs to port 28777. 🎉🎉🎉</p>
<h1 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h1><p>We only need to perform TCP communication according to the rules <a href="#Simple TCP interface">Simple TCP interface</a>, and the log can be displayed on the browser.</p>
<h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><p><a href="https://github.com/madordie/logio" target="_blank" rel="noopener">logio for iOS</a></p>
<hr>
<ul>
<li><a href="http://logio.org/" target="_blank" rel="noopener">logio.org</a></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>tool</tag>
        <tag>logio</tag>
      </tags>
  </entry>
  <entry>
    <title>用CollectionView简化代码，专注于业务和UI</title>
    <url>/post/ios-tool-collectionview-simplify-business/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><code>UITableView</code>作为高级控件被开发者广泛使用，同样的，<code>UICollectionView</code>由于其NB的布局也被广泛使用。但是后者在使用的时候大多数都属于自定义的比较多，前者则相对普通，list基本上都用。</p>
<p>在业务需求中，常规布局，大多数都是采用<code>UITableView</code>进行的，但是有痛点：</p>
<ul>
<li>当使在APP内用过一次瀑布流之后，设计师会突然的让你在正常的list中底部追加瀑布流。。虽然是在底部追加，但是要从<code>UITableView</code>迁移到<code>UICollectionView</code></li>
<li><code>UITableViewDelegate</code>、<code>UITableViewDataSource</code> 恐怕每处使用都要写繁琐的相同的代码吧～</li>
<li>很多人也会对其进行高度缓存啊神马的优化策略</li>
<li>不知不觉这些代码堆在一起已经将<code>UIViewController</code>堆的相当的高</li>
</ul>
<p>然后呢，我们现在使用一个<code>CollectionView</code>将这些操作包装一下，达到这样一个流程:</p>
<ol>
<li><p>自定义Cell、CellModel</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LabelCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> info = <span class="type">UILabel</span>()</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">sizeThatFits</span><span class="params">(<span class="number">_</span> size: CGSize)</span></span> -&gt; <span class="type">CGSize</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGSize</span>(width: size.width, height: info.frame.maxY + info.frame.minY)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">LabelCell</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span>: <span class="title">ListItemDefaultProtocol</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> info: <span class="type">String?</span></span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(view: LabelCell)</span></span> &#123;</span><br><span class="line">            view.info.text = info</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>请求、处理数据格式化为<code>LabelCell.Model</code>这样的类</p>
</li>
<li><p>处理好的数据交给<code>CollectionView</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">list.sections = model.format(...)</span><br></pre></td></tr></table></figure>
</li>
<li><p>休息一会，完工了～</p>
</li>
</ol>
<p>然后，来看看<code>Collection</code>里面都做了什么操作</p>
<a id="more"></a>

<h3 id="CollectionView"><a href="#CollectionView" class="headerlink" title="CollectionView"></a>CollectionView</h3><p>为了达到上面效果中的第三步，我们需要自定义一个<code>CollectionView</code>来处理刷新数据、设置代理、设置数据源、注册cell、等操作。</p>
<p>需要说明的是，此处使用<a href="https://github.com/chiahsien/CHTCollectionViewWaterfallLayout" target="_blank" rel="noopener"><code>CHTCollectionViewWaterfallLayout</code></a>来处理瀑布流。</p>
<p>创建一个<code>CollectionViewSection</code>的类/结构体来保存section信息。比如说：<code>sectionInset</code>、<code>minimumColumnSpacing</code>、<code>minimumInteritemSpacing</code>、<code>columnCount</code>、等</p>
<p>在<code>CollectionView</code>中设置一个<code>var sections = [KTJCollectionViewSection]()</code>用于保存sections</p>
<p>实现<code>UICollectionViewDataSource</code>、 <code>UICollectionViewDelegate</code>。此处省略约1千字…</p>
<h3 id="ListItemDefaultProtocol：绑定Cell和Model"><a href="#ListItemDefaultProtocol：绑定Cell和Model" class="headerlink" title="ListItemDefaultProtocol：绑定Cell和Model"></a>ListItemDefaultProtocol：绑定Cell和Model</h3><p>上面<code>省略约1千字</code>中有一个并没有说：<code>CollectionViewSection</code>的<code>header</code>、<code>items</code>、<code>footer</code>如何实现。😂</p>
<p>好了，此处这三个均采用协议<code>ListItemDefaultProtocol</code>来实现。（PS：大家都喜欢用父类，但父类只有一个，为了兼容和冲突，这里协议是最好不过的～，特别是swift中的协议）</p>
<p>协议需要给出这么几个信息：</p>
<ul>
<li><code>reuseIdentifier</code> 用来复用的重用标识符</li>
<li><code>cellClass</code> 用来注册用的类名</li>
<li><code>func fillModel(item: AnyObject)</code> 用来给cell填充model的方法</li>
</ul>
<p>那么这个协议就出来了：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">KTJListItemProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> identifa: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="keyword">var</span> registClass: <span class="type">AnyClass</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(item: AnyObject)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<strong>swift</strong>协议支持默认实现，于是乎，就可以再写一个:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ListItemDefaultProtocol</span>: <span class="title">KTJListItemProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">ItemType</span>: <span class="type">UIView</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(view: ItemType)</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ListItemDefaultProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> identifa: <span class="type">String</span> &#123; <span class="keyword">return</span>  <span class="type">NSStringFromClass</span>(<span class="type">ItemType</span>.<span class="keyword">self</span>)&#125;</span><br><span class="line">    <span class="keyword">var</span> registClass: <span class="type">AnyClass</span> &#123; <span class="keyword">return</span> <span class="type">ItemType</span>.<span class="keyword">self</span> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(item: AnyObject)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> reusableView = item <span class="keyword">as</span>? <span class="type">ItemType</span> &#123;</span><br><span class="line">            fillModel(view: reusableView)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，就可以愉快的玩耍了～～</p>
<p>最后Cell中的的代码效果就是<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView-simplify-business/LabelCell.swift" target="_blank" rel="noopener">这个样子</a>。<br>再加上<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView-simplify-business/ViewController.swift" target="_blank" rel="noopener">数据填充</a>是不是很简单了呢～～</p>
<h3 id="以后如何开发"><a href="#以后如何开发" class="headerlink" title="以后如何开发"></a>以后如何开发</h3><p>真的如同前面的例子一样，只需要这么几步绕不过去的：</p>
<ol>
<li>处理接口吐出来的数据。</li>
<li>创建新的UI样式，并做好接口数据中间件。</li>
<li>点击事件在处理数据的时候预先埋好，所有的数据、逻辑和UI数据一起被传递，不需要多次类型判断。</li>
</ol>
<p>统一使用<code>CollectionView</code>还有一个好处：不管前面谁写的一个UI，都能拉过来用。不用做中间层去从<code>TableViewCell</code>转<code>CollectionViewCell</code>。</p>
<p>开发只需要关心业务，业务。安安心心做一个写业务的程序员吧～</p>
<h3 id="关于Cell的跳转处理"><a href="#关于Cell的跳转处理" class="headerlink" title="关于Cell的跳转处理"></a>关于Cell的跳转处理</h3><p>乍一看，完美了。不过还有一个巨烦的跳转处理。。。不过，<strong>莫怕</strong></p>
<p>跳转，有这么几种：</p>
<ul>
<li>支持路由的URL跳转，这个是最简单的，也是最爽的</li>
<li>只能复杂的进行创建类、赋值、push啊神马的</li>
</ul>
<p>由于我们将数据全部处理好后扔给了<code>cellmodel</code>，而跳转、打点所需要的参数均在此处为最全的，我们可以将回调作为数据一起传递。。</p>
<p>嗯, 事件需要传递的对象大约这个样子：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Jmp</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 支持URL跳转的URL</span></span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">String?</span></span><br><span class="line">    <span class="comment">/// 打点事件名</span></span><br><span class="line">    <span class="keyword">let</span> event: <span class="type">String?</span></span><br><span class="line">    <span class="comment">/// 打点参数</span></span><br><span class="line">    <span class="keyword">let</span> attr: [<span class="type">AnyHashable</span>: <span class="type">Any</span>]?</span><br><span class="line">    <span class="comment">/// 不支持URL的直接回调</span></span><br><span class="line">    <span class="keyword">let</span> eventCallback: (() -&gt; <span class="type">Void</span>)?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后cell对应的另一个类是这样的：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KTJJmp</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> info: <span class="type">Jmp?</span></span><br><span class="line">    <span class="keyword">let</span> action = #selector(topVCJmp)</span><br><span class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">topVCJmp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ... <span class="comment">// 打点</span></span><br><span class="line">        <span class="type">KTJURLJump</span>.jumpToViewOnTopVC(jmp: info)</span><br><span class="line">        info?.eventCallback?()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tap</span><span class="params">()</span></span> -&gt; <span class="type">UITapGestureRecognizer</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">UITapGestureRecognizer</span>(target: <span class="keyword">self</span>, action: #selector(topVCJmp))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个类共同作用就是：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JmpCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> jmp = <span class="type">JmpCellModel</span>()</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setup</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        jmpBtn.addTarget(jmp, action: jmp.action, <span class="keyword">for</span>: .touchUpInside)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JmpCellModel</span>: <span class="title">ListItemDefaultProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> jmp: <span class="type">Jmp?</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(view: JmpCell)</span></span> &#123;</span><br><span class="line">        view.jmp.info = jmp</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于这个<code>JmpCellModel.jmp</code>怎么生成，这里就不说了。</p>
<h3 id="关于算高那点事"><a href="#关于算高那点事" class="headerlink" title="关于算高那点事"></a>关于算高那点事</h3><h4 id="算高位置的选择"><a href="#算高位置的选择" class="headerlink" title="算高位置的选择"></a>算高位置的选择</h4><p>我也曾纠结过frame的代码应该写在哪里。。有写在初始化的，有单独写一个方法的，还有写在<code>func sizeThatFits(:) -&gt; CGSize</code></p>
<p>由于当年对<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell" target="_blank" rel="noopener">UITableView-FDTemplateLayoutCell</a>中毒较深，所以沿用了最后一种方案。</p>
<h4 id="算高使用的view的选择"><a href="#算高使用的view的选择" class="headerlink" title="算高使用的view的选择"></a>算高使用的view的选择</h4><p>在算高的时候，首先需要明确的是：<strong>高度是数据和当前最大宽度共同决定的</strong>，所以在算高的时候需要拿着数据、view然后才能去算高（PS：至于那些拿着数据硬算出一个高度的代码，此处不发表看法😂，早晚会后悔的）</p>
<p>然后就是<code>UITableView</code>、<code>UICollectionView</code>的算高是通过一个单独的代理去获取的，并不提供view去计算。。这就是矛盾的地方。</p>
<p>虽然<code>UITableView</code>、<code>UICollectionView</code>在算高的地方不提供View,但是有一个<code>dequeueReusableCell....</code>的方法可以获取到缓存池中的<code>Cell</code>呀</p>
<p>如果你这样做了，那么你将会付出惨重的代码。这个方案我在<a href="http://www.cnblogs.com/madordie" target="_blank" rel="noopener">博客园</a>2015.03.17的<a href="http://www.cnblogs.com/madordie/p/4344209.html" target="_blank" rel="noopener">“iOS 优化性能之TableView”</a>中已经说了：</p>
<blockquote>
<p>dequeueReusableCellWithIdentifier:此函数的调用要注意以下几点：<br>    i.此函数的返回值是做为tableView:cellForRowAtIndexPath:的返回值的。这样保证拿出来的完整还给TableView。<br>    ii.如果此函数的返回值不是为了给tableView:cellForRowAtIndexPath:做返回值，那么你要注意这是在一个拿取别人稀缺资源的操作，需要注意珍惜这个返回值，能不浪费就不要浪费。<br>    iii.对于AL自动适应的TableView取Cell时候要注意保存。个人建议封装TableView，然后用来计算高度的Cell保存在TableView中。对于多种类型的Cell，则可以使用复用标识符作为Key的字典来存储。这样能够有效节约dequeueReusableCellWithIdentifier:调用次数。</p>
</blockquote>
<p><code>UICollectionView</code>也是如此。所以使用<code>dequeueReusableCell....</code>方法是<strong>很不靠谱的</strong>。</p>
<p>在<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell/blob/912b3ce4a61198c0b79a3d85b977f8fdacd153ea/Classes/UITableView%2BFDTemplateLayoutCell.m#L134-#L155" target="_blank" rel="noopener">UITableView-FDTemplateLayoutCell</a>中使用了字典保存缓存算高的View，也是比较赞的。</p>
<p>但是现在有了<code>CollectionView</code>，我们可以不用OC的<code>objc_setAssociatedObject(,,,)</code>去处理而直接使用了<code>NSCache</code>去处理就行了～</p>
<p>如果看了<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView.swift" target="_blank" rel="noopener"><code>CollectionView</code></a>就会发现，<code>ListItemProtocol</code>还有一个get方法<code>var newItem: AnyObject { get }</code>这个是用来算高的。</p>
<p>在<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView.swift" target="_blank" rel="noopener">CollectionView.swift</a>关于高度的代理设置中可以看到相关获取和设置。</p>
<h4 id="算高的时候变局的控制"><a href="#算高的时候变局的控制" class="headerlink" title="算高的时候变局的控制"></a>算高的时候变局的控制</h4><p>高度的计算现在已经可以正常计算，但是对于<code>columnCount &gt; 1</code>的时候，牵扯到间隙的计算需要注意一次啊。毕竟<code>CHTCollectionViewWaterfallLayout</code>功能更强大。</p>
<p>相关代码在<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView.swift" target="_blank" rel="noopener">CollectionView.swift</a>的<code>func collectionView(:,layout:,sizeForItemAt:) -&gt; CGSize</code>函数中。</p>
<h3 id="关于代理那点事"><a href="#关于代理那点事" class="headerlink" title="关于代理那点事"></a>关于代理那点事</h3><p>丫的，需求总是比想的多，但是办法也比问题多。</p>
<p>对于<code>CollectionView</code>来说，代理都设置成了self，这样会导致有时候需要<code>UIScrollViewDelegate</code>干些事情的时候总是不那么自由。。。实乃新痛点，不过有办法。</p>
<p>下面是几种方案：</p>
<h4 id="KVO"><a href="#KVO" class="headerlink" title="KVO"></a>KVO</h4><p>直接KVO到<code>self.contentOffset</code>，这样一了百了。写什么代理，要什么自行车！（PS：swift提供闭包的代理，也是很好用的）</p>
<p>如果不会，请自行<a href="https://www.google.com/" target="_blank" rel="noopener">Google</a>。<a href="https://objccn.io/issue-7-3/" target="_blank" rel="noopener">ObjC-中国：KVC 和 KVO</a>，我只能帮你到这里</p>
<h4 id="Rx系"><a href="#Rx系" class="headerlink" title="Rx系"></a>Rx系</h4><p>很抱歉，你不能用<code>self.rx.contentOffset</code>。原因是<a href="https://github.com/chiahsien/CHTCollectionViewWaterfallLayout" target="_blank" rel="noopener"><code>CHTCollectionViewWaterfallLayout</code></a>中有这么一行断言：</p>
<blockquote>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">NSAssert</span>([<span class="keyword">self</span>.delegate conformsToProtocol:@<span class="class"><span class="keyword">protocol</span>(<span class="title">CHTCollectionViewDelegateWaterfallLayout</span>)], @"<span class="title">UICollectionView</span>'<span class="title">s</span> <span class="title">delegate</span> <span class="title">should</span> <span class="title">conform</span> <span class="title">to</span> <span class="title">CHTCollectionViewDelegateWaterfallLayout</span> <span class="title">protocol</span>"); </span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>但是</strong>，你可以使用Rx里面的KVO呀～也是贼方便</p>
<h4 id="RAC系"><a href="#RAC系" class="headerlink" title="RAC系"></a>RAC系</h4><p>抱歉，我不会。原因在此<a href="../reactivecocoa-ready-to-use">准备食用RAC(ReactiveCocoa)的顾虑</a></p>
<h4 id="代理传递"><a href="#代理传递" class="headerlink" title="代理传递"></a>代理传递</h4><p>当然也可以使用代理进行传递出去。大致这个样子：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">CollectionViewDelegate</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> allDelegate: <span class="type">CollectionViewDelegate?</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.allDelegate?.collectionView(<span class="keyword">self</span>, didSelectItemAt: indexPath)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这方案没啥聊的。。</p>
<h3 id="OC咋办？"><a href="#OC咋办？" class="headerlink" title="OC咋办？"></a>OC咋办？</h3><p>这个OC也能用，只不过需要一些手段，比如说：继承、扩展、等</p>
<p><code>ListItemProtocol</code>就是为了给OC使用留的，还有就是<code>CollectionViewSection</code>使用了类，而不是结构体。</p>
<p>不过具体没有例子，不想写OC代码，太麻烦了。。主要是这种思路:)</p>
<h3 id="填充Cell的数据为什么会在CellModel中？"><a href="#填充Cell的数据为什么会在CellModel中？" class="headerlink" title="填充Cell的数据为什么会在CellModel中？"></a>填充Cell的数据为什么会在CellModel中？</h3><p>对于Cell来说，Cell是干净的，没有任何继承、协议来限制Cell如何处理。那么Cell就可以接受来自任何模块的各种风格的Cell，这是我想要的减少侵入。</p>
<p>cellModel中定义了Cell所对应的填充数据格式，在第一次写的时候难免会按照业务逻辑起一些业务逻辑的名字，在复用的时候又不能改名字，会对维护和开发加了一定量的复杂度，这不是我想要的。。</p>
<p>于是乎每个CellModel根据自己的需要绑定需要绑定的Cell，去填充Cell所对应的数据就好。只需要侵入cellModel即可。代价最小，受益最大。</p>
<p>PS.对于同一个List，需要注意cell的复用和多个cellModel同时绑定一个cell时，属性的设置。</p>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p><a href="https://github.com/madordie/collectionview-simplify-business" target="_blank" rel="noopener">Demo</a>部分没有写跳转相关内容，但是别的都有了😂</p>
<h3 id="别的"><a href="#别的" class="headerlink" title="别的"></a>别的</h3><p>好像没了吧～，想起来了再补充咯</p>
<h3 id="偶然看到一个类似的文章"><a href="#偶然看到一个类似的文章" class="headerlink" title="偶然看到一个类似的文章"></a>偶然看到一个类似的文章</h3><blockquote>
<p><a href="https://www.appcoda.com.tw/tableview-mvvm/" target="_blank" rel="noopener">Table View 太複雜？利用 MVVM 和 Protocol 就可以為它重構瘦身！</a></p>
</blockquote>
<p>昨天(2018.7.24)翻文章的时候看到这个文章，然后将文章和代码捋了一下，发现这才是MVVM吧。觉得不错，贴出来～</p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>tool</tag>
        <tag>UICollectionView</tag>
      </tags>
  </entry>
  <entry>
    <title>实时显示日志logio</title>
    <url>/post/logio-brief-zh-cn/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="log-io"><a href="#log-io" class="headerlink" title="log.io"></a>log.io</h1><p><a href="https://madordie.github.io/post/logio-brief/">English</a></p>
<p>一个能在浏览器上实时显示日志的工具。</p>
<a id="more"></a>

<h1 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h1><p>以下摘自<a href="http://logio.org/" target="_blank" rel="noopener">logio.org</a>，我觉得已经非常的详细了，这里就不啰嗦了。</p>
<blockquote>
<p>Harvesters watch log files for changes, send new log messages to the server, which broadcasts to web clients. Log messages are tagged with stream, node, and log level information based on user configuration.</p>
<p>Log.io has no persistence layer. Harvesters are informed of file changes via inotify, and log messages hop from harvester to server to web client via TCP and socket.io, respectively.</p>
<p><img src="/images/2019-05-17-10-03-13.png" alt="work io"><br><img src="/images/2019-05-17-10-12-25.png" alt="Activate streams &amp; nodes to watch log messages"></p>
</blockquote>
<h2 id="通信使用的TCP接口"><a href="#通信使用的TCP接口" class="headerlink" title="通信使用的TCP接口"></a><a name="Simple TCP interface">通信使用的TCP接口</a></h2><blockquote>
<p>Log.io uses a stateless TCP API to receive log messages.</p>
<p>Writing a third party harvester is easy. Open a TCP connection to the &gt; server and begin writing properly formatted messages to the socket.</p>
<p>Read the <a href="https://github.com/NarrativeScience/Log.io" target="_blank" rel="noopener">API documentation</a>.</p>
</blockquote>
<h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+log|my_stream|my_node|info|this is log message\r\n</span><br></pre></td></tr></table></figure>

<h3 id="注册一个新的node和stream"><a href="#注册一个新的node和stream" class="headerlink" title="注册一个新的node和stream"></a>注册一个新的node和stream</h3><p>如果原来已经存在，那么还是原来的那个。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+node|my_node|my_stream1,my_stream2\r\n</span><br></pre></td></tr></table></figure>

<h3 id="删除node"><a href="#删除node" class="headerlink" title="删除node"></a>删除node</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-node|my_node\r\n</span><br></pre></td></tr></table></figure>

<h1 id="安装Log-io服务端"><a href="#安装Log-io服务端" class="headerlink" title="安装Log.io服务端"></a>安装Log.io服务端</h1><p>这个年久失修的原始项目<a href="https://github.com/NarrativeScience/Log.io" target="_blank" rel="noopener">NarrativeScience/Log.io</a>已经没办法正常工作了。。</p>
<p>幸运的是，docker版本的<a href="https://github.com/blacklabelops-legacy/logio" target="_blank" rel="noopener">blacklabelops-legacy/logio</a>还可以用，所以我们就用这个吧。</p>
<h2 id="安装并开启docker"><a href="#安装并开启docker" class="headerlink" title="安装并开启docker"></a>安装并开启docker</h2><p>docker的文档<a href="https://docs.docker.com/install/" target="_blank" rel="noopener">docs.docker.com</a>依旧非常详细，不再赘述。</p>
<p>值得一提的是支持的平台有很多，比如：<a href="https://docs.docker.com/install/" target="_blank" rel="noopener">Cloud</a>、 <a href="https://docs.docker.com/docker-for-mac/install/" target="_blank" rel="noopener">MacOS</a> 、<a href="https://docs.docker.com/install/" target="_blank" rel="noopener">Linux</a> 、 <a href="https://docs.docker.com/docker-for-windows/install/" target="_blank" rel="noopener">Windows</a></p>
<h2 id="pull-镜像"><a href="#pull-镜像" class="headerlink" title="pull 镜像"></a>pull 镜像</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ docker pull blacklabelops/logio</span><br></pre></td></tr></table></figure>

<h2 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">    -p 28778:28778 \</span><br><span class="line">    -p 28777:28777 \</span><br><span class="line">    --name logio \</span><br><span class="line">    blacklabelops/logio</span><br></pre></td></tr></table></figure>

<p>值得一提的是，原文档<a href="https://github.com/blacklabelops-legacy/logio" target="_blank" rel="noopener">blacklabelops-legacy/logio</a>中是没有<code>-p 28777:28777</code>参数的，会导致其28777端口无响应，应该是一个手误或者特殊需要？反正这里打开就好了。</p>
<h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><p>其他配置在<a href="https://github.com/blacklabelops-legacy/logio" target="_blank" rel="noopener">blacklabelops-legacy/logio</a>中也很详细😂，需要的请自取。比如说日志、https、等</p>
<h2 id="最终效果图"><a href="#最终效果图" class="headerlink" title="最终效果图"></a>最终效果图</h2><p>在浏览器上打开<a href="http://localhost:28778/%E5%8D%B3%E5%8F%AF%E3%80%82%EF%BC%88localhost" target="_blank" rel="noopener">http://localhost:28778/即可。（localhost</a> 是安装server的IP）<br><img src="/images/2019-05-17-10-40-18.png" alt="log.io server"></p>
<p>于是乎，我们就可以向localhost:28778疯狂的写日志了. 🎉🎉🎉</p>
<h1 id="支持的插件"><a href="#支持的插件" class="headerlink" title="支持的插件"></a>支持的插件</h1><p>这个日志服务<a href="#Simple TCP interface">对外接口</a>比较简单，所以理论上来讲，只需要可以进行TCP通信的包均可以支持，包括但不限于安卓、iOS。</p>
<h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><p><a href="https://github.com/madordie/logio" target="_blank" rel="noopener">iOS版本</a>基于<a href="https://cocoapods.org/" target="_blank" rel="noopener">CocoaPods</a>的项目只需要在Podfile中添加：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">pod <span class="string">'LogIO'</span>, <span class="symbol">:git</span> =&gt; <span class="string">'https://github.com/madordie/logio.git'</span></span><br></pre></td></tr></table></figure>

<p>其iOS版本已经放在了这里：<a href="https://github.com/madordie/logio" target="_blank" rel="noopener">madordie/logio</a></p>
<p>iOS上之前有一个类似的<a href="https://github.com/s4nchez/LogIO-CocoaLumberjack" target="_blank" rel="noopener">LogIO-CocoaLumberjack</a>, 我这里做了简单的更新，目的是不绑定<a href="https://github.com/robbiehanson/CocoaAsyncSocket" target="_blank" rel="noopener">CocoaAsyncSocket</a>。</p>
<hr>
<ul>
<li><a href="http://logio.org/" target="_blank" rel="noopener">logio.org</a></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>tool</tag>
        <tag>logio</tag>
      </tags>
  </entry>
  <entry>
    <title>「转」一个NB的补救项目国际化的方案</title>
    <url>/post/yi-ge-nb-de-bu-jiu-xiang-mu-guo-ji-hua-de-fang-an/</url>
    <content><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p><a href="http://www.devashen.com/blog/2016/01/15/localized02/" target="_blank" rel="noopener"> iOS 多语言版本的开发（二）</a> 中我们实现了如何让用户自己去切换系统语言的功能，我们还写了<a href="https://github.com/Ashen-Zhao/easyLocalized" target="_blank" rel="noopener">Demo</a> 以供辅助学习；但是，继以上两篇文章都是建立在项目刚刚启动或启动不久，项目中存在的中文字符串还不是很多，手动改起来也还可以接受; 那么问题来了，如果项目已经竣工或者已经迭代几个版本了，那该如何实现了？手动改起来也不太现实，耗时耗力不讨好的手动，在这里就不用考虑了。 不让考虑，是因为我有更简单快捷高效的方法，让我慢慢与您道来；</p>
<h2 id="如何辨别项目中的中文字符串"><a href="#如何辨别项目中的中文字符串" class="headerlink" title="如何辨别项目中的中文字符串?"></a>如何辨别项目中的中文字符串?</h2><p> 既然要替换项目中使用到的中文字符串，那么前提就必须要先找到这些个字符串，然后将这些字符串，替换成我们定义的宏， 为了替换方便，可将这些字符串自身作为key， 这里不理解的不要紧，下面我还会讲到。 既然是辨别中文字符串，那也就是说在项目文件中进行匹配查找，说到匹配，那就需要正则表达式了，用正则表达式匹配Xcode中的使用的中文字符串，使用<code>(@&quot;[^&quot;]*[\u4E00-\u9FA5]+[^&quot;\n]*?&quot;)\s*</code> 即可， 打开你的Xcode 试试看，切记find 后面的选项要选择 <code>Regular Expression</code>, 默认选中的是<code>Text</code>, 如图</p>
<p><img src="/images/2018-05-25-13-32-53.png" alt="啊神多语言"></p>
<h2 id="如何取出识别到的中文字符串？"><a href="#如何取出识别到的中文字符串？" class="headerlink" title="如何取出识别到的中文字符串？"></a>如何取出识别到的中文字符串？</h2><p> 我们已经知道如何识别项目中的字符串了，但是如何取出来使用呢？ 这就需要遍历项目中所有的指定后缀（e.g: .h、.m等）的文件，然后利用正则表达匹配所有使用到的中文字符串，并写入文件中。为了方便起见，我将此过程写了一个Mac客户端<a href="https://github.com/Ashen-Zhao/ReadChinese" target="_blank" rel="noopener">小应用</a>，可直接将选中的项目中所有的中文字符串，导出到指定的路径下；该应用还可以选择对于重复出现的中文字符串进行处理，以及还可以将中文字符串导出为繁体； <a href="https://github.com/Ashen-Zhao/ReadChinese" target="_blank" rel="noopener">小应用</a>更值得关注的是它导出的文件，可以直接拿来当做多语言文件中的<code>key=value</code> 使用，非常简单，喜欢的可以去<a href="https://github.com/Ashen-Zhao/ReadChinese" target="_blank" rel="noopener">下载看看</a>， 含有源码的哦；小应用运行图如下：</p>
<p><img src="/images/2018-05-25-13-48-12.png" alt="啊神多语言"></p>
<h2 id="如何使用取出的中文字符串？"><a href="#如何使用取出的中文字符串？" class="headerlink" title="如何使用取出的中文字符串？"></a>如何使用取出的中文字符串？</h2><p> 已经拿到取出的中文字符串文件，这个文件是可以直接拿来用做多语言文件使用的，小应用导出的文件，只可以用于中文以及繁体多语言文件，而对于其他的语言，就需要你拿着导出的文件，找你们公司的翻译人员，进行翻译； 拿繁体版来举个例子，导出来的繁体文件如下（收留我App导出的文件）：</p>
<p><img src="/images/2018-05-25-13-48-38.png" alt="啊神多语言"></p>
<p>这个繁体文件，可以直接作为繁体多语言使用，如何想要翻译成英文，可以将此文件拷贝一份，交给翻译人员，让其翻译。翻译的时候，你一定要给翻译人员沟通好，让其只翻译<code>value</code>, 也就是图中<code>=</code> 后面双引号中的内容，格式什么的也不要让他乱改，否则容易出现问题，导致key与value对不上号。 一切沟通妥当后，等翻译把文件给你后，直接将文件中的内容，复制到多语言文件的英语文件中即可；</p>
<h2 id="如何将项目中的中文字符串进行替换"><a href="#如何将项目中的中文字符串进行替换" class="headerlink" title="如何将项目中的中文字符串进行替换"></a>如何将项目中的中文字符串进行替换</h2><p> 多语言文件已经配置完成，到了这里，那么问题来了，我们只是取出项目中使用的中文字符串，然后将字符串封装成多语言文件，但是对于项目中使用的中文字符串依然还是中文字符串，我们还并没有进行替换处理。当然，这一步我们是不能够忘了，由于是替换项目中所有的使用中文字符串，我们还是谨慎为好，首先将你的项目进行备份、备份、备份，非常重要的事情说三篇，切记一定要备份。备份好后，我们就可以开始替换工作了，没有备份的不要往下看了，赶紧备份去；<br> 假设你已经备份好了，你就可以开始替换工作了，前面我们说过让中文字符串自身作为key 进行替换，之所以让其自身作为key, 是因为这样可以大大减轻替换的困难度，而且还有利于代码的可读性，基本上算是保持原有代码；既然要替换项目中的使用中文字符串，就要用到Xcode 自带的字符串替换功能，首先还需要使用正则表达式<code>(@&quot;[^&quot;]*[\u4E00-\u9FA5]+[^&quot;\n]*?&quot;)\s*</code>，匹配出项目中使用的中文字符串，然后在对其进行替换处理。</p>
<p> 由于我们在<a href="http://www.devashen.com/blog/2016/01/15/localized02/" target="_blank" rel="noopener">iOS 多语言版本的开发（二）</a>中，对取key对应的语言内容，进行了宏的封装, 这里我们可以将匹配到的使用中文字符直接替换成我们定义的宏的使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#define ASLocalizedString(key)  [NSString stringWithFormat:@&quot;%@&quot;, [[NSBundle bundleWithPath:[[NSBundle mainBundle] pathForResource:[NSString stringWithFormat:@&quot;%@&quot;,[[NSUserDefaults standardUserDefaults] objectForKey:@&quot;appLanguage&quot;]] ofType:@&quot;lproj&quot;]] localizedStringForKey:(key) value:nil table:@&quot;ASLocalized&quot;]]</span><br></pre></td></tr></table></figure>

<p>以上是宏的定义，我们需要将字符串进行替换成宏的使用，如：<br> 替换前是这样的<code>_lbl.text = @&quot;我是多语言&quot;;</code><br> 替换后<code>_lbl.text = ASLocalizedString(@&quot;我是多语言&quot;)</code></p>
<p>替换规则如图：</p>
<p><img src="/images/2018-05-25-13-50-18.png" alt="啊神多语言"></p>
<p>这次选中的是<code>Replace</code>, 不是<code>Find</code>。按图中所示，选择完毕后，点击<code>ReplaceAll</code>, 会出来一个弹框，不用管它直接继续，即可，然后你在看项目中使用到的中文字符串是否已经替换掉了，到这里基本上大功告成了；</p>
<h2 id="遗留问题"><a href="#遗留问题" class="headerlink" title="遗留问题"></a>遗留问题</h2><p>1、正则表达式，不懂得可以先照文章里写就行，然后再去学习下，<a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="noopener">这里有篇基础文章</a><br>2、ASLocalizedString(key) ， 该宏使用面积广，可以将其定义成公共头文件中，然后用时引用头文件即可，也可将文件封装进pch文件中，这样无需使用头文件接口使用<br>3、替换后，可能会有些地方报错，command + b 编译下，看看报错的地方，进行相应修改即可。报错原因：a. 可能是你定义的常量字符串； b. 可能是定义的宏； c. 可能是替换后没有换行； 基本上报的错误很明显，进行修改即可；<br>4、在迭代版本中，再次使用中文字符串，就需要使用<code>ASLocalizedString(key)</code>， 来代替了，然后再多语言文件中，进行<code>key=value</code> 配置；</p>
<blockquote>
<p>相关文章</p>
</blockquote>
<blockquote>
<p>iOS 多语言版本的开发（一）</p>
</blockquote>
<blockquote>
<p>iOS 多语言版本的开发（二）</p>
</blockquote>
<hr>
<p>文章转自 <a href="http://www.devashen.com/blog/2016/01/18/localized03/" target="_blank" rel="noopener">iOS 多语言版本的开发（三）</a></p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
      <tags>
        <tag>国际化</tag>
      </tags>
  </entry>
</search>
