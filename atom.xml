<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>继刚的博客</title>
  
  <subtitle>不疯魔,不成活</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://madordie.github.io/"/>
  <updated>2020-10-20T03:28:21.184Z</updated>
  <id>https://madordie.github.io/</id>
  
  <author>
    <name>继刚</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>iOS的__bridge_retained可以做什么</title>
    <link href="https://madordie.github.io/post/what-happened-on-the-bridge-in-ios-2/"/>
    <id>https://madordie.github.io/post/what-happened-on-the-bridge-in-ios-2/</id>
    <published>2020-10-19T16:00:00.000Z</published>
    <updated>2020-10-20T03:28:21.184Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="抛出问题"><a href="#抛出问题" class="headerlink" title="抛出问题"></a>抛出问题</h2><p>群友(@止一)昨晚上发了一个问题:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> Test &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *arr;</span><br><span class="line">&#125; Test;</span><br><span class="line">- (<span class="keyword">void</span>)test &#123;</span><br><span class="line">    Test test = &#123;&#125;;</span><br><span class="line">    test.arr = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">self</span>.var = test;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    [<span class="keyword">self</span> test];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, <span class="keyword">self</span>.var.arr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>xcode12这样写会崩溃</p></blockquote><a id="more"></a><h2 id="大佬提供的一些资料"><a href="#大佬提供的一些资料" class="headerlink" title="大佬提供的一些资料"></a>大佬提供的一些资料</h2><ul><li><a href="https://lengmolehongyan.github.io/blog/2020/09/19/xcode-12-reactnativeart-crash/">Xcode 12 ReactNativeART Crash</a></li><li><a href="https://devstreaming-cdn.apple.com/videos/wwdc/2018/409t8zw7rumablsh/409/409_whats_new_in_llvm.pdf">WWDC2018 Session409: What’s New in LLVM </a></li></ul><h2 id="还原一下场景"><a href="#还原一下场景" class="headerlink" title="还原一下场景"></a>还原一下场景</h2><p>打开<code>Zombie Objects</code>时场景如下:</p><p><img src="/images/2020-10-20-10-35-52.png" alt="Xcode12-Zombie-Objects"></p><p>当不打开的时候是这样的:</p><p><img src="/images/2020-10-20-10-39-08.png" alt="Xcode12-No-Zombie-Objects"></p><p><code>Xcode11</code>并不崩溃:</p><p><img src="/images/2020-10-20-10-41-28.png" alt="Xcode11"></p><h2 id="对比一下汇编伪代码"><a href="#对比一下汇编伪代码" class="headerlink" title="对比一下汇编伪代码"></a>对比一下汇编伪代码</h2><p>仔细对比了一下代码,发现<code>test</code>函数完全一样:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test &#123;</span><br><span class="line">    Test test = &#123;&#125;;</span><br><span class="line">    test.arr = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">self</span>.var = test;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 汇编伪代码</span></span><br><span class="line"><span class="keyword">void</span> __cdecl -[XX test](XX *<span class="keyword">self</span>, SEL a2)</span><br><span class="line">&#123;</span><br><span class="line">  v14 = <span class="keyword">self</span>;</span><br><span class="line">  v13 = a2;</span><br><span class="line">  v8 = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>];</span><br><span class="line">  v12 = objc_retainAutoreleasedReturnValue(v8);</span><br><span class="line">  objc_release(<span class="number">0</span>LL);</span><br><span class="line">  __copy_constructor_8_8_s0(&amp;v11, &amp;v12);</span><br><span class="line">  v9 = v14;</span><br><span class="line">  __copy_constructor_8_8_s0(&amp;v10, &amp;v11);</span><br><span class="line">  -[XX setVar:](v9, <span class="string">&quot;setVar:&quot;</span>, v10);</span><br><span class="line">  __destructor_8_s0(&amp;v12);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后, 关联的<code>for-NSLog</code>:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">    [<span class="keyword">self</span> test];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, <span class="keyword">self</span>.var.arr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Xcode12下汇编伪代码</span></span><br><span class="line"><span class="keyword">void</span> __cdecl -[XX main](XX *<span class="keyword">self</span>, SEL a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span> *v2; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  SEL v4; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">void</span> *v5; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="keyword">self</span>;</span><br><span class="line">  v4 = a2;</span><br><span class="line">  -[XX test](<span class="keyword">self</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = objc_msgSend(v5, <span class="string">&quot;var&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="built_in">CFSTR</span>(<span class="string">&quot;%@&quot;</span>), v2);</span><br><span class="line">    __destructor_8_s0((__int64)&amp;v2);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Xcode12下汇编伪代码</span></span><br><span class="line"><span class="keyword">void</span> __cdecl -[XX main](XX *<span class="keyword">self</span>, SEL a2)</span><br><span class="line">&#123;</span><br><span class="line">  Test v2; <span class="comment">// ST10_8</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  -[XX test](<span class="keyword">self</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v2.var0 = -[XX var](<span class="keyword">self</span>, <span class="string">&quot;var&quot;</span>).var0;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="built_in">CFSTR</span>(<span class="string">&quot;%@&quot;</span>), v2.var0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以Xcode12比Xcode11多了一行<code>__destructor_8_s0((__int64)&amp;v2);</code>, 再看下这个是啥:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall __destructor_8_s0(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> objc_storeStrong(a1, <span class="number">0</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结案, Xcode12下<code>self.var.arr</code>之后会将返回值进行一次<code>release</code></p><h2 id="Xcode12的这种情境下如何修正"><a href="#Xcode12的这种情境下如何修正" class="headerlink" title="Xcode12的这种情境下如何修正"></a>Xcode12的这种情境下如何修正</h2><ul><li>此处只是作为<a href="./what-happened-on-the-bridge-in-ios">iOS的__bridge、__bridge_transfer究竟做了啥</a>的补充去讨论<code>__bridge_retained</code>, 至于真正的场景应该如何修复, 或许只是一个Xcode12的BUG, 请继续Google :&gt;</li></ul><p>按照<a href="./what-happened-on-the-bridge-in-ios">iOS的__bridge、__bridge_transfer究竟做了啥</a>的思路来: 我们需要加一下<code>__bridge*</code>的标记, <code>struct</code>虽然不是<code>CoreFounction</code>的东西,但是可以用的</p><p>从对比来看, 我们应该修改的是<code>for-NSLog</code>中的代码, 这样才不至于引出其他的问题, 然后从<a href="./what-happened-on-the-bridge-in-ios">上文</a>可以得知, 此处我们应该用<code>__bridge</code>, 来试验一下:</p><p><img src="/images/2020-10-20-11-10-46.png" alt="Xcode12-__bridge"></p><p>GG, 我们注意到<code>__destructor_8_s0</code>函数在<code>test</code>中也出现过, 作用是释放<code>@[@1, @2, @3]</code>临时变量, 难道作用是<code>将ObjC对象交给C处理之后清理ObjC对象临时引用</code>? 按照这个思路我们应该试一下<code>__bridge_retained</code>, 目的是伪造一个从Objc对象移交给<code>CoreFounction</code>的假象,试一下:</p><p><img src="/images/2020-10-20-11-20-14.png" alt="Xcode12-__bridge_retained"></p><p>不崩溃了~~</p><p>看下伪代码:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">    [<span class="keyword">self</span> test];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, (__bridge_retained <span class="keyword">void</span>*)(<span class="keyword">self</span>.var.arr));</span><br><span class="line">    &#125;</span><br><span class="line">    printf(<span class="string">&quot;over\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Xcode12伪代码</span></span><br><span class="line"><span class="keyword">void</span> __cdecl -[XX main](XX *<span class="keyword">self</span>, SEL a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> *v4; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  SEL v6; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">void</span> *v7; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = <span class="keyword">self</span>;</span><br><span class="line">  v6 = a2;</span><br><span class="line">  -[XX test](<span class="keyword">self</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = objc_msgSend(v7, <span class="string">&quot;var&quot;</span>);</span><br><span class="line">    v4 = v2;</span><br><span class="line">    v3 = objc_retain(v2);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="built_in">CFSTR</span>(<span class="string">&quot;%@&quot;</span>), v3);</span><br><span class="line">    __destructor_8_s0((__int64)&amp;v4);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>从<code>__bridge</code>、<code>__bridge_transfer</code>到<code>__bridge_retained</code>, 而没有一处是关于<code>CoreFounction</code>的东西, 却看到了ARC下对引用计数的干预…</p><p>愿世界再无BUG~</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;抛出问题&quot;&gt;&lt;a href=&quot;#抛出问题&quot; class=&quot;headerlink&quot; title=&quot;抛出问题&quot;&gt;&lt;/a&gt;抛出问题&lt;/h2&gt;&lt;p&gt;群友(@止一)昨晚上发了一个问题:&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; Test &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *arr;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; Test;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)test &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Test test = &amp;#123;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    test.arr = @[@&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, @&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, @&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.var = test;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)viewDidLoad &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; viewDidLoad];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; test];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&amp;quot;%@&amp;quot;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.var.arr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;blockquote&gt;
&lt;p&gt;xcode12这样写会崩溃&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="DEBUG" scheme="https://madordie.github.io/tags/DEBUG/"/>
    
      <category term="__bridge*" scheme="https://madordie.github.io/tags/bridge/"/>
    
  </entry>
  
  <entry>
    <title>iOS的__bridge、__bridge_transfer究竟做了啥</title>
    <link href="https://madordie.github.io/post/what-happened-on-the-bridge-in-ios/"/>
    <id>https://madordie.github.io/post/what-happened-on-the-bridge-in-ios/</id>
    <published>2020-10-09T16:00:00.000Z</published>
    <updated>2020-10-20T03:29:22.461Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="抛出问题"><a href="#抛出问题" class="headerlink" title="抛出问题"></a>抛出问题</h2><p>群友(@闲人)贴了这么一个<strong>会崩溃</strong>的代码:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">test</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)performSelector:(SEL)aSelector withObjects:(<span class="built_in">NSArray</span> *)objects &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *methodSignature = [[<span class="keyword">self</span> <span class="keyword">class</span>] instanceMethodSignatureForSelector:aSelector];</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> invocationWithMethodSignature:methodSignature];</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    [invocation invoke];</span><br><span class="line">    <span class="comment">//返回值处理</span></span><br><span class="line">    <span class="keyword">id</span> callBackObject = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(methodSignature.methodReturnLength) &#123;</span><br><span class="line">        [invocation getReturnValue:&amp;callBackObject];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> callBackObject;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TestModel</span>: <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSNumber</span> *age;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TestModel</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithA:(<span class="built_in">NSString</span> *)a b:(<span class="built_in">NSString</span> *)b c:(<span class="built_in">NSString</span> *)c &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        printf(<span class="string">&quot;initABC\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    TestModel *_teM;</span><br><span class="line">    Class <span class="keyword">class</span> = <span class="built_in">NSClassFromString</span>(<span class="string">@&quot;TestModel&quot;</span>);</span><br><span class="line">    _teM = [[<span class="keyword">class</span> alloc] performSelector:<span class="keyword">@selector</span>(initWithA:b:c:) withObjects:@[<span class="string">@&quot;1&quot;</span>,<span class="string">@&quot;1&quot;</span>,<span class="string">@&quot;1&quot;</span>]];</span><br><span class="line">    [_teM performSelector:<span class="keyword">@selector</span>(setAge:) withObject:@<span class="number">1</span>]; <span class="comment">/*  &lt;- EXC_BAD_ACCESS  */</span></span><br><span class="line">    printf(<span class="string">&quot;over\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>对,段错误,代码挂在了<code>[_teM performSelector:@selector(setAge:) withObject:@1]</code></p><a id="more"></a><h2 id="粗略分析"><a href="#粗略分析" class="headerlink" title="粗略分析"></a>粗略分析</h2><p>先打开<code>Zombie Objects</code>再跑一次:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*** -[TestModel performSelector:withObject:]: message sent to deallocated instance 0x6000039ec630</span><br></pre></td></tr></table></figure><p>哦,<code>_teM&lt;0x6000039ec630&gt;</code>已经被释放了. 那是谁释放的呢?</p><p>回到崩溃的问题上: <code>message sent to deallocated instance 0x6000039ec630</code></p><p>那么实现<code>-[TestModel dealloc]</code>即可找到什么时候释放的呗~</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; breakpoint 2.1</span><br><span class="line">  * frame #0: 0x000000010ec8a770 PerformDemo&#96;-[TestModel dealloc](self&#x3D;0x0000600003c847d0, _cmd&#x3D;&quot;dealloc&quot;) at ViewController.m:31:5</span><br><span class="line">    frame #1: 0x00007fff2018f7f4 libobjc.A.dylib&#96;objc_object::sidetable_release(bool, bool) + 174</span><br><span class="line">    frame #2: 0x000000010ec8a949 PerformDemo&#96;-[ViewController viewDidLoad](self&#x3D;0x00007ff403614fc0, _cmd&#x3D;&quot;viewDidLoad&quot;) at ViewController.m:46:5</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>是不是很没头绪? 如果没头绪的话就被我<del>这一顿粗略分析</del>给带沟里了…</p><h2 id="看点别的"><a href="#看点别的" class="headerlink" title="看点别的"></a>看点别的</h2><p>我们先看下<code>-[NSObject performSelector:withObjects:]</code>中的返回值获取的逻辑:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> callBackObject = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span>(methodSignature.methodReturnLength) &#123;</span><br><span class="line">    [invocation getReturnValue:&amp;callBackObject];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于<code>NSInvocation</code>我用的比较少,但是看过<a href="https://github.com/Awhisper">唯敬</a>大佬的<a href="https://github.com/Awhisper/VKMsgSend">VKMsgSend</a>库, 这几行代码是真的短..</p><p>先看下这几行的汇编伪代码:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">v15 = <span class="number">0L</span>L;</span><br><span class="line"><span class="keyword">if</span> ( objc_msgSend(v24, <span class="string">&quot;methodReturnLength&quot;</span>) )</span><br><span class="line">  objc_msgSend(v23, <span class="string">&quot;getReturnValue:&quot;</span>, &amp;v15);</span><br><span class="line">v12 = objc_retain(v15);   <span class="comment">// +1</span></span><br><span class="line">objc_storeStrong(&amp;v15, <span class="number">0L</span>L);  <span class="comment">// -1</span></span><br><span class="line">objc_storeStrong(&amp;v23, <span class="number">0L</span>L);</span><br><span class="line">objc_storeStrong(&amp;v24, <span class="number">0L</span>L);</span><br><span class="line"><span class="keyword">return</span> (id)objc_autoreleaseReturnValue(v12);  <span class="comment">// --&gt; append autoreleasepool</span></span><br></pre></td></tr></table></figure><p>所以此时关于该对象的生命周期操作大概如下:</p><ul><li>v12 = objc_retain(v15);   // +1</li><li>objc_storeStrong(&amp;v15, 0LL);  // -1</li><li>return (id)objc_autoreleaseReturnValue(v12);  // –&gt; append autoreleasepool</li></ul><p>这个对象从<code>-[NSInvocation getReturnValue:]</code>获取出来之后在没有增加引用计数的情况下反而给人家加到了<code>autoreleasepool</code>里面.</p><p>众所周知<code>autoreleasepool</code>在释放的时候会对其进行一次<code>release</code>, 而这次不对等的<code>release</code>就是这个崩溃发生的究极原因.</p><h2 id="怎么解决"><a href="#怎么解决" class="headerlink" title="怎么解决"></a>怎么解决</h2><p><code>ObjC</code>的<code>ARC</code>下除了能用个<code>@autoreleasepool&#123;&#125;</code>让其提前<code>objc_release</code>,基本上没有能干预得了.</p><p>不过这个<code>-[NSInvocation getReturnValue:]</code>API的返回值是地址直接传递的, API也是属于<code>CoreFounction</code>中, 其与<code>ARC</code>对象之间还有<code>__bridge*</code>可用.</p><p>再看下<a href="https://github.com/Awhisper/VKMsgSend/blob/master/VKMsgSend/VKMsgSend.m#L214-#L227">小抄</a>, 嗯,确实缺少了<code>__bridge*</code>:</p><p>然后问题来了: 重写的<code>init</code>应该用<code>__bridge_transfer</code>还是<code>__bridge</code>?</p><p>这个问题其实也很简单, 试一下子撒~~ (答案是<code>__bridge</code> :)</p><p>先看下<a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html">官方文档</a>原文</p><blockquote><p>The compiler does not automatically manage the lifetimes of Core Foundation objects. You tell the compiler about the ownership semantics of objects using either a cast (defined in objc/runtime.h) or a Core Foundation-style macro (defined in NSObject.h):</p><ul><li>__bridge transfers a pointer between Objective-C and Core Foundation with no transfer of ownership.</li><li>__bridge_retained or CFBridgingRetain casts an Objective-C pointer to a Core Foundation pointer and also transfers ownership to you.<br>You are responsible for calling CFRelease or a related function to relinquish ownership of the object.</li><li>__bridge_transfer or CFBridgingRelease moves a non-Objective-C pointer to Objective-C and also transfers ownership to ARC.<br>ARC is responsible for relinquishing ownership of the object.</li></ul></blockquote><p>然后, 我想说点在网上目前还搜不到的.</p><h3 id="bridge-transfer为什么不行"><a href="#bridge-transfer为什么不行" class="headerlink" title="__bridge_transfer为什么不行"></a><code>__bridge_transfer</code>为什么不行</h3><p>如原文说了<code>a pointer between Objective-C and Core Foundation with no transfer of ownership</code>, 并不会发生所有权的转移.</p><p>然后<code>__bridge_transfer</code>究竟做了什么呢? 对比一下汇编伪代码吧,简单直接:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v15 = <span class="number">0L</span>L;</span><br><span class="line"><span class="keyword">if</span> ( objc_msgSend(v24, <span class="string">&quot;methodReturnLength&quot;</span>) )</span><br><span class="line">  objc_msgSend(v23, <span class="string">&quot;getReturnValue:&quot;</span>, &amp;v15);</span><br><span class="line">v12 = v15;</span><br><span class="line">objc_storeStrong(&amp;v23, <span class="number">0L</span>L);</span><br><span class="line">objc_storeStrong(&amp;v24, <span class="number">0L</span>L);</span><br><span class="line"><span class="keyword">return</span> (id)objc_autoreleaseReturnValue(v12);</span><br></pre></td></tr></table></figure><p><code>v12 = v15</code>, 是的,就是这么彪悍. 直接赋值的, 比不加<code>__bridge_transfer</code>少了一次<code>objc_retain(v15)</code>和<code>objc_storeStrong(&amp;v15, 0LL)</code>, 理论来讲速度更加快了,毕竟两者效果是一样的.</p><h3 id="bridge为什么行"><a href="#bridge为什么行" class="headerlink" title="__bridge为什么行"></a><code>__bridge</code>为什么行</h3><p>原文中说会讲所有权移交给ARC, 也就是ARC要负责释放该对象, 等价于将引用计数加一.</p><p>再来看一下汇编伪代码:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v15 = <span class="number">0L</span>L;</span><br><span class="line"><span class="keyword">if</span> ( objc_msgSend(v24, <span class="string">&quot;methodReturnLength&quot;</span>) )</span><br><span class="line">  objc_msgSend(v23, <span class="string">&quot;getReturnValue:&quot;</span>, &amp;v15);</span><br><span class="line">v12 = objc_retain(v15);</span><br><span class="line">objc_storeStrong(&amp;v23, <span class="number">0L</span>L);</span><br><span class="line">objc_storeStrong(&amp;v24, <span class="number">0L</span>L);</span><br><span class="line"><span class="keyword">return</span> (id)objc_autoreleaseReturnValue(v12);</span><br></pre></td></tr></table></figure><p>注意此时关于<code>v15/v12</code>的内存管理, 就只剩下了<code>objc_retain(v15)</code>与<code>objc_autoreleaseReturnValue(v12)</code>.</p><p>不说了, 运行很完美.</p><h2 id="一个意外"><a href="#一个意外" class="headerlink" title="一个意外"></a>一个意外</h2><p>从上面的分析可以看的出来, 由于对象在<code>-[NSObject performSelector:withObjects:]</code>中被添加到<code>autoreleasepool</code>导致引用计数不匹配, 但是为什么会在函数解释之后再次调用就立即GG了呢?</p><p>来断点看一下.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(lldb) breakpoint set -n &#39;-[NSObject performSelector:withObjects:]&#39;</span><br><span class="line">Breakpoint 2: where &#x3D; PerformDemo&#96;-[NSObject(test) performSelector:withObjects:] + 46 at NSObject+test.m:15:44, address &#x3D; 0x0000000101e14a0e</span><br><span class="line">(lldb) continue</span><br><span class="line">Process 17773 resuming</span><br><span class="line">(lldb) finish</span><br><span class="line">initABC: 0x6000037ec980</span><br><span class="line">(lldb) next</span><br><span class="line">(lldb) po _teM</span><br><span class="line">&lt;TestModel: 0x6000037ec980&gt;</span><br><span class="line"></span><br><span class="line">(lldb) next</span><br><span class="line">(lldb) next</span><br><span class="line">over</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>有没有注意到<code>over</code>打印出来了,也就是原本崩溃的<code>[_teM performSelector:@selector(setAge:) withObject:@1]</code>执行了…</p><p>那是不是问题解决了呢? 当然不是,<code>continue</code>之后依旧会在<code>main</code>函数报<code>EXC_BAD_ACCESS</code>错误.</p><p>–分割线—</p><p>换个角度, 重写<code>dealloc</code>:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    printf(<span class="string">&quot;model dealloc..\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>删除所有的断点,并仅保留在<code>dealloc</code>的一处断点.得到:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">initABC: 0x600000e68480</span><br><span class="line">(lldb) frame info</span><br><span class="line">frame #0: 0x000000010b3546b0 PerformDemo&#96;-[TestModel dealloc](self&#x3D;0x0000600000e68480, _cmd&#x3D;&quot;dealloc&quot;) at ViewController.m:31:5</span><br><span class="line">(lldb) bt</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; breakpoint 1.1</span><br><span class="line">  * frame #0: 0x000000010b3546b0 PerformDemo&#96;-[TestModel dealloc](self&#x3D;0x0000600000e68480, _cmd&#x3D;&quot;dealloc&quot;) at ViewController.m:31:5</span><br><span class="line">    frame #1: 0x000000010bb7e7f4 libobjc.A.dylib&#96;objc_object::sidetable_release(bool, bool) + 174</span><br><span class="line">    frame #2: 0x000000010b354919 PerformDemo&#96;-[ViewController viewDidLoad](self&#x3D;0x00007ffe74d16a60, _cmd&#x3D;&quot;viewDidLoad&quot;) at ViewController.m:55:5</span><br><span class="line">    ...</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p><img src="/images/2020-10-14-16-58-33.png" alt="不够清晰,看图"></p><p>贴一下相关的伪代码/汇编:</p><details><summary>void __cdecl -[ViewController viewDidLoad](ViewController *self, SEL a2):</summary><pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __cdecl -[ViewController viewDidLoad](ViewController *self, SEL a2)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> *v4; <span class="comment">// ST38_8</span></span><br><span class="line">  <span class="keyword">void</span> *v5; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// ST30_8</span></span><br><span class="line">  <span class="keyword">void</span> *v8; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> *v9; <span class="comment">// rax</span></span><br><span class="line">  __int64 v10; <span class="comment">// ST18_8</span></span><br><span class="line">  <span class="keyword">void</span> *v11; <span class="comment">// [rsp+58h] [rbp-48h]</span></span><br><span class="line">  ViewController *v12; <span class="comment">// [rsp+60h] [rbp-40h]</span></span><br><span class="line">  __objc2_class *v13; <span class="comment">// [rsp+68h] [rbp-38h]</span></span><br><span class="line">  SEL v14; <span class="comment">// [rsp+70h] [rbp-30h]</span></span><br><span class="line">  ViewController *v15; <span class="comment">// [rsp+78h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">const</span> __CFString *v16; <span class="comment">// [rsp+80h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">const</span> __CFString *v17; <span class="comment">// [rsp+88h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">const</span> __CFString *v18; <span class="comment">// [rsp+90h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v15 = self;</span><br><span class="line">  v14 = a2;</span><br><span class="line">  v12 = self;</span><br><span class="line">  v13 = &amp;OBJC_CLASS___ViewController;</span><br><span class="line">  objc_msgSendSuper2(&amp;v12, <span class="string">&quot;viewDidLoad&quot;</span>);</span><br><span class="line">  v2 = NSClassFromString(CFSTR(<span class="string">&quot;TestModel&quot;</span>));</span><br><span class="line">  v3 = objc_alloc(v2);</span><br><span class="line">  v16 = CFSTR(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">  v17 = CFSTR(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">  v18 = CFSTR(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">  v4 = (<span class="keyword">void</span> *)v3;</span><br><span class="line">  v5 = objc_msgSend(&amp;OBJC_CLASS___NSArray, <span class="string">&quot;arrayWithObjects:count:&quot;</span>, &amp;v16, <span class="number">3L</span>L);</span><br><span class="line">  v6 = objc_retainAutoreleasedReturnValue((__int64)v5);</span><br><span class="line">  v7 = v6;</span><br><span class="line">  v8 = objc_msgSend(v4, <span class="string">&quot;performSelector:withObjects:&quot;</span>, <span class="string">&quot;initWithA:b:c:&quot;</span>, v6);</span><br><span class="line">  v11 = (<span class="keyword">void</span> *)objc_retainAutoreleasedReturnValue((__int64)v8);</span><br><span class="line">  objc_release(<span class="number">0L</span>L);</span><br><span class="line">  objc_release(v7);</span><br><span class="line">  objc_release(v4);</span><br><span class="line">  v9 = objc_msgSend(&amp;OBJC_CLASS___NSNumber, <span class="string">&quot;numberWithInt:&quot;</span>, <span class="number">1L</span>L);</span><br><span class="line">  v10 = objc_retainAutoreleasedReturnValue((__int64)v9);</span><br><span class="line">  objc_msgSend(v11, <span class="string">&quot;performSelector:withObject:&quot;</span>, <span class="string">&quot;setAge:&quot;</span>, v10);</span><br><span class="line">  objc_release(v10);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;over\n&quot;</span>);</span><br><span class="line">  objc_storeStrong(&amp;v11, <span class="number">0L</span>L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></pre></details><details><summary><汇编> PerformDemo`-[ViewController viewDidLoad]:</summary><pre><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">PerformDemo</span>`-[ViewController viewDidLoad]:</span><br><span class="line">    <span class="number">0x10b354810</span> &lt;+<span class="number">0</span>&gt;:   pushq  %rbp</span><br><span class="line">    <span class="number">0x10b354811</span> &lt;+<span class="number">1</span>&gt;:   movq   %rsp, %rbp</span><br><span class="line">    <span class="number">0x10b354814</span> &lt;+<span class="number">4</span>&gt;:   subq   <span class="number">$0xa0</span>, %rsp</span><br><span class="line">    <span class="number">0x10b35481b</span> &lt;+<span class="number">11</span>&gt;:  movq   <span class="number">0x27de</span>(%rip), %rax        <span class="comment">; (void *)0x000000010d3ff0b0: __stack_chk_guard</span></span><br><span class="line">    <span class="number">0x10b354822</span> &lt;+<span class="number">18</span>&gt;:  movq   (%rax), %rax</span><br><span class="line">    <span class="number">0x10b354825</span> &lt;+<span class="number">21</span>&gt;:  movq   %rax, -<span class="number">0x8</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b354829</span> &lt;+<span class="number">25</span>&gt;:  movq   %rdi, -<span class="number">0x28</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b35482d</span> &lt;+<span class="number">29</span>&gt;:  movq   %rsi, -<span class="number">0x30</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b354831</span> &lt;+<span class="number">33</span>&gt;:  movq   -<span class="number">0x28</span>(%rbp), %rax</span><br><span class="line">    <span class="number">0x10b354835</span> &lt;+<span class="number">37</span>&gt;:  movq   %rax, -<span class="number">0x40</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b354839</span> &lt;+<span class="number">41</span>&gt;:  movq   <span class="number">0x7e58</span>(%rip), %rax        <span class="comment">; (void *)0x000000010b35c700: ViewController</span></span><br><span class="line">    <span class="number">0x10b354840</span> &lt;+<span class="number">48</span>&gt;:  movq   %rax, -<span class="number">0x38</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b354844</span> &lt;+<span class="number">52</span>&gt;:  movq   <span class="number">0x7d65</span>(%rip), %rsi        <span class="comment">; &quot;viewDidLoad&quot;</span></span><br><span class="line">    <span class="number">0x10b35484b</span> &lt;+<span class="number">59</span>&gt;:  leaq   -<span class="number">0x40</span>(%rbp), %rdi</span><br><span class="line">    <span class="number">0x10b35484f</span> &lt;+<span class="number">63</span>&gt;:  callq  <span class="number">0x10b355210</span>               <span class="comment">; symbol stub for: objc_msgSendSuper2</span></span><br><span class="line">    <span class="number">0x10b354854</span> &lt;+<span class="number">68</span>&gt;:  leaq   <span class="number">0x27cd</span>(%rip), %rax        <span class="comment">; @&quot;TestModel&quot;</span></span><br><span class="line">    <span class="number">0x10b35485b</span> &lt;+<span class="number">75</span>&gt;:  movq   <span class="number">$0x0</span>, -<span class="number">0x48</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b354863</span> &lt;+<span class="number">83</span>&gt;:  movq   %rax, %rdi</span><br><span class="line">    <span class="number">0x10b354866</span> &lt;+<span class="number">86</span>&gt;:  callq  <span class="number">0x10b3551d4</span>               <span class="comment">; symbol stub for: NSClassFromString</span></span><br><span class="line">    <span class="number">0x10b35486b</span> &lt;+<span class="number">91</span>&gt;:  movq   %rax, -<span class="number">0x50</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b35486f</span> &lt;+<span class="number">95</span>&gt;:  movq   -<span class="number">0x50</span>(%rbp), %rdi</span><br><span class="line">    <span class="number">0x10b354873</span> &lt;+<span class="number">99</span>&gt;:  callq  <span class="number">0x10b3551ec</span>               <span class="comment">; symbol stub for: objc_alloc</span></span><br><span class="line">    <span class="number">0x10b354878</span> &lt;+<span class="number">104</span>&gt;: leaq   <span class="number">0x27c9</span>(%rip), %rcx        <span class="comment">; @&quot;&#x27;1&#x27;&quot;</span></span><br><span class="line">    <span class="number">0x10b35487f</span> &lt;+<span class="number">111</span>&gt;: movq   <span class="number">0x7d32</span>(%rip), %rdx        <span class="comment">; &quot;initWithA:b:c:&quot;</span></span><br><span class="line">    <span class="number">0x10b354886</span> &lt;+<span class="number">118</span>&gt;: movq   %rcx, -<span class="number">0x20</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b35488a</span> &lt;+<span class="number">122</span>&gt;: movq   %rcx, -<span class="number">0x18</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b35488e</span> &lt;+<span class="number">126</span>&gt;: movq   %rcx, -<span class="number">0x10</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b354892</span> &lt;+<span class="number">130</span>&gt;: movq   <span class="number">0x7dc7</span>(%rip), %rcx        <span class="comment">; (void *)0x000000010c15e720: NSArray</span></span><br><span class="line">    <span class="number">0x10b354899</span> &lt;+<span class="number">137</span>&gt;: movq   <span class="number">0x7d20</span>(%rip), %rsi        <span class="comment">; &quot;arrayWithObjects:count:&quot;</span></span><br><span class="line">    <span class="number">0x10b3548a0</span> &lt;+<span class="number">144</span>&gt;: leaq   -<span class="number">0x20</span>(%rbp), %rdi</span><br><span class="line">    <span class="number">0x10b3548a4</span> &lt;+<span class="number">148</span>&gt;: movq   %rdi, -<span class="number">0x58</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b3548a8</span> &lt;+<span class="number">152</span>&gt;: movq   %rcx, %rdi</span><br><span class="line">    <span class="number">0x10b3548ab</span> &lt;+<span class="number">155</span>&gt;: movq   -<span class="number">0x58</span>(%rbp), %rcx</span><br><span class="line">    <span class="number">0x10b3548af</span> &lt;+<span class="number">159</span>&gt;: movq   %rdx, -<span class="number">0x60</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b3548b3</span> &lt;+<span class="number">163</span>&gt;: movq   %rcx, %rdx</span><br><span class="line">    <span class="number">0x10b3548b6</span> &lt;+<span class="number">166</span>&gt;: movl   <span class="number">$0x3</span>, %ecx</span><br><span class="line">    <span class="number">0x10b3548bb</span> &lt;+<span class="number">171</span>&gt;: movq   %rax, -<span class="number">0x68</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b3548bf</span> &lt;+<span class="number">175</span>&gt;: callq  *<span class="number">0x2743</span>(%rip)             <span class="comment">; (void *)0x000000010bb62880: objc_msgSend</span></span><br><span class="line">    <span class="number">0x10b3548c5</span> &lt;+<span class="number">181</span>&gt;: movq   %rax, %rdi</span><br><span class="line">    <span class="number">0x10b3548c8</span> &lt;+<span class="number">184</span>&gt;: callq  <span class="number">0x10b355222</span>               <span class="comment">; symbol stub for: objc_retainAutoreleasedReturnValue</span></span><br><span class="line">    <span class="number">0x10b3548cd</span> &lt;+<span class="number">189</span>&gt;: movq   <span class="number">0x7cf4</span>(%rip), %rsi        <span class="comment">; &quot;performSelector:withObjects:&quot;</span></span><br><span class="line">    <span class="number">0x10b3548d4</span> &lt;+<span class="number">196</span>&gt;: movq   -<span class="number">0x68</span>(%rbp), %rdi</span><br><span class="line">    <span class="number">0x10b3548d8</span> &lt;+<span class="number">200</span>&gt;: movq   -<span class="number">0x60</span>(%rbp), %rdx</span><br><span class="line">    <span class="number">0x10b3548dc</span> &lt;+<span class="number">204</span>&gt;: movq   %rax, %rcx</span><br><span class="line">    <span class="number">0x10b3548df</span> &lt;+<span class="number">207</span>&gt;: movq   %rax, -<span class="number">0x70</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b3548e3</span> &lt;+<span class="number">211</span>&gt;: callq  *<span class="number">0x271f</span>(%rip)             <span class="comment">; (void *)0x000000010bb62880: objc_msgSend</span></span><br><span class="line">    <span class="number">0x10b3548e9</span> &lt;+<span class="number">217</span>&gt;: movq   %rax, %rdi</span><br><span class="line">    <span class="number">0x10b3548ec</span> &lt;+<span class="number">220</span>&gt;: callq  <span class="number">0x10b355222</span>               <span class="comment">; symbol stub for: objc_retainAutoreleasedReturnValue</span></span><br><span class="line">    <span class="number">0x10b3548f1</span> &lt;+<span class="number">225</span>&gt;: movq   -<span class="number">0x48</span>(%rbp), %rcx</span><br><span class="line">    <span class="number">0x10b3548f5</span> &lt;+<span class="number">229</span>&gt;: movq   %rax, -<span class="number">0x48</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b3548f9</span> &lt;+<span class="number">233</span>&gt;: movq   %rcx, %rdi</span><br><span class="line">    <span class="number">0x10b3548fc</span> &lt;+<span class="number">236</span>&gt;: callq  *<span class="number">0x270e</span>(%rip)             <span class="comment">; (void *)0x000000010bb7e720: objc_release</span></span><br><span class="line">    <span class="number">0x10b354902</span> &lt;+<span class="number">242</span>&gt;: movq   -<span class="number">0x70</span>(%rbp), %rax</span><br><span class="line">    <span class="number">0x10b354906</span> &lt;+<span class="number">246</span>&gt;: movq   %rax, %rdi</span><br><span class="line">    <span class="number">0x10b354909</span> &lt;+<span class="number">249</span>&gt;: callq  *<span class="number">0x2701</span>(%rip)             <span class="comment">; (void *)0x000000010bb7e720: objc_release</span></span><br><span class="line">    <span class="number">0x10b35490f</span> &lt;+<span class="number">255</span>&gt;: movq   -<span class="number">0x68</span>(%rbp), %rdi</span><br><span class="line">    <span class="number">0x10b354913</span> &lt;+<span class="number">259</span>&gt;: callq  *<span class="number">0x26f7</span>(%rip)             <span class="comment">; (void *)0x000000010bb7e720: objc_release</span></span><br><span class="line">-&gt;  <span class="number">0x10b354919</span> &lt;+<span class="number">265</span>&gt;: movq   -<span class="number">0x48</span>(%rbp), %rax</span><br><span class="line">    <span class="number">0x10b35491d</span> &lt;+<span class="number">269</span>&gt;: movq   <span class="number">0x7cac</span>(%rip), %rdx        <span class="comment">; &quot;setAge:&quot;</span></span><br><span class="line">    <span class="number">0x10b354924</span> &lt;+<span class="number">276</span>&gt;: movq   <span class="number">0x7d3d</span>(%rip), %rcx        <span class="comment">; (void *)0x000000010b91cc68: NSNumber</span></span><br><span class="line">    <span class="number">0x10b35492b</span> &lt;+<span class="number">283</span>&gt;: movq   <span class="number">0x7ca6</span>(%rip), %rsi        <span class="comment">; &quot;numberWithInt:&quot;</span></span><br><span class="line">    <span class="number">0x10b354932</span> &lt;+<span class="number">290</span>&gt;: movq   %rcx, %rdi</span><br><span class="line">    <span class="number">0x10b354935</span> &lt;+<span class="number">293</span>&gt;: movl   <span class="number">$0x1</span>, %r8d</span><br><span class="line">    <span class="number">0x10b35493b</span> &lt;+<span class="number">299</span>&gt;: movq   %rdx, -<span class="number">0x78</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b35493f</span> &lt;+<span class="number">303</span>&gt;: movl   %r8d, %edx</span><br><span class="line">    <span class="number">0x10b354942</span> &lt;+<span class="number">306</span>&gt;: movq   %rax, -<span class="number">0x80</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b354946</span> &lt;+<span class="number">310</span>&gt;: callq  *<span class="number">0x26bc</span>(%rip)             <span class="comment">; (void *)0x000000010bb62880: objc_msgSend</span></span><br><span class="line">    <span class="number">0x10b35494c</span> &lt;+<span class="number">316</span>&gt;: movq   %rax, %rdi</span><br><span class="line">    <span class="number">0x10b35494f</span> &lt;+<span class="number">319</span>&gt;: callq  <span class="number">0x10b355222</span>               <span class="comment">; symbol stub for: objc_retainAutoreleasedReturnValue</span></span><br><span class="line">    <span class="number">0x10b354954</span> &lt;+<span class="number">324</span>&gt;: movq   %rax, %rcx</span><br><span class="line">    <span class="number">0x10b354957</span> &lt;+<span class="number">327</span>&gt;: movq   <span class="number">0x7c82</span>(%rip), %rsi        <span class="comment">; &quot;performSelector:withObject:&quot;</span></span><br><span class="line">    <span class="number">0x10b35495e</span> &lt;+<span class="number">334</span>&gt;: movq   -<span class="number">0x80</span>(%rbp), %rdi</span><br><span class="line">    <span class="number">0x10b354962</span> &lt;+<span class="number">338</span>&gt;: movq   -<span class="number">0x78</span>(%rbp), %rdx</span><br><span class="line">    <span class="number">0x10b354966</span> &lt;+<span class="number">342</span>&gt;: movq   %rax, -<span class="number">0x88</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b35496d</span> &lt;+<span class="number">349</span>&gt;: callq  *<span class="number">0x2695</span>(%rip)             <span class="comment">; (void *)0x000000010bb62880: objc_msgSend</span></span><br><span class="line">    <span class="number">0x10b354973</span> &lt;+<span class="number">355</span>&gt;: movq   -<span class="number">0x88</span>(%rbp), %rcx</span><br><span class="line">    <span class="number">0x10b35497a</span> &lt;+<span class="number">362</span>&gt;: movq   %rcx, %rdi</span><br><span class="line">    <span class="number">0x10b35497d</span> &lt;+<span class="number">365</span>&gt;: movq   %rax, -<span class="number">0x90</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b354984</span> &lt;+<span class="number">372</span>&gt;: callq  *<span class="number">0x2686</span>(%rip)             <span class="comment">; (void *)0x000000010bb7e720: objc_release</span></span><br><span class="line">    <span class="number">0x10b35498a</span> &lt;+<span class="number">378</span>&gt;: leaq   <span class="number">0x185a</span>(%rip), %rdi        <span class="comment">; &quot;over\n&quot;</span></span><br><span class="line">    <span class="number">0x10b354991</span> &lt;+<span class="number">385</span>&gt;: movb   <span class="number">$0x0</span>, %al</span><br><span class="line">    <span class="number">0x10b354993</span> &lt;+<span class="number">387</span>&gt;: callq  <span class="number">0x10b355234</span>               <span class="comment">; symbol stub for: printf</span></span><br><span class="line">    <span class="number">0x10b354998</span> &lt;+<span class="number">392</span>&gt;: xorl   %r8d, %r8d</span><br><span class="line">    <span class="number">0x10b35499b</span> &lt;+<span class="number">395</span>&gt;: movl   %r8d, %esi</span><br><span class="line">    <span class="number">0x10b35499e</span> &lt;+<span class="number">398</span>&gt;: leaq   -<span class="number">0x48</span>(%rbp), %rcx</span><br><span class="line">    <span class="number">0x10b3549a2</span> &lt;+<span class="number">402</span>&gt;: movq   %rcx, %rdi</span><br><span class="line">    <span class="number">0x10b3549a5</span> &lt;+<span class="number">405</span>&gt;: movl   %eax, -<span class="number">0x94</span>(%rbp)</span><br><span class="line">    <span class="number">0x10b3549ab</span> &lt;+<span class="number">411</span>&gt;: callq  <span class="number">0x10b355228</span>               <span class="comment">; symbol stub for: objc_storeStrong</span></span><br><span class="line">    <span class="number">0x10b3549b0</span> &lt;+<span class="number">416</span>&gt;: movq   <span class="number">0x2649</span>(%rip), %rcx        <span class="comment">; (void *)0x000000010d3ff0b0: __stack_chk_guard</span></span><br><span class="line">    <span class="number">0x10b3549b7</span> &lt;+<span class="number">423</span>&gt;: movq   (%rcx), %rcx</span><br><span class="line">    <span class="number">0x10b3549ba</span> &lt;+<span class="number">426</span>&gt;: movq   -<span class="number">0x8</span>(%rbp), %rdx</span><br><span class="line">    <span class="number">0x10b3549be</span> &lt;+<span class="number">430</span>&gt;: cmpq   %rdx, %rcx</span><br><span class="line">    <span class="number">0x10b3549c1</span> &lt;+<span class="number">433</span>&gt;: jne    <span class="number">0x10b3549d0</span>               <span class="comment">; &lt;+448&gt; at ViewController.m</span></span><br><span class="line">    <span class="number">0x10b3549c7</span> &lt;+<span class="number">439</span>&gt;: addq   <span class="number">$0xa0</span>, %rsp</span><br><span class="line">    <span class="number">0x10b3549ce</span> &lt;+<span class="number">446</span>&gt;: popq   %rbp</span><br><span class="line">    <span class="number">0x10b3549cf</span> &lt;+<span class="number">447</span>&gt;: retq</span><br><span class="line">    <span class="number">0x10b3549d0</span> &lt;+<span class="number">448</span>&gt;: callq  <span class="number">0x10b3551e6</span>               <span class="comment">; symbol stub for: __stack_chk_fail</span></span><br><span class="line">    <span class="number">0x10b3549d5</span> &lt;+<span class="number">453</span>&gt;: ud2</span><br></pre></td></tr></table></figure></pre></details><details><summary><汇编>libobjc.A.dylib`objc_object::sidetable_release:</summary><pre><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">libobjc.A.dylib</span>`objc_object::sidetable_release:</span><br><span class="line">    <span class="number">0x10bb7e746</span> &lt;+<span class="number">0</span>&gt;:   pushq  %rbp</span><br><span class="line">    <span class="number">0x10bb7e747</span> &lt;+<span class="number">1</span>&gt;:   movq   %rsp, %rbp</span><br><span class="line">    <span class="number">0x10bb7e74a</span> &lt;+<span class="number">4</span>&gt;:   pushq  %<span class="built_in">r15</span></span><br><span class="line">    <span class="number">0x10bb7e74c</span> &lt;+<span class="number">6</span>&gt;:   pushq  %<span class="built_in">r14</span></span><br><span class="line">    <span class="number">0x10bb7e74e</span> &lt;+<span class="number">8</span>&gt;:   pushq  %<span class="built_in">r13</span></span><br><span class="line">    <span class="number">0x10bb7e750</span> &lt;+<span class="number">10</span>&gt;:  pushq  %<span class="built_in">r12</span></span><br><span class="line">    <span class="number">0x10bb7e752</span> &lt;+<span class="number">12</span>&gt;:  pushq  %rbx</span><br><span class="line">    <span class="number">0x10bb7e753</span> &lt;+<span class="number">13</span>&gt;:  subq   <span class="number">$0x28</span>, %rsp</span><br><span class="line">    <span class="number">0x10bb7e757</span> &lt;+<span class="number">17</span>&gt;:  movl   %esi, %r14d</span><br><span class="line">    <span class="number">0x10bb7e75a</span> &lt;+<span class="number">20</span>&gt;:  movq   %rdi, %<span class="built_in">r13</span></span><br><span class="line">    <span class="number">0x10bb7e75d</span> &lt;+<span class="number">23</span>&gt;:  movl   %r13d, %eax</span><br><span class="line">    <span class="number">0x10bb7e760</span> &lt;+<span class="number">26</span>&gt;:  shrl   <span class="number">$0x9</span>, %eax</span><br><span class="line">    <span class="number">0x10bb7e763</span> &lt;+<span class="number">29</span>&gt;:  movl   %r13d, %ebx</span><br><span class="line">    <span class="number">0x10bb7e766</span> &lt;+<span class="number">32</span>&gt;:  shrl   <span class="number">$0x4</span>, %ebx</span><br><span class="line">    <span class="number">0x10bb7e769</span> &lt;+<span class="number">35</span>&gt;:  xorl   %eax, %ebx</span><br><span class="line">    <span class="number">0x10bb7e76b</span> &lt;+<span class="number">37</span>&gt;:  andl   <span class="number">$0x3f</span>, %ebx</span><br><span class="line">    <span class="number">0x10bb7e76e</span> &lt;+<span class="number">40</span>&gt;:  shlq   <span class="number">$0x6</span>, %rbx</span><br><span class="line">    <span class="number">0x10bb7e772</span> &lt;+<span class="number">44</span>&gt;:  leaq   <span class="number">0x1bac7</span>(%rip), %<span class="built_in">r12</span>       <span class="comment">; (anonymous namespace)::SideTablesMap</span></span><br><span class="line">    <span class="number">0x10bb7e779</span> &lt;+<span class="number">51</span>&gt;:  leaq   (%<span class="built_in">r12</span>,%rbx), %<span class="built_in">r15</span></span><br><span class="line">    <span class="number">0x10bb7e77d</span> &lt;+<span class="number">55</span>&gt;:  movq   %<span class="built_in">r15</span>, %rdi</span><br><span class="line">    <span class="number">0x10bb7e780</span> &lt;+<span class="number">58</span>&gt;:  movl   <span class="number">$0x50000</span>, %esi            <span class="comment">; imm = 0x50000</span></span><br><span class="line">    <span class="number">0x10bb7e785</span> &lt;+<span class="number">63</span>&gt;:  callq  <span class="number">0x10bb822d0</span>               <span class="comment">; symbol stub for: os_unfair_lock_lock_with_options</span></span><br><span class="line">    <span class="number">0x10bb7e78a</span> &lt;+<span class="number">68</span>&gt;:  leaq   <span class="number">0x8</span>(%rbx,%<span class="built_in">r12</span>), %rsi</span><br><span class="line">    <span class="number">0x10bb7e78f</span> &lt;+<span class="number">73</span>&gt;:  movq   %<span class="built_in">r13</span>, %rax</span><br><span class="line">    <span class="number">0x10bb7e792</span> &lt;+<span class="number">76</span>&gt;:  negq   %rax</span><br><span class="line">    <span class="number">0x10bb7e795</span> &lt;+<span class="number">79</span>&gt;:  leaq   -<span class="number">0x38</span>(%rbp), %rdx</span><br><span class="line">    <span class="number">0x10bb7e799</span> &lt;+<span class="number">83</span>&gt;:  movq   %rax, (%rdx)</span><br><span class="line">    <span class="number">0x10bb7e79c</span> &lt;+<span class="number">86</span>&gt;:  leaq   -<span class="number">0x30</span>(%rbp), %rcx</span><br><span class="line">    <span class="number">0x10bb7e7a0</span> &lt;+<span class="number">90</span>&gt;:  movq   <span class="number">$0x2</span>, (%rcx)</span><br><span class="line">    <span class="number">0x10bb7e7a7</span> &lt;+<span class="number">97</span>&gt;:  leaq   -<span class="number">0x50</span>(%rbp), %<span class="built_in">r12</span></span><br><span class="line">    <span class="number">0x10bb7e7ab</span> &lt;+<span class="number">101</span>&gt;: movq   %<span class="built_in">r12</span>, %rdi</span><br><span class="line">    <span class="number">0x10bb7e7ae</span> &lt;+<span class="number">104</span>&gt;: callq  <span class="number">0x10bb7e820</span>               <span class="comment">; std::__1::pair&lt;objc::DenseMapIterator&lt;DisguisedPtr&lt;objc_object&gt;, unsigned long, (anonymous namespace)::RefcountMapValuePurgeable, objc::DenseMapInfo&lt;DisguisedPtr&lt;objc_object&gt; &gt;, objc::detail::DenseMapPair&lt;DisguisedPtr&lt;objc_object&gt;, unsigned long&gt;, false&gt;, bool&gt; objc::DenseMapBase&lt;objc::DenseMap&lt;DisguisedPtr&lt;objc_object&gt;, unsigned long, (anonymous namespace)::RefcountMapValuePurgeable, objc::DenseMapInfo&lt;DisguisedPtr&lt;objc_object&gt; &gt;, objc::detail::DenseMapPair&lt;DisguisedPtr&lt;objc_object&gt;, unsigned long&gt; &gt;, DisguisedPtr&lt;objc_object&gt;, unsigned long, (anonymous namespace)::RefcountMapValuePurgeable, objc::DenseMapInfo&lt;DisguisedPtr&lt;objc_object&gt; &gt;, objc::detail::DenseMapPair&lt;DisguisedPtr&lt;objc_object&gt;, unsigned long&gt; &gt;::try_emplace&lt;unsigned long&gt;(DisguisedPtr&lt;objc_object&gt;&amp;&amp;, unsigned long&amp;&amp;)</span></span><br><span class="line">    <span class="number">0x10bb7e7b3</span> &lt;+<span class="number">109</span>&gt;: cmpb   <span class="number">$0x0</span>, <span class="number">0x10</span>(%<span class="built_in">r12</span>)</span><br><span class="line">    <span class="number">0x10bb7e7b9</span> &lt;+<span class="number">115</span>&gt;: jne    <span class="number">0x10bb7e7d1</span>               <span class="comment">; &lt;+139&gt;</span></span><br><span class="line">    <span class="number">0x10bb7e7bb</span> &lt;+<span class="number">117</span>&gt;: movq   -<span class="number">0x50</span>(%rbp), %rax</span><br><span class="line">    <span class="number">0x10bb7e7bf</span> &lt;+<span class="number">121</span>&gt;: movq   <span class="number">0x8</span>(%rax), %rcx</span><br><span class="line">    <span class="number">0x10bb7e7c3</span> &lt;+<span class="number">125</span>&gt;: cmpq   <span class="number">$0x1</span>, %rcx</span><br><span class="line">    <span class="number">0x10bb7e7c7</span> &lt;+<span class="number">129</span>&gt;: ja     <span class="number">0x10bb7e7f6</span>               <span class="comment">; &lt;+176&gt;</span></span><br><span class="line">    <span class="number">0x10bb7e7c9</span> &lt;+<span class="number">131</span>&gt;: orq    <span class="number">$0x2</span>, %rcx</span><br><span class="line">    <span class="number">0x10bb7e7cd</span> &lt;+<span class="number">135</span>&gt;: movq   %rcx, <span class="number">0x8</span>(%rax)</span><br><span class="line">    <span class="number">0x10bb7e7d1</span> &lt;+<span class="number">139</span>&gt;: movq   %<span class="built_in">r15</span>, %rdi</span><br><span class="line">    <span class="number">0x10bb7e7d4</span> &lt;+<span class="number">142</span>&gt;: callq  <span class="number">0x10bb822d6</span>               <span class="comment">; symbol stub for: os_unfair_lock_unlock</span></span><br><span class="line">    <span class="number">0x10bb7e7d9</span> &lt;+<span class="number">147</span>&gt;: movl   <span class="number">$0x1</span>, %r15d</span><br><span class="line">    <span class="number">0x10bb7e7df</span> &lt;+<span class="number">153</span>&gt;: testb  %r14b, %r14b</span><br><span class="line">    <span class="number">0x10bb7e7e2</span> &lt;+<span class="number">156</span>&gt;: je     <span class="number">0x10bb7e80e</span>               <span class="comment">; &lt;+200&gt;</span></span><br><span class="line">    <span class="number">0x10bb7e7e4</span> &lt;+<span class="number">158</span>&gt;: movq   <span class="number">0x169bd</span>(%rip), %rsi       <span class="comment">; &quot;dealloc&quot;</span></span><br><span class="line">    <span class="number">0x10bb7e7eb</span> &lt;+<span class="number">165</span>&gt;: movq   %<span class="built_in">r13</span>, %rdi</span><br><span class="line">    <span class="number">0x10bb7e7ee</span> &lt;+<span class="number">168</span>&gt;: callq  *<span class="number">0x1486c</span>(%rip)            <span class="comment">; (void *)0x000000010bb62880: objc_msgSend</span></span><br><span class="line">-&gt;  <span class="number">0x10bb7e7f4</span> &lt;+<span class="number">174</span>&gt;: jmp    <span class="number">0x10bb7e80e</span>               <span class="comment">; &lt;+200&gt;</span></span><br><span class="line">    <span class="number">0x10bb7e7f6</span> &lt;+<span class="number">176</span>&gt;: testq  %rcx, %rcx</span><br><span class="line">    <span class="number">0x10bb7e7f9</span> &lt;+<span class="number">179</span>&gt;: js     <span class="number">0x10bb7e803</span>               <span class="comment">; &lt;+189&gt;</span></span><br><span class="line">    <span class="number">0x10bb7e7fb</span> &lt;+<span class="number">181</span>&gt;: addq   $-<span class="number">0x4</span>, %rcx</span><br><span class="line">    <span class="number">0x10bb7e7ff</span> &lt;+<span class="number">185</span>&gt;: movq   %rcx, <span class="number">0x8</span>(%rax)</span><br><span class="line">    <span class="number">0x10bb7e803</span> &lt;+<span class="number">189</span>&gt;: movq   %<span class="built_in">r15</span>, %rdi</span><br><span class="line">    <span class="number">0x10bb7e806</span> &lt;+<span class="number">192</span>&gt;: callq  <span class="number">0x10bb822d6</span>               <span class="comment">; symbol stub for: os_unfair_lock_unlock</span></span><br><span class="line">    <span class="number">0x10bb7e80b</span> &lt;+<span class="number">197</span>&gt;: xorl   %r15d, %r15d</span><br><span class="line">    <span class="number">0x10bb7e80e</span> &lt;+<span class="number">200</span>&gt;: movq   %<span class="built_in">r15</span>, %rax</span><br><span class="line">    <span class="number">0x10bb7e811</span> &lt;+<span class="number">203</span>&gt;: addq   <span class="number">$0x28</span>, %rsp</span><br><span class="line">    <span class="number">0x10bb7e815</span> &lt;+<span class="number">207</span>&gt;: popq   %rbx</span><br><span class="line">    <span class="number">0x10bb7e816</span> &lt;+<span class="number">208</span>&gt;: popq   %<span class="built_in">r12</span></span><br><span class="line">    <span class="number">0x10bb7e818</span> &lt;+<span class="number">210</span>&gt;: popq   %<span class="built_in">r13</span></span><br><span class="line">    <span class="number">0x10bb7e81a</span> &lt;+<span class="number">212</span>&gt;: popq   %<span class="built_in">r14</span></span><br><span class="line">    <span class="number">0x10bb7e81c</span> &lt;+<span class="number">214</span>&gt;: popq   %<span class="built_in">r15</span></span><br><span class="line">    <span class="number">0x10bb7e81e</span> &lt;+<span class="number">216</span>&gt;: popq   %rbp</span><br><span class="line">    <span class="number">0x10bb7e81f</span> &lt;+<span class="number">217</span>&gt;: retq</span><br></pre></td></tr></table></figure></pre></details><p>很扎心, 用LLDB运行的结果和实际的并不一样的事情我并不能确定原因.</p><p>不过, 我还是上传了源码: <a href="https://github.com/madordie/PerformDemo">madordie/PerformDemo</a></p><p>希望能找到答案~ 😭</p><p>纯猜一下:</p><p>关于LLDB曾经有过这么一段讨论:</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">It seems that the retain count of the object increases 1 whenever you execute `expression object`. Another workaround is to use frame variable<br><br>(lldb) frame variable object <a href="https://t.co/Y2ghQ3sHzL">pic.twitter.com/Y2ghQ3sHzL</a></p>&mdash; Pofat (@PofatTseng) <a href="https://twitter.com/PofatTseng/status/1057644037107118080?ref_src=twsrc%5Etfw">October 31, 2018</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>会不会和<code>Debug Area</code>有关系?</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;抛出问题&quot;&gt;&lt;a href=&quot;#抛出问题&quot; class=&quot;headerlink&quot; title=&quot;抛出问题&quot;&gt;&lt;/a&gt;抛出问题&lt;/h2&gt;&lt;p&gt;群友(@闲人)贴了这么一个&lt;strong&gt;会崩溃&lt;/strong&gt;的代码:&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@implementation&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;NSObject&lt;/span&gt; (&lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)performSelector:(SEL)aSelector withObjects:(&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)objects &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMethodSignature&lt;/span&gt; *methodSignature = [[&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt;] instanceMethodSignatureForSelector:aSelector];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSInvocation&lt;/span&gt; *invocation = [&lt;span class=&quot;built_in&quot;&gt;NSInvocation&lt;/span&gt; invocationWithMethodSignature:methodSignature];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [invocation invoke];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//返回值处理&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; callBackObject = &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(methodSignature.methodReturnLength) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [invocation getReturnValue:&amp;amp;callBackObject];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; callBackObject;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@interface&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;TestModel&lt;/span&gt;: &lt;span class=&quot;title&quot;&gt;NSObject&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@property&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;nonatomic&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;strong&lt;/span&gt;) &lt;span class=&quot;built_in&quot;&gt;NSNumber&lt;/span&gt; *age;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@implementation&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;TestModel&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;instancetype&lt;/span&gt;)initWithA:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)a b:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)b c:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)c &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; = [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; init]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        printf(&lt;span class=&quot;string&quot;&gt;&amp;quot;initABC\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@implementation&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ViewController&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)viewDidLoad &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; viewDidLoad];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    TestModel *_teM;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Class &lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; = &lt;span class=&quot;built_in&quot;&gt;NSClassFromString&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&amp;quot;TestModel&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _teM = [[&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; alloc] performSelector:&lt;span class=&quot;keyword&quot;&gt;@selector&lt;/span&gt;(initWithA:b:c:) withObjects:@[&lt;span class=&quot;string&quot;&gt;@&amp;quot;1&amp;quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;@&amp;quot;1&amp;quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;@&amp;quot;1&amp;quot;&lt;/span&gt;]];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [_teM performSelector:&lt;span class=&quot;keyword&quot;&gt;@selector&lt;/span&gt;(setAge:) withObject:@&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]; &lt;span class=&quot;comment&quot;&gt;/*  &amp;lt;- EXC_BAD_ACCESS  */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    printf(&lt;span class=&quot;string&quot;&gt;&amp;quot;over\n&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@end&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;对,段错误,代码挂在了&lt;code&gt;[_teM performSelector:@selector(setAge:) withObject:@1]&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="DEBUG" scheme="https://madordie.github.io/tags/DEBUG/"/>
    
      <category term="__bridge*" scheme="https://madordie.github.io/tags/bridge/"/>
    
  </entry>
  
  <entry>
    <title>如何快速查找ipa内的符号引用</title>
    <link href="https://madordie.github.io/post/how-to-quickly-find-symbol-references-in-ipa/"/>
    <id>https://madordie.github.io/post/how-to-quickly-find-symbol-references-in-ipa/</id>
    <published>2020-07-21T16:00:00.000Z</published>
    <updated>2020-07-22T03:42:22.381Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote><p>ITMS-90809: Deprecated API Usage - Apple will stop accepting submissions of apps that use UIWebView APIs . See <a href="https://developer.apple.com/documentation/uikit/uiwebview">https://developer.apple.com/documentation/uikit/uiwebview</a> for more information.</p></blockquote><p>熟悉不?</p><a id="more"></a><h2 id="源码级别引用"><a href="#源码级别引用" class="headerlink" title="源码级别引用"></a>源码级别引用</h2><p>有些时候, 我们需要查找我们的<code>.ipa</code>里面什么地方使用了某个API, 而常规操作是在Xcode的<code>Navigation -&gt; Find</code>里面直接search一下就可以查到源码上哪些地方直接调用了该API.</p><p>而往往这种情况下可以解决问题的话就不会跑去<code>Google</code>了.</p><h2 id="二进制级别引用"><a href="#二进制级别引用" class="headerlink" title="二进制级别引用"></a>二进制级别引用</h2><p>APP总会通过各种手段集成些别人的第三方库, 而此库究竟干了什么我们一般并不能十分了解(如果能了解大概人家就开源了吧). 这个时候要如何查找这些库有没有使用某API该咋办呢?</p><h3 id="定位究竟有谁在包含"><a href="#定位究竟有谁在包含" class="headerlink" title="定位究竟有谁在包含"></a>定位究竟有谁在包含</h3><p>我们提交<code>App Store</code>都是打包成<code>.ipa</code>提交,所以我们先将<code>.ipa</code>重命名<code>.zip</code>并解压. 然后假设我们需要找的是<code>UIWebView</code>, <code>Terminal</code>搞开,到解压后的目录.</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">╭─Bingo@madordie xxx.app</span><br><span class="line">╰─&gt;$ find . -print0 | xargs -0 grep -s <span class="string">&#x27;UIWebView&#x27;</span></span><br></pre></td></tr></table></figure><p>便得到<code>xxx.app</code>内所有包含<code>UIWebView</code>字符的文件(包括Mach-O). 这个时候输出的行<code>Binary file ./XXXX/YYYY matches</code>即为匹配到了.</p><p>此时定位到<code>XXXX/YYYY</code>内含有<code>UIWebView</code>.</p><p>另外: 上述命令在项目主目录执行也可以搜索到, 只不过除了<code>Navigation -&gt; Find</code>里search的还有其他的, 内容如果多的话可以再用<code>grep</code>过滤一次.</p><p>比如只关心<code>Binary file</code>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">╭─Bingo@madordie project-main-path</span><br><span class="line">╰─&gt;$ find . -print0 | xargs -0 grep -s <span class="string">&#x27;UIWebView&#x27;</span> | grep <span class="string">&#x27;^Binary&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="这个API在Mach-O中是什么"><a href="#这个API在Mach-O中是什么" class="headerlink" title="这个API在Mach-O中是什么"></a>这个API在Mach-O中是什么</h3><h4 id="有字符串吗"><a href="#有字符串吗" class="headerlink" title="有字符串吗"></a>有字符串吗</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">╭─Bingo@madordie xxx.app</span><br><span class="line">╰─&gt;$ strings ./XXXX/YYYY | grep <span class="string">&#x27;UIWebView&#x27;</span></span><br><span class="line">T@<span class="string">&quot;UIWebView&quot;</span>,R,N,V_webView</span><br><span class="line">UIWebViewDelegate</span><br><span class="line">B40@0:8@<span class="string">&quot;UIWebView&quot;</span>16@<span class="string">&quot;NSURLRequest&quot;</span>24q32</span><br><span class="line">v24@0:8@<span class="string">&quot;UIWebView&quot;</span>16</span><br><span class="line">v32@0:8@<span class="string">&quot;UIWebView&quot;</span>16@<span class="string">&quot;NSError&quot;</span>24</span><br><span class="line">@<span class="string">&quot;UIWebView&quot;</span></span><br></pre></td></tr></table></figure><h4 id="有symbol吗"><a href="#有symbol吗" class="headerlink" title="有symbol吗"></a>有symbol吗</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">╭─Bingo@madordie xxx.app</span><br><span class="line">╰─&gt;$ nm ./XXXX/YYYY | grep <span class="string">&#x27;UIWebView&#x27;</span></span><br><span class="line">                 U _OBJC_CLASS_<span class="variable">$_UIWebView</span></span><br></pre></td></tr></table></figure><h3 id="值得说一下"><a href="#值得说一下" class="headerlink" title="值得说一下"></a>值得说一下</h3><p>通过上面的操作基本上可以检索出来App Store查到的API, 但是说其他的字符串拼接/加密的方案去绕过的话,那么就问问作者吧…</p><p>真不行使用逆向分析工具去分析也可以. 但是个人觉得稍微有点大材小用 :)</p><p>上面使用的命令的文档均可通过<code>man xxx</code>、<code>xxx --help</code>、Google等方式查询就不啰嗦了.</p><h3 id="UIWebView的废弃通告"><a href="#UIWebView的废弃通告" class="headerlink" title="UIWebView的废弃通告"></a>UIWebView的废弃通告</h3><p><a href="https://developer.apple.com/cn/news/?id=12232019b">更新使用网页视图的 App</a></p><blockquote><p>更新使用网页视图的 App<br>2019 年 12 月 23 日</p><p>如果您的 app 仍在使用已弃用的 UIWebView API 嵌入网络内容，我们强烈建议您尽快更新为 WKWebView 以提升安全性和稳定性。WKWebView 可将网页处理限制在 app 的网页视图中，从而确保不安全的网站内容不会影响到 app 的其他部分。此外，iOS、macOS 和 Mac Catalyst 均支持 WKWebView。</p><p>2020 年 4 月起 App Store 将不再接受使用 UIWebView 的新 app，2020 年 12 月起将不再接受使用 UIWebView 的 app 更新。</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ITMS-90809: Deprecated API Usage - Apple will stop accepting submissions of apps that use UIWebView APIs . See &lt;a href=&quot;https://developer.apple.com/documentation/uikit/uiwebview&quot;&gt;https://developer.apple.com/documentation/uikit/uiwebview&lt;/a&gt; for more information.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;熟悉不?&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
      <category term="macOS" scheme="https://madordie.github.io/categories/iOS/macOS/"/>
    
    
      <category term="DEBUG" scheme="https://madordie.github.io/tags/DEBUG/"/>
    
      <category term="tool" scheme="https://madordie.github.io/tags/tool/"/>
    
  </entry>
  
  <entry>
    <title>class的class-static-func使用Self作为返回值</title>
    <link href="https://madordie.github.io/post/class-static-func-return-self/"/>
    <id>https://madordie.github.io/post/class-static-func-return-self/</id>
    <published>2020-05-17T16:00:00.000Z</published>
    <updated>2020-05-18T06:59:35.356Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="一个问题"><a href="#一个问题" class="headerlink" title="一个问题"></a>一个问题</h1><ul><li>Xcode: Version 11.4.1 (11E503a)</li><li>swift: Swift 5</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MDButton</span>: <span class="title">UIButton</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 为了更清楚展示问题,代码经过精简</span></span><br><span class="line">    <span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">make</span>() -&gt; <span class="title">Self</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">MDButton</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码无法编译:</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ViewController.swift: error: cannot convert return expression of type &#x27;MDButton&#x27; to return type &#x27;Self&#x27;</span><br><span class="line">        return MDButton()</span><br><span class="line">               ^~~~~~~~~~</span><br><span class="line">                          as! Self</span><br></pre></td></tr></table></figure><a id="more"></a><h1 id="查找关于Self的新特性"><a href="#查找关于Self的新特性" class="headerlink" title="查找关于Self的新特性"></a>查找关于<code>Self</code>的新特性</h1><p><a href="https://github.com/apple/swift-evolution/blob/master/proposals/0068-universal-self.md">Proposal: SE-0068</a>这里有说到关于这个<code>Self</code>的问题.</p><p>其目的是为了解决:</p><blockquote><ul><li><code>dynamicType</code> remains an exception to Swift’s lowercased keywords rule. This change eliminates a special case that’s out of step with Swift’s new standards.</li><li><code>Self</code> is shorter and clearer in its intent. It mirrors <code>self</code>, which refers to the current instance.</li><li>It provides an easier way to access static members. As type names grow large, readability suffers. <code>MyExtremelyLargeTypeName.staticMember</code> is unwieldy to type and read.</li><li>Code using hardwired type names is less portable than code that automatically knows its type.</li><li>Renaming a type means updating any <code>TypeName</code> references in code.</li><li>Using <code>self.dynamicType</code> fights against Swift’s goals of concision and clarity in that it is both noisy and esoteric.</li></ul></blockquote><p>所以说该问题在<code>struct</code>中并不存在,也就是下面的代码完全没有问题:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xxx</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">make</span><span class="params">()</span></span> -&gt; <span class="type">Self</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> xxx()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="究竟如何修改"><a href="#究竟如何修改" class="headerlink" title="究竟如何修改"></a>究竟如何修改</h1><p>好吧,上面测试过这几个关键字之后,尝试修改函数内的返回对象吧.此时既然<code>Self</code>是<code>dynamicType</code>,那么可以使用<code>self</code>去调用初始化方法就行了吧, 于是:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MDButton2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">     <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">make</span>() -&gt; <span class="title">Self</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 或 return self.init()</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">Self</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="一点看法"><a href="#一点看法" class="headerlink" title="一点看法"></a>一点看法</h1><p>首先, 整个过程(包括Xcode的提示)不使用<code>as!</code>的解决方案, 对,我就是那个坚决不使用<code>as!</code>的人(刷题除外).</p><p>然后, 可以翻一下这个<code>Self</code>的实现<a href="https://github.com/apple/swift/pull/22863">apple/swift#22863</a>,内容比较多.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;一个问题&quot;&gt;&lt;a href=&quot;#一个问题&quot; class=&quot;headerlink&quot; title=&quot;一个问题&quot;&gt;&lt;/a&gt;一个问题&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Xcode: Version 11.4.1 (11E503a)&lt;/li&gt;
&lt;li&gt;swift: Swift 5&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight swift&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; UIKit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MDButton&lt;/span&gt;: &lt;span class=&quot;title&quot;&gt;UIButton&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 为了更清楚展示问题,代码经过精简&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;open&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;make&lt;/span&gt;() -&amp;gt; &lt;span class=&quot;title&quot;&gt;Self&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;MDButton&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;上面的代码无法编译:&lt;/p&gt;
&lt;figure class=&quot;highlight txt&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ViewController.swift: error: cannot convert return expression of type &amp;#x27;MDButton&amp;#x27; to return type &amp;#x27;Self&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        return MDButton()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               ^~~~~~~~~~&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          as! Self&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="DEBUG" scheme="https://madordie.github.io/tags/DEBUG/"/>
    
      <category term="Swift" scheme="https://madordie.github.io/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu使用SakuraFrp实现内网穿透</title>
    <link href="https://madordie.github.io/post/ubuntu-sakura-frp/"/>
    <id>https://madordie.github.io/post/ubuntu-sakura-frp/</id>
    <published>2019-07-08T16:00:00.000Z</published>
    <updated>2019-08-29T10:24:09.319Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>记录将一台吃灰的笔记本改装成服务器，并暴露在公网下的过程。</p><a id="more"></a><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><ul><li>一个 ubuntu-18.04.2-desktop-amd64.iso</li><li>一台陈旧的Gateway笔记本</li><li>一台主战MBP</li></ul><p>iso: 如果从<a href="https://ubuntu.com/download/desktop">官网</a>下载速度比较慢，可以考虑上<code>wget</code>、迅雷。我这里使用了<code>wget</code>并且使用了<a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cdimage/ubuntu/releases/">清华的镜像</a></p><p>Gateway: 还是个win10，于是乎顺手就把<code>ubuntu-18.04.2-desktop-amd64.iso</code>制作成了U盘，此处我就不说了，反正能引导进去就行啊哈哈哈</p><p>MBP: 主要工作在这里。比如远程win桌面用的是<a href="https://apps.apple.com/us/app/microsoft-remote-desktop/id1295203466?mt=12">Microsoft Remote Desktop</a></p><h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><p>注意，Ubuntu会将硬盘 <strong>所有分区全部格式化</strong> ，请先妥善备份。</p><p>经过安装提示以及笔记本的疯狂发热很快就安装完事了。</p><h2 id="设置Ubuntu软件源"><a href="#设置Ubuntu软件源" class="headerlink" title="设置Ubuntu软件源"></a>设置Ubuntu软件源</h2><p>这里还是用清华大学的镜像，其<a href="https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/">Ubuntu 镜像使用帮助</a>也是相当的详细：</p><blockquote><p>Ubuntu 的软件源配置文件是 /etc/apt/sources.list。将系统自带的该文件做个备份，将该文件替换为下面内容，即可使用 TUNA 的软件源镜像。</p><p>选择你的ubuntu版本: 18.04 LTS</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-updates main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-backports main restricted universe multiverse</span><br><span class="line">deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"># 预发布软件源，不建议启用</span><br><span class="line"># deb https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-proposed main restricted universe multiverse</span><br><span class="line"># deb-src https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;ubuntu&#x2F; bionic-proposed main restricted universe multiverse</span><br></pre></td></tr></table></figure><h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p><code>apt</code>已经相当完善，此处不再赘述。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt dist-upgrade</span><br></pre></td></tr></table></figure><p>当然，别忘了安装<code>wget</code>:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install wget</span><br></pre></td></tr></table></figure><p>此处如果按照上面的步骤已经设置了清华大学的镜像源，那速度将会很快。要不然就很慢慢慢。。</p><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><p>此步骤并非必须，只是记录一下一些很坑的事情，啊哈哈哈哈</p><h3 id="没有Wi-Fi选项"><a href="#没有Wi-Fi选项" class="headerlink" title="没有Wi-Fi选项"></a>没有Wi-Fi选项</h3><p>安装Wi-Fi驱动，记得重启哦：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install bcmwl-kernel-source</span><br></pre></td></tr></table></figure><h3 id="未知的显示器（Unknown-Display）"><a href="#未知的显示器（Unknown-Display）" class="headerlink" title="未知的显示器（Unknown Display）"></a>未知的显示器（Unknown Display）</h3><p>如果是很快的意识到是<code>设置</code>里面有一个<code>未知的显示器</code>，并且以<code>拼接</code>的方式使用，那你就直接根据<a href="https://bugs.launchpad.net/ubuntu/+source/ubuntu-drivers-common/+bug/1296020">Non-existent display detected in both intel driver and nvidia driver (Optimus Laptop)</a>所示，只需安装Bumblebee并重启即可。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install bumblebee-nvidia</span><br></pre></td></tr></table></figure><p>该问题貌似是由于集成显卡和独显共存的问题，所以当你并没有连接外接显示器但是却出现以下双显示器才有的功能时候记得用这个方案。</p><ul><li>APP打开了却看不到界面，只看到页面嗖的一下飞出了屏幕</li><li>左上角有时候会出现一个黑框框，里面有一个数字1</li><li>鼠标放至屏幕上下左右，有一个边会进去</li><li>右键窗口会有一个类似<code>移至显示器右侧</code>的按钮，点了就看不见了</li><li><code>xrandr --listmonitors</code> 有两个</li></ul><h3 id="切换Intel和Nvidia显卡"><a href="#切换Intel和Nvidia显卡" class="headerlink" title="切换Intel和Nvidia显卡"></a>切换Intel和Nvidia显卡</h3><p><strong>no zuo no die no life, 听我一句劝别玩这个。。。</strong>。如果G了去看下<a href="https://www.qingsword.com/qing/ubuntu-remove-nvidia.html">解决Ubuntu18.04安装Nvidia驱动开机卡死</a></p><p><a href="https://www.linuxbabe.com/desktop-linux/switch-intel-nvidia-graphics-card-ubuntu">How To Switch Between Intel and Nvidia Graphics Card on Ubuntu</a>遇到卡在<code>Started bpfilter</code>之后需要编辑/etc/gdm3/custom.conf，将下面这一行放开：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">＃WaylandEnable = FALSE</span><br></pre></td></tr></table></figure><h1 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h1><p>将<code>内网穿透</code>放在Google里面搜索一下会有很多方案，我的VPS被邻居连累之后就没有再买，所以我没有域名、公网IP。。。其中搜索结果的大部分都不适合我。</p><p>其中大部分提到一个<code>DDNS</code>的概念：<a href="https://zh.wikipedia.org/wiki/%E5%8B%95%E6%85%8BDNS">维基百科:动态DNS</a></p><blockquote><p>动态DNS（英语：Dynamic DNS，简称DDNS）是域名系统（DNS）中的一种自动更新名称服务器（Name server）内容的技术。根据互联网的域名订立规则，域名必须跟从固定的IP地址。但动态DNS系统为动态网域提供一个固定的名称服务器（Name server），透过即时更新，使外界用户能够连上动态用户的网址。</p></blockquote><p>了解玩这个之后就可以搜索并选择DDMS方案了。</p><p>再明确一下目标：在外网ssh进内网我们刚建好的Ubuntu。</p><h2 id="fatedier-frp"><a href="#fatedier-frp" class="headerlink" title="fatedier/frp"></a>fatedier/frp</h2><p>首推这种方案：<a href="https://github.com/fatedier/frp">fatedier/frp</a>, 文档有中文并且比较详细。</p><p>还有少数派的一个文章也不错：<a href="https://sspai.com/post/52523">使用frp进行内网穿透</a></p><h2 id="TPDDNS"><a href="#TPDDNS" class="headerlink" title="TPDDNS"></a>TPDDNS</h2><p>不过我家里的路由是<a href="https://www.tp-link.com.cn/">TP-LINK</a>的，TP-LINK是可以参考<a href="https://service.tp-link.com.cn/detail_article_2978.html">TPDDNS的使用方法介绍</a>可以直接使用的。</p><p>不过坑比的事情是[TPDDNS]支持的硬件版本是4.0。参考<a href="https://service.tp-link.com.cn/detail_article_1420.html">如何查看产品型号与硬件版本？</a>，也就是其<code>ver 4.0</code>之上是可以的。</p><p>最好是问一下<code>TP-LINK 在线客服</code>，一般 某猫、某狗上面的客服是不懂这个的。</p><p>很显然我家里的路由是V3.0 啊哈哈哈 此方案我这里不适用。不过看上面的教程已经很详尽了，应该比较好搞。</p><h2 id="Sakura-Frp"><a href="#Sakura-Frp" class="headerlink" title="Sakura Frp"></a>Sakura Frp</h2><p>这个据<a href="https://www.natfrp.org/">官网</a>介绍是这样的：</p><blockquote><p>简单方便<br>客户端基于 Fatedier Frp 修改，免去了配置文件，改为从网络读取配置，您只需要在网站上简单操作即可添加映射。</p><p>完全免费<br>您不必再为了内网穿透多花一分钱，Sakura Frp 是永远免费的，我们只为了让更多人能体验到免费、好用的内网穿透。</p><p>自由使用<br>我们非常欢迎您将 Sakura Frp 集成到自己的软件中，并且我们提供了多种 API 接口以供使用，完全没有使用限制。</p></blockquote><p>好了，适合我这种不愿意花钱的穷屌丝，来<a href="https://openid.natfrp.org/?action=register&src=www.natfrp.com">注册</a>吧。。</p><p>登录进去才发现，好多文字。没有明显的新手教程，对我这种不是很懂<code>FRP</code>的人来说简直一脸懵逼。</p><h2 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h2><p><a href="https://www.natfrp.com/page/panel/">映射列表</a>中的<code>示例映射 - Linux SSH</code>正合我意，然后只需要再点一下<code>随机端口</code>就可以不用输入直接点添加了。</p><p><img src="/images/2019-07-09-13-43-31.png" alt="Linux SSH 并随机端口"></p><p><img src="/images/2019-07-09-13-44-25.png" alt="已添加的隧道列表"></p><p>至此第一个映射已经创建了，然后需要去Ubuntu上开启代理吧</p><h2 id="开启代理"><a href="#开启代理" class="headerlink" title="开启代理"></a>开启代理</h2><p>在<a href="https://www.natfrp.com/page/panel/">客户软件</a>中找到适合自己的<code>Linux x64 (64位操作系统)</code>包并下载至Ubuntu:</p><p>此处将包下载至<code>/opt/natfrp</code>(该路径将在后面的配置中使用)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/natfrp &amp;&amp; <span class="built_in">cd</span> /opt/natfrp</span><br><span class="line">sudo wget https://cdn.tcotp.cn:4443/client/Sakura_frpc_linux_amd64.tar.gz</span><br><span class="line">sudo tar zxvf Sakura_frpc_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure><p>解压完成后，就会得到一个可执行文件<code>Sakura_frpc_linux_amd64</code>(该文件名将在后面的配置中使用)</p><p>根据<a href="https://www.zerobbs.net/?s=viewpost&tid=5">Linux 将 Sakura Frp 设置为服务，开机自动启动</a>的教程操作如下：</p><h3 id="创建service"><a href="#创建service" class="headerlink" title="创建service"></a>创建service</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/systemd/system/sakurafrp.service</span><br></pre></td></tr></table></figure><h3 id="根据自己的配置写入service"><a href="#根据自己的配置写入service" class="headerlink" title="根据自己的配置写入service"></a>根据自己的配置写入service</h3><p><code>/opt/natfrp/</code>: Sakura_frpc_linux_amd64的全路径<br><code>/opt/natfrp/Sakura_frpc_linux_amd64</code>: 解压之后的Sakura_frpc_linux_amd64全路径<br><code>--sid=</code>: 服务器列表中左侧的数字</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Sakura Frp Client</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">WorkingDirectory=/opt/natfrp/</span><br><span class="line">LimitNOFILE=4096</span><br><span class="line">PIDFile=/var/run/sakurafrp/client.pid</span><br><span class="line">ExecStart=/opt/natfrp/Sakura_frpc_linux_amd64 --su=你的账号 --sp=你的密码 --sid=你要选择的服务器的ID(就是服务器列表左侧的数字)</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitInterval=600</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>sid信息[2019.7.9:14:10]:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">| ID名称状态介绍</span><br><span class="line">|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">| 1宁波电信√ 在线高防线路，适合搭 Minecraft 服务器，使用人数较多 (官方服务器)</span><br><span class="line">| 2宁波联通√ 在线联通线路，防御 20G，适合部分移动联通&#x2F;用户使用 (官方服务器)</span><br><span class="line">| 3徐州电信√ 在线徐州高防电信，适合开服，月流量固定 500G，请合理使用 (官方服务器)</span><br><span class="line">| 4贵州电信× 离线贵州电信节点，无防御，适合小流量传输服务[超流量停机] (官方服务器)</span><br><span class="line">| 6罗马尼亚× 离线罗马尼亚不限内容无视 DMCA 版权服务器，免备案 (官方服务器)</span><br><span class="line">| 7日本千兆√ 在线日本千兆服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">| 8台湾百兆√ 在线台湾谷歌云 100M 服务器，适合建站，延迟较低，免备案 (官方服务器)</span><br><span class="line">| 9香港线路1 √ 在线香港 StarryDNS 100M 服务器，适合建站 (官方服务器)</span><br><span class="line">| 10江苏镇江√ 在线江苏镇江 100M 服务器，BGP 全国优化线路，适合开服 (官方服务器)</span><br><span class="line">| 12河南电信√ 在线河南电信线路服务器，适合开服以及小流量服务 (官方服务器)</span><br><span class="line">| 13香港线路2 √ 在线香港谷歌云 100M 服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">| 30洛杉矶01√ 在线美国洛杉矶千兆服务器，适合建站，免备案 线路 1 (官方服务器)</span><br><span class="line">| 31洛杉矶02√ 在线美国洛杉矶千兆服务器，适合建站，免备案 线路 2 (官方服务器)</span><br><span class="line">| 32洛杉矶03√ 在线美国洛杉矶千兆服务器，适合建站，免备案 线路 3 (官方服务器)</span><br><span class="line">| 33洛杉矶04√ 在线美国洛杉矶千兆服务器，适合建站，免备案 线路 4 (官方服务器)</span><br><span class="line">| 34洛杉矶05√ 在线美国洛杉矶千兆服务器，适合建站，免备案 线路 5 (官方服务器)</span><br><span class="line">| 38新加坡01× 离线新加坡阿里云 30M 服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">| 39蒙特利尔√ 在线加拿大蒙特利尔谷歌云 100M 服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">| 43香港移动× 离线香港 UOvZ 100M 移动服务器，适合建站，免备案[机房断网维护中] (官方服务器)</span><br><span class="line">| 45美国纽约1 √ 在线美国纽约百兆服务器，适合建站，免备案 线路1 (官方服务器)</span><br><span class="line">| 46美国纽约2 √ 在线美国纽约百兆服务器，适合建站，免备案 线路2 (官方服务器)</span><br><span class="line">| 47日本长野× 离线日本长野百兆服务器，适合建站，免备案 (官方服务器)</span><br><span class="line">|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><h3 id="启动service"><a href="#启动service" class="headerlink" title="启动service"></a>启动service</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>服务就创建成功了，接下来启动服务：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start sakurafrp</span><br></pre></td></tr></table></figure><p>将服务设置为开机启动</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> sakurafrp</span><br></pre></td></tr></table></figure><p>如果要停止运行客户端，只需要输入</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop sakurafrp</span><br></pre></td></tr></table></figure><p>如果要禁止开机启动，输入</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> sakurafrp</span><br></pre></td></tr></table></figure><p>至此，来让我们看一下当前的状态：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">╰─&gt;$ sudo systemctl status sakurafrp</span><br><span class="line">● sakurafrp.service - Sakura Frp Client</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/sakurafrp.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Tue 2019-07-09 11:07:19 CST; 3h 13min ago</span><br><span class="line"> Main PID: 3301 (Sakura_frpc_lin)</span><br><span class="line">    Tasks: 10 (<span class="built_in">limit</span>: 4915)</span><br><span class="line">   Memory: 5.9M</span><br><span class="line">   CGroup: /system.slice/sakurafrp.service</span><br><span class="line">           └─3301 /opt/natfrp/Sakura_frpc_linux_amd64 --su=xxxxxxxx --sp=xxxxxxxx --sid=xxx</span><br><span class="line"></span><br><span class="line">7月 09 11:07:20 madordie-NV47H Sakura_frpc_linux_amd64[3301]: &gt;配置文件载入成功</span><br><span class="line">7月 09 11:07:20 madordie-NV47H Sakura_frpc_linux_amd64[3301]: 2019/07/09 11:07:20 [I] [proxy_manager.go:322] 增加代理: [xxx.natfrp.org:22941        29795-87248]</span><br><span class="line">7月 09 11:07:20 madordie-NV47H Sakura_frpc_linux_amd64[3301]: 2019/07/09 11:07:20 [I] [control.go:242] [d54792913cdac17d] 登录成功, 获取到运行ID [d54792913cdac17d], server udp port [7001]</span><br><span class="line">7月 09 11:07:20 madordie-NV47H Sakura_frpc_linux_amd64[3301]: 2019/07/09 11:07:20 [I] [control.go:167] [d54792913cdac17d] [xxx.natfrp.org:22941        29795-87248] 启动代理成功</span><br></pre></td></tr></table></figure><p>可以看到<code>[xxx.natfrp.org:22941        29795-87248] 启动代理成功</code></p><p>需要注意的是选用的sid不一样其代理的域名也不一样。这个是很显然的，但是是容易忽略的。</p><h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p>在MBP上验证一下<code>xxx.natfrp.org:22941</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">╰─&gt;$ ssh -p 22941 madordie@xxx.natfrp.org</span><br><span class="line">Welcome to Ubuntu 19.04 (GNU/Linux 4.18.0-15-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12 updates can be installed immediately.</span><br><span class="line">6 of these updates are security updates.</span><br><span class="line"></span><br><span class="line">Last login: Tue Jul  9 14:19:33 2019 from 127.0.0.1</span><br></pre></td></tr></table></figure><p><code>Sakura Frp</code>已通，愉快的玩耍吧！</p><p>括弧：一旦其暴露出去别忘了考虑安全，比如你的这个SSH账号、密码是否足够复杂，或者是否关闭了账号密码登陆。</p><h1 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h1><p>还有一些其他的方案可以选择，比如：</p><ul><li><a href="https://hsk.oray.com/">花生壳</a></li><li><a href="https://www.noip.com/">no-ip</a></li><li><a href="https://github.com/fatedier/frp">开源的frp</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;记录将一台吃灰的笔记本改装成服务器，并暴露在公网下的过程。&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://madordie.github.io/categories/Linux/"/>
    
    
      <category term="内网穿透" scheme="https://madordie.github.io/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>实时显示日志logio</title>
    <link href="https://madordie.github.io/post/logio-brief-zh-cn/"/>
    <id>https://madordie.github.io/post/logio-brief-zh-cn/</id>
    <published>2019-05-21T16:00:00.000Z</published>
    <updated>2019-07-15T02:36:55.358Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="log-io"><a href="#log-io" class="headerlink" title="log.io"></a>log.io</h1><p><a href="https://madordie.github.io/post/logio-brief/">English</a></p><p>一个能在浏览器上实时显示日志的工具。</p><a id="more"></a><h1 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h1><p>以下摘自<a href="http://logio.org/">logio.org</a>，我觉得已经非常的详细了，这里就不啰嗦了。</p><blockquote><p>Harvesters watch log files for changes, send new log messages to the server, which broadcasts to web clients. Log messages are tagged with stream, node, and log level information based on user configuration.</p><p>Log.io has no persistence layer. Harvesters are informed of file changes via inotify, and log messages hop from harvester to server to web client via TCP and socket.io, respectively.</p><p><img src="/images/2019-05-17-10-03-13.png" alt="work io"><br><img src="/images/2019-05-17-10-12-25.png" alt="Activate streams &amp; nodes to watch log messages"></p></blockquote><h2 id="通信使用的TCP接口"><a href="#通信使用的TCP接口" class="headerlink" title="通信使用的TCP接口"></a><a name="Simple TCP interface">通信使用的TCP接口</a></h2><blockquote><p>Log.io uses a stateless TCP API to receive log messages.</p><p>Writing a third party harvester is easy. Open a TCP connection to the &gt; server and begin writing properly formatted messages to the socket.</p><p>Read the <a href="https://github.com/NarrativeScience/Log.io">API documentation</a>.</p></blockquote><h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+log|my_stream|my_node|info|this is log message\r\n</span><br></pre></td></tr></table></figure><h3 id="注册一个新的node和stream"><a href="#注册一个新的node和stream" class="headerlink" title="注册一个新的node和stream"></a>注册一个新的node和stream</h3><p>如果原来已经存在，那么还是原来的那个。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+node|my_node|my_stream1,my_stream2\r\n</span><br></pre></td></tr></table></figure><h3 id="删除node"><a href="#删除node" class="headerlink" title="删除node"></a>删除node</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-node|my_node\r\n</span><br></pre></td></tr></table></figure><h1 id="安装Log-io服务端"><a href="#安装Log-io服务端" class="headerlink" title="安装Log.io服务端"></a>安装Log.io服务端</h1><p>这个年久失修的原始项目<a href="https://github.com/NarrativeScience/Log.io">NarrativeScience/Log.io</a>已经没办法正常工作了。。</p><p>幸运的是，docker版本的<a href="https://github.com/blacklabelops-legacy/logio">blacklabelops-legacy/logio</a>还可以用，所以我们就用这个吧。</p><h2 id="安装并开启docker"><a href="#安装并开启docker" class="headerlink" title="安装并开启docker"></a>安装并开启docker</h2><p>docker的文档<a href="https://docs.docker.com/install/">docs.docker.com</a>依旧非常详细，不再赘述。</p><p>值得一提的是支持的平台有很多，比如：<a href="https://docs.docker.com/install/">Cloud</a>、 <a href="https://docs.docker.com/docker-for-mac/install/">MacOS</a> 、<a href="https://docs.docker.com/install/">Linux</a> 、 <a href="https://docs.docker.com/docker-for-windows/install/">Windows</a></p><h2 id="pull-镜像"><a href="#pull-镜像" class="headerlink" title="pull 镜像"></a>pull 镜像</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull blacklabelops/logio</span><br></pre></td></tr></table></figure><h2 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">    -p 28778:28778 \</span><br><span class="line">    -p 28777:28777 \</span><br><span class="line">    --name logio \</span><br><span class="line">    blacklabelops/logio</span><br></pre></td></tr></table></figure><p>值得一提的是，原文档<a href="https://github.com/blacklabelops-legacy/logio">blacklabelops-legacy/logio</a>中是没有<code>-p 28777:28777</code>参数的，会导致其28777端口无响应，应该是一个手误或者特殊需要？反正这里打开就好了。</p><h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><p>其他配置在<a href="https://github.com/blacklabelops-legacy/logio">blacklabelops-legacy/logio</a>中也很详细😂，需要的请自取。比如说日志、https、等</p><h2 id="最终效果图"><a href="#最终效果图" class="headerlink" title="最终效果图"></a>最终效果图</h2><p>在浏览器上打开<a href="http://localhost:28778/%E5%8D%B3%E5%8F%AF%E3%80%82%EF%BC%88localhost">http://localhost:28778/即可。（localhost</a> 是安装server的IP）<br><img src="/images/2019-05-17-10-40-18.png" alt="log.io server"></p><p>于是乎，我们就可以向localhost:28778疯狂的写日志了. 🎉🎉🎉</p><h1 id="支持的插件"><a href="#支持的插件" class="headerlink" title="支持的插件"></a>支持的插件</h1><p>这个日志服务<a href="#Simple TCP interface">对外接口</a>比较简单，所以理论上来讲，只需要可以进行TCP通信的包均可以支持，包括但不限于安卓、iOS。</p><h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><p><a href="https://github.com/madordie/logio">iOS版本</a>基于<a href="https://cocoapods.org/">CocoaPods</a>的项目只需要在Podfile中添加：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="string">&#x27;LogIO&#x27;</span>, <span class="symbol">:git</span> =&gt; <span class="string">&#x27;https://github.com/madordie/logio.git&#x27;</span></span><br></pre></td></tr></table></figure><p>其iOS版本已经放在了这里：<a href="https://github.com/madordie/logio">madordie/logio</a></p><p>iOS上之前有一个类似的<a href="https://github.com/s4nchez/LogIO-CocoaLumberjack">LogIO-CocoaLumberjack</a>, 我这里做了简单的更新，目的是不绑定<a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a>。</p><hr><ul><li><a href="http://logio.org/">logio.org</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;log-io&quot;&gt;&lt;a href=&quot;#log-io&quot; class=&quot;headerlink&quot; title=&quot;log.io&quot;&gt;&lt;/a&gt;log.io&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://madordie.github.io/post/logio-brief/&quot;&gt;English&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一个能在浏览器上实时显示日志的工具。&lt;/p&gt;
    
    </summary>
    
      <category term="工具" scheme="https://madordie.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="tool" scheme="https://madordie.github.io/tags/tool/"/>
    
      <category term="logio" scheme="https://madordie.github.io/tags/logio/"/>
    
  </entry>
  
  <entry>
    <title>logio</title>
    <link href="https://madordie.github.io/post/logio-brief/"/>
    <id>https://madordie.github.io/post/logio-brief/</id>
    <published>2019-05-16T16:00:00.000Z</published>
    <updated>2019-07-10T03:24:19.041Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="log-io"><a href="#log-io" class="headerlink" title="log.io"></a>log.io</h1><p><a href="https://madordie.github.io/post/logio-brief-zh-cn/">中文</a></p><p>Real-time log monitoring in your browser.</p><a id="more"></a><h1 id="How-does-it-work"><a href="#How-does-it-work" class="headerlink" title="How does it work"></a>How does it work</h1><blockquote><p>Harvesters watch log files for changes, send new log messages to the server, which broadcasts to web clients. Log messages are tagged with stream, node, and log level information based on user configuration.</p><p>Log.io has no persistence layer. Harvesters are informed of file changes via inotify, and log messages hop from harvester to server to web client via TCP and socket.io, respectively.</p><p><img src="/images/2019-05-17-10-03-13.png" alt="work io"></p></blockquote><h2 id="Activate-streams-amp-nodes-to-watch-log-messages"><a href="#Activate-streams-amp-nodes-to-watch-log-messages" class="headerlink" title="Activate streams &amp; nodes to watch log messages"></a>Activate streams &amp; nodes to watch log messages</h2><blockquote><p><img src="/images/2019-05-17-10-12-25.png" alt="Activate streams &amp; nodes to watch log messages"></p></blockquote><h2 id="Simple-TCP-interface"><a href="#Simple-TCP-interface" class="headerlink" title="Simple TCP interface"></a><a name="Simple TCP interface">Simple TCP interface</a></h2><blockquote><p>Log.io uses a stateless TCP API to receive log messages.</p><p>Writing a third party harvester is easy. Open a TCP connection to the &gt; server and begin writing properly formatted messages to the socket.</p><p>Read the <a href="https://github.com/NarrativeScience/Log.io">API documentation</a>.</p></blockquote><h3 id="Send-a-log-message"><a href="#Send-a-log-message" class="headerlink" title="Send a log message"></a>Send a log message</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+log|my_stream|my_node|info|this is log message\r\n</span><br></pre></td></tr></table></figure><h3 id="Register-a-new-node-with-stream-associations"><a href="#Register-a-new-node-with-stream-associations" class="headerlink" title="Register a new node, with stream associations"></a>Register a new node, with stream associations</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+node|my_node|my_stream1,my_stream2\r\n</span><br></pre></td></tr></table></figure><h3 id="Remove-a-node"><a href="#Remove-a-node" class="headerlink" title="Remove a node"></a>Remove a node</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-node|my_node\r\n</span><br></pre></td></tr></table></figure><h1 id="Install-Log-io"><a href="#Install-Log-io" class="headerlink" title="Install Log.io"></a>Install Log.io</h1><p>The original project <a href="https://github.com/NarrativeScience/Log.io">NarrativeScience/Log.io</a> has been unavailable due to lack of maintenance for a long time.</p><p>Fortunately, the <a href="https://github.com/blacklabelops-legacy/logio">blacklabelops-legacy/logio</a> can also be used.</p><p>So we can install the project like this：</p><h2 id="Install-and-start-docker"><a href="#Install-and-start-docker" class="headerlink" title="Install and start docker"></a>Install and start docker</h2><p>The <a href="https://docs.docker.com/install/">docs.docker.com</a> is very detailed.</p><p>Support <a href="https://docs.docker.com/install/">Cloud</a>、 <a href="https://docs.docker.com/docker-for-mac/install/">MacOS</a> 、<a href="https://docs.docker.com/install/">Linux</a> 、 <a href="https://docs.docker.com/docker-for-windows/install/">Windows</a></p><h2 id="Pull-image"><a href="#Pull-image" class="headerlink" title="Pull image"></a>Pull image</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull blacklabelops/logio</span><br></pre></td></tr></table></figure><h2 id="Start-the-server"><a href="#Start-the-server" class="headerlink" title="Start the server"></a>Start the server</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">    -p 28778:28778 \</span><br><span class="line">    -p 28777:28777 \</span><br><span class="line">    --name logio \</span><br><span class="line">    blacklabelops/logio</span><br></pre></td></tr></table></figure><h2 id="Other-configure"><a href="#Other-configure" class="headerlink" title="Other configure"></a>Other configure</h2><p><a href="https://github.com/blacklabelops-legacy/logio">blacklabelops-legacy/logio</a>.</p><h2 id="Complete"><a href="#Complete" class="headerlink" title="Complete"></a>Complete</h2><p>Browser: <a href="http://localhost:28778/">http://localhost:28778/</a><br><img src="/images/2019-05-17-10-40-18.png" alt="log.io server"></p><p>Now we can write logs to port 28777. 🎉🎉🎉</p><h1 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h1><p>We only need to perform TCP communication according to the rules <a href="#Simple TCP interface">Simple TCP interface</a>, and the log can be displayed on the browser.</p><h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><p><a href="https://github.com/madordie/logio">logio for iOS</a></p><hr><ul><li><a href="http://logio.org/">logio.org</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;log-io&quot;&gt;&lt;a href=&quot;#log-io&quot; class=&quot;headerlink&quot; title=&quot;log.io&quot;&gt;&lt;/a&gt;log.io&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://madordie.github.io/post/logio-brief-zh-cn/&quot;&gt;中文&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Real-time log monitoring in your browser.&lt;/p&gt;
    
    </summary>
    
      <category term="工具" scheme="https://madordie.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="tool" scheme="https://madordie.github.io/tags/tool/"/>
    
      <category term="logio" scheme="https://madordie.github.io/tags/logio/"/>
    
  </entry>
  
  <entry>
    <title>Gitment/Gitalk自动初始化</title>
    <link href="https://madordie.github.io/post/blog-gitment-auto-setup/"/>
    <id>https://madordie.github.io/post/blog-gitment-auto-setup/</id>
    <published>2018-08-29T08:58:47.000Z</published>
    <updated>2020-10-14T03:28:59.284Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>一个ruby脚本解放你双手啪啪啪的敲键盘三分钟～</p><p>PS.</p><ul><li>ruby新手，轻拍。。</li><li>三是虚指。。</li></ul><a id="more"></a><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>之前看到人家的私站都是用的<a href="https://github.com/">GitHub</a>做的评论系统。。很想要，但是人家没有用<a href="https://pages.github.com/">pages</a>这样的玩意。。</p><p>今天看到<a href="http://awhisper.github.io/">味精</a>大佬的RSS跪了，然后看到人家用的是GitHub的评论。。顿时觉得想要，23333</p><p>然后看了一哈 是这个：<a href="https://github.com/imsun/gitment">gitment</a></p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>这个我就不说了，作者有写中文文档，看一眼就明白了。</p><p>列一下我的使用<a href="https://github.com/iissnan/hexo-theme-next">NexT主题</a>的配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gitment</span></span><br><span class="line"><span class="comment"># Introduction: https://imsun.net/posts/gitment-introduction/</span></span><br><span class="line"><span class="attr">gitment:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mint:</span> <span class="literal">true</span> <span class="comment"># RECOMMEND, A mint on Gitment, to support count, language and proxy_gateway</span></span><br><span class="line">  <span class="attr">count:</span> <span class="literal">true</span> <span class="comment"># Show comments count in post meta area</span></span><br><span class="line">  <span class="attr">lazy:</span> <span class="literal">false</span> <span class="comment"># Comments lazy loading with a button</span></span><br><span class="line">  <span class="attr">cleanly:</span> <span class="literal">false</span> <span class="comment"># Hide &#x27;Powered by ...&#x27; on footer, and more</span></span><br><span class="line">  <span class="attr">language:</span> <span class="comment"># Force language, or auto switch by theme</span></span><br><span class="line">  <span class="attr">github_user:</span> <span class="string">xxxxxx</span> <span class="comment"># MUST HAVE, Your Github ID</span></span><br><span class="line">  <span class="attr">github_repo:</span> <span class="string">xxxxxx</span> <span class="comment"># MUST HAVE, The repo you use to store Gitment comments</span></span><br><span class="line">  <span class="attr">client_id:</span> <span class="string">xxxxxx</span> <span class="comment"># MUST HAVE, Github client id for the Gitment</span></span><br><span class="line">  <span class="attr">client_secret:</span> <span class="string">xxxxxx</span> <span class="comment"># EITHER this or proxy_gateway, Github access secret token for the Gitment</span></span><br><span class="line">  <span class="attr">proxy_gateway:</span> <span class="comment"># Address of api proxy, See: https://github.com/aimingoo/intersect</span></span><br><span class="line">  <span class="attr">redirect_protocol:</span> <span class="comment"># Protocol of redirect_uri with force_redirect_protocol when mint enabled</span></span><br></pre></td></tr></table></figure><h2 id="开始自动化配置"><a href="#开始自动化配置" class="headerlink" title="开始自动化配置"></a>开始自动化配置</h2><p>关于<code>gitment</code>作者的<a href="https://github.com/imsun/gitment/issues/8">初始化评论框方案讨论</a>还在讨论中。。。</p><p>但是我要用。。等是不可能等的了。</p><p>看到<a href="https://draveness.me/git-comments-initialize">自动初始化 Gitalk 和 Gitment 评论</a>的脚本想着刚好我的也是自动发布、备份，这不是刚好嘛。。</p><p>但是存在多次执行就会多次创建的问题。这不是我想要的。</p><p><strong>为了防止忘记更新下面的脚本, 请去<a href="https://github.com/madordie/madordie.github.io/blob/master/comment.rb">comment.rb</a>确保最新版本</strong></p><figure class="highlight rb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># token已放在.git-token文件下，防止泄漏。。</span></span><br><span class="line"></span><br><span class="line">username = <span class="string">&quot;madordie&quot;</span> <span class="comment"># GitHub 用户名</span></span><br><span class="line">token = <span class="string">`cat .git-token`</span>  <span class="comment"># GitHub Token</span></span><br><span class="line">repo_name = <span class="string">&quot;madordie.github.io&quot;</span> <span class="comment"># 存放 issues</span></span><br><span class="line">sitemap_url = <span class="string">&quot;https://raw.githubusercontent.com/madordie/madordie.github.io/master/sitemap.xml&quot;</span> <span class="comment"># sitemap</span></span><br><span class="line">kind = <span class="string">&quot;Gitalk&quot;</span> <span class="comment"># &quot;Gitalk&quot; or &quot;gitment&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;open-uri&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;faraday&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;active_support&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;active_support/core_ext&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sitemap-parser&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;digest&#x27;</span></span><br><span class="line"></span><br><span class="line">puts <span class="string">&quot;正在检索URL&quot;</span></span><br><span class="line"></span><br><span class="line">sitemap = SitemapParser.new sitemap_url</span><br><span class="line">urls = sitemap.to_a</span><br><span class="line"></span><br><span class="line">puts <span class="string">&quot;检索到文章共<span class="subst">#&#123;urls.count&#125;</span>个&quot;</span></span><br><span class="line"></span><br><span class="line">conn = Faraday.new(<span class="symbol">:url</span> =&gt; <span class="string">&quot;https://api.github.com/&quot;</span>) <span class="keyword">do</span> <span class="params">|conn|</span></span><br><span class="line">  conn.basic_auth(username, token)</span><br><span class="line">  conn.headers[<span class="string">&#x27;Accept&#x27;</span>] = <span class="string">&quot;application/vnd.github.symmetra-preview+json&quot;</span></span><br><span class="line">  conn.adapter  Faraday.default_adapter</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">commenteds = Array.new</span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">  if [ ! -f .commenteds ]; then</span></span><br><span class="line"><span class="string">    touch .commenteds</span></span><br><span class="line"><span class="string">  fi</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">File.open(<span class="string">&quot;.commenteds&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">do</span> <span class="params">|file|</span></span><br><span class="line">  file.each_line <span class="keyword">do</span> <span class="params">|line|</span></span><br><span class="line">      commenteds.push line</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">urls.each_with_index <span class="keyword">do</span> <span class="params">|url, index|</span></span><br><span class="line">  url = url.gsub(<span class="regexp">/index.html$/</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">  md5_key = URI.parse(url).path</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> md5_key.match(<span class="regexp">/^\/tags\/.+/</span>) <span class="params">||</span> md5_key.match(<span class="regexp">/^\/categories\/.+/</span>)</span><br><span class="line">    <span class="comment"># 此处并不需要评论</span></span><br><span class="line">  <span class="keyword">elsif</span> commenteds.<span class="keyword">include</span>?(<span class="string">&quot;<span class="subst">#&#123;url&#125;</span>\n&quot;</span>) == <span class="literal">false</span></span><br><span class="line">    url_key = Digest::MD5.hexdigest(URI.parse(url).path)</span><br><span class="line">    response = conn.get <span class="string">&quot;/search/issues?q=label:<span class="subst">#&#123;url_key&#125;</span>+state:open+repo:<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    puts <span class="string">&quot;正在创建: <span class="subst">#&#123;url&#125;</span> (<span class="subst">#&#123;URI.parse(url).path&#125;</span>) -&gt; [<span class="subst">#&#123;url_key&#125;</span>, <span class="subst">#&#123;kind&#125;</span>]&quot;</span></span><br><span class="line">    labels = JSON.parse(response.body)[<span class="string">&quot;items&quot;</span>]</span><br><span class="line">      .map &#123; <span class="params">|item|</span></span><br><span class="line">        item[<span class="string">&quot;labels&quot;</span>].map &#123; <span class="params">|label|</span> label[<span class="string">&quot;name&quot;</span>] &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      .flatten</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> labels.<span class="keyword">include</span>?(url_key)</span><br><span class="line">      <span class="keyword">if</span> labels.<span class="keyword">include</span>?(kind)</span><br><span class="line">        puts <span class="string">&quot;\t↳ 已存在&quot;</span></span><br><span class="line">        <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        issue_id = JSON.parse(response.body)[<span class="string">&quot;items&quot;</span>]</span><br><span class="line">          .map &#123; <span class="params">|item|</span> item[<span class="string">&quot;number&quot;</span>] &#125;</span><br><span class="line">          .first</span><br><span class="line"></span><br><span class="line">        puts <span class="string">&quot;\t↳ 正在为评论(<span class="subst">#&#123;issue_id&#125;</span>)增加`<span class="subst">#&#123;kind&#125;</span>`标签&quot;</span></span><br><span class="line">        response = conn.post(<span class="string">&quot;/repos/<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>/issues/<span class="subst">#&#123;issue_id&#125;</span>/labels&quot;</span>) <span class="keyword">do</span> <span class="params">|req|</span></span><br><span class="line">          req.body = &#123; <span class="symbol">labels:</span> [kind] &#125;.to_json</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> response.status == <span class="number">200</span></span><br><span class="line">          <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">          puts <span class="string">&quot;\t\t↳ 已增加成功&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          puts <span class="string">&quot;\t↳ <span class="subst">#&#123;response.body&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      title = open(url).read.scan(<span class="regexp">/&lt;title&gt;(.*?)&lt;\/title&gt;/</span>).first.first.force_encoding(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">      response = conn.post(<span class="string">&quot;/repos/<span class="subst">#&#123;username&#125;</span>/<span class="subst">#&#123;repo_name&#125;</span>/issues&quot;</span>) <span class="keyword">do</span> <span class="params">|req|</span></span><br><span class="line">        req.body = &#123; <span class="symbol">body:</span> url, <span class="symbol">labels:</span> [kind, url_key], <span class="symbol">title:</span> title &#125;.to_json</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span> JSON.parse(response.body)[<span class="string">&#x27;number&#x27;</span>] &gt; <span class="number">0</span></span><br><span class="line">        <span class="string">`echo <span class="subst">#&#123;url&#125;</span> &gt;&gt; .commenteds`</span></span><br><span class="line">        puts <span class="string">&quot;\t↳ 已创建成功&quot;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        puts <span class="string">&quot;\t↳ <span class="subst">#&#123;response.body&#125;</span>&quot;</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>同时别忘了修改对应的网页。。我这里使用的是<a href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces v5.1.4</a></p><p>需要修改<code>/themes/next/layout/_third-party/comments/gitment.swig</code>文件，由于JS不支持MD5,所以还需要引入一个JS，于是乎大约这样：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    &#123;% if theme.gitment.mint %&#125;</span><br><span class="line">        &#123;% set CommentsClass &#x3D; &quot;Gitmint&quot; %&#125;</span><br><span class="line">        &lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;https:&#x2F;&#x2F;aimingoo.github.io&#x2F;gitmint&#x2F;style&#x2F;default.css&quot;&gt;</span><br><span class="line">        &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;aimingoo.github.io&#x2F;gitmint&#x2F;dist&#x2F;gitmint.browser.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">+       &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;blueimp-md5&#x2F;2.10.0&#x2F;js&#x2F;md5.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">        &#123;% set CommentsClass &#x3D; &quot;Gitment&quot; %&#125;</span><br><span class="line">        &lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;https:&#x2F;&#x2F;imsun.github.io&#x2F;gitment&#x2F;style&#x2F;default.css&quot;&gt;</span><br><span class="line">        &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;imsun.github.io&#x2F;gitment&#x2F;dist&#x2F;gitment.browser.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">+       &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;blueimp-md5&#x2F;2.10.0&#x2F;js&#x2F;md5.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">...</span><br><span class="line">        var gitment &#x3D; new &#123;&#123;CommentsClass&#125;&#125;(&#123;</span><br><span class="line">-           id: document.location.href,</span><br><span class="line">+           id: md5(window.location.pathname.replace(&#x2F;index.html&#x2F;, &quot;&quot;)),</span><br><span class="line">            owner: &#39;&#123;&#123; theme.gitment.github_user &#125;&#125;&#39;,</span><br><span class="line">            repo: &#39;&#123;&#123; theme.gitment.github_repo &#125;&#125;&#39;,</span><br></pre></td></tr></table></figure><p>至于这个MD5的引入，我是随便搜的一个。。这个<code>if theme.gitment.mint</code>我并不知道在哪里配置的，所以俩都加上吧。</p><p>执行一下脚本吧，应该齐活了。</p><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips."></a>Tips.</h2><p>另外为了避免<code>label</code>过长的问题这个的讨论很多，在issues中搜一下大约这样：<a href="https://github.com/imsun/gitment/issues?utf8=%E2%9C%93&q=is:issue+validation+Failed">Error: Validation Failed</a>。</p><p>这个<code>Error: Validation Failed</code>就是label太长。</p><p>关于这个问题在<a href="https://developer.github.com/v3/issues/labels/#create-a-label">API: Create a label</a>并未提及。</p><p>但是在任何一个仓库下，按照<code>Issues -&gt; New label</code>的时候，输入的<code>Label name</code>是有限制的，输入超过<code>50</code>个自符之后便无法再接收输入。就酱，没找到什么文档。。</p><p>看了这个<a href="https://github.com/imsun/gitment/issues/116">Validation Failed ID长度问题建议</a>之后觉得，MD5一下吧那就。。</p><p>为了选择一个KEY去MD5，顺便解决一下<a href="https://github.com/imsun/gitment/issues/168">同一个页面，带锚点#more会初始化一条新的issue</a>这个问题，</p><p>所以KEY使用<a href="https://github.com/imsun/gitment/issues/68">关于hexo博客单篇文章初始化两次的问题</a>中提出的<code>window.location.pathname</code>吧，但是关于<code>/</code>的讨论，我这里貌似并没有看到，我的都是有的😂。。如果看到的话再更，或者保险期间，先按照这种方案更新一下。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><ul><li>文中提到的关于链接<code>/</code>飘忽不定的事情我没碰到，我是直接取的<a href="https://madordie.github.io/sitemap.xml">sitemap</a>，貌似每个文章都带了<code>/</code></li><li>文中的引用啥的我都标记了链接，如有漏掉、不明白，麻烦告诉我一哈，我去补一下</li><li>我只是个小小的iOS，对ruby、js懂得不多，rb写的不好的地方轻拍</li><li>哦对了，这脚本全部在这里：<a href="https://github.com/madordie/madordie.github.io/blob/master/comment.rb">comment.rb</a>。同时，这个脚本我又放在了自动发布的shell脚本里面，同样shell写的很水。。放在了这里：<a href="https://github.com/madordie/madordie.github.io/blob/master/deploy.sh">deploy.sh</a>，而且是很早之前就写了的。。</li><li>如果还有什么问题，可以拉出来讨论一哈 ;)</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;一个ruby脚本解放你双手啪啪啪的敲键盘三分钟～&lt;/p&gt;
&lt;p&gt;PS.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ruby新手，轻拍。。&lt;/li&gt;
&lt;li&gt;三是虚指。。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="工具" scheme="https://madordie.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="blog" scheme="https://madordie.github.io/tags/blog/"/>
    
      <category term="gitment" scheme="https://madordie.github.io/tags/gitment/"/>
    
      <category term="gitalk" scheme="https://madordie.github.io/tags/gitalk/"/>
    
  </entry>
  
  <entry>
    <title>UIFont字体信息</title>
    <link href="https://madordie.github.io/post/uifont-infos/"/>
    <id>https://madordie.github.io/post/uifont-infos/</id>
    <published>2018-08-16T10:43:20.000Z</published>
    <updated>2018-08-23T03:17:26.448Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>iOS系统下字体信息。</p><a id="more"></a><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul><li>iOS12.0(16A5357b)</li><li>iPhone6</li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> label = <span class="type">UILabel</span>()</span><br><span class="line">label.text = <span class="string">&quot;这是啥&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> format: (<span class="type">UIFont</span>) -&gt; [<span class="type">String</span>: <span class="type">Any</span>] = &#123; (font) <span class="keyword">in</span></span><br><span class="line">    label.font = font</span><br><span class="line">    label.sizeToFit()</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&quot;font.familyName&quot;</span>: font.familyName,</span><br><span class="line">            <span class="string">&quot;font.fontName&quot;</span>: font.fontName,</span><br><span class="line">            <span class="string">&quot;font.pointSize&quot;</span>: font.pointSize,</span><br><span class="line">            <span class="string">&quot;font.ascender&quot;</span>: font.ascender,</span><br><span class="line">            <span class="string">&quot;font.descender&quot;</span>: font.descender,</span><br><span class="line">            <span class="string">&quot;font.capHeight&quot;</span>: font.capHeight,</span><br><span class="line">            <span class="string">&quot;font.xHeight&quot;</span>: font.xHeight,</span><br><span class="line">            <span class="string">&quot;font.lineHeight&quot;</span>: font.lineHeight,</span><br><span class="line">            <span class="string">&quot;font.leading&quot;</span>: font.leading,</span><br><span class="line">            <span class="string">&quot;label.sizeToFit&quot;</span>: label.frame.height]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> json: [<span class="type">String</span>: [[<span class="type">String</span>: <span class="type">Any</span>]]] = [:]</span><br><span class="line"><span class="keyword">for</span> family <span class="keyword">in</span> <span class="type">UIFont</span>.familyNames &#123;</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="type">UIFont</span>.fontNames(forFamilyName: family) &#123;</span><br><span class="line">        <span class="keyword">var</span> list: [[<span class="type">String</span>: <span class="type">Any</span>]] = []</span><br><span class="line">        <span class="keyword">for</span> size <span class="keyword">in</span> <span class="number">5</span>...<span class="number">60</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> font = <span class="type">UIFont</span>.<span class="keyword">init</span>(name: name, size: <span class="type">CGFloat</span>(size)) <span class="keyword">else</span> &#123; <span class="keyword">continue</span> &#125;</span><br><span class="line">            list.append(format(font))</span><br><span class="line">        &#125;</span><br><span class="line">        json[<span class="string">&quot;\(family) -&gt; \(name)&quot;</span>] = list</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="type">String</span>(data:(<span class="keyword">try</span>? <span class="type">JSONSerialization</span>.data(withJSONObject: json, options: .prettyPrinted)) ?? <span class="type">Data</span>(), encoding: .utf8)!)</span><br></pre></td></tr></table></figure><h2 id="长长的数据"><a href="#长长的数据" class="headerlink" title="长长的数据"></a>长长的数据</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><p>然而数据太多加载不出来。。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;iOS系统下字体信息。&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="UIFont" scheme="https://madordie.github.io/tags/UIFont/"/>
    
  </entry>
  
  <entry>
    <title>从一个常见的崩溃开始</title>
    <link href="https://madordie.github.io/post/debug-sth-from-crash/"/>
    <id>https://madordie.github.io/post/debug-sth-from-crash/</id>
    <published>2018-07-25T02:38:04.000Z</published>
    <updated>2018-07-25T10:06:59.566Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>昨天下班时候一朋友碰到一个下面的崩溃，但是全局断点却无法断到指定位置。鉴于不信邪的态度，决定尝试一番。然后将此事记录如下文。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*** Terminating app due to uncaught exception &#39;NSInvalidArgumentException&#39;, reason: &#39;-[__NSCFConstantString hasPrefix:]: nil argument&#39;</span><br><span class="line">*** First throw call stack:</span><br><span class="line">(0x18521ed8c .....)</span><br><span class="line">libc++abi.dylib: terminating with uncaught exception of type NSException</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="崩溃表现"><a href="#崩溃表现" class="headerlink" title="崩溃表现"></a>崩溃表现</h2><p>那老哥说他的APP运行之后，什么都不做，等待10s之后就会闪退，闪退的最重要信息是上面，栈结构上没有函数信息，只有地址。</p><p>打开全局断点，也无法直接断到指定的函数，这个信息我留了一张图，大致如下：(已脱敏)</p><p><img src="/images/2018-07-25-10-52-38.png" alt="崩溃截图"></p><h2 id="先简单的分析一下"><a href="#先简单的分析一下" class="headerlink" title="先简单的分析一下"></a>先简单的分析一下</h2><ul><li>崩溃原因很明确:<code>-[__NSCFConstantString hasPrefix:]: nil argument</code>。</li><li><code>__NSCFConstantString</code>为<code>NSString</code>类簇里面的一个类，常见的类似的还有很多。</li><li><code>- (BOOL)hasPrefix:(NSString *)str;</code>中<code>nil argument</code>，也就是<code>str</code>为<code>nil</code>。</li><li><code>First throw call stack</code>下方均为地址，说明此函数应该在一个<code>.a/.framework</code>中。</li><li><code>APP运行之后，什么都不做，等待10s之后就会闪退</code>说明此崩溃为异步调用，至于是不是定时调用，这个真不好说。</li><li>由于我技术有限，别的好像提炼不出有用信息了。。</li></ul><h2 id="复现一下崩溃"><a href="#复现一下崩溃" class="headerlink" title="复现一下崩溃"></a>复现一下崩溃</h2><p>先来个简单的代码，验证一下 ** <code>- (BOOL)hasPrefix:(NSString *)str;</code>中<code>nil argument</code>，也就是<code>str</code>为<code>nil</code>。 **</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, @([<span class="string">@&quot;&quot;</span> hasPrefix:<span class="literal">nil</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行一下，结果很意料之中，得出如下：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Untitled.m:<span class="number">4</span>:<span class="number">29</span>: warning: null passed to a callee that requires a non-null argument [-Wnonnull]</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, @([<span class="string">@&quot;&quot;</span> hasPrefix:<span class="literal">nil</span>]));</span><br><span class="line">                            ^         ~~~</span><br><span class="line"><span class="number">1</span> warning generated.</span><br><span class="line">Terminated due to signal: ABORT TRAP (<span class="number">6</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">44</span>:<span class="number">50.569</span> Untitled[<span class="number">53770</span>:<span class="number">899141</span>] *** Terminating app due to uncaught exception <span class="string">&#x27;NSInvalidArgumentException&#x27;</span>, reason: <span class="string">&#x27;-[__NSCFConstantString hasPrefix:]: nil argument&#x27;</span></span><br><span class="line">*** First throw call stack:</span><br><span class="line">(</span><br><span class="line"><span class="number">0</span>   CoreFoundation                      <span class="number">0x00007fff30aae2db</span> __exceptionPreprocess + <span class="number">171</span></span><br><span class="line"><span class="number">1</span>   libobjc.A.dylib                     <span class="number">0x00007fff57c58c76</span> objc_exception_throw + <span class="number">48</span></span><br><span class="line"><span class="number">2</span>   CoreFoundation                      <span class="number">0x00007fff30b3fd7d</span> +[<span class="built_in">NSException</span> raise:format:] + <span class="number">205</span></span><br><span class="line"><span class="number">3</span>   CoreFoundation                      <span class="number">0x00007fff30a01840</span> -[__NSCFString hasPrefix:] + <span class="number">96</span></span><br><span class="line"><span class="number">4</span>   Untitled                            <span class="number">0x000000010787fd60</span> main + <span class="number">64</span></span><br><span class="line"><span class="number">5</span>   libdyld.dylib                       <span class="number">0x00007fff58872015</span> start + <span class="number">1</span></span><br><span class="line">)</span><br><span class="line">libc++abi.dylib: terminating with uncaught exception of type <span class="built_in">NSException</span></span><br></pre></td></tr></table></figure><p>经过<code>1 warning generated</code>之后，果断崩溃了，还有明确的崩溃时候栈结构。</p><p>好，问题确定了就是这个<code>1 warning generated</code>造成的。改下就完事咯～～</p><h2 id="寻找问题"><a href="#寻找问题" class="headerlink" title="寻找问题"></a>寻找问题</h2><h3 id="尝试解除warning"><a href="#尝试解除warning" class="headerlink" title="尝试解除warning"></a>尝试解除warning</h3><p>远程进去之后我震惊了，<code>warning: 999+</code>。先快速找到问题，要什么自行车。。</p><p>Xcode中全局搜索<code>hasPrefix</code>关键字，带变量的全部加上断点。</p><p>run一下，问题依旧如此。。正如上面说的一样：</p><blockquote><p><code>First throw call stack</code>下方均为地址，说明此函数应该在一个<code>.a/.framework</code>中。</p></blockquote><p>GO DIE…</p><p>PS.</p><ul><li>关于<code>hasPrefix</code>函数的<a href="https://developer.apple.com/documentation/foundation/nsstring/1410309-hasprefix?language=objc">OC声明</a>、<a href="https://developer.apple.com/documentation/foundation/nsstring/1410309-hasprefix">swift声明</a>均为完整字符串，所以安心全局搜索就能找到代码中已存在的<code>hasPrefix</code>函数</li><li>顺便搜了一下该项目不包含第三方<code>.a</code>, 但是<code>.framework</code>不少。。有<a href="https://cocoapods.org/">CocoaPods</a>集成有直接拖进来的。。</li></ul><h3 id="尝试Method-Swizzling一下"><a href="#尝试Method-Swizzling一下" class="headerlink" title="尝试Method Swizzling一下"></a>尝试Method Swizzling一下</h3><p>这玩意既然在别人的framework中，那就更新一下咯，但是全部更新并不可取。。</p><p>framework的更新可能导致一些不可预估的可变因素。比如说API修改、内部逻辑变更导致外部使用不兼容、某些开发者喜欢直接修改framework、等。</p><p>所以先确定是哪个framework。</p><p>Method Swizzling。将其<code>-[__NSCFConstantString hasPrefix:]: nil argument</code>直接过滤<code>nil</code>，岂不美滋滋～～</p><p>好了先测试一下：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MySafeString</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MySafeString</span></span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    Class originalClass = <span class="built_in">NSClassFromString</span>(<span class="string">@&quot;__NSCFConstantString&quot;</span>);</span><br><span class="line">    Class swizzledClass = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">    SEL originalSelector = <span class="keyword">@selector</span>(hasPrefix:);</span><br><span class="line">    SEL swizzledSelector = <span class="keyword">@selector</span>(safe_hasPrefix:);</span><br><span class="line">    Method originalMethod = class_getInstanceMethod(originalClass, originalSelector);</span><br><span class="line">    Method swizzledMethod = class_getInstanceMethod(swizzledClass, swizzledSelector);</span><br><span class="line">    </span><br><span class="line">    IMP originalIMP = method_getImplementation(originalMethod);</span><br><span class="line">    IMP swizzledIMP = method_getImplementation(swizzledMethod);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *originalType = method_getTypeEncoding(originalMethod);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *swizzledType = method_getTypeEncoding(swizzledMethod);</span><br><span class="line">    </span><br><span class="line">    class_replaceMethod(originalClass,swizzledSelector,originalIMP,originalType);</span><br><span class="line">    class_replaceMethod(originalClass,originalSelector,swizzledIMP,swizzledType);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)safe_hasPrefix:(<span class="built_in">NSString</span> *)str &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> [<span class="keyword">self</span> safe_hasPrefix:str];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, @([<span class="string">@&quot;&quot;</span> hasPrefix:<span class="literal">nil</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Untitled.m:<span class="number">33</span>:<span class="number">29</span>: warning: null passed to a callee that requires a non-null argument [-Wnonnull]</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, @([<span class="string">@&quot;&quot;</span> hasPrefix:<span class="literal">nil</span>]));</span><br><span class="line">                            ^         ~~~</span><br><span class="line"><span class="number">1</span> warnings generated.</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-25</span> <span class="number">11</span>:<span class="number">32</span>:<span class="number">20.634</span> Untitled[<span class="number">54520</span>:<span class="number">926937</span>] <span class="number">1</span></span><br></pre></td></tr></table></figure><p>不崩溃了，赶紧粘过去，并在<code>- (BOOL)safe_hasPrefix:(NSString *)str</code>中的<code>return YES;</code>打上断点。</p><p>内心得到了极大的满足～ 美滋滋～～～</p><p>2分钟后。</p><p>断点停了，向<code>- (BOOL)safe_hasPrefix:(NSString *)str</code>的<code>str</code>传nil的调用者是<code>[MOBFErrorReportService writeHTTPErrorMsg:error:]</code>。</p><p>将<code>MOBFErrorReportService</code>放入<a href="https://www.google.com/">Google</a>看到第二个就是这个<a href="http://bbs.mob.com/thread-23618-1-1.html">[MOBFDevice duid] - BUG提交- Mob官方论坛</a>。文中指出<code>SDK 版本: ShareSDKVersion-3.5.1</code>。</p><p>好了看一下<code>ShareSDK</code>这个库。emmm 这个库是拖拽进去的。老哥说这项目接手之后没更新过这个库。</p><p>事已至此，确定是<code>ShareSDK</code>的问题。</p><p>更新之，问题解决～  真心的美滋滋～～</p><p>PS.</p><ul><li>上文中关于类簇的 Method Swizzling，详见<a href="http://www.tanhao.me/code/160723.html/">Method Swizzling的各种姿势</a>。</li></ul><h2 id="寻找的过程部分特写"><a href="#寻找的过程部分特写" class="headerlink" title="寻找的过程部分特写"></a>寻找的过程部分特写</h2><p>上面的逻辑并不是一气呵成，而是由于粗心也走了部分弯路，特列出来引以为戒。</p><h3 id="看到全局断点真的走不到时"><a href="#看到全局断点真的走不到时" class="headerlink" title="看到全局断点真的走不到时"></a>看到全局断点真的走不到时</h3><p>由于代码是公司代码，也没有demo,所以布吉岛为啥确实断点不会走。。。</p><p>MMP 看到了<code>First throw call stack</code>之后第一反应是，这些地址应该可以还原到对应的位置。</p><p>然后想到了逆向里面的骚操作。顿时想逆向分析一下。。。</p><p>但由于看了一下<code>.app</code>中的可执行文件有 ** 40M ** ,算了算了，IDA载入的有点慢，这要好久才能分析完。。</p><p>想了想天要下雨，媳妇和娃都在外面。果断放弃分析一波的冲动，来<code>Method Swizzling</code>会更快。</p><h3 id="看走眼的-Method-Swizzling"><a href="#看走眼的-Method-Swizzling" class="headerlink" title="看走眼的 Method Swizzling"></a>看走眼的 Method Swizzling</h3><p>之前看过这个<a href="http://www.tanhao.me/code/160723.html/">Method Swizzling的各种姿势</a>文章，印象深刻。</p><p>由于 ** Method Swizzling ** 风险不那么容易控制，所以并没用类簇相关的。</p><p>一顿<code>cmd c / cmd v</code>之后改了类名就扔了过去。当时大约这个样子：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)safe_hasPrefix:(<span class="built_in">NSString</span> *)str &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 此处会发生循环调用，是错误的示例</span></span><br><span class="line">        <span class="keyword">return</span> [(<span class="built_in">NSString</span> *)<span class="keyword">self</span> hasPrefix:str];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正如我刚在上面的备注一样。</p><p>脑袋一热，这类簇会不会有别的坑，然后过分的自信忽略了<code>safe_</code>前缀，并写了个C的前缀比较：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)safe_hasPrefix:(<span class="built_in">NSString</span> *)str &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((<span class="built_in">NSString</span> *)<span class="keyword">self</span>).length &lt; str.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 此处逻辑并未经过很多的测试用例测试，只是临时修补。实际方案应该直接调用safe_hasPrefix</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *str1 = [str cStringUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *str2 = [(<span class="built_in">NSString</span> *)<span class="keyword">self</span> cStringUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> idx = str.length; idx &gt;= <span class="number">0</span>; idx--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str1[idx] != str2[idx]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一番梭哈之后，定位到了问题。</p><p>但是今天复盘的时候想到这个类簇的IMP正常的操作也不可能出现循环调用。。。。</p><p>然后发现昨天的一番梭哈真的是弱智。。惭愧惭愧。。。</p><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><ul><li>解决问题的方案在于知识面的宽度。（一直为我没有通过<code>First throw call stack</code>直接定位而害羞）</li><li>着急下班的时候别写太多逻辑，容易漏。要么别着急，要么万分小心。</li><li>集成第三方SDK别瞎胡闹，使用代码直接集成(除非万不得已)。尽量使用<a href="https://cocoapods.org/">CocoaPods</a>这样的工具。</li><li>代码中的 ** warning ** 记得消一下。成天<code>999+</code> 容易漏掉关键信息。</li><li>开发的第三方SDK一定要注意测试覆盖率。</li><li>swift大法好。swift不用<code>!</code>绝对不会有机会出现<code>func hasPrefix(_ str: String) -&gt; Bool</code>中参数<code>str</code>传空的可能 :)</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;昨天下班时候一朋友碰到一个下面的崩溃，但是全局断点却无法断到指定位置。鉴于不信邪的态度，决定尝试一番。然后将此事记录如下文。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;*** Terminating app due to uncaught exception &amp;#39;NSInvalidArgumentException&amp;#39;, reason: &amp;#39;-[__NSCFConstantString hasPrefix:]: nil argument&amp;#39;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*** First throw call stack:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(0x18521ed8c .....)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;libc++abi.dylib: terminating with uncaught exception of type NSException&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="DEBUG" scheme="https://madordie.github.io/tags/DEBUG/"/>
    
  </entry>
  
  <entry>
    <title>sketech模块同步插件</title>
    <link href="https://madordie.github.io/post/sync-sketchplugin/"/>
    <id>https://madordie.github.io/post/sync-sketchplugin/</id>
    <published>2018-06-21T10:33:47.000Z</published>
    <updated>2018-06-22T02:27:56.050Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="Sketch-模块同步插件"><a href="#Sketch-模块同步插件" class="headerlink" title="Sketch 模块同步插件"></a>Sketch 模块同步插件</h2><p>通过该插件可以将sketch中的画板转换为data然后上传至服务器，并能通过插件将服务器的data下载至本地还原为之前的画板。</p><p><img src="https://github.com/madordie/sync-sketch-plugin/blob/master/Untitled.gif?raw=true" alt="预览"></p><a id="more"></a><h2 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h2><p>功能的实现都是通过<a href="https://www.sketchapp.com/">Sketch.app</a>的API实现</p><p>其核心功能就俩：</p><ul><li>将画板编码</li><li>解码为画板</li></ul><h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><p>由于功能并不复杂，但是sketch并没有完整的API文档，所以只能摸索着来，最后总结一下用到的API，只有下面的几个重要函数。</p><p>但是要找到这些API并不是随手一个Google可以得到，现将其列出，方便你能随手Google一下就得到：）</p><p>另外，下面几部分的代码都通过<a href="https://github.com/ccgus/CocoaScript">CocoaScript</a>的语法，所以可以直接应用到插件中。</p><p>为了能更好的理解和使用相关API，我尽量详细。</p><h3 id="将画板编码"><a href="#将画板编码" class="headerlink" title="将画板编码"></a>将画板编码</h3><p>本节会将所有已经选中的层所对应的画板转换为json字符串。</p><p>ps.</p><ul><li><code>层</code>包含sketch能够呈现的所有组件，包括但不限于：文本、矩形、图片、画板。</li><li>如果选中的层没有画板，将会被忽略。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> selection = context.selection,</span><br><span class="line">    artboards = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; selection.count(); i++) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 取出选中的所有画板</span></span><br><span class="line">        <span class="keyword">var</span> artboard = selection[i].parentArtboard();</span><br><span class="line">        <span class="keyword">if</span> (artboards.indexOf(artboard) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// 过滤重复的画板</span></span><br><span class="line">            artboards.push(artboard);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (artboards.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 并无选中的任何画板</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此时 artboards 数组， 即为当前选中的所有画板</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> selectionStrings = [];</span><br><span class="line">artboards.forEach(<span class="function"><span class="params">artboard</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 将画板转为JSON字符串，并保存在 selectionStrings 数组中</span></span><br><span class="line">        selectionStrings.push(MSJSONDataArchiver.archiveStringWithRootObject_error_(artboard.immutableModelObject(), nil));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将selectionStrings数组转为数组JSON字符串</span></span><br><span class="line"><span class="keyword">var</span> selectionsString = <span class="string">&#x27;[&#x27;</span> + selectionStrings.join(<span class="string">&#x27;,&#x27;</span>) + <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此时selectionsString字符串即为当前选中的所有画板的json数组字符串形式。 </span></span><br></pre></td></tr></table></figure><h3 id="解码为画板"><a href="#解码为画板" class="headerlink" title="解码为画板"></a>解码为画板</h3><p>接上一节的<code>selectionsString</code>。</p><p>先将<code>selectionsString</code>转为<code>page</code>的json数据，然后解析为一个新的<code>page</code>，并居中展示。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> selectionsString = res.layers,</span><br><span class="line">    pageUUID = NSUUID.UUID().UUIDString(),</span><br><span class="line">    <span class="comment">// 用page的JSON包裹selectionsString，同时生成一个新的UUID</span></span><br><span class="line">    pageString = <span class="string">&#x27;&#123;&quot;_class&quot;:&quot;page&quot;,&quot;do_objectID&quot;:&quot;&#x27;</span> + pageUUID + <span class="string">&#x27;&quot;,&quot;layers&quot;:&#x27;</span> + selectionsString + <span class="string">&#x27;&#125;&#x27;</span>,</span><br><span class="line">    data = NSString.alloc().initWithString(pageString).dataUsingEncoding_(<span class="number">4</span>),</span><br><span class="line">    <span class="comment">// 将JSON解码</span></span><br><span class="line">    unarchive = MSJSONDataUnarchiver.unarchiveObjectWithData(data),</span><br><span class="line">    <span class="comment">// 生成新的page</span></span><br><span class="line">    newPage = MSPage.alloc().initWithImmutableModelObject(unarchive),</span><br><span class="line">    <span class="comment">// 插入一个新的page</span></span><br><span class="line">    page = MSDocument.currentDocument().addBlankPage();</span><br><span class="line"><span class="comment">// 将生成的page所有的layers转移到新的page里面</span></span><br><span class="line">page.addLayers(newPage.layers());</span><br><span class="line"><span class="comment">// 为page设置哥名字</span></span><br><span class="line">page.setName(res.project);</span><br><span class="line"><span class="comment">// page剧中</span></span><br><span class="line">MSDocument.currentDocument().contentDrawView().centerLayersInCanvas();</span><br><span class="line">MSDocument.currentDocument().pageTreeLayoutDidChange();</span><br></pre></td></tr></table></figure><h3 id="其他代码"><a href="#其他代码" class="headerlink" title="其他代码"></a>其他代码</h3><p>关于别的后端操作啊 什么的我认为并不是核心代码。那代码谁都会写。。毕竟我写这个的时候只有2周的摸索经验😂，还是不聊这个了。</p><ul><li><code>sync-npm</code> 插件相关的目录，采用<a href="https://github.com/skpm/skpm">skpm</a>构建</li><li><code>sync-server</code> 插件对应的服务端代码，采用<a href="https://nodejs.org/en/">Node-js</a>构建</li></ul><h2 id="目前还存在的问题"><a href="#目前还存在的问题" class="headerlink" title="目前还存在的问题"></a>目前还存在的问题</h2><ul><li>如果是带图片的画板，并且较多的时候，<code>selectionsString</code>会很大，传输速度有点慢。。</li><li>UI交互有点吃藕。。最好开发一套macOS的UI，但是我还是只菜鸡。。</li><li>项目的代码我只是简简单单的连学带写2周做出来的。。写的不是一般的渣，见谅。。</li></ul><h2 id="你可能需要的参考资料"><a href="#你可能需要的参考资料" class="headerlink" title="你可能需要的参考资料"></a>你可能需要的参考资料</h2><ul><li>Sketch的头文件：<a href="https://github.com/abynim/Sketch-Headers">Sketch-Headers</a>，可以省去自己<a href="http://stevenygard.com/projects/class-dump/">class-dump</a>的麻烦.</li><li>插件开发神器：<a href="https://github.com/skpm/skpm">skpm</a></li><li>用来调试很不错：<a href="https://github.com/skpm/sketch-dev-tools">Sketch DevTools</a></li><li>官方开发文档：<a href="https://developer.sketchapp.com/">Sketch Developer</a></li><li>插件开发社区：<a href="https://sketchplugins.com/">Sketch Developers</a></li><li>插件使用的语言：<a href="https://github.com/ccgus/CocoaScript">CocoaScript</a>，但是并不仅限这一种哟</li><li>推荐搜索引擎: <a href="https://www.google.com/">Google</a>，别问我为什么用Google不用百度，我是不会告诉你sketch插件开发本来资料就少，国内更少的。。</li></ul><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>老规矩：<a href="https://github.com/madordie/sync-sketch-plugin">madordie/sync-sketch-plugin</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Sketch-模块同步插件&quot;&gt;&lt;a href=&quot;#Sketch-模块同步插件&quot; class=&quot;headerlink&quot; title=&quot;Sketch 模块同步插件&quot;&gt;&lt;/a&gt;Sketch 模块同步插件&lt;/h2&gt;&lt;p&gt;通过该插件可以将sketch中的画板转换为data然后上传至服务器，并能通过插件将服务器的data下载至本地还原为之前的画板。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/madordie/sync-sketch-plugin/blob/master/Untitled.gif?raw=true&quot; alt=&quot;预览&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="工具" scheme="https://madordie.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="Sketchplugin" scheme="https://madordie.github.io/tags/Sketchplugin/"/>
    
  </entry>
  
  <entry>
    <title>关于日志打印和过滤的那点破事</title>
    <link href="https://madordie.github.io/post/reverse-ios-socat-watch-filter/"/>
    <id>https://madordie.github.io/post/reverse-ios-socat-watch-filter/</id>
    <published>2018-06-14T16:00:00.000Z</published>
    <updated>2018-07-02T11:05:37.344Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>前两天，重启电脑突然发现我的<code>iOS8</code>设备无法连接到<code>MacOS</code>了。。</p><p>MMP，也就是说没有办法使用Xcode调试、之前使用的日志查看也没有办法继续。。</p><p>具体报错如下：<br><code>Xcode&lt;Version 9.4 (9F1027a)&gt;</code>报错如下: (我安装过<code>Xcode10 beta1</code>)<br><img src="/images/2018-06-15-10-13-16.png" alt="Xcode报错"></p><p><code>iTunes</code>报错如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iTunes 无法连接 iPhone “iPhone”，因为收到来自此设备的无效响应。</span><br></pre></td></tr></table></figure><p><img src="/images/2018-06-15-10-06-16.png" alt="iTunes报错"></p><p><code>Apple Configurator2</code>报错如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">已收到设备上的意外响应。</span><br></pre></td></tr></table></figure><p><img src="/images/2018-06-15-10-09-33.png" alt="Apple Configurator2报错"></p><a id="more"></a><p>还是 先来聊一下日志打印的几种方案吧。</p><h2 id="手机可以连接到MacOS"><a href="#手机可以连接到MacOS" class="headerlink" title="手机可以连接到MacOS"></a>手机可以连接到MacOS</h2><p>这种情况是最常见的，就是能在Xcode下Debug….</p><h3 id="方案一：Console-app-控制台"><a href="#方案一：Console-app-控制台" class="headerlink" title="方案一：Console.app(控制台)"></a>方案一：Console.app(控制台)</h3><p>这是MacOS自带的日志神器～ 效果顶呱呱👍👍👍，截图如下：<br><img src="/images/2018-06-15-10-23-02.png" alt="Console.app"></p><p>具体用法我就不说了。。。毕竟都是中文😂</p><h3 id="方案二：LogGuru"><a href="#方案二：LogGuru" class="headerlink" title="方案二：LogGuru"></a>方案二：LogGuru</h3><p><a href="https://github.com/madordie/LogGuru">madordie/LogGuru</a> 也不错，很久之前fork自<a href="https://github.com/FIRHQ/LogGuru">FIRHQ/LogGuru</a>，增加了直接过滤的功能，要不然速度真的很慢。。</p><p>只要插入USB，即可显示日志，还是不错滴。。</p><p><img src="/images/2018-06-15-10-29-07.png" alt="原来的截图"></p><h3 id="方案三-其他的"><a href="#方案三-其他的" class="headerlink" title="方案三: 其他的"></a>方案三: 其他的</h3><p>还有很多方案，比如说命令行啊、其他的工具啊，我就不说了，我觉得 <strong>Console.app(控制台)</strong> 就够了😂</p><h2 id="手机无法链接进MacOS"><a href="#手机无法链接进MacOS" class="headerlink" title="手机无法链接进MacOS"></a>手机无法链接进MacOS</h2><p>也就是最开始说的报错的情况下，可以连接进MacOS的方案均无法使用。苦逼，只能让iOS打印日志了。。</p><p>下面都是 <strong>越狱环境</strong> 下的。。不越狱还有人用iOS8么😂</p><p>先来看个文档：<a href="https://www.theiphonewiki.com/wiki/System_Log">The iPhone Wiki/System Log</a>,这里提供了很多方案，也非常全面，值得一试。</p><p>苦逼的事情是我手上的iOS8.4.1无法使用<code>syslogd to /var/log/syslog</code>插件，尝试使用<a href="https://www.theiphonewiki.com/wiki/System_Log#On-device_with_saving_to_a_file_via_a_Python_script">On-device with saving to a file via a Python script</a>的方案去解决也并不如意。。</p><p>开始用<a href="https://www.theiphonewiki.com/wiki/System_Log#On-device_with_socat">On-device with socat</a>（ 在<a href="http://bbs.iosre.com/">iosre</a>中也有一个类似的文章：<a href="http://bbs.iosre.com/t/ios-socat/139">iOS查看日志利器 —— socat</a>），说的都是相当的详细。</p><h3 id="socat的坑"><a href="#socat的坑" class="headerlink" title="socat的坑"></a>socat的坑</h3><h4 id="stop没有用"><a href="#stop没有用" class="headerlink" title="stop没有用"></a>stop没有用</h4><p>如<a href="http://bbs.iosre.com/t/ios-socat/139">iOS查看日志利器 —— socat</a>所说：</p><blockquote><p>输入watch查看，输入stop停止（不过停止貌似没用，也不知道为啥，知道的请告诉我）</p></blockquote><p>这个真的是没有用，所以<code>watch</code>功能就很鸡肋。。</p><h4 id="没有办法实时过滤"><a href="#没有办法实时过滤" class="headerlink" title="没有办法实时过滤"></a>没有办法实时过滤</h4><p>文中提到了很多过滤条件，但是一旦开启过滤，就没有办法显示实时日志。。也就是说无法和<code>watch</code>共存。。。</p><h3 id="换个姿势使用socat"><a href="#换个姿势使用socat" class="headerlink" title="换个姿势使用socat"></a>换个姿势使用socat</h3><p><code>socat</code>的日志都在终端上，不着色不说还有上面的两个很影响使用的问题。。。于是乎，为了增加过滤功能，需要通过管道将输出接入另外的命令如：<code>grep</code>等。</p><p><code>socat</code>命令需要手动输入<code>watch</code>才能显示出实时命令，这个让管道并不能直接使用。这里需要借助<code>expect</code>命令。</p><p>好了所有的点都通了，大致步骤如下：</p><h4 id="在mac上安装expect"><a href="#在mac上安装expect" class="headerlink" title="在mac上安装expect"></a>在mac上安装expect</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install expect</span><br></pre></td></tr></table></figure><h4 id="在mac的～-bash-profile配置"><a href="#在mac的～-bash-profile配置" class="headerlink" title="在mac的～/.bash_profile配置"></a>在mac的～/.bash_profile配置</h4><p>此处假设你的设备已经按照<a href="../reverse-ios-ssh">iOS逆向-设备ssh免密登录</a>配置好了：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> ios-<span class="function"><span class="title">socat</span></span>() &#123;</span><br><span class="line">    expect -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">        spawn ssh i5s \&quot;socat - UNIX-CONNECT:/var/run/lockdown/syslog.sock\&quot;</span></span><br><span class="line"><span class="string">        expect &#123;</span></span><br><span class="line"><span class="string">            \&quot;&gt; \&quot; &#123;send \&quot;watch\n\&quot;;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    interact&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>ios-socat</code> 函数名，在命令行可以直接输入函数名调用该函数</li><li><code>i5s</code> 在<code>~/.ssh/config</code>中配置的名字</li></ul><p>如果没有配置ssh免密呢需要这样：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> ios-<span class="function"><span class="title">socat</span></span>() &#123;</span><br><span class="line">    expect -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">        spawn ssh -p22 root@ios&#x27;s_ip \&quot;socat - UNIX-CONNECT:/var/run/lockdown/syslog.sock\&quot;</span></span><br><span class="line"><span class="string">        expect &#123;</span></span><br><span class="line"><span class="string">            \&quot;*password: \&quot; &#123;send \&quot;mypassword\n\&quot;;&#125;</span></span><br><span class="line"><span class="string">            \&quot;&gt; \&quot; &#123;send \&quot;watch\n\&quot;;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    interact&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>-p22</code> 端口号，22是默认不用写，但是其他的需要写。</li><li><code>ios&#39;s_ip</code> iOS设备的ip。</li><li><code>mypassword</code> iOS设备密码</li><li>这个我没测。。大致如此，我对<code>expect</code>的语法也不是很熟</li></ul><p>最后别忘了让<code>~/.bash_profile</code>生效：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure><p>然后只需要在命令行输入<code>ios-socat</code>就可以看到蹭蹭蹭的日志打印咯。。至于用什么管道啊都不是问题。</p><p>比如：<br>只显示包含<code>iosre</code>关键字的日志</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ios-socat | grep iosre</span><br></pre></td></tr></table></figure><h4 id="晋级用法"><a href="#晋级用法" class="headerlink" title="晋级用法"></a>晋级用法</h4><ul><li><p>我的iOS设备通过<code>iproxy</code>来进行端口映射。具体用法移步<a href="https://www.google.com/search?q=iproxy&oq=iproxy">Google</a></p></li><li><p>通过<code>ios-socat &gt; ~/Desktop/ios.log</code> 然后下载<a href="https://itunes.apple.com/cn/app/logtail/id1073404370?mt=12">LogTail</a>，剩下的摸索一下咯</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2></li></ul><p>我还不清楚究竟什么原因导致了<code>收到来自此设备的无效响应</code>错误，布吉岛系统修改了什么。我尝试重新安装iTunes、Xcode都无效（据说陌陌的开发为这个无法调试直接将系统降级是可以的😂）。。有老铁懂得指点下～～</p><p>目前虽然上面都可以用，但是看个日志并不能满足我的野心，最后在移动硬盘里做了一个10.12的系统😂，用了Console.app…</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;前两天，重启电脑突然发现我的&lt;code&gt;iOS8&lt;/code&gt;设备无法连接到&lt;code&gt;MacOS&lt;/code&gt;了。。&lt;/p&gt;
&lt;p&gt;MMP，也就是说没有办法使用Xcode调试、之前使用的日志查看也没有办法继续。。&lt;/p&gt;
&lt;p&gt;具体报错如下：&lt;br&gt;&lt;code&gt;Xcode&amp;lt;Version 9.4 (9F1027a)&amp;gt;&lt;/code&gt;报错如下: (我安装过&lt;code&gt;Xcode10 beta1&lt;/code&gt;)&lt;br&gt;&lt;img src=&quot;/images/2018-06-15-10-13-16.png&quot; alt=&quot;Xcode报错&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;iTunes&lt;/code&gt;报错如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;iTunes 无法连接 iPhone “iPhone”，因为收到来自此设备的无效响应。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;/images/2018-06-15-10-06-16.png&quot; alt=&quot;iTunes报错&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Apple Configurator2&lt;/code&gt;报错如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;已收到设备上的意外响应。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;img src=&quot;/images/2018-06-15-10-09-33.png&quot; alt=&quot;Apple Configurator2报错&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="逆向" scheme="https://madordie.github.io/tags/%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>iOS逆向-创建Cydia源</title>
    <link href="https://madordie.github.io/post/reverse-ios-creat-cydia-sources/"/>
    <id>https://madordie.github.io/post/reverse-ios-creat-cydia-sources/</id>
    <published>2018-01-01T16:00:00.000Z</published>
    <updated>2018-06-21T10:31:28.035Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>搭建自己的cydia源。</p><a id="more"></a><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul><li>Ubuntu 16.04 LTS</li></ul><h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><h4 id="dpkg-dev"><a href="#dpkg-dev" class="headerlink" title="dpkg-dev"></a>dpkg-dev</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install dpkg-dev</span><br><span class="line">$ dpkg-scanpackages --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install nginx</span><br></pre></td></tr></table></figure><h3 id="开工"><a href="#开工" class="headerlink" title="开工"></a>开工</h3><h4 id="准备deb"><a href="#准备deb" class="headerlink" title="准备deb"></a>准备deb</h4><p>此处目录为<code>/opt/cydia/debs</code>，可以为别的，但是建议你也这样做:)。</p><h4 id="生成依赖"><a href="#生成依赖" class="headerlink" title="生成依赖"></a>生成依赖</h4><p>更新插件需要重新执行哟。。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/cydia</span><br><span class="line">$ dpkg-scanpackages -m ./debs /dev/null &gt; Packages</span><br><span class="line">$ bzip2 Packages</span><br></pre></td></tr></table></figure><h4 id="添加sources-list"><a href="#添加sources-list" class="headerlink" title="添加sources.list"></a>添加sources.list</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;deb file:///opt/cydia ./debs/&quot;</span> &gt;&gt; /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>ps. 注意路径信息</p><h4 id="更新一下"><a href="#更新一下" class="headerlink" title="更新一下"></a>更新一下</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update</span><br></pre></td></tr></table></figure><h4 id="扔出去"><a href="#扔出去" class="headerlink" title="扔出去"></a>扔出去</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /var/www/html</span><br><span class="line">$ ln -s /opt/cydia cydia</span><br><span class="line">$ /etc/init.d/nginx start</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="http://www.saurik.com/id/7">http://www.saurik.com/id/7</a></li><li><a href="https://bbs.feng.com/read-htm-tid-8052646.html">https://bbs.feng.com/read-htm-tid-8052646.html</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;搭建自己的cydia源。&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="逆向" scheme="https://madordie.github.io/tags/%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>描述文件获取UDID</title>
    <link href="https://madordie.github.io/post/ios-tool-configurator-get-udid/"/>
    <id>https://madordie.github.io/post/ios-tool-configurator-get-udid/</id>
    <published>2017-12-06T16:00:00.000Z</published>
    <updated>2018-08-13T02:19:58.647Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="UDID"><a href="#UDID" class="headerlink" title="UDID"></a>UDID</h3><p>对，就是在iTunes等工具上看到的UDID..</p><a id="more"></a><h3 id="工具及文档"><a href="#工具及文档" class="headerlink" title="工具及文档"></a>工具及文档</h3><p>嗯，Apple出的为数不多的mac app:<a href="https://itunes.apple.com/cn/app/apple-configurator-2/id1037126344?mt=12">Apple Configurator 2</a></p><p>这个工具是有中文文档的：<a href="http://help.apple.com/configurator/mac/2.3/">Apple Configurator 2 官方文档</a></p><p>当然还有比较暴力的直接写xml: <a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/iPhoneOTAConfiguration/ConfigurationProfileExamples/ConfigurationProfileExamples.html">Apple的相关文档</a></p><hr><ul><li><a href="http://www.skyfox.org/safari-ios-device-udid.html">通过Safari浏览器获取iOS设备UDID(设备唯一标识符)</a></li><li><a href="http://www.skyfox.org/ios-mobileconfig-sign.html">为iOS的mobileconfig文件进行签名</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;UDID&quot;&gt;&lt;a href=&quot;#UDID&quot; class=&quot;headerlink&quot; title=&quot;UDID&quot;&gt;&lt;/a&gt;UDID&lt;/h3&gt;&lt;p&gt;对，就是在iTunes等工具上看到的UDID..&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="tool" scheme="https://madordie.github.io/tags/tool/"/>
    
      <category term="UDID" scheme="https://madordie.github.io/tags/UDID/"/>
    
  </entry>
  
  <entry>
    <title>「转」一张思维导图，让正则表达式不再难懂</title>
    <link href="https://madordie.github.io/post/reprinted-regular-mind-map/"/>
    <id>https://madordie.github.io/post/reprinted-regular-mind-map/</id>
    <published>2017-10-15T16:00:00.000Z</published>
    <updated>2017-10-16T02:26:02.834Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><img src="/images/bruch-up-regular-expressions-1.png" alt="思维导图"></p><a id="more"></a><h2 id="字符"><a href="#字符" class="headerlink" title="字符"></a>字符</h2><ul><li><p>普通字符：字母、数字、汉字、下划线，匹配与之相同的一个字符</p></li><li><p>简单转义字符：\n（换行）,\t（制表）,\（\本身）和 ^…（^等有特殊作用的符号如要匹配自己的话要用转义）</p></li><li><p>标准字符集合<br>注意区分大小写，大写是相反的意思，匹配相反是不匹配</p><ul><li>\d<br>  任意一个数字，0~9</li><li>\w<br>  任意一个字母、数字、汉字或下划线，A<del>Z、a</del>z、0~9、_和任意一个汉字</li><li>\s<br>  任意空白符，包括空格、制表符、换行符</li><li>.<br>  小数点可以匹配任意一个字符，换行除外（如果要匹配包括”\n”在内的所有字符，一般用[\s\S]）</li></ul></li><li><p>自定义字符集合<br>[ ]方括号匹配方式，能够匹配方括号中的任意一个字符,^表示取反</p><ul><li>[ab5@]<br>  匹配”a”或”b”或”5”或”@”</li><li>[^abc]<br>  匹配a、b、c之外的任意字符</li><li>[f-k]<br>  匹配“f”到”k”之间的字符</li><li>[^A-F0-3]<br>  匹配“A”-“F”,”0”-“3”之外的任意一个字符</li></ul></li></ul><h2 id="量词-Quantifier"><a href="#量词-Quantifier" class="headerlink" title="量词(Quantifier)"></a>量词(Quantifier)</h2><p>修饰前面的一个表达式，如果要修饰多个表达式，就用( )把表达式包起来</p><ul><li>{n}<br>  表达式重复n次​</li><li>{m,n}<br>  表达式至少重复m次，最多重复n次<ul><li>贪婪模式 （默认）<br>匹配符合的最长的字符串</li><li>非贪婪模式 （在量词后面加 ? 例：{m,n}? )<br>  匹配符合的最短的字符串</li></ul></li><li>{m,}<br>  表达式至少重复m次</li><li>？<br>  匹配表达式0或1次，相当于{0,1}</li><li>+<br>  表达式至少出现一次，相当于{1,}</li><li>*<br>  表达式不出现或出现任意次，相当于{0,}</li></ul><h2 id="字符边界"><a href="#字符边界" class="headerlink" title="字符边界"></a>字符边界</h2><pre><code>零宽：匹配的不是字符而是位置，符合某种条件的位置</code></pre><ul><li>^<br>  与字符串开始的地方匹配</li><li>$<br>  与字符串结束的地方匹配</li><li>\b<br>  匹配一个单词的边界，当前位置前面的字符和后面的字符不全是\w</li></ul><h2 id="预搜索（零宽断言、环视）"><a href="#预搜索（零宽断言、环视）" class="headerlink" title="预搜索（零宽断言、环视）"></a>预搜索（零宽断言、环视）</h2><p>零宽：匹配的不是字符而是位置，符合某种条件的位置</p><ul><li>(?=exp)<br>  断言自身出现的位置的后面能匹配表达式exp</li><li>(?!exp)<br>  断言自身出现的位置的后面不能匹配表达式exp</li><li>(?&lt;=exp)<br>  断言自身出现的位置的前面能匹配表达式exp</li><li>(?&lt;!exp)<br>  断言自身出现的位置的前面不能匹配表达式exp</li></ul><h2 id="匹配模式"><a href="#匹配模式" class="headerlink" title="匹配模式"></a>匹配模式</h2><p>对文本的处理方式</p><ul><li>IGNORECASE 忽略大小写模式<br>  匹配时忽略大小写<br>  默认是区分大小写的</li><li>SINGLELINE 单行模式<br>  整个文本看作一个字符串，只有一个开头一个结尾<br>  使小数点”.”可以匹配包含换行符(\n)在内的任意字符</li><li>MULTILINE 多行模式<br>  每行都是一个字符串<br>  在多行模式下，如果需要仅匹配字符串开始和结束位置，可以使用\A和\Z</li></ul><h2 id="选择符和分组"><a href="#选择符和分组" class="headerlink" title="选择符和分组"></a>选择符和分组</h2><p>分支结构、捕获组合非捕获组</p><ul><li>| 分支结构​<br>  左右表达式之间“或”关系，匹配左边或右边</li><li>( ) 捕获组<br>  （1）、在被修饰匹配次数的时候，括号中的表达式可以作为整体被修饰<br>  （2）、取匹配结果的时候，括号中的表达式匹配到的内容可以被单独得到<br>  （3）、每一对括号会分配一个编号，使用（）的捕获根据左括号的顺序从1开始自动编号。捕获编号为零的第一个捕获是整个正则表达式模式匹配的文本<br>   反向引用：通过反向引用，可以对分组已捕获的字符串进行引用。</li><li>(?:Expression) 非捕获组<br>  一些表达式中，不得不使用（），但又不需要保存（）中子表达式匹配的内容，这时可以用非捕获组来抵消（）带来的副作用。</li></ul><hr><p>原文：<a href="https://my.oschina.net/u/3080373/blog/1550653">一张思维导图，让正则表达式不再难懂</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;/images/bruch-up-regular-expressions-1.png&quot; alt=&quot;思维导图&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="工具" scheme="https://madordie.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="正则表达式" scheme="https://madordie.github.io/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>用CollectionView简化代码，专注于业务和UI</title>
    <link href="https://madordie.github.io/post/ios-tool-collectionview-simplify-business/"/>
    <id>https://madordie.github.io/post/ios-tool-collectionview-simplify-business/</id>
    <published>2017-10-11T16:00:00.000Z</published>
    <updated>2020-05-18T02:46:39.005Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><code>UITableView</code>作为高级控件被开发者广泛使用，同样的，<code>UICollectionView</code>由于其NB的布局也被广泛使用。但是后者在使用的时候大多数都属于自定义的比较多，前者则相对普通，list基本上都用。</p><p>在业务需求中，常规布局，大多数都是采用<code>UITableView</code>进行的，但是有痛点：</p><ul><li>当使在APP内用过一次瀑布流之后，设计师会突然的让你在正常的list中底部追加瀑布流。。虽然是在底部追加，但是要从<code>UITableView</code>迁移到<code>UICollectionView</code></li><li><code>UITableViewDelegate</code>、<code>UITableViewDataSource</code> 恐怕每处使用都要写繁琐的相同的代码吧～</li><li>很多人也会对其进行高度缓存啊神马的优化策略</li><li>不知不觉这些代码堆在一起已经将<code>UIViewController</code>堆的相当的高</li></ul><p>然后呢，我们现在使用一个<code>CollectionView</code>将这些操作包装一下，达到这样一个流程:</p><ol><li><p>自定义Cell、CellModel</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LabelCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> info = <span class="type">UILabel</span>()</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">sizeThatFits</span><span class="params">(<span class="number">_</span> size: CGSize)</span></span> -&gt; <span class="type">CGSize</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGSize</span>(width: size.width, height: info.frame.maxY + info.frame.minY)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">LabelCell</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span>: <span class="title">ListItemDefaultProtocol</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> info: <span class="type">String?</span></span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(view: LabelCell)</span></span> &#123;</span><br><span class="line">            view.info.text = info</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>请求、处理数据格式化为<code>LabelCell.Model</code>这样的类</p></li><li><p>处理好的数据交给<code>CollectionView</code></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list.sections = model.format(...)</span><br></pre></td></tr></table></figure></li><li><p>休息一会，完工了～</p></li></ol><p>然后，来看看<code>Collection</code>里面都做了什么操作</p><a id="more"></a><h3 id="CollectionView"><a href="#CollectionView" class="headerlink" title="CollectionView"></a>CollectionView</h3><p>为了达到上面效果中的第三步，我们需要自定义一个<code>CollectionView</code>来处理刷新数据、设置代理、设置数据源、注册cell、等操作。</p><p>需要说明的是，此处使用<a href="https://github.com/chiahsien/CHTCollectionViewWaterfallLayout"><code>CHTCollectionViewWaterfallLayout</code></a>来处理瀑布流。</p><p>创建一个<code>CollectionViewSection</code>的类/结构体来保存section信息。比如说：<code>sectionInset</code>、<code>minimumColumnSpacing</code>、<code>minimumInteritemSpacing</code>、<code>columnCount</code>、等</p><p>在<code>CollectionView</code>中设置一个<code>var sections = [KTJCollectionViewSection]()</code>用于保存sections</p><p>实现<code>UICollectionViewDataSource</code>、 <code>UICollectionViewDelegate</code>。此处省略约1千字…</p><h3 id="ListItemDefaultProtocol：绑定Cell和Model"><a href="#ListItemDefaultProtocol：绑定Cell和Model" class="headerlink" title="ListItemDefaultProtocol：绑定Cell和Model"></a>ListItemDefaultProtocol：绑定Cell和Model</h3><p>上面<code>省略约1千字</code>中有一个并没有说：<code>CollectionViewSection</code>的<code>header</code>、<code>items</code>、<code>footer</code>如何实现。😂</p><p>好了，此处这三个均采用协议<code>ListItemDefaultProtocol</code>来实现。（PS：大家都喜欢用父类，但父类只有一个，为了兼容和冲突，这里协议是最好不过的～，特别是swift中的协议）</p><p>协议需要给出这么几个信息：</p><ul><li><code>reuseIdentifier</code> 用来复用的重用标识符</li><li><code>cellClass</code> 用来注册用的类名</li><li><code>func fillModel(item: AnyObject)</code> 用来给cell填充model的方法</li></ul><p>那么这个协议就出来了：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">KTJListItemProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> identifa: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="keyword">var</span> registClass: <span class="type">AnyClass</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(item: AnyObject)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<strong>swift</strong>协议支持默认实现，于是乎，就可以再写一个:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ListItemDefaultProtocol</span>: <span class="title">KTJListItemProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">ItemType</span>: <span class="type">UIView</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(view: ItemType)</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ListItemDefaultProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> identifa: <span class="type">String</span> &#123; <span class="keyword">return</span>  <span class="type">NSStringFromClass</span>(<span class="type">ItemType</span>.<span class="keyword">self</span>)&#125;</span><br><span class="line">    <span class="keyword">var</span> registClass: <span class="type">AnyClass</span> &#123; <span class="keyword">return</span> <span class="type">ItemType</span>.<span class="keyword">self</span> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(item: AnyObject)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> reusableView = item <span class="keyword">as</span>? <span class="type">ItemType</span> &#123;</span><br><span class="line">            fillModel(view: reusableView)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后，就可以愉快的玩耍了～～</p><p>最后Cell中的的代码效果就是<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView-simplify-business/LabelCell.swift">这个样子</a>。<br>再加上<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView-simplify-business/ViewController.swift">数据填充</a>是不是很简单了呢～～</p><h3 id="以后如何开发"><a href="#以后如何开发" class="headerlink" title="以后如何开发"></a>以后如何开发</h3><p>真的如同前面的例子一样，只需要这么几步绕不过去的：</p><ol><li>处理接口吐出来的数据。</li><li>创建新的UI样式，并做好接口数据中间件。</li><li>点击事件在处理数据的时候预先埋好，所有的数据、逻辑和UI数据一起被传递，不需要多次类型判断。</li></ol><p>统一使用<code>CollectionView</code>还有一个好处：不管前面谁写的一个UI，都能拉过来用。不用做中间层去从<code>TableViewCell</code>转<code>CollectionViewCell</code>。</p><p>开发只需要关心业务，业务。安安心心做一个写业务的程序员吧～</p><h3 id="关于Cell的跳转处理"><a href="#关于Cell的跳转处理" class="headerlink" title="关于Cell的跳转处理"></a>关于Cell的跳转处理</h3><p>乍一看，完美了。不过还有一个巨烦的跳转处理。。。不过，<strong>莫怕</strong></p><p>跳转，有这么几种：</p><ul><li>支持路由的URL跳转，这个是最简单的，也是最爽的</li><li>只能复杂的进行创建类、赋值、push啊神马的</li></ul><p>由于我们将数据全部处理好后扔给了<code>cellmodel</code>，而跳转、打点所需要的参数均在此处为最全的，我们可以将回调作为数据一起传递。。</p><p>嗯, 事件需要传递的对象大约这个样子：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Jmp</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// 支持URL跳转的URL</span></span><br><span class="line">    <span class="keyword">let</span> url: <span class="type">String?</span></span><br><span class="line">    <span class="comment">/// 打点事件名</span></span><br><span class="line">    <span class="keyword">let</span> event: <span class="type">String?</span></span><br><span class="line">    <span class="comment">/// 打点参数</span></span><br><span class="line">    <span class="keyword">let</span> attr: [<span class="type">AnyHashable</span>: <span class="type">Any</span>]?</span><br><span class="line">    <span class="comment">/// 不支持URL的直接回调</span></span><br><span class="line">    <span class="keyword">let</span> eventCallback: (() -&gt; <span class="type">Void</span>)?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后cell对应的另一个类是这样的：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KTJJmp</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> info: <span class="type">Jmp?</span></span><br><span class="line">    <span class="keyword">let</span> action = #selector(topVCJmp)</span><br><span class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">topVCJmp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ... <span class="comment">// 打点</span></span><br><span class="line">        <span class="type">KTJURLJump</span>.jumpToViewOnTopVC(jmp: info)</span><br><span class="line">        info?.eventCallback?()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tap</span><span class="params">()</span></span> -&gt; <span class="type">UITapGestureRecognizer</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">UITapGestureRecognizer</span>(target: <span class="keyword">self</span>, action: #selector(topVCJmp))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两个类共同作用就是：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JmpCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> jmp = <span class="type">JmpCellModel</span>()</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setup</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        jmpBtn.addTarget(jmp, action: jmp.action, <span class="keyword">for</span>: .touchUpInside)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JmpCellModel</span>: <span class="title">ListItemDefaultProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> jmp: <span class="type">Jmp?</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fillModel</span><span class="params">(view: JmpCell)</span></span> &#123;</span><br><span class="line">        view.jmp.info = jmp</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至于这个<code>JmpCellModel.jmp</code>怎么生成，这里就不说了。</p><h3 id="关于算高那点事"><a href="#关于算高那点事" class="headerlink" title="关于算高那点事"></a>关于算高那点事</h3><h4 id="算高位置的选择"><a href="#算高位置的选择" class="headerlink" title="算高位置的选择"></a>算高位置的选择</h4><p>我也曾纠结过frame的代码应该写在哪里。。有写在初始化的，有单独写一个方法的，还有写在<code>func sizeThatFits(:) -&gt; CGSize</code></p><p>由于当年对<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell">UITableView-FDTemplateLayoutCell</a>中毒较深，所以沿用了最后一种方案。</p><h4 id="算高使用的view的选择"><a href="#算高使用的view的选择" class="headerlink" title="算高使用的view的选择"></a>算高使用的view的选择</h4><p>在算高的时候，首先需要明确的是：<strong>高度是数据和当前最大宽度共同决定的</strong>，所以在算高的时候需要拿着数据、view然后才能去算高（PS：至于那些拿着数据硬算出一个高度的代码，此处不发表看法😂，早晚会后悔的）</p><p>然后就是<code>UITableView</code>、<code>UICollectionView</code>的算高是通过一个单独的代理去获取的，并不提供view去计算。。这就是矛盾的地方。</p><p>虽然<code>UITableView</code>、<code>UICollectionView</code>在算高的地方不提供View,但是有一个<code>dequeueReusableCell....</code>的方法可以获取到缓存池中的<code>Cell</code>呀</p><p>如果你这样做了，那么你将会付出惨重的代码。这个方案我在<a href="http://www.cnblogs.com/madordie">博客园</a>2015.03.17的<a href="http://www.cnblogs.com/madordie/p/4344209.html">“iOS 优化性能之TableView”</a>中已经说了：</p><blockquote><p>dequeueReusableCellWithIdentifier:此函数的调用要注意以下几点：<br>    i.此函数的返回值是做为tableView:cellForRowAtIndexPath:的返回值的。这样保证拿出来的完整还给TableView。<br>    ii.如果此函数的返回值不是为了给tableView:cellForRowAtIndexPath:做返回值，那么你要注意这是在一个拿取别人稀缺资源的操作，需要注意珍惜这个返回值，能不浪费就不要浪费。<br>    iii.对于AL自动适应的TableView取Cell时候要注意保存。个人建议封装TableView，然后用来计算高度的Cell保存在TableView中。对于多种类型的Cell，则可以使用复用标识符作为Key的字典来存储。这样能够有效节约dequeueReusableCellWithIdentifier:调用次数。</p></blockquote><p><code>UICollectionView</code>也是如此。所以使用<code>dequeueReusableCell....</code>方法是<strong>很不靠谱的</strong>。</p><p>在<a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell/blob/912b3ce4a61198c0b79a3d85b977f8fdacd153ea/Classes/UITableView%2BFDTemplateLayoutCell.m#L134-#L155">UITableView-FDTemplateLayoutCell</a>中使用了字典保存缓存算高的View，也是比较赞的。</p><p>但是现在有了<code>CollectionView</code>，我们可以不用OC的<code>objc_setAssociatedObject(,,,)</code>去处理而直接使用了<code>NSCache</code>去处理就行了～</p><p>如果看了<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView.swift"><code>CollectionView</code></a>就会发现，<code>ListItemProtocol</code>还有一个get方法<code>var newItem: AnyObject &#123; get &#125;</code>这个是用来算高的。</p><p>在<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView.swift">CollectionView.swift</a>关于高度的代理设置中可以看到相关获取和设置。</p><h4 id="算高的时候变局的控制"><a href="#算高的时候变局的控制" class="headerlink" title="算高的时候变局的控制"></a>算高的时候变局的控制</h4><p>高度的计算现在已经可以正常计算，但是对于<code>columnCount &gt; 1</code>的时候，牵扯到间隙的计算需要注意一次啊。毕竟<code>CHTCollectionViewWaterfallLayout</code>功能更强大。</p><p>相关代码在<a href="https://github.com/madordie/collectionview-simplify-business/blob/master/CollectionView.swift">CollectionView.swift</a>的<code>func collectionView(:,layout:,sizeForItemAt:) -&gt; CGSize</code>函数中。</p><h3 id="关于代理那点事"><a href="#关于代理那点事" class="headerlink" title="关于代理那点事"></a>关于代理那点事</h3><p>丫的，需求总是比想的多，但是办法也比问题多。</p><p>对于<code>CollectionView</code>来说，代理都设置成了self，这样会导致有时候需要<code>UIScrollViewDelegate</code>干些事情的时候总是不那么自由。。。实乃新痛点，不过有办法。</p><p>下面是几种方案：</p><h4 id="KVO"><a href="#KVO" class="headerlink" title="KVO"></a>KVO</h4><p>直接KVO到<code>self.contentOffset</code>，这样一了百了。写什么代理，要什么自行车！（PS：swift提供闭包的代理，也是很好用的）</p><p>如果不会，请自行<a href="https://www.google.com/">Google</a>。<a href="https://objccn.io/issue-7-3/">ObjC-中国：KVC 和 KVO</a>，我只能帮你到这里</p><h4 id="Rx系"><a href="#Rx系" class="headerlink" title="Rx系"></a>Rx系</h4><p>很抱歉，你不能用<code>self.rx.contentOffset</code>。原因是<a href="https://github.com/chiahsien/CHTCollectionViewWaterfallLayout"><code>CHTCollectionViewWaterfallLayout</code></a>中有这么一行断言：</p><blockquote><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NSAssert</span>([<span class="keyword">self</span>.delegate conformsToProtocol:@<span class="class"><span class="keyword">protocol</span>(<span class="title">CHTCollectionViewDelegateWaterfallLayout</span>)], @&quot;<span class="title">UICollectionView</span>&#x27;<span class="title">s</span> <span class="title">delegate</span> <span class="title">should</span> <span class="title">conform</span> <span class="title">to</span> <span class="title">CHTCollectionViewDelegateWaterfallLayout</span> <span class="title">protocol</span>&quot;);</span></span><br></pre></td></tr></table></figure></blockquote><p><strong>但是</strong>，你可以使用Rx里面的KVO呀～也是贼方便</p><h4 id="RAC系"><a href="#RAC系" class="headerlink" title="RAC系"></a>RAC系</h4><p>抱歉，我不会。原因在此<a href="../reactivecocoa-ready-to-use">准备食用RAC(ReactiveCocoa)的顾虑</a></p><h4 id="代理传递"><a href="#代理传递" class="headerlink" title="代理传递"></a>代理传递</h4><p>当然也可以使用代理进行传递出去。大致这个样子：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">CollectionViewDelegate</span>: <span class="title">NSObjectProtocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectionView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> allDelegate: <span class="type">CollectionViewDelegate?</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.allDelegate?.collectionView(<span class="keyword">self</span>, didSelectItemAt: indexPath)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这方案没啥聊的。。</p><h3 id="OC咋办？"><a href="#OC咋办？" class="headerlink" title="OC咋办？"></a>OC咋办？</h3><p>这个OC也能用，只不过需要一些手段，比如说：继承、扩展、等</p><p><code>ListItemProtocol</code>就是为了给OC使用留的，还有就是<code>CollectionViewSection</code>使用了类，而不是结构体。</p><p>不过具体没有例子，不想写OC代码，太麻烦了。。主要是这种思路:)</p><h3 id="填充Cell的数据为什么会在CellModel中？"><a href="#填充Cell的数据为什么会在CellModel中？" class="headerlink" title="填充Cell的数据为什么会在CellModel中？"></a>填充Cell的数据为什么会在CellModel中？</h3><p>对于Cell来说，Cell是干净的，没有任何继承、协议来限制Cell如何处理。那么Cell就可以接受来自任何模块的各种风格的Cell，这是我想要的减少侵入。</p><p>cellModel中定义了Cell所对应的填充数据格式，在第一次写的时候难免会按照业务逻辑起一些业务逻辑的名字，在复用的时候又不能改名字，会对维护和开发加了一定量的复杂度，这不是我想要的。。</p><p>于是乎每个CellModel根据自己的需要绑定需要绑定的Cell，去填充Cell所对应的数据就好。只需要侵入cellModel即可。代价最小，受益最大。</p><p>PS.对于同一个List，需要注意cell的复用和多个cellModel同时绑定一个cell时，属性的设置。</p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p><a href="https://github.com/madordie/collectionview-simplify-business">Demo</a>部分没有写跳转相关内容，但是别的都有了😂</p><h3 id="别的"><a href="#别的" class="headerlink" title="别的"></a>别的</h3><p>好像没了吧～，想起来了再补充咯</p><h3 id="偶然看到一个类似的文章"><a href="#偶然看到一个类似的文章" class="headerlink" title="偶然看到一个类似的文章"></a>偶然看到一个类似的文章</h3><blockquote><p><a href="https://www.appcoda.com.tw/tableview-mvvm/">Table View 太複雜？利用 MVVM 和 Protocol 就可以為它重構瘦身！</a></p></blockquote><p>昨天(2018.7.24)翻文章的时候看到这个文章，然后将文章和代码捋了一下，发现这才是MVVM吧。觉得不错，贴出来～</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;UITableView&lt;/code&gt;作为高级控件被开发者广泛使用，同样的，&lt;code&gt;UICollectionView&lt;/code&gt;由于其NB的布局也被广泛使用。但是后者在使用的时候大多数都属于自定义的比较多，前者则相对普通，list基本上都用。&lt;/p&gt;
&lt;p&gt;在业务需求中，常规布局，大多数都是采用&lt;code&gt;UITableView&lt;/code&gt;进行的，但是有痛点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;当使在APP内用过一次瀑布流之后，设计师会突然的让你在正常的list中底部追加瀑布流。。虽然是在底部追加，但是要从&lt;code&gt;UITableView&lt;/code&gt;迁移到&lt;code&gt;UICollectionView&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;UITableViewDelegate&lt;/code&gt;、&lt;code&gt;UITableViewDataSource&lt;/code&gt; 恐怕每处使用都要写繁琐的相同的代码吧～&lt;/li&gt;
&lt;li&gt;很多人也会对其进行高度缓存啊神马的优化策略&lt;/li&gt;
&lt;li&gt;不知不觉这些代码堆在一起已经将&lt;code&gt;UIViewController&lt;/code&gt;堆的相当的高&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;然后呢，我们现在使用一个&lt;code&gt;CollectionView&lt;/code&gt;将这些操作包装一下，达到这样一个流程:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;自定义Cell、CellModel&lt;/p&gt;
&lt;figure class=&quot;highlight swift&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;LabelCell&lt;/span&gt;: &lt;span class=&quot;title&quot;&gt;UICollectionViewCell&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; info = &lt;span class=&quot;type&quot;&gt;UILabel&lt;/span&gt;()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sizeThatFits&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;number&quot;&gt;_&lt;/span&gt; size: CGSize)&lt;/span&gt;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;type&quot;&gt;CGSize&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;type&quot;&gt;CGSize&lt;/span&gt;(width: size.width, height: info.frame.maxY + info.frame.minY)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;extension&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;LabelCell&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Model&lt;/span&gt;: &lt;span class=&quot;title&quot;&gt;ListItemDefaultProtocol&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; info: &lt;span class=&quot;type&quot;&gt;String?&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;fillModel&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(view: LabelCell)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            view.info.text = info&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;请求、处理数据格式化为&lt;code&gt;LabelCell.Model&lt;/code&gt;这样的类&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;处理好的数据交给&lt;code&gt;CollectionView&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight swift&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;list.sections = model.format(...)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;休息一会，完工了～&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;然后，来看看&lt;code&gt;Collection&lt;/code&gt;里面都做了什么操作&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="tool" scheme="https://madordie.github.io/tags/tool/"/>
    
      <category term="UICollectionView" scheme="https://madordie.github.io/tags/UICollectionView/"/>
    
  </entry>
  
  <entry>
    <title>mac10.13 pods 命令错误</title>
    <link href="https://madordie.github.io/post/macos-high-sierra-cocoapods/"/>
    <id>https://madordie.github.io/post/macos-high-sierra-cocoapods/</id>
    <published>2017-09-29T06:03:58.000Z</published>
    <updated>2017-10-10T06:08:43.665Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>每逢升级大版本总要过搞点事情。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pod env</span><br><span class="line">-bash: /usr/<span class="built_in">local</span>/bin/pod: /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby: bad interpreter: No such file or directory</span><br></pre></td></tr></table></figure><p>不论是<code>pod env</code>、<code>pod update</code> 等等均报上面的错误。</p><p>如果Google发现：</p><ul><li><a href="https://stackoverflow.com/questions/44396215/cocoapods-not-working-in-macos-high-sierra">ruby - CocoaPods not working in macOS High Sierra - Stack Overflow</a></li><li><a href="https://github.com/CocoaPods/CocoaPods/issues/6778">CocoaPods CLI fails in High Sierra due to change of Ruby version #6778</a></li><li><a href="https://github.com/CocoaPods/CocoaPods/issues/6898#issuecomment-332060096">High Sierra: bad interpreter #6898</a></li></ul><p>事情的缘由就是这样。</p><p><a href="https://github.com/CocoaPods/CocoaPods/issues/6898#issuecomment-332060096">#6898</a>中道出了简单直接的解决方案：</p><blockquote><p>for all others:</p></blockquote><blockquote><p><code>gem install -n /usr/local/bin cocoapods</code></p></blockquote><blockquote><p>fixes it</p></blockquote><p><strong>综合起来</strong>解决这个问题是这样的：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gem update --system</span><br><span class="line">$ gem uninstall cocoapods</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;gem: --bindir /usr/local/bin&#x27;</span> &gt;&gt; ~/.gemrc</span><br><span class="line">$ sudo gem install cocoapods</span><br></pre></td></tr></table></figure><p>愉快的使用cocoapods吧～</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css&quot;&gt;&lt;p&gt;每逢升级大版本总要过搞点事情。&lt;/p&gt;
&lt;figure class=&quot;hig
      
    
    </summary>
    
      <category term="macOS" scheme="https://madordie.github.io/categories/macOS/"/>
    
    
      <category term="cocoapods" scheme="https://madordie.github.io/tags/cocoapods/"/>
    
  </entry>
  
  <entry>
    <title>mac10.13依旧让Xcode支持打开终端</title>
    <link href="https://madordie.github.io/post/mac-high-sierra-open-with-external/"/>
    <id>https://madordie.github.io/post/mac-high-sierra-open-with-external/</id>
    <published>2017-09-28T11:06:47.000Z</published>
    <updated>2017-10-09T04:59:40.198Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>在macOS10.13以前是支持Xcode中直接打开终端的，步骤呢就是下面这样子：</p><p><img src="/images/mac-high-sierra-open-with-external-1.gif" alt="效果图"></p><ol><li>右击工程</li><li>Open With External Editor</li><li>终端弹出来了。。</li></ol><p>如果没有生效，就是你的电脑上装了什么可以打开<code>xx.xcodeproj</code>的应用程序，也就是在<code>Finder</code>下右击可以看到如下样式：</p><p><img src="/images/mac-high-sierra-open-with-external-2.jpg" alt="效果图"></p><p>呐～ Xcode为默认，备忘录为默认下面的第一个～～</p><p>对，如果这样的话，那么按照上面3步，得到的结果是：这个文件被莫名其妙的保存在了备忘录～～  </p><p>这不是我们要的🤷‍♂️，下面我们通过修改<code>备忘录.app</code>的配置文件来达到我们的效果。</p><a id="more"></a><h3 id="成因"><a href="#成因" class="headerlink" title="成因"></a>成因</h3><p>macSO10.13加强了备忘录，嗯的确变强了，可是并没有Xcode和终端常用。</p><p>备忘录增加了导入的功能，支持了一些文件的打开(只是导入而已。。)，但是并不适合我。于是改一下吧～～</p><h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><ol><li>在<code>应用程序</code>中找到<code>备忘录</code></li><li>显示包内容</li><li>找到 我们要修改的plist文件： <code>Contents/Info.plist</code></li><li>做一下备份：复制一下。。</li><li>确保 &lt;4&gt; 已完成</li><li>直接修改<code>Info.plist</code>会提示没有权限，使用<code>sudo vim Info.plist</code>修改</li><li>不管你用什么方法，删除下面的这些代码<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleTypeName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>General files and folders<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>CFBundleTypeRole<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>Viewer<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>LSItemContentTypes<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>public.data<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>public.directory<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><code>:wq</code></li><li>重启一下 （目的：重建索引）</li></ol><h3 id="至于我做了什么"><a href="#至于我做了什么" class="headerlink" title="至于我做了什么"></a>至于我做了什么</h3><p>讲道理，用Xcode的都知道吧？这个是注册的app支持的文件类型。 删除之后就可以了，就这么多😂</p><h3 id="注意一下"><a href="#注意一下" class="headerlink" title="注意一下"></a>注意一下</h3><p><code>操作</code>中的<code>步骤9</code>可以有脚本，但是还是老实重启一下吧，有的脚本会使部分图标失效，巨烦。。还是重启一下比较靠谱。毕竟不着急</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在macOS10.13以前是支持Xcode中直接打开终端的，步骤呢就是下面这样子：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/mac-high-sierra-open-with-external-1.gif&quot; alt=&quot;效果图&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;右击工程&lt;/li&gt;
&lt;li&gt;Open With External Editor&lt;/li&gt;
&lt;li&gt;终端弹出来了。。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;如果没有生效，就是你的电脑上装了什么可以打开&lt;code&gt;xx.xcodeproj&lt;/code&gt;的应用程序，也就是在&lt;code&gt;Finder&lt;/code&gt;下右击可以看到如下样式：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/mac-high-sierra-open-with-external-2.jpg&quot; alt=&quot;效果图&quot;&gt;&lt;/p&gt;
&lt;p&gt;呐～ Xcode为默认，备忘录为默认下面的第一个～～&lt;/p&gt;
&lt;p&gt;对，如果这样的话，那么按照上面3步，得到的结果是：这个文件被莫名其妙的保存在了备忘录～～  &lt;/p&gt;
&lt;p&gt;这不是我们要的🤷‍♂️，下面我们通过修改&lt;code&gt;备忘录.app&lt;/code&gt;的配置文件来达到我们的效果。&lt;/p&gt;
    
    </summary>
    
      <category term="macOS" scheme="https://madordie.github.io/categories/macOS/"/>
    
    
      <category term="Xcode" scheme="https://madordie.github.io/tags/Xcode/"/>
    
  </entry>
  
  <entry>
    <title>Xcode9编译失败</title>
    <link href="https://madordie.github.io/post/debug-xcode9-build-ipa/"/>
    <id>https://madordie.github.io/post/debug-xcode9-build-ipa/</id>
    <published>2017-09-26T06:16:32.000Z</published>
    <updated>2017-10-11T03:37:39.832Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="错误输出"><a href="#错误输出" class="headerlink" title="错误输出"></a>错误输出</h2><blockquote><p>error: exportArchive: “Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features.</p></blockquote><blockquote><p>Error Domain=IDEProvisioningErrorDomain Code=9 “”Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features.” UserInfo={NSLocalizedDescription=”Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features., NSLocalizedRecoverySuggestion=Add a profile to the “provisioningProfiles” dictionary in your Export Options property list.}</p></blockquote><a id="more"></a><h2 id="错误原因"><a href="#错误原因" class="headerlink" title="错误原因"></a>错误原因</h2><p>在升级Xcode9正式版之后，Jenkins也就升级了，于是乎用原来的套路打包之后就是上面的错误 5555…</p><p>如果使用<code>xcodebuild</code>进行处理，那么这个会发生在选择证书的步骤，错误大致就是这样。</p><p><code>$xcodebuild --help</code> 可以看到一些信息，而且在最后还特意提出了一个“-exportOptionsPlist”参数。具体内容见<code>xcodebuild --help</code></p><h2 id="解决问题才是关键"><a href="#解决问题才是关键" class="headerlink" title="解决问题才是关键"></a>解决问题才是关键</h2><ol><li><p>使用xcode9进行一次<code>archive</code></p></li><li><p>选择相关证书啊神马的，保持<code>thinning</code>不变就好</p></li><li><p>导出</p></li><li><p>导出目录有一个<code>ExportOptionsPlist.plist</code>，这个就是打包时候需要的plist</p></li></ol><h2 id="脚本构建"><a href="#脚本构建" class="headerlink" title="脚本构建"></a>脚本构建</h2><p><code>ipa</code>即为目标变量，具体的参看<a href="../build-ipa-sh">打包脚本</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ./build/*</span><br><span class="line">cat &lt;&lt; EOF &gt; ./build/exportOptionsPlist.plist</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC <span class="string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span><br><span class="line">&lt;plist version=<span class="string">&quot;1.0&quot;</span>&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">    &lt;key&gt;compileBitcode&lt;/key&gt;</span><br><span class="line">    &lt;<span class="literal">true</span>/&gt;</span><br><span class="line">    &lt;key&gt;method&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;enterprise&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;provisioningProfiles&lt;/key&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">        &lt;key&gt;ershoufanglzg.fangdd.com&lt;/key&gt;</span><br><span class="line">        &lt;string&gt;ershoufanglzg_dis&lt;/string&gt;</span><br><span class="line">    &lt;/dict&gt;</span><br><span class="line">    &lt;key&gt;signingCertificate&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;iPhone Distribution&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;signingStyle&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;manual&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;stripSwiftSymbols&lt;/key&gt;</span><br><span class="line">    &lt;<span class="literal">true</span>/&gt;</span><br><span class="line">    &lt;key&gt;teamID&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;J3B467DURT&lt;/string&gt;</span><br><span class="line">    &lt;key&gt;thinning&lt;/key&gt;</span><br><span class="line">    &lt;string&gt;&amp;lt;none&amp;gt;&lt;/string&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">xcodebuild -archivePath <span class="string">&quot;./build/xxx.xcarchive&quot;</span> -workspace Fangduoduo.xcworkspace -sdk iphoneos -scheme <span class="string">&quot;Fangduoduo_ent&quot;</span> -configuration <span class="string">&quot;Release Inhouse&quot;</span> archive</span><br><span class="line">xcodebuild -exportArchive -archivePath <span class="string">&quot;./build/xxx.xcarchive&quot;</span> -exportPath <span class="string">&quot;./build/&quot;</span> -exportOptionsPlist ./build/exportOptionsPlist.plist</span><br><span class="line"></span><br><span class="line">ipa=$(<span class="built_in">pwd</span>)/$(ls ./build/*.ipa)</span><br></pre></td></tr></table></figure><h2 id="xcodebuild-–help"><a href="#xcodebuild-–help" class="headerlink" title="xcodebuild –help"></a>xcodebuild –help</h2><blockquote><p>Available keys for -exportOptionsPlist:</p></blockquote><blockquote><p>compileBitcode : Bool</p></blockquote><blockquote><p>For non-App Store exports, should Xcode re-compile the app from bitcode? Defaults to YES.</p></blockquote><blockquote><p>embedOnDemandResourcesAssetPacksInBundle : Bool</p></blockquote><blockquote><p>For non-App Store exports, if the app uses On Demand Resources and this is YES, asset packs are embedded in the app bundle so that the app can be tested without a server to host asset packs. Defaults to YES unless onDemandResourcesAssetPacksBaseURL is specified.</p></blockquote><blockquote><p>iCloudContainerEnvironment : String</p></blockquote><blockquote><p>If the app is using CloudKit, this configures the “com.apple.developer.icloud-container-environment” entitlement. Available options vary depending on the type of provisioning profile used, but may include: Development and Production.</p></blockquote><blockquote><p>installerSigningCertificate : String</p></blockquote><blockquote><p>For manual signing only. Provide a certificate name, SHA-1 hash, or automatic selector to use for signing. Automatic selectors allow Xcode to pick the newest installed certificate of a particular type. The available automatic selectors are “Mac Installer Distribution” and “Developer ID Installer”. Defaults to an automatic certificate selector matching the current distribution method.</p></blockquote><blockquote><p>manifest : Dictionary</p></blockquote><blockquote><p>For non-App Store exports, users can download your app over the web by opening your distribution manifest file in a web browser. To generate a distribution manifest, the value of this key should be a dictionary with three sub-keys: appURL, displayImageURL, fullSizeImageURL. The additional sub-key assetPackManifestURL is required when using on-demand resources.</p></blockquote><blockquote><p>method : String</p></blockquote><blockquote><p>Describes how Xcode should export the archive. Available options: app-store, package, ad-hoc, enterprise, development, developer-id, and mac-application. The list of options varies based on the type of archive. Defaults to development.</p></blockquote><blockquote><p>onDemandResourcesAssetPacksBaseURL : String</p></blockquote><blockquote><p>For non-App Store exports, if the app uses On Demand Resources and embedOnDemandResourcesAssetPacksInBundle isn’t YES, this should be a base URL specifying where asset packs are going to be hosted. This configures the app to download asset packs from the specified URL.</p></blockquote><blockquote><p>provisioningProfiles : Dictionary</p></blockquote><blockquote><p>For manual signing only. Specify the provisioning profile to use for each executable in your app. Keys in this dictionary are the bundle identifiers of executables; values are the provisioning profile name or UUID to use.</p></blockquote><blockquote><p>signingCertificate : String</p></blockquote><blockquote><p>For manual signing only. Provide a certificate name, SHA-1 hash, or automatic selector to use for signing. Automatic selectors allow Xcode to pick the newest installed certificate of a particular type. The available automatic selectors are “Mac App Distribution”, “iOS Developer”, “iOS Distribution”, “Developer ID Application”, and “Mac Developer”. Defaults to an automatic certificate selector matching the current distribution method.</p></blockquote><blockquote><p>signingStyle : String</p></blockquote><blockquote><p>The signing style to use when re-signing the app for distribution. Options are manual or automatic. Apps that were automatically signed when archived can be signed manually or automatically during distribution, and default to automatic. Apps that were manually signed when archived must be manually signed during distribtion, so the value of signingStyle is ignored.</p></blockquote><blockquote><p>stripSwiftSymbols : Bool</p></blockquote><blockquote><p>Should symbols be stripped from Swift libraries in your IPA? Defaults to YES.</p></blockquote><blockquote><p>teamID : String</p></blockquote><blockquote><p>The Developer Portal team to use for this export. Defaults to the team used to build the archive.</p></blockquote><blockquote><p>thinning : String</p></blockquote><blockquote><p>For non-App Store exports, should Xcode thin the package for one or more device variants? Available options: <none> (Xcode produces a non-thinned universal app), <thin-for-all-variants> (Xcode produces a universal app and all available thinned variants), or a model identifier for a specific device (e.g. “iPhone7,1”). Defaults to <none>.</p></blockquote><blockquote><p>uploadBitcode : Bool</p></blockquote><blockquote><p>For App Store exports, should the package include bitcode? Defaults to YES.</p></blockquote><blockquote><p>uploadSymbols : Bool</p></blockquote><blockquote><p>For App Store exports, should the package include symbols? Defaults to YES.</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;错误输出&quot;&gt;&lt;a href=&quot;#错误输出&quot; class=&quot;headerlink&quot; title=&quot;错误输出&quot;&gt;&lt;/a&gt;错误输出&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;error: exportArchive: “Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Error Domain=IDEProvisioningErrorDomain Code=9 “”Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features.” UserInfo={NSLocalizedDescription=”Fangduoduo_ent.app” requires a provisioning profile with the Push Notifications and Associated Domains features., NSLocalizedRecoverySuggestion=Add a profile to the “provisioningProfiles” dictionary in your Export Options property list.}&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="构建" scheme="https://madordie.github.io/tags/%E6%9E%84%E5%BB%BA/"/>
    
      <category term="DEBUG" scheme="https://madordie.github.io/tags/DEBUG/"/>
    
  </entry>
  
  <entry>
    <title>iOS自动化-Jenkins编译工程</title>
    <link href="https://madordie.github.io/post/ios-automation-jenkins-build/"/>
    <id>https://madordie.github.io/post/ios-automation-jenkins-build/</id>
    <published>2017-09-14T09:27:15.000Z</published>
    <updated>2017-10-10T06:05:41.268Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><ul><li><a href="../ios-automation-jenkins-configuration">iOS自动化-Jenkins环境搭建</a></li><li><a href="../ios-automation-jenkins-build">iOS自动化-Jenkins编译工程</a></li></ul><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Jenkins环境已搭建好，现在我们来开始愉快的为iOS打包吧～</p><p>从这个文章中你将要实现以下功能：</p><ul><li>在Jenkins创建工程</li><li>build出ipa</li><li>将ipa上传至fir</li><li>钉钉机器人群通知</li><li>将dsym上传至bugly</li></ul><a id="more"></a><h2 id="脚本环境安装"><a href="#脚本环境安装" class="headerlink" title="脚本环境安装"></a>脚本环境安装</h2><p>这里大多数操作都是用脚本来进行的，不为别的，就为自由和以后～</p><h3 id="fastlane"><a href="#fastlane" class="headerlink" title="fastlane"></a>fastlane</h3><p>此乃自动化神器。<a href="https://docs.fastlane.tools/">文档在此</a>。<a href="https://github.com/fastlane/fastlane">开源哟～</a></p><p>此处主要用来编译、打包。</p><p>安装方法：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew cask install fastlane</span><br></pre></td></tr></table></figure><p>此神器除了上述功能，还提供很多很多很多很多功能，包括自定义神马的都支持。需要的可以去文档里面翻翻。</p><p>在Xcode9 我使用的版本2.14.1打包出问题了。。具体在这里详见<a href="../debug-xcode9-build-ipa">Xcode9编译失败</a>。于是呼采用了<code>xcodebuild</code>进行打包</p><h3 id="fir-im-cli"><a href="#fir-im-cli" class="headerlink" title="fir.im-cli"></a>fir.im-cli</h3><p><a href="https://fir.im/">fir.im</a>提供的应用内测托管工具。<a href="https://github.com/FIRHQ/fir-cli/blob/master/README.md">开源官网</a>。</p><p>安装方法：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gem install fir-cli</span><br></pre></td></tr></table></figure><p>此工具也提供打包ipa、apk、上传符号表至BugHD、等功能。但是我们在这里选择了<code>fastlane gym</code></p><p>上传加速：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh -c <span class="string">&quot;<span class="subst">$(curl -sSL https://gist.githubusercontent.com/trawor/5dda140dee86836b8e60/raw/turbo-qiniu.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure><p>上传加速代码已经<a href="http://blog.fir.im/turbo-qiniu/">开源至此</a>。</p><p><a href="http://bughd.com/">BugHD</a>: 已停止线上免费服务，开始卖私有部署了。</p><p>另外，fir 也有<a href="http://blog.fir.im/jenkins/">Jenkins插件</a>，但是这里选择脚本方式。</p><h2 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h2><p>所有的插件可以在<code>系统管理 -&gt; 插件管理</code>中进行安装、卸载、降级、更新、等操作。</p><p>确保以下插件已经被安装：</p><ul><li>源代码管理：<a href="https://wiki.jenkins.io/display/JENKINS/Git+Plugin">Git Plugin</a></li><li>编译脚本环境变量：<a href="http://wiki.hudson-ci.org/display/HUDSON/Tool+Environment+Plugin">Tool Environment Plugin</a></li></ul><p>嗯，开始创建工程，然后配置打包吧！</p><h2 id="工程相关配置"><a href="#工程相关配置" class="headerlink" title="工程相关配置"></a>工程相关配置</h2><p>左侧的<code>新建(New Item)</code>我就不说了吧～，点击输入项目名字，然后选择第一个<code>构建一个自由风格的软件项目</code>就行啦～～</p><p>此处项目名字暂且成为<code>test</code>。这里只说一些比较重要的，没有活不成的那种配置。别的自己研究一下或者点击右侧❓就能看到介绍。</p><h3 id="源码管理"><a href="#源码管理" class="headerlink" title="源码管理"></a>源码管理</h3><p>此处点击<code>Git</code>，展开之后输入<code>Repository URL</code>即可。</p><p><code>Repository URL</code>输入完毕之后点击别处，Jenkins的Git插件会自动校验该URL是否能够clone下来代码。出现红色就自己根据错误修改一下咯。。</p><p>另外此处支持<code>ssh</code> 的方式，大致样式为：<code>ssh://sunjigang@github.com:29418/projects/aaa</code>。</p><p><code>Branches to build</code> 写上你的构建分支～，根据自己需求来，<code>master</code>一般为仓库的默认分支。</p><h3 id="构建触发器"><a href="#构建触发器" class="headerlink" title="构建触发器"></a>构建触发器</h3><p>此处表示该项目的构建触发条件。（可选）</p><p>我们这里说一下<code>Poll SCM</code>：</p><p>定时检查源码变更。条件是 一定要配置<code>Git</code>这样的源码管理。</p><p>例子：</p><ul><li><code>H/15 * * * *</code>：每15分钟构建一次</li><li><code>0 2 * * *</code>： 每天2:00构建一次</li></ul><h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p>此处为构建的核心😂。当然，我们为了自由，此处全部使用<code>shell</code>脚本。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 工程名</span></span><br><span class="line">workspace=<span class="string">&#x27;xxx.xcworkspace&#x27;</span></span><br><span class="line"><span class="comment"># 构建scheme</span></span><br><span class="line">scheme=<span class="string">&#x27;xxx&#x27;</span></span><br><span class="line"><span class="comment"># 打包类型：app-store, ad-hoc, package, enterprise, development, and developer-id.</span></span><br><span class="line">export_method=<span class="string">&#x27;enterprise&#x27;</span></span><br><span class="line"><span class="comment"># fir的token，在fir-&gt;用户-&gt;token 获取</span></span><br><span class="line">fir_token=<span class="string">&#x27;c5077e0368888b9750ae848b9fe00***&#x27;</span></span><br><span class="line"><span class="comment"># fir上传短链接，效果为 https://fir.im/xxx</span></span><br><span class="line">fir_url=<span class="string">&#x27;xxx&#x27;</span></span><br><span class="line"><span class="comment"># 钉钉机器人token</span></span><br><span class="line">dingtalk_token=<span class="string">&#x27;6d09e43ddc62e540be914ff2e901e28b921d55c5ad457f6f3571f9f881287***&#x27;</span></span><br><span class="line"><span class="comment"># 钉钉机器人发送的内容</span></span><br><span class="line">dingtalk_content=<span class="string">&quot;iOSXXX已经上传至 http://fir.im/<span class="variable">$&#123;fir_url&#125;</span> ,吧啦吧啦吧啦～&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建</span></span><br><span class="line">fastlane gym</span><br><span class="line">    --workspace <span class="variable">$workspace</span> \</span><br><span class="line">    --scheme <span class="variable">$scheme</span> \</span><br><span class="line">    --export_method <span class="variable">$export_method</span> \</span><br><span class="line">    clean</span><br><span class="line"></span><br><span class="line"><span class="comment"># fir</span></span><br><span class="line">ipa=$(<span class="built_in">pwd</span>)/$(ls *.ipa)</span><br><span class="line">git <span class="built_in">log</span> -10 &gt; git.log</span><br><span class="line">fir p <span class="variable">$ipa</span> -T <span class="variable">$fir_token</span> -s <span class="variable">$fir_url</span> -c git.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 钉钉通知</span></span><br><span class="line">curl <span class="string">&quot;https://oapi.dingtalk.com/robot/send?access_token=<span class="variable">$&#123;dingtalk_token&#125;</span>&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span>    -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    &#123;&quot;msgtype&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;text&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;content&quot;:$&#123;dingtalk_content&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>至此 已经完成了打包、上传fir、钉钉机器人通知。</p><p>上述脚本只是配置的例子，可以根据自己需求，自己编写和配置。特别是</p><ul><li><code>.xcworkspace</code>的位置，要找清楚呀</li><li><code>scheme</code>无法找到是因为你在提交代码的时候没有将其设置为shared</li><li><code>fastlane gym</code> 支持很多参数，是对<code>xcodebuild</code>的封装，<a href="https://github.com/fastlane/fastlane/tree/master/gym">源码及文档在此</a></li></ul><h3 id="上传dSYM至Bugly"><a href="#上传dSYM至Bugly" class="headerlink" title="上传dSYM至Bugly"></a>上传dSYM至Bugly</h3><p>这个还是有点点复杂的，因为bugly并未提供完整的cli工具链，需要手动跑jar包。不过都是可以完成的。</p><p>为了隔离开打包和上传，这里在Jenkins上新建一个项目用来上传dSYM</p><p>其中需要衔接的地方就是上面的输出要作为这个的输出。所以需要前后对应位置。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 路径主要用来提取Info.plist以及dsym文件</span></span><br><span class="line">path=<span class="string">&#x27;/Users/FDD/.jenkins/workspace/fdd-ios-app/fdd-app-ios/Fangduoduo&#x27;</span></span><br><span class="line"><span class="comment"># scheme name</span></span><br><span class="line">scheme=<span class="string">&#x27;Fangduoduo_ent&#x27;</span></span><br><span class="line"><span class="comment"># ipa bundleId</span></span><br><span class="line">package=<span class="string">&#x27;xx.xx.com&#x27;</span></span><br><span class="line"><span class="comment"># bugly id</span></span><br><span class="line">bugly_id=<span class="string">&#x27;9xxx&#x27;</span></span><br><span class="line"><span class="comment"># bugly key</span></span><br><span class="line">bugly_key=<span class="string">&#x27;wHzxcxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">rm -rf *dSYM*</span><br><span class="line">cp <span class="variable">$&#123;path&#125;</span>/Fangduoduo/Fangduoduo_ent-Info.plist ./Info.plist</span><br><span class="line">cp -rf <span class="variable">$&#123;path&#125;</span>/build/*.xcarchive/dSYMs .</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------ post dsym ------------ #</span></span><br><span class="line"></span><br><span class="line">app_infoplist_path=<span class="string">&#x27;Info.plist&#x27;</span></span><br><span class="line">version=$(/usr/libexec/PlistBuddy -c <span class="string">&quot;print CFBundleVersion&quot;</span> <span class="variable">$&#123;app_infoplist_path&#125;</span>)</span><br><span class="line"></span><br><span class="line">java -jar ./bugly/buglySymboliOS.jar \</span><br><span class="line">-i dSYMs/<span class="variable">$&#123;scheme&#125;</span>.app.dSYM \</span><br><span class="line">    -dsym \</span><br><span class="line">    -u \</span><br><span class="line">    -id <span class="variable">$&#123;bugly_id&#125;</span> \</span><br><span class="line">    -key <span class="variable">$&#123;bugly_key&#125;</span> \</span><br><span class="line">    -package <span class="variable">$&#123;package&#125;</span> \</span><br><span class="line">    -version <span class="variable">$&#123;version&#125;</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># @bugly jar执行的时候返回状态码有问题。已反馈，但是不见修改。。</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># ------------ UUID ------------ #</span></span><br><span class="line"></span><br><span class="line">unzip -o ./dSYMs/<span class="variable">$&#123;scheme&#125;</span>.app.dSYM.zip</span><br><span class="line">xcrun dwarfdump --uuid ./<span class="variable">$&#123;scheme&#125;</span> &gt;&gt; ./uuids-<span class="variable">$&#123;version&#125;</span>.txt</span><br></pre></td></tr></table></figure><p>值得说的是，如果上面的报错，那么检查一下是不是路径什么的写错了。。。</p><p>如果还有问题，可以在<a href="../../about">关于</a>中找到我。</p>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;../ios-automation-jenkins-configuration&quot;&gt;iOS自动化-Jenkins环境搭建&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;../ios-automation-jenkins-build&quot;&gt;iOS自动化-Jenkins编译工程&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;Jenkins环境已搭建好，现在我们来开始愉快的为iOS打包吧～&lt;/p&gt;
&lt;p&gt;从这个文章中你将要实现以下功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在Jenkins创建工程&lt;/li&gt;
&lt;li&gt;build出ipa&lt;/li&gt;
&lt;li&gt;将ipa上传至fir&lt;/li&gt;
&lt;li&gt;钉钉机器人群通知&lt;/li&gt;
&lt;li&gt;将dsym上传至bugly&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://madordie.github.io/categories/iOS/"/>
    
    
      <category term="构建" scheme="https://madordie.github.io/tags/%E6%9E%84%E5%BB%BA/"/>
    
      <category term="Jenkins" scheme="https://madordie.github.io/tags/Jenkins/"/>
    
  </entry>
  
</feed>
